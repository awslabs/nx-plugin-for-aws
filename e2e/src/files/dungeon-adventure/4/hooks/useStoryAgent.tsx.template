import { useAuth } from 'react-oidc-context';
import { useRuntimeConfig } from './useRuntimeConfig';
import { useMemo } from 'react';

export interface GenerateStoryInput {
  playerName: string;
  genre: string;
  actions: { role: string; content: string }[];
}

export interface StreamChunk {
  content: string;
}

export const useStoryAgent = () => {
  const { agentArn } = useRuntimeConfig();
  const region = agentArn.split(':')[3];
  const url = `https://bedrock-agentcore.${region}.amazonaws.com/runtimes/${encodeURIComponent(agentArn)}/invocations?qualifier=DEFAULT`;

  const { user } = useAuth();

  return useMemo(
    () => ({
      generateStory: async function* (
        opts: GenerateStoryInput,
      ): AsyncIterableIterator<StreamChunk> {
        const response = await fetch(url, {
          headers: {
            Authorization: `Bearer ${user?.id_token}`,
            'Content-Type': 'application/json',
          },
          method: 'POST',
          body: JSON.stringify(opts),
        });

        const reader = response.body
          ?.pipeThrough(new TextDecoderStream())
          .getReader();

        if (!reader) return;

        let buffer = '';
        while (true) {
          const { value, done } = await reader.read();

          if (done) {
            if (buffer.trim()) {
              yield JSON.parse(buffer) as StreamChunk;
            }
            return;
          }

          buffer += value;
          const lines = buffer.split('\n');
          buffer = lines.pop() ?? '';
          for (const line of lines) {
            if (line.trim()) {
              yield JSON.parse(line) as StreamChunk;
            }
          }
        }
      },
    }),
    [url, user?.id_token],
  );
};
