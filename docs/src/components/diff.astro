---
import { Code, Tabs, TabItem } from '@astrojs/starlight/components';
import { diffLines } from 'diff';

const { before, after, lang } = Astro.props;

const diff = diffLines(before, after, { newlineIsToken: false })
  .map(change => {
    const prefix = change.added ? '+' : change.removed ? '-' : '';
    return change.value.slice(0, -1).split('\n').map(line => `${prefix}${line}`).join('\n') + '\n';
  }).join('');

let removedLines = 0;
const afterMeta = diff.split('\n').map((line, i) => {
  if (line.startsWith('+')) {
    return `ins={${i + 1 - removedLines}}`;
  } else if (line.startsWith('-')) {
    removedLines++;
  }
  return undefined;
}).filter(x => x).join(' ');

---
{
  removedLines > 0 ? (
    <Tabs syncKey="diff">
      <TabItem label="+">
        <Code lang={lang} code={after} meta={afterMeta} />
      </TabItem>
      <TabItem label="+-">
        <Code lang="diff" code={diff} {...(lang ? { meta: `lang="${lang}"`} : {})} />
      </TabItem>
    </Tabs>
  ) : <Code lang="diff" code={diff} {...(lang ? { meta: `lang="${lang}"`} : {})} />
}
