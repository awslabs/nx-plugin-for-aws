---
title: "Juego de Mazmorra de IA Ag√©ntica"
description: "Un tutorial de c√≥mo construir un juego de aventuras de mazmorra con IA ag√©ntica usando @aws/nx-plugin."
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## M√≥dulo 3: Implementaci√≥n del Agente de Historia

<Aside type="caution">
Aseg√∫rate que tu cuenta de AWS tenga acceso habilitado al [modelo predeterminado de Strands](https://strandsagents.com/latest/documentation/docs/user-guide/concepts/model-providers/amazon-bedrock/) dentro de Bedrock para tu regi√≥n objetivo, siguiendo los pasos descritos en [esta gu√≠a](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html). Al momento de escribir esto, el modelo es Anthropic Claude Sonnet 4.
</Aside>

El Agente de Historia es un agente de [Strands](https://strandsagents.com/) que, dado un `Game` y una lista de `Action`s como contexto, progresar√° una historia. Configuraremos el agente para interactuar con nuestro Inventory MCP Server y gestionar los objetos disponibles del jugador.

:::note
Para simplificar este tutorial, implementamos el Agente de forma "sin estado" donde cada invocaci√≥n es una sesi√≥n independiente que incluye todo el historial de mensajes. Para producci√≥n, considera integrar con [Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html). M√°s documentaci√≥n sobre el uso de AgentCore Memory con Strands est√° [disponible aqu√≠](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands).
:::

### Implementaci√≥n del Agente

Implementemos nuestro agente. Actualiza los siguientes archivos en `packages/story/dungeon_adventure_story/agent`:

<Tabs>
  <TabItem label="main.py">
<E2ECode lang="python" path="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2ECode lang="python" path="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

Esto configura:

- Extracci√≥n del jugador, g√©nero y acciones del payload del agente
- Construcci√≥n de un cliente que el Agente puede usar para invocar nuestro servidor MCP con autenticaci√≥n SigV4
- Construcci√≥n del agente con un prompt del sistema y las herramientas del servidor MCP

### Despliegue y pruebas

Primero, compilemos el c√≥digo base:

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
Si encuentras errores de lint, puedes ejecutar este comando para corregirlos autom√°ticamente:

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

Ahora puedes desplegar la aplicaci√≥n ejecutando:

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/*']} />

Este despliegue tomar√° aproximadamente 2 minutos en completarse.

Una vez completado el despliegue, ver√°s salidas similares a estas _(algunos valores han sido omitidos)_:

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 ‚úÖ  dungeon-adventure-infra-sandbox-Application

‚ú®  Tiempo de despliegue: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

Podemos probar nuestra API de dos formas:
<ul>
<li>Iniciando una instancia local del servidor del Agente e invoc√°ndola con `curl`</li>
<li>Llamando a la API desplegada usando curl con un token JWT</li>
</ul>

<Tabs>
  <TabItem label="Local">
  Inicia tu servidor local del Agente ejecutando:
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    Usa la salida `InventoryMcpArn` del despliegue CDK arriba, y especifica tu `AWS_REGION` objetivo.
    :::

    Una vez que el servidor del Agente est√© en ejecuci√≥n (¬°no ver√°s ninguna salida!), inv√≥calo ejecutando:

    ```bash
    curl -N -X POST http://127.0.0.1:8080/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789"
    ```
  </TabItem>
  <TabItem label="Desplegado">
    Para probar el agente desplegado, necesitas autenticarte con Cognito y obtener un token JWT. Primero configura tus variables de entorno:

    ```bash
    # Configura tu ID de User Pool de Cognito y Client ID desde las salidas CDK
    export POOL_ID="<UserPoolId de salidas CDK>"
    export CLIENT_ID="<UserPoolClientId de salidas CDK>"
    export REGION="<tu-regi√≥n>"
    ```

    Crea un usuario de prueba y obt√©n un token de autenticaci√≥n:

    ```bash
    # Crear usuario
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --temporary-password "TempPass123!" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # Establecer contrase√±a permanente (¬°reemplaza con algo m√°s seguro!)
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --password "PermanentPass123!" \
      --region $REGION \
      --permanent > /dev/null

    # Autenticar usuario y capturar token
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='testuser',PASSWORD='PermanentPass123!' \
      --region $REGION | jq -r '.AuthenticationResult.IdToken')
    ```

    :::caution
    Usa la salida `UserIdentityUserIdentityUserPoolIdXXX` para `POOL_ID` y aseg√∫rate de tener el Client ID correspondiente de tus salidas CDK.
    :::

    Ahora invoca el agente desplegado usando la URL de Bedrock AgentCore Runtime:

    ```bash
    # Configura el ARN del Agente de Historia desde las salidas CDK
    export AGENT_ARN="<StoryAgentArn de salidas CDK>"

    # Codificar ARN para URL
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # Construir URL de invocaci√≥n
    export MCP_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # Invocar el agente
    curl -N -X POST "$MCP_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    La codificaci√≥n URL es necesaria para formatear correctamente el ARN en el endpoint de API de Bedrock AgentCore.
    :::
  </TabItem>
</Tabs>

Si el comando se ejecuta exitosamente, ver√°s eventos transmitidos similares a:

```
data: {"init_event_loop": true}

data: {"start": true}

data: {"start_event_loop": true}

data: {"event": {"messageStart": {"role": "assistant"}}}

data: {"event": {"contentBlockDelta": {"delta": {"text": "Welcome"}, "contentBlockIndex": 0}}}

...
```

¬°Felicidades! Has construido y desplegado tu primer Agente de Strands en Bedrock AgentCore Runtime. üéâüéâüéâ