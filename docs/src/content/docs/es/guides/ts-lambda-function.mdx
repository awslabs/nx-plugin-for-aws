---
title: "Función Lambda de TypeScript"
description: "Generar una función lambda de TypeScript"
---



import { FileTree } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';

El generador de funciones Lambda en TypeScript permite añadir una función lambda a un proyecto existente en TypeScript.

Este generador crea un nuevo manejador de lambda en TypeScript con configuración de infraestructura AWS CDK. El manejador generado utiliza [AWS Lambda Powertools for TypeScript](https://docs.powertools.aws.dev/lambda/typescript/latest/) para observabilidad, incluyendo registro, trazas con AWS X-Ray y métricas de CloudWatch, además de validación opcional de tipos para eventos usando [Parser de AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/).

## Uso

### Generar una función Lambda en TypeScript

Puedes generar una función lambda de dos maneras:

<RunGenerator generator="ts#lambda-function" />

### Opciones

<GeneratorParameters generator="ts#lambda-function" />

## Salida del generador

El generador añadirá los siguientes archivos a tu proyecto:

<FileTree>

- \<project-name>
  - src/
    - \<lambda-function>.ts Implementación de la función

</FileTree>

El generador también creará un constructo CDK para desplegar tu función, ubicado en el directorio `packages/common/constructs/src/app/lambda-functions`.

Si se proporciona la opción `functionPath`, el generador añadirá el manejador en la ruta especificada dentro del directorio fuente del proyecto:

<FileTree>

- \<project-name>
  - src/
    - \<custom-path>/
      - \<function-name>.ts Implementación de la función

</FileTree>

## Implementación de tu función

La implementación principal está en `<function-name>.ts`. Aquí un ejemplo:

```typescript
import { parser } from '@aws-lambda-powertools/parser/middleware';
import { EventBridgeSchema } from '@aws-lambda-powertools/parser/schemas';
import middy from '@middy/core';
import { Tracer } from '@aws-lambda-powertools/tracer';
import { captureLambdaHandler } from '@aws-lambda-powertools/tracer/middleware';
import { injectLambdaContext } from '@aws-lambda-powertools/logger/middleware';
import { Logger } from '@aws-lambda-powertools/logger';
import { Metrics, MetricUnit } from '@aws-lambda-powertools/metrics';
import { logMetrics } from '@aws-lambda-powertools/metrics/middleware';

process.env.POWERTOOLS_METRICS_NAMESPACE = "MyFunction";
process.env.POWERTOOLS_SERVICE_NAME = "MyFunction";

const tracer = new Tracer();
const logger = new Logger();
const metrics = new Metrics();

export const handler = middy()
  .use(captureLambdaHandler(tracer))
  .use(injectLambdaContext(logger))
  .use(logMetrics(metrics))
  .use(parser({ schema: EventBridgeSchema }))
  .handler(async (event) => {
    logger.info("Received event", event);

    metrics.addMetric("InvocationCount", MetricUnit.Count, 1);

    try {
        // TODO: Implementar
        metrics.addMetric("SuccessCount", MetricUnit.Count, 1);
        // TODO: Implementar respuesta de éxito si es necesario
    } catch (e) {
        logger.error("Error processing event", e as Error);
        metrics.addMetric("ErrorCount", MetricUnit.Count, 1);
        // TODO: Implementar respuesta de error si es necesario
    }
  });
```

El generador configura automáticamente varias características:

1. **Middleware stack de Middy** para funcionalidad extendida de Lambda
2. **Integración con AWS Lambda Powertools** para observabilidad
3. **Recolección de métricas** con CloudWatch
4. **Validación de tipos** usando middleware de parser
5. **Empaquetado con esbuild** para paquetes de despliegue optimizados

### Observabilidad con AWS Lambda Powertools

#### Registro

El generador configura registro estructurado usando AWS Lambda Powertools con inyección automática de contexto mediante middleware Middy.

```typescript
export const handler = middy()
  .use(injectLambdaContext(logger))
  .handler(async (event) => {
    logger.info("Received event", event);
    logger.error("Error processing event", error);
  });
```

#### Trazas

El rastreo con AWS X-Ray se configura automáticamente mediante el middleware `captureLambdaHandler`. Puedes añadir subsegmentos personalizados:

```typescript
export const handler = middy()
  .use(captureLambdaHandler(tracer))
  .handler(async (event) => {
    // Crea un nuevo subsegmento
    const subsegment = tracer.getSegment()?.addNewSubsegment('custom-operation');
    try {
      // Tu lógica aquí
    } catch (error) {
      subsegment?.addError(error as Error);
      throw error;
    } finally {
      subsegment?.close();
    }
  });
```

#### Métricas

Las métricas de CloudWatch se recolectan automáticamente en cada solicitud mediante el middleware `logMetrics`. Puedes añadir métricas personalizadas:

```typescript
export const handler = middy()
  .use(logMetrics(metrics))
  .handler(async (event) => {
    metrics.addMetric("CustomMetric", MetricUnit.Count, 1);
    metrics.addMetric("ProcessingTime", MetricUnit.Milliseconds, processingTime);
  });
```

### Validación de tipos

Si seleccionaste un `eventSource` al generar tu función, esta se instrumenta con el [middleware `parser` de AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/). Por ejemplo:

```typescript {4}
export const handler = middy()
  .use(parser({ schema: EventBridgeSchema }))
  .handler(async (event) => {
    event.detail // <- tipado seguro con autocompletado en IDE
  });
```

Esto provee validación de tipos en tiempo de compilación y validación en tiempo de ejecución para los eventos Lambda.

:::caution
Si no deseas que tu manejador lance un error cuando el evento no coincide con el esquema, puedes usar la [opción `safeParse`](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/#safe-parsing).
:::

:::tip
Si tienes datos personalizados anidados en un evento, como un stream de DynamoDB o evento de EventBridge, puedes beneficiarte usando [Envelopes](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/#envelopes) para validar esos datos.
:::

Si no deseas tipar tu evento, puedes seleccionar `Any` como `eventSource`, lo que resultará en un tipo `any` para el parámetro del evento.

## Empaquetado

El generador configura automáticamente [esbuild](https://esbuild.github.io/) para paquetes de despliegue optimizados:

Empaqueta una función lambda específica con:

<NxCommands commands={['run <project-name>:bundle-<function-name>']} />

Empaqueta todas las funciones lambda del proyecto con:

<NxCommands commands={['run <project-name>:bundle']} />

## Despliegue de tu función

El generador crea un constructo CDK para desplegar tu función en la carpeta `common/constructs`. Puedes usarlo en una aplicación CDK:

```typescript {1, 6}
import { MyProjectMyFunction } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // Añade la función a tu stack
    const fn = new MyProjectMyFunction(this, 'MyFunction');
  }
}
```

Esto configura:

1. Función AWS Lambda
2. Grupo de logs en CloudWatch
3. Configuración de trazas con X-Ray
4. Namespace de métricas en CloudWatch

Esta función puede usarse como destino para cualquier [origen de eventos Lambda](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/):

:::note
Asegúrate de que el origen del evento coincida con la opción `eventSource` seleccionada para un manejo adecuado en tu función.
:::

El siguiente ejemplo muestra código CDK para invocar tu función en un horario usando EventBridge:

```typescript
import { Rule, Schedule } from 'aws-cdk-lib/aws-events';
import { LambdaFunction } from 'aws-cdk-lib/aws-events-targets';
import { MyProjectMyFunction } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // Añade la función al stack
    const fn = new MyProjectMyFunction(this, 'MyFunction');

    // Añade la función a una regla programada de EventBridge
    const eventRule = new Rule(this, 'MyFunctionScheduleRule', {
      schedule: Schedule.cron({ minute: '15' }),
      targets: [new LambdaFunction(fn)],
    });
  }
}
```