---
title: "FastAPI"
description: "FastAPI 参考文档"
---

import { FileTree, AnchorHeading, Tabs, TabItem } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';

[FastAPI](https://fastapi.tiangolo.com/) 是一个用于构建 Python API 的框架。

FastAPI 生成器可创建带有 AWS CDK 或 Terraform 基础设施配置的新 FastAPI 项目。生成的后端使用 AWS Lambda 进行无服务器部署,通过 AWS API Gateway API 暴露接口。它配置了 [AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/python/latest/) 用于可观测性,包括日志记录、AWS X-Ray 追踪和 Cloudwatch 指标。

## 使用方式

### 生成 FastAPI

您可以通过两种方式生成新的 FastAPI:

<RunGenerator generator="py#fast-api" />

### 选项配置

<GeneratorParameters generator="py#fast-api" />

<Snippet name="api/api-choice-note" />

:::tip
如果您打算构建任何流式操作,请选择 `ServerlessApiGatewayRestApi`(默认)作为您的 `computeType`。
:::

## 生成器输出

生成器将在 `<directory>/<api-name>` 目录下创建以下项目结构:

<FileTree>

- project.json 项目配置和构建目标
- pyproject.toml Python 项目配置和依赖项
- run.sh Lambda Web Adapter 引导脚本,通过 uvicorn 启动 FastAPI 应用
- \<module_name>
  - \_\_init\_\_.py 模块初始化
  - init.py 设置 FastAPI 应用并配置 powertools 中间件
  - main.py API 实现
- scripts
  - generate_open_api.py 从 FastAPI 应用生成 OpenAPI 模式的脚本

</FileTree>

### 基础设施

<Snippet name="shared-constructs" />

<Snippet name="api/shared-constructs" />

## 实现 FastAPI

主要的 API 实现位于 `main.py`。这是定义 API 路由及其实现的地方。示例如下:

```python
from pydantic import BaseModel
from .init import app, tracer

class Item(BaseModel):
  name: str

@app.get("/items/{item_id}")
@tracer.capture_method
def get_item(item_id: int) -> Item:
    return Item(name=...)

@app.post("/items")
@tracer.capture_method
def create_item(item: Item):
    return ...
```

生成器自动配置了以下功能:

1. 用于可观测性的 AWS Lambda Powertools 集成
2. 错误处理中间件
3. 请求/响应关联
4. 指标收集
5. 通过 [Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) 使用 uvicorn 进行 AWS Lambda 部署
6. 类型安全的流式传输(仅限 REST API)

### 使用 AWS Lambda Powertools 实现可观测性

#### 日志记录

生成器使用 AWS Lambda Powertools 配置结构化日志记录。您可以在路由处理程序中访问日志记录器:

```python
from .init import app, logger

@app.get("/items/{item_id}")
def read_item(item_id: int):
    logger.info("Fetching item", extra={"item_id": item_id})
    return {"item_id": item_id}
```

日志记录器自动包含:

- 用于请求追踪的关联 ID
- 请求路径和方法
- Lambda 上下文信息
- 冷启动指示器

#### 追踪

自动配置 AWS X-Ray 追踪。您可以为追踪添加自定义子段:

```python
from .init import app, tracer

@app.get("/items/{item_id}")
@tracer.capture_method
def read_item(item_id: int):
    # 创建新的子段
    with tracer.provider.in_subsegment("fetch-item-details"):
        # 在此处添加逻辑
        return {"item_id": item_id}
```

#### 指标

自动收集每个请求的 CloudWatch 指标。您可以添加自定义指标:

```python
from .init import app, metrics
from aws_lambda_powertools.metrics import MetricUnit

@app.get("/items/{item_id}")
def read_item(item_id: int):
    metrics.add_metric(name="ItemViewed", unit=MetricUnit.Count, value=1)
    return {"item_id": item_id}
```

默认指标包括:

- 请求计数
- 成功/失败计数
- 冷启动指标
- 按路由统计的指标

### 错误处理

生成器包含全面的错误处理:

```python
from fastapi import HTTPException

@app.get("/items/{item_id}")
def read_item(item_id: int):
    if item_id < 0:
        raise HTTPException(status_code=400, detail="Item ID must be positive")
    return {"item_id": item_id}
```

未捕获的异常会被中间件捕获并:

1. 记录完整异常和堆栈跟踪
2. 记录失败指标
3. 向客户端返回安全的 500 响应
4. 保留关联 ID

:::tip
如果使用 `connection` 生成器,建议为 API 操作指定响应模型以获得更好的代码生成效果。<Link path="guides/connection/react-fastapi#errors">详见此处</Link>。
:::

### 流式传输

:::caution
流式传输仅在 `computeType` 为 `ServerlessApiGatewayRestApi`(默认)时支持,因为 API Gateway HTTP API 不支持响应流式传输。
:::

生成的 FastAPI 在使用 REST API 时开箱即支持流式响应。基础设施配置为使用 [AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) 在 Lambda 内通过 uvicorn 运行您的 FastAPI,并在 API Gateway 中为所有 REST API 操作设置 `ResponseTransferMode.STREAM`,这使得流式传输可以与非流式操作并行工作。

#### 使用 `JsonStreamingResponse`

生成的 `init.py` 导出了 `JsonStreamingResponse` 类,该类提供类型安全的流式传输和正确的 OpenAPI 模式生成。这确保 <Link path="guides/connection/react-fastapi">`connection` 生成器</Link> 可以生成正确类型的流式客户端方法。

```python
from pydantic import BaseModel
from .init import app, JsonStreamingResponse

class Chunk(BaseModel):
    message: str

async def generate_chunks():
    for i in range(100):
        yield Chunk(message=f"This is chunk {i}")

@app.post(
    "/stream",
    response_class=JsonStreamingResponse,
    responses={200: JsonStreamingResponse.openapi_response(Chunk, "Stream of chunks")},
)
async def my_stream() -> JsonStreamingResponse:
    return JsonStreamingResponse(generate_chunks())
```

`JsonStreamingResponse` 类:

1. 将 Pydantic 模型序列化为 [JSON Lines](https://jsonlines.org/) 格式(`application/jsonl`)
2. 提供 `openapi_response` 辅助方法,生成包含 `itemSchema` 的正确 OpenAPI 模式,使 <Link path="guides/connection/react-fastapi#consuming-a-stream">`connection` 生成器</Link> 能够生成类型安全的流式客户端方法

#### 消费

要消费流式响应,可以使用 <Link path="guides/connection/react-fastapi#consuming-a-stream">`connection` 生成器</Link>,该生成器将提供类型安全的方法来迭代流式数据块。

## 部署 FastAPI

FastAPI 生成器根据您选择的 `iacProvider` 创建 CDK 或 Terraform 基础设施即代码。您可以使用此代码部署 FastAPI。

<Infrastructure>
<Fragment slot="cdk">
用于部署 API 的 CDK 构造位于 `common/constructs` 文件夹中。您可以在 CDK 应用程序中使用它:

```ts {6-8}
import { MyApi } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // 将 API 添加到堆栈
    const api = new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });
  }
}
```

此配置设置:

1. 为 FastAPI 应用中的每个操作创建 AWS Lambda 函数
2. 将 API Gateway HTTP/REST API 作为函数触发器
3. IAM 角色和权限
4. CloudWatch 日志组
5. X-Ray 追踪配置
6. CloudWatch 指标命名空间

<Snippet name="api/cors-configuration-cdk-note" />

:::note
如果选择使用 `Cognito` 身份验证,需要向 API 构造提供 `identity` 属性:

```ts {9}
import { MyApi, UserIdentity } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const identity = new UserIdentity(this, 'Identity');

    const api = new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
      identity,
    });
  }
}
```

可以使用 <Link path="/guides/react-website-auth">`ts#react-website-auth` 生成器</Link> 生成 `UserIdentity` 构造
:::
</Fragment>
<Fragment slot="terraform">
用于部署 API 的 Terraform 模块位于 `common/terraform` 文件夹中。您可以在 Terraform 配置中使用它:

```hcl {2}
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  # Lambda 函数的环境变量
  env = {
    ENVIRONMENT = var.environment
    LOG_LEVEL   = "INFO"
  }

  # 额外的 IAM 策略(如有需要)
  additional_iam_policy_statements = [
    # 添加 API 需要的任何额外权限
  ]

  tags = local.common_tags
}
```

此配置设置:

1. 服务所有 FastAPI 路由的 AWS Lambda 函数
2. 将 API Gateway HTTP/REST API 作为函数触发器
3. IAM 角色和权限
4. CloudWatch 日志组
5. X-Ray 追踪配置
6. CORS 配置

<Snippet name="api/cors-configuration-terraform-note" />

:::note
如果选择使用 `Cognito` 身份验证,需要提供 Cognito 配置:

```hcl {4-5}
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  user_pool_id         = local.user_pool_id
  user_pool_client_ids = [local.client_id]

  env = {
    ENVIRONMENT = var.environment
    LOG_LEVEL   = "INFO"
  }

  tags = local.common_tags
}
```

可以使用适当的 Terraform 资源或模块设置 Cognito 用户池和客户端。
:::

Terraform 模块提供多个输出可供使用:

```hcl
# 访问 API 端点
output "api_url" {
  value = module.my_api.stage_invoke_url
}

# 访问 Lambda 函数详细信息
output "lambda_function_name" {
  value = module.my_api.lambda_function_name
}

# 访问用于授予额外权限的 IAM 角色
output "lambda_execution_role_arn" {
  value = module.my_api.lambda_execution_role_arn
}
```

可以通过传递变量来自定义 CORS 设置:

```hcl
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  # 自定义 CORS 配置
  cors_allow_origins = ["https://myapp.com", "https://staging.myapp.com"]
  cors_allow_methods = ["GET", "POST", "PUT", "DELETE"]
  cors_allow_headers = [
    "authorization",
    "content-type",
    "x-custom-header"
  ]

  tags = local.common_tags
}
```

:::caution
如果在运行生成器时选择 `None` 作为 `auth` 选项,可能会看到 Checkov 检查失败,例如:

<Tabs syncKey="http-rest">
<TabItem label="HTTP API">
```
Check: CKV_AWS_309: "Ensure API GatewayV2 routes specify an authorization type"
 FAILED for resource: aws_apigatewayv2_route.proxy_routes["PUT"]
```
</TabItem>
<TabItem label="REST API">
```
Check: CKV_AWS_59: "Ensure there is no open access to back-end resources through API"
 FAILED for resource: aws_api_gateway_method.proxy_method
```
</TabItem>
</Tabs>

如果确定需要 API 公开访问,可以[添加抑制注释](https://www.checkov.io/2.Basics/Suppressing%20and%20Skipping%20Policies.html)。
:::
</Fragment>
</Infrastructure>

### 集成

<Snippet name="api/type-safe-api-integrations" parentHeading="集成" />

#### 代码生成

<Infrastructure>
<Fragment slot="cdk">
由于 FastAPI 的操作在 Python 中定义而 CDK 基础设施在 TypeScript 中实现,我们通过代码生成工具向 CDK 构造提供元数据,以实现类型安全的集成接口。

在公共构造的 `project.json` 中添加了 `generate:<ApiName>-metadata` 目标以促进此代码生成,该目标会生成类似 `packages/common/constructs/src/generated/my-api/metadata.gen.ts` 的文件。由于这是在构建时生成的,因此版本控制中会忽略此文件。

:::note
每当更改 API 时都需要运行构建,以确保 CDK 构造使用的类型是最新的。

<PackageManagerShortCommand commands={["build"]} />
:::

:::tip
如果同时进行 CDK 基础设施和 FastAPI 开发,可以使用 [`nx watch`](https://nx.dev/nx-api/nx/documents/watch) 在每次 API 更改时重新生成这些类型:

<NxCommands
  commands={[
    'watch --projects=<FastAPIProject> -- \\ ',
    'run <InfraProject>:"generate:<ApiName>-metadata"',
  ]}
/>
:::
</Fragment>
<Fragment slot="terraform">
:::note
如果选择 Terraform 作为 `iacProvider`,我们不支持类型安全集成,因此不会配置代码生成目标。
:::
</Fragment>
</Infrastructure>

### 授予访问权限(仅限 IAM)

如果选择使用 `IAM` 身份验证,可以使用 `grantInvokeAccess` 方法授予 API 访问权限:

<Infrastructure>
<Fragment slot="cdk">
```ts
api.grantInvokeAccess(myIdentityPool.authenticatedRole);
```
</Fragment>
<Fragment slot="terraform">
```hcl
# 创建允许调用 API 的 IAM 策略
resource "aws_iam_policy" "api_invoke_policy" {
  name        = "MyApiInvokePolicy"
  description = "允许调用 FastAPI 的策略"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = "execute-api:Invoke"
        Resource = "${module.my_api.api_execution_arn}/*/*"
      }
    ]
  })
}

# 将策略附加到 IAM 角色(例如已验证用户角色)
resource "aws_iam_role_policy_attachment" "api_invoke_access" {
  role       = aws_iam_role.authenticated_user_role.name
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}

# 或按名称附加到现有角色
resource "aws_iam_role_policy_attachment" "api_invoke_access_existing" {
  role       = "MyExistingRole"
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}
```

API 模块的关键输出可用于 IAM 策略:

- `module.my_api.api_execution_arn` - 用于授予 execute-api:Invoke 权限
- `module.my_api.api_arn` - API Gateway ARN
- `module.my_api.lambda_function_arn` - Lambda 函数 ARN
</Fragment>
</Infrastructure>

## 本地开发

生成器配置了本地开发服务器,可通过以下命令运行:

<NxCommands commands={['run my-api:serve']} />

这将启动本地 FastAPI 开发服务器,包含:

- 代码更改时自动重载
- 在 `/docs` 或 `/redoc` 提供交互式 API 文档
- 在 `/openapi.json` 提供 OpenAPI 模式

## 调用 FastAPI

要从 React 网站调用 API,可以使用 <Link path="guides/connection/react-fastapi">`connection` 生成器</Link>。