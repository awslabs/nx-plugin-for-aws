---
title: "Nx 生成器生成器"
description: "生成 Nx 生成器"
---



import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import schema from '../../../../../../packages/nx-plugin/src/ts/nx-generator/schema.json';

为 TypeScript 项目添加一个 [Nx Generator](https://nx.dev/extending-nx/recipes/local-generators)，帮助自动化重复性任务（如创建组件模板或强制特定项目结构）。

## 使用方式

### 生成生成器

可通过两种方式生成生成器：

<RunGenerator generator="ts#nx-generator" />

### 选项参数

<GeneratorParameters schema={schema} />

## 生成器输出

生成器会在指定的 `pluginProject` 中创建以下项目文件：

<FileTree>
  - src/\<name>/
    - schema.json 生成器的输入模式定义
    - schema.d.ts 模式的 TypeScript 类型声明
    - generator.ts 生成器实现存根
    - generator.spec.ts 生成器测试文件
  - generators.json Nx 生成器配置定义
</FileTree>

## 本地生成器

:::tip
建议先使用 `ts#project` 生成器为所有生成器创建专用 TypeScript 项目。例如：

<RunGenerator generator="ts#project" requiredParameters={{ name: 'nx-plugin', directory: 'tools' }} />
:::

运行 `ts#nx-generator` 生成器时选择本地 `nx-plugin` 项目，并指定名称及可选的目录和描述。

### 定义模式

`schema.json` 文件定义生成器接受的选项，遵循 [JSON Schema](https://json-schema.org/) 格式并带有 Nx 扩展。

#### 基础结构

schema.json 文件的基本结构：

```json
{
  "$schema": "https://json-schema.org/schema",
  "$id": "YourGeneratorName",
  "title": "生成器标题",
  "description": "生成器功能描述",
  "type": "object",
  "properties": {
    // 生成器选项定义
  },
  "required": ["必填项1", "必填项2"]
}
```

#### 简单示例

包含基本选项的示例：

```json
{
  "$schema": "https://json-schema.org/schema",
  "$id": "ComponentGenerator",
  "title": "创建组件",
  "description": "新建 React 组件",
  "type": "object",
  "properties": {
    "name": {
      "type": "string",
      "description": "组件名称",
      "x-priority": "important"
    },
    "directory": {
      "type": "string",
      "description": "组件创建目录",
      "default": "src/components"
    },
    "withTests": {
      "type": "boolean",
      "description": "是否生成测试文件",
      "default": true
    }
  },
  "required": ["name"]
}
```

#### 交互式提示（CLI）

通过添加 `x-prompt` 属性自定义 CLI 提示：

```json
"name": {
  "type": "string",
  "description": "组件名称",
  "x-prompt": "请输入组件名称："
}
```

布尔选项可使用是/否提示：

```json
"withTests": {
  "type": "boolean",
  "description": "是否生成测试文件",
  "x-prompt": "是否生成测试文件？"
}
```

#### 下拉选择

对固定选项集合使用 `enum`：

```json
"style": {
  "type": "string",
  "description": "样式方案选择",
  "enum": ["css", "scss", "styled-components", "none"],
  "default": "css"
}
```

#### 项目选择下拉框

常见模式是让用户从现有项目中选择：

```json
"project": {
  "type": "string",
  "description": "目标项目",
  "x-prompt": "请选择目标项目：",
  "x-dropdown": "projects"
}
```

`x-dropdown: "projects"` 属性指示 Nx 用工作区项目填充下拉列表。

#### 位置参数

配置命令行位置参数：

```json
"name": {
  "type": "string",
  "description": "组件名称",
  "x-priority": "important",
  "$default": {
    "$source": "argv",
    "index": 0
  }
}
```

用户可执行 `nx g your-generator my-component` 代替 `nx g your-generator --name=my-component`。

#### 设置优先级

使用 `x-priority` 标记重要选项：

```json
"name": {
  "type": "string",
  "description": "组件名称",
  "x-priority": "important"
}
```

支持 `"important"` 或 `"internal"` 优先级，用于调整 Nx VSCode 扩展中的属性顺序。

#### 默认值

为选项提供默认值：

```json
"directory": {
  "type": "string",
  "description": "组件创建目录",
  "default": "src/components"
}
```

#### 更多信息

详见 [Nx 生成器选项文档](https://nx.dev/extending-nx/recipes/generator-options)。

#### TypeScript 类型声明

生成器会创建 `schema.d.ts` 文件提供类型声明：

```typescript
export interface YourGeneratorSchema {
  name: string;
  directory?: string;
  withTests?: boolean;
}
```

该接口用于生成器实现，提供类型安全与代码补全：

```typescript
import { YourGeneratorSchema } from './schema';

export default async function (tree: Tree, options: YourGeneratorSchema) {
  const { name, directory = 'src/components', withTests = true } = options;
  // ...
}
```

:::caution
修改 `schema.json` 后必须同步更新 `schema.d.ts`：
- 添加/删除属性
- 修改属性类型
- 设置必填/可选（使用 `?` 标记可选属性）

TypeScript 接口需准确反映 JSON 模式定义。
:::

### 实现生成器

生成器骨架创建完成后，可在 `generator.ts` 中编写实现逻辑。

生成器函数通过操作虚拟文件系统 (`Tree`) 进行文件读写来实现变更。

#### 文件读写

```typescript
// 读取文件
const content = tree.read('path/to/file.ts', 'utf-8');

// 写入文件
tree.write('path/to/new-file.ts', 'export const hello = "world";');

// 检查文件存在性
if (tree.exists('path/to/file.ts')) {
  // 执行操作
}
```

#### 模板文件生成

```typescript
import { generateFiles, joinPathFragments } from '@nx/devkit';

generateFiles(
  tree,
  joinPathFragments(__dirname, 'files'), // 模板目录
  'path/to/output', // 输出目录
  {
    name: options.name,
    nameCamelCase: camelCase(options.name),
    nameKebabCase: kebabCase(options.name)
  }
);
```

#### TypeScript AST 操作

推荐使用 [TSQuery](https://github.com/phenomnomnominal/tsquery) 进行 AST 操作：

```typescript
import { tsquery } from '@phenomnomnominal/tsquery';
import * as ts from 'typescript';

// 示例：递增版本号
const sourceFile = tsquery.ast(tree.read('path/to/version.ts', 'utf-8'));
const nodes = tsquery.query(
  sourceFile,
  'VariableDeclaration:has(Identifier[name="VERSION"]) NumericLiteral'
);

if (nodes.length > 0) {
  const numericNode = nodes[0] as ts.NumericLiteral;
  const currentVersion = Number(numericNode.text);
  const newVersion = currentVersion + 1;

  const result = tsquery.replace(
    sourceFile,
    'VariableDeclaration:has(Identifier[name="VERSION"]) NumericLiteral',
    () => ts.factory.createNumericLiteral(newVersion)
  );

  tree.write(
    'path/to/version.ts',
    ts.createPrinter({ newLine: ts.NewLineKind.LineFeed })
      .printNode(ts.EmitHint.Unspecified, result, sourceFile)
  );
}
```

:::tip
可在 [TSQuery Playground](https://tsquery-playground.firebaseapp.com/) 在线测试选择器。
:::

#### 添加依赖

```typescript
import { addDependenciesToPackageJson } from '@nx/devkit';

addDependenciesToPackageJson(
  tree,
  { 'new-dependency': '^1.0.0' },
  { 'new-dev-dependency': '^2.0.0' }
);
```

#### 格式化文件

```typescript
import { formatFiles } from '@nx/devkit';

await formatFiles(tree);
```

#### JSON 文件操作

```typescript
import { readJson, updateJson } from '@nx/devkit';

const packageJson = readJson(tree, 'package.json');

updateJson(tree, 'tsconfig.json', (json) => {
  json.compilerOptions.strict = true;
  return json;
});
```

### 运行生成器

两种运行方式：

<RunGenerator namespace="@my-project/nx-plugin" generator="my-generator" />

:::note
若 VSCode 插件未显示生成器，可刷新 Nx 工作区：

<NxCommands commands={['reset']} />
:::

### 测试生成器

单元测试示例如下：

```typescript
import { createTreeWithEmptyWorkspace } from '@nx/devkit/testing';
import { yourGenerator } from './generator';

describe('your generator', () => {
  let tree;

  beforeEach(() => {
    tree = createTreeWithEmptyWorkspace();
    tree.write('project.json', JSON.stringify({ name: 'test-project' }));
  });

  it('生成预期文件', async () => {
    await yourGenerator(tree, { name: 'test' });
    expect(tree.exists('src/test/file.ts')).toBeTruthy();
    expect(tree.read('src/test/file.ts', 'utf-8')).toMatchSnapshot();
  });

  it('更新现有文件', async () => {
    await yourGenerator(tree, { name: 'test' });
    expect(tree.read('src/existing-file.ts', 'utf-8')).toContain('import { test }');
  });

  it('错误处理', async () => {
    await expect(yourGenerator(tree, { name: 'invalid' }))
      .rejects.toThrow('预期错误信息');
  });
});
```

测试要点：
- 使用 `createTreeWithEmptyWorkspace()` 创建虚拟文件系统
- 预先设置必要文件
- 验证文件生成与更新
- 使用快照测试复杂内容
- 测试错误场景

## 向 @aws/nx-plugin 贡献生成器

使用 `ts#nx-generator` 可在仓库中创建生成器框架：

<FileTree>
  - packages/nx-plugin/src/\<name>/
    - schema.json
    - schema.d.ts
    - generator.ts
    - generator.spec.ts
  - docs/src/content/docs/guides/
    - \<name>.mdx 生成器文档
  - packages/nx-plugin/generators.json 更新包含新生成器
</FileTree>

:::tip
关于贡献 AWS Nx 插件的详细指南，请参阅 <Link path="get_started/tutorials/contribute-generator">此教程</Link>。
:::