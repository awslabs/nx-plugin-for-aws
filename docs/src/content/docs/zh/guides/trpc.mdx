---
title: "tRPC"
description: "tRPC 的参考文档"
---



import { FileTree, Tabs, TabItem } from '@astrojs/starlight/components';
import AnchorHeading from '@astrojs/starlight/components/AnchorHeading.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';

[tRPC](https://trpc.io/) 是一个用于在 TypeScript 中构建端到端类型安全 API 的框架。使用 tRPC 时，API 操作输入输出的变更会立即反映在客户端代码中，并直接在 IDE 中可见，无需重新构建项目。

tRPC API 生成器会创建一个新的 tRPC API，并配置 AWS CDK 或 Terraform 基础设施。生成的后端使用 AWS Lambda 进行无服务器部署，通过 AWS API Gateway API 暴露，并包含使用 [Zod](https://zod.dev/) 的 schema 验证。它配置了 [AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/typescript/latest/) 用于可观测性，包括日志记录、AWS X-Ray 追踪和 Cloudwatch 指标。

## 使用方式

### 生成 tRPC API

有两种方式生成新的 tRPC API：

<RunGenerator generator="ts#trpc-api" />

### 选项配置

<GeneratorParameters generator="ts#trpc-api" />

<Snippet name="api/api-choice-note" />

## 生成器输出

生成器会在 `<directory>/<api-name>` 目录下创建以下项目结构：

<FileTree>
  - src
    - init.ts 后端 tRPC 初始化
    - router.ts tRPC 路由定义（Lambda 处理程序 API 入口）
    - schema 使用 Zod 的 schema 定义
      - echo.ts "echo" 操作的输入输出示例定义
    - procedures API 暴露的操作
      - echo.ts 示例操作
    - middleware
      - error.ts 错误处理中间件
      - logger.ts 配置 AWS Powertools Lambda 日志的中间件
      - tracer.ts 配置 AWS Powertools Lambda 追踪的中间件
      - metrics.ts 配置 AWS Powertools Lambda 指标的中间件
    - local-server.ts 本地开发服务器使用的独立适配器入口
    - client
      - index.ts 机器间 API 调用的类型安全客户端
  - tsconfig.json TypeScript 配置
  - project.json 项目配置和构建目标
</FileTree>

生成器还会在 `packages/common` 目录中创建用于部署 API 的 CDK 或 Terraform 基础设施即代码。

## 实现 tRPC API

从高层次看，tRPC API 由将请求分派到特定操作的路由器组成。每个操作都有使用 Zod schema 定义的输入和输出。

### Schema

`src/schema` 目录包含客户端和服务端共享的类型定义。这些类型使用 [Zod](https://zod.dev/)（一个 TypeScript 优先的 schema 声明和验证库）定义。

示例 schema 如下：

```ts
import { z } from 'zod';

// Schema 定义
export const UserSchema = z.object({
  name: z.string(),
  height: z.number(),
  dateOfBirth: z.string().datetime(),
});

// 对应的 TypeScript 类型
export type User = z.TypeOf<typeof UserSchema>;
```

根据上述 schema，`User` 类型等效于以下 TypeScript：

```ts
interface User {
  name: string;
  height: number;
  dateOfBirth: string;
}
```

Schema 在服务端和客户端代码间共享，为 API 使用的结构变更提供单一更新点。tRPC API 在运行时自动验证 schema，省去了手动编写后端验证逻辑的麻烦。

Zod 提供强大的工具来组合或派生 schema，如 `.merge`、`.pick`、`.omit` 等。更多信息请参考 [Zod 文档](https://zod.dev/?id=basic-usage)。

### 路由与操作

API 入口位于 `src/router.ts`，包含将请求路由到具体操作的 Lambda 处理程序。每个操作定义输入、输出和实现。

生成的路由示例包含名为 `echo` 的单个操作：

```ts
import { echo } from './procedures/echo.js';

export const appRouter = router({
  echo,
});
```

示例 `echo` 操作在 `src/procedures/echo.ts` 中生成：

```ts
export const echo = publicProcedure
  .input(EchoInputSchema)
  .output(EchoOutputSchema)
  .query((opts) => ({ result: opts.input.message }));
```

代码解析：
- `publicProcedure` 定义 API 的公共方法，包含 `src/middleware` 配置的中间件（含 AWS Lambda Powertools 的日志、追踪和指标集成）
- `input` 接受定义操作输入预期的 Zod schema，请求会自动验证
- `output` 接受定义输出预期的 Zod schema，实现返回不符合 schema 时会报类型错误
- `query` 接收定义操作实现的函数，通过 `opts` 获取输入和中间件设置的上下文（`opts.ctx`）

使用 `query` 表示非变更操作，用于数据检索。变更操作应使用 `mutation` 方法。

新增操作时，需在 `src/router.ts` 的路由器中注册。

## 自定义 tRPC API

### 错误处理

在实现中，可通过抛出 `TRPCError` 返回错误响应。例如：

```ts
throw new TRPCError({
  code: 'NOT_FOUND',
  message: '请求的资源不存在',
});
```

### 操作组织

随着 API 扩展，可通过嵌套路由器分组相关操作：

```ts
import { getUser } from './procedures/users/get.js';
import { listUsers } from './procedures/users/list.js';

const appRouter = router({
   users: router({
      get: getUser,
      list: listUsers,
   }),
   ...
})
```

客户端调用分组操作示例：

```ts
client.users.list.query();
```

### 日志记录

AWS Lambda Powertools 日志器在 `src/middleware/logger.ts` 配置，可通过 `opts.ctx.logger` 访问。例如：

```ts {5}
export const echo = publicProcedure
   .input(...)
   .output(...)
   .query(async (opts) => {
      opts.ctx.logger.info('操作调用输入', opts.input);
      return ...;
   });
```

更多信息参考 [AWS Lambda Powertools 日志文档](https://docs.powertools.aws.dev/lambda/typescript/latest/core/logger/)。

### 记录指标

AWS Lambda Powertools 指标在 `src/middleware/metrics.ts` 配置，可通过 `opts.ctx.metrics` 访问。例如：

```ts {5}
export const echo = publicProcedure
   .input(...)
   .output(...)
   .query(async (opts) => {
      opts.ctx.metrics.addMetric('调用次数', 'Count', 1);
      return ...;
   });
```

更多信息参考 [AWS Lambda Powertools 指标文档](https://docs.powertools.aws.dev/lambda/typescript/latest/core/metrics/)。

### 微调 X-Ray 追踪

AWS Lambda Powertools 追踪器在 `src/middleware/tracer.ts` 配置，可通过 `opts.ctx.tracer` 访问。例如：

```ts {5-7}
export const echo = publicProcedure
   .input(...)
   .output(...)
   .query(async (opts) => {
      const subSegment = opts.ctx.tracer.getSegment()!.addNewSubsegment('我的算法');
      // ... 需要捕获的算法逻辑
      subSegment.close();
      return ...;
   });
```

更多信息参考 [AWS Lambda Powertools 追踪文档](https://docs.powertools.aws.dev/lambda/typescript/latest/core/tracer/)。

### 实现自定义中间件

通过实现中间件可向操作上下文添加额外值。例如在 `src/middleware/identity.ts` 中实现提取调用用户信息的中间件：

:::warning
此示例假设 `auth` 设置为 `IAM`。对于 Cognito 认证，身份中间件更直接，可直接从 `event` 提取声明。
:::

定义上下文扩展：

```ts
export interface IIdentityContext {
  identity?: {
    sub: string;
    username: string;
  };
}
```

实现中间件：

<Tabs>
<TabItem label="REST">
```ts
// REST API 实现
```
</TabItem>
<TabItem label="HTTP">
```ts
// HTTP API 实现
```
</TabItem>
</Tabs>

## 部署 tRPC API

根据选择的 `iacProvider`，生成器会创建 CDK 或 Terraform 基础设施代码。

<Infrastructure>
<Fragment slot="cdk">
CDK 构造位于 `common/constructs` 文件夹。使用示例：

```ts {6-8}
// CDK 应用示例
```

:::note
若选择 Cognito 认证，需提供 `identity` 属性：

```ts {9}
// Cognito 配置示例
```
:::
</Fragment>
<Fragment slot="terraform">
Terraform 模块位于 `common/terraform` 文件夹。使用示例：

```hcl {6-8}
// Terraform 配置示例
```

:::note
若选择 Cognito 认证，需提供配置：

```hcl {4-5}
// Cognito Terraform 配置
```
:::
</Fragment>
</Infrastructure>

### 集成

<Snippet name="api/type-safe-api-integrations" parentHeading="集成" />

:::tip
选择 CDK 时，操作变更会立即反映在 CDK 构造中，无需重新构建。
:::

### 授权访问（仅限 IAM）

若使用 IAM 认证，授权访问方式：

<Infrastructure>
<Fragment slot="cdk">
```ts
api.grantInvokeAccess(myIdentityPool.authenticatedRole);
```
</Fragment>
<Fragment slot="terraform">
```hcl
# IAM 策略配置示例
```
</Fragment>
</Infrastructure>

## 本地 tRPC 服务器

使用 `serve` 目标运行本地服务器：

<NxCommands commands={['run @my-scope/my-api:serve']} />

入口文件为 `src/local-server.ts`，支持热重载。

## 调用 tRPC API

创建类型安全客户端调用 API。后端调用示例：

```ts
import { createMyApiClient } from ':my-scope/my-api';

const client = createMyApiClient({ url: 'https://my-api-url.example.com/' });

await client.echo.query({ message: 'Hello world!' });
```

React 网站调用可参考 <Link path="guides/api-connection/react-trpc">API 连接</Link> 生成器。

## 更多信息

更多 tRPC 信息请参考 [tRPC 文档](https://trpc.io/docs)。