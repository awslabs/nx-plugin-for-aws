---
title: "TypeScript 项目"
description: "TypeScript 项目的参考文档"
---

import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import InstallCommand from '@components/install-command.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import Link from '@components/link.astro';

TypeScript项目生成器可用于创建配置了最佳实践的现代化[TypeScript](https://www.typescriptlang.org/)库或应用，包括[ECMAScript Modules (ESM)](https://www.typescriptlang.org/docs/handbook/modules/reference.html)、TypeScript[项目引用](https://www.typescriptlang.org/docs/handbook/project-references.html)、用于运行测试的[Vitest](https://vitest.dev/)和用于静态分析的[ESLint](https://eslint.org/)。

## 用法

### 生成TypeScript项目

您可以通过两种方式生成新的TypeScript项目：

<RunGenerator generator="ts#project" />

### 选项

<GeneratorParameters generator="ts#project" />

## 生成器输出

生成器将在`<directory>/<name>`目录下创建以下项目结构：

<FileTree>

  - src TypeScript源代码
    - index.ts
  - project.json 项目配置和构建目标
  - tsconfig.json 项目基础TypeScript配置（继承工作区根目录的tsconfig.base.json）
  - tsconfig.lib.json 库的TypeScript配置（运行时或打包源码）
  - tsconfig.spec.json 测试的TypeScript配置
  - vite.config.ts Vitest配置
  - eslint.config.mjs ESLint配置

</FileTree>

:::tip
注意，此项目不会创建`package.json`文件！您可以在[下方](#dependencies)了解原因。
:::

您还会发现工作区根目录的以下文件发生了变化：

<FileTree>

  - nx.json Nx配置更新以配置@nx/js/typescript插件
  - tsconfig.base.json 设置TypeScript别名以便工作区其他项目导入
  - tsconfig.json 添加了项目的TypeScript项目引用

</FileTree>

## 编写TypeScript源码

在`src`目录中添加TypeScript代码。

### ESM导入语法

由于TypeScript项目是ES模块，请确保使用正确的ESM语法编写导入语句，显式指定文件扩展名：

```ts title="index.ts" ".js"
import { sayHello } from './hello.js';
```

:::note
虽然我们使用TypeScript且`sayHello`定义在`hello.ts`中，但导入时使用`.js`扩展名。更多信息请阅读[此处](https://www.typescriptlang.org/docs/handbook/modules/reference.html)。
:::

### 为其他TypeScript项目导出

项目的入口点是`src/index.ts`。您可以在此处添加需要被其他项目导入的导出：

```ts title="src/index.ts"
export { sayHello } from './hello.js';
export * from './algorithms/index.js';
```

### 在其他项目中导入库代码

工作区`tsconfig.base.json`中配置了[TypeScript别名](https://www.typescriptlang.org/docs/handbook/modules/reference.html#paths)，允许从其他TypeScript项目引用您的项目：

```ts title="packages/my-other-project/src/index.ts"
import { sayHello } from ':my-scope/my-library';
```

:::note
TypeScript项目的别名以`:`开头而非传统的`@`，这可以避免工作区本地包与[NPM](https://www.npmjs.com/)远程包之间的命名冲突。
:::

首次在工作区中导入新项目时，IDE可能会显示类似以下错误：

<details>
<summary>导入错误</summary>

```bash wrap
File '/path/to/my/workspace/packages/my-library/src/index.ts' is not under 'rootDir' '/path/to/my/workspace/packages/my-consumer'. 'rootDir' is expected to contain all source files.
  File is ECMAScript module because '/path/to/my/workspace/package.json' has field "type" with value "module" ts(6059)
File '/path/to/my/workspace/packages/my-library/src/index.ts' is not listed within the file list of project '/path/to/my/workspace/packages/my-consumer/tsconfig.lib.json'. Projects must list all files or use an 'include' pattern.
  File is ECMAScript module because '/path/to/my/workspace/package.json' has field "type" with value "module" ts(6307)
```

</details>

这是因为尚未设置[项目引用](https://www.typescriptlang.org/docs/handbook/project-references.html)。

TypeScript项目默认配置了Nx TypeScript同步生成器，您无需手动配置项目引用。只需运行以下命令，Nx将自动添加所需配置：

<NxCommands commands={['sync']} />

此后IDE错误应消失，即可正常使用库。

:::tip
构建项目时也会提示类似信息：

```bash wrap
[@nx/js:typescript-sync]: Some TypeScript configuration files are missing project references to the projects they depend on or contain outdated project references.

This will result in an error in CI.

? Would you like to sync the identified changes to get your workspace up to date?
Yes, sync the changes and run the tasks
No, run the tasks without syncing the changes
```

选择`Yes`允许Nx更新项目引用。
:::

### 保持路径别名同步

如果您在项目的`tsconfig.json`中添加自定义的`compilerOptions.paths`条目，TypeScript将停止继承`tsconfig.base.json`中定义的工作区别名。隐藏的`ts#sync`生成器会在`compile`目标之前运行（在`nx.json`中配置），将缺失的基础别名复制到已声明`paths`的`tsconfig.json`、`tsconfig.lib.json`和`tsconfig.app.json`文件中。要禁用此功能，请从`nx.json`的`targetDefaults.compile.syncGenerators`中移除`@aws/nx-plugin:ts#sync`。

### 依赖管理

您会注意到TypeScript项目没有`package.json`文件，这对习惯传统TypeScript单体仓库的用户可能有些意外。

要为monorepo中的TypeScript包添加依赖，只需将依赖添加到工作区根目录的`package.json`。可通过包管理器的命令行添加：

<InstallCommand pkg="some-npm-package" />

此后工作区中所有TypeScript项目均可使用该依赖。

#### 运行时代码

当将TypeScript项目作为运行时代码（例如AWS Lambda函数处理程序）时，建议使用[Rolldown](https://rolldown.rs/)等工具进行打包，因其支持[tree-shaking](https://rolldown.rs/guide/in-depth/why-bundlers)确保仅包含实际使用的依赖。

可通过在`project.json`中添加如下目标实现：

```json
{
  ...
  "targets": {
    ...
    "bundle": {
      "cache": true,
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/packages/my-library/bundle"],
      "options": {
        "command": "rolldown -c rolldown.config.ts"
      }
    },
  },
}
```

并添加`rolldown.config.ts`文件：

```ts
// rolldown.config.ts
import { defineConfig } from 'rolldown';

export default defineConfig([
  {
    input: 'src/index.ts',
    output: {
      file: '../../dist/packages/my-library/bundle/index.js',
      format: 'cjs',
      inlineDynamicImports: true,
    },
  },
]);
```

:::note
上述配置选择`src/index.ts`作为打包入口点，意味着该文件导出的代码及其依赖将被包含在包中。
:::

:::tip
如需构建AWS Lambda函数，可查看<Link path="/guides/ts-lambda-function">`ts#lambda-function`</Link>生成器，该生成器已配置打包并生成基础设施，添加可观测性和类型安全。
:::

#### 发布到NPM

如需将TypeScript项目发布到NPM，必须创建`package.json`文件。

该文件需声明项目依赖。由于构建时项目会解析工作区根目录`package.json`中的依赖，建议配置[Nx Dependency Checks ESLint插件](https://nx.dev/nx-api/eslint-plugin/documents/dependency-checks)来确保发布的`package.json`包含所有使用依赖。

### 构建

项目配置了`build`目标（定义于`project.json`），可通过以下命令运行：

<NxCommands commands={['run <project-name>:build']} />

其中`<project-name>`是项目的全限定名称。

`build`目标将编译、lint和测试项目。

构建输出位于工作区根目录`dist`文件夹中，具体路径为`dist/packages/<my-library>/tsc`。

要构建工作区中所有项目，请运行：

<NxCommands commands={['run-many --target build']} />

或使用简写命令：

<PackageManagerShortCommand commands={["build"]} />

## 测试

项目配置了[Vitest](https://vitest.dev/)进行测试。

### 编写测试

测试应写在`.spec.ts`或`.test.ts`文件中，与源码共置于`src`目录。

例如：

<FileTree>
  - src
    - hello.ts 库源码
    - hello.spec.ts 测试文件
</FileTree>

Vitest提供类似Jest的测试语法，支持`describe`、`it`、`test`和`expect`等工具。

```ts title="hello.spec.ts"
import { sayHello } from './hello.js';

describe('sayHello', () => {

  it('should greet the caller', () => {
    expect(sayHello('Darth Vader')).toBe('Hello, Darth Vader!');
  });

});

```

更多测试编写方法和模拟依赖等特性，请参考[Vitest文档](https://vitest.dev/guide/#writing-tests)

### 运行测试

测试将作为`build`目标的一部分运行，也可单独运行`test`目标：

<NxCommands commands={['run <project-name>:test']} />

可使用`-t`标志运行单个测试或测试套件：

<NxCommands commands={["run <project-name>:test -t 'sayHello'"]} />

:::tip
VSCode用户建议安装[真正可用的Vitest Runner扩展](https://marketplace.visualstudio.com/items?itemName=rluvaton.vscode-vitest)，支持直接从IDE运行、监视或调试测试。
:::

## 代码检查

TypeScript项目使用[ESLint](https://eslint.org/)进行代码检查，[Prettier](https://prettier.io/)进行格式化。

建议在工作区根目录`eslint.config.mjs`中配置ESLint，修改将应用于工作区所有TypeScript项目以确保一致性。

同理，可在根目录`.prettierrc`中配置Prettier。

### 运行检查器

运行`lint`目标进行检查：

<NxCommands commands={["run <project-name>:lint"]} />

### 修复问题

大多数检查或格式化问题可自动修复。通过`--configuration=fix`参数让ESLint自动修复：

<NxCommands commands={["run <project-name>:lint --configuration=fix"]} />

要修复工作区所有包的lint问题，可运行：

<NxCommands commands={["run-many --target lint --all --configuration=fix"]} />

:::tip
这有一个从工作区根目录运行的简写命令：

<PackageManagerShortCommand commands={["lint"]} />
:::

### 跳过代码检查问题

为避免代码检查问题在开发过程中拖慢速度（特别是当项目中存在无法自动修复的问题时），可以使用`skip-lint`配置运行构建：

<NxCommands commands={["run-many --target build --configuration=skip-lint"]} />

这仍会在构建过程中运行ESLint，但lint目标将始终被视为成功。

:::tip
这有一个从工作区根目录运行的简写命令：

<PackageManagerShortCommand commands={["build:skip-lint"]} />
:::