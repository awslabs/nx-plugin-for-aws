---
title: "React 网站"
description: "React 网站的参考文档"
---

import { FileTree, Steps } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';

该生成器会创建一个默认配置了 [Cloudscape](http://cloudscape.design/) 的新 [React](https://react.dev/) 网站，并生成 AWS CDK 或 Terraform 基础设施代码，用于将您的网站作为静态站点部署到云端，托管在 [S3](https://aws.amazon.com/s3/) 中，通过 [CloudFront](https://aws.amazon.com/cloudfront/) 分发，并通过 [WAF](https://aws.amazon.com/waf/) 提供保护。

生成的应用程序使用 [Vite](https://vite.dev/) 作为构建工具和打包器，并采用 [TanStack Router](https://tanstack.com/router/v1) 实现类型安全的路由。

:::note
此生成器默认配置了 [Cloudscape](http://cloudscape.design/)，但如果您希望使用不同的组件库或设计系统，可以选择 `None` 作为 `uxProvider`。
:::

## 使用方式

### 生成 React 网站

您可以通过两种方式生成新的 React 网站：

<RunGenerator generator="ts#react-website" />

### 选项配置

<GeneratorParameters generator="ts#react-website" />

## 生成器输出

生成器将在 `<directory>/<name>` 目录下创建以下项目结构：

<FileTree>
  - index.html HTML 入口文件
  - public 静态资源目录
  - src
    - main.tsx React 应用入口文件
    - config.ts 应用配置（如 logo）
    - components
      - AppLayout 包含整体布局和导航栏的组件
    - hooks
      - useAppLayout.tsx 用于从嵌套组件调整 Cloudscape AppLayout 的钩子（如果 UX Provider 设置为 Cloudscape）
    - routes
      - index.tsx 使用 TanStack Router 的示例路由（页面）
    - styles.css 全局样式
  - vite.config.ts Vite 和 Vitest 配置
  - tsconfig.json 基础 TypeScript 配置（源码和测试）
  - tsconfig.app.json 源码 TypeScript 配置
  - tsconfig.spec.json 测试 TypeScript 配置
</FileTree>

:::note
如果您选择不使用 [TanStack Router](https://tanstack.com/router/v1)，将会生成一个简单的 `src/app.tsx` 文件作为应用入口点，而不是 `routes` 目录。
:::

### 基础设施

<Snippet name="shared-constructs" />

生成器会根据您选择的 `iacProvider` 创建基础设施即代码：

<Infrastructure>
<Fragment slot="cdk">
<FileTree>
  - packages/common/constructs/src
    - app
      - static-websites
        - \<name>.ts 网站专属基础设施
    - core
      - static-website.ts 通用 StaticWebsite 构造
</FileTree>
</Fragment>
<Fragment slot="terraform">
<FileTree>
  - packages/common/terraform/src
    - app
      - static-websites
        - \<name>
          - \<name>.tf 网站专属模块
    - core
      - static-website
        - static-website.tf 通用静态网站模块
</FileTree>
</Fragment>
</Infrastructure>

## 开发 React 网站

[React 文档](https://react.dev/learn) 是学习 React 基础的良好起点。[Cloudscape 文档](https://cloudscape.design/components/) 则详细介绍了可用组件及其使用方法。

### 路由管理

#### 创建路由/页面

默认配置的 Cloudscape 网站已集成 [TanStack Router](https://tanstack.com/router/v1)，添加新路由非常简单：

<Steps>
  1. [启动本地开发服务器](#local-development-server)
  2. 在 `src/routes` 中创建新文件 `<page-name>.tsx`，文件路径对应页面路径
  3. 系统会自动生成 `Route` 和 `RouteComponent`，您可在此开始构建页面
</Steps>

#### 页面间导航

使用 `Link` 组件或 `useNavigate` 钩子实现页面跳转：

```tsx {1, 4, 8-9, 14}
import { Link, useNavigate } from '@tanstack/react-router';

export const MyComponent = () => {
  const navigate = useNavigate();

  const submit = async () => {
    const id = await ...
    // 使用 `navigate` 实现异步操作后跳转
    navigate({ to: '/products/$id', { params: { id }} });
  };

  return (
    <>
      <Link to="/products">取消</Link>
      <Button onClick={submit}>提交</Button>
    </>
  )
};
```

更多细节请参考 [TanStack Router 文档](https://tanstack.com/router/latest/docs/framework/react/overview)。

## 运行时配置

基础设施配置通过运行时配置提供给网站，这使得网站可以访问部署时才能确定的参数（如 API 地址）。

### 基础设施配置

<Infrastructure>
<Fragment slot="cdk">
使用 `RuntimeConfig` CDK 构造管理配置。通过 `@aws/nx-plugin` 生成器（如 <Link path="guides/trpc">`ts#trpc-api`</Link> 和 <Link path="guides/fastapi">`py#fast-api`</Link>）创建的 CDK 构造会自动向 `RuntimeConfig` 添加值。

网站 CDK 构造会将运行时配置部署为 S3 根目录下的 `runtime-config.json` 文件。

```ts title="packages/infra/src/stacks/application-stack.ts" {9-12,14-15}
import { Stack } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyWebsite } from ':my-scope/common-constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string) {
    super(scope, id);

    // 自动向 RuntimeConfig 添加值
    new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });

    // 自动部署 runtime-config.json
    new MyWebsite(this, 'MyWebsite');
  }
}
```

:::caution
必须确保在声明网站构造之前声明所有会向 `RuntimeConfig` 添加值的构造，否则这些值将不会出现在 `runtime-config.json` 中。
:::
</Fragment>
<Fragment slot="terraform">
Terraform 通过 runtime-config 模块管理配置。通过 `@aws/nx-plugin` 生成器（如 <Link path="guides/trpc">`ts#trpc-api`</Link> 和 <Link path="guides/fastapi">`py#fast-api`</Link>）创建的 Terraform 模块会自动更新运行时配置。

网站 Terraform 模块会将运行时配置部署为 S3 根目录下的 `runtime-config.json` 文件。

```hcl title="packages/infra/src/main.tf" {14-15}
# 自动更新运行时配置
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"
}

# 自动部署 runtime-config.json
module "my_website" {
  source = "../../common/terraform/src/app/static-websites/my-website"

  providers = {
    aws.us_east_1 = aws.us_east_1
  }

  # 确保 API 模块优先部署以更新配置
  depends_on = [module.my_api]
}
```

:::caution
必须确保在声明网站模块之前声明所有会更新运行时配置的模块，并正确配置 `depends_on` 以保证执行顺序，否则这些值将不会出现在 `runtime-config.json` 中。
:::
</Fragment>
</Infrastructure>

### 网站代码

在网站代码中，使用 `useRuntimeConfig` 钩子获取运行时配置值：

```tsx {1,4}
import { useRuntimeConfig } from '../hooks/useRuntimeConfig';

const MyComponent = () => {
  const runtimeConfig = useRuntimeConfig();

  // 在此访问运行时配置值
  const apiUrl = runtimeConfig.apis.MyApi;
};
```

### 本地运行时配置

运行[本地开发服务器](#local-development-server)时，需要在 `public` 目录下放置 `runtime-config.json` 文件以使网站能获取后端 URL 等配置。

网站项目已配置 `load:runtime-config` 目标，用于从已部署环境拉取配置文件：

<NxCommands commands={['run <my-website>:"load:runtime-config"']} />

:::note
<Infrastructure>
<Fragment slot="cdk">
如果修改了基础设施项目 `src/main.ts` 中的环境名前缀，需要同步更新网站项目 `project.json` 中的 `load:runtime-config` 目标配置。

注意该目标假设单个环境部署到当前 AWS 凭证对应的账户区域，若同一账户区域部署多环境需调整命令。
</Fragment>
<Fragment slot="terraform">
对于 Terraform 项目，`load:runtime-config` 目标会复制最近一次本地 `terraform apply` 生成的 `runtime-config.json` 文件。
</Fragment>
</Infrastructure>
:::

## 本地开发服务器

可通过 `serve` 或 `serve-local` 目标启动本地开发服务器。

### Serve 目标

`serve` 目标启动网站本地服务器，需要已部署相关基础设施并[加载本地运行时配置](#local-runtime-config)。

运行命令：

<NxCommands commands={['run <my-website>:serve']} />

此模式适用于针对已部署 API 进行网站修改的场景。

### Serve Local 目标

`serve-local` 目标启动本地服务器（设置 [Vite `MODE`](https://vite.dev/guide/env-and-mode) 为 `serve-local`），并同时启动通过 <Link path="/guides/connection">连接生成器</Link> 关联的本地 API 服务器。

在此模式下，`runtime-config.json` 会自动指向本地 API 地址。

运行命令：

<NxCommands commands={['run <my-website>:serve-local']} />

此模式适用于需要同时开发网站和 API 的快速迭代场景。

:::warning
在此模式下若未配置 `runtime-config.json`，如果配置了 Cognito 认证（通过 <Link path="/guides/react-website-auth">`ts#react-website#auth` 生成器</Link>），登录流程将被跳过，请求不会携带认证头。

如需启用 `serve-local` 的登录认证功能，请部署基础设施后加载运行时配置。
:::

:::tip
使用 `serve-local` 运行时，您可以指定 API 所需的任何环境变量以指向其他已部署的 AWS 资源，例如：

<NxCommands env={{DYNAMODB_TABLE_NAME: 'xxxxx'}} commands={['run <my-website>:serve-local']} />

注意，您的本地 API 服务器将使用本地配置的 AWS 凭证运行。
:::

## 构建部署

使用 `build` 目标进行生产构建，该目标会使用 Vite 在根目录 `dist/packages/<my-website>/bundle` 下创建生产包，并执行类型检查、代码编译和代码检查。

<NxCommands commands={['run <my-website>:build']} />

## 测试方案

测试方案与标准 TypeScript 项目类似，详见 <Link path="guides/typescript-project#testing">TypeScript 项目指南</Link>。

针对 React 的测试，已预装 React Testing Library 供您使用。具体用法参考 [React Testing Library 文档](https://testing-library.com/docs/react-testing-library/example-intro)。

运行测试：

<NxCommands commands={['run <my-website>:test']} />

## 网站部署

根据选择的 `iacProvider`，React 网站生成器会创建 CDK 或 Terraform 基础设施代码用于部署。

<Infrastructure>
<Fragment slot="cdk">
推荐使用 <Link path="guides/typescript-infrastructure">`ts#infra` 生成器</Link> 创建 CDK 应用。

使用 `packages/common/constructs` 中生成的 CDK 构造进行部署：

```ts title="packages/infra/src/stacks/application-stack.ts" {3, 9}
import { Stack } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyWebsite } from ':my-scope/common-constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string) {
    super(scope, id);

    new MyWebsite(this, 'MyWebsite');
  }
}
```

该配置包含：

1. 托管静态文件的 S3 存储桶
2. 全球分发的 CloudFront
3. 安全防护的 WAF
4. 安全的 S3 访问控制
5. 自动部署网站文件及运行时配置
</Fragment>
<Fragment slot="terraform">
推荐使用 <Link path="guides/terraform-infrastructure">`terraform#project` 生成器</Link> 创建 Terraform 项目。

使用 `packages/common/terraform` 中生成的 Terraform 模块进行部署：

```hcl title="packages/infra/src/main.tf" {3}
# 部署网站
module "my_website" {
  source = "../../common/terraform/src/app/static-websites/my-website"

  providers = {
    aws.us_east_1 = aws.us_east_1
  }
}
```

该配置包含：

1. 托管静态文件的 S3 存储桶
2. 全球分发的 CloudFront
3. 部署于 us-east-1 的 WAF
4. 安全的 S3 访问控制
5. 自动部署网站文件及运行时配置

:::note
CloudFront 和 WAF 资源必须部署在 us-east-1 区域，需要配置 `aws.us_east_1` provider。请确保您的 Terraform 配置包含此 provider：

```hcl title="packages/infra/src/providers.tf"
provider "aws" {
  alias  = "us_east_1"
  region = "us-east-1"
}
```
:::
</Fragment>
</Infrastructure>