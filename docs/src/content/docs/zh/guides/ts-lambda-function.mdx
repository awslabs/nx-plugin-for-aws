---
title: "TypeScript Lambda 函数"
description: "生成一个 TypeScript lambda 函数"
---



import { FileTree } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';

TypeScript Lambda 函数生成器支持在现有 TypeScript 项目中添加 Lambda 函数。

该生成器会创建一个新的 TypeScript Lambda 处理程序，并配置 AWS CDK 基础设施。生成的处理器使用 [AWS Lambda Powertools for TypeScript](https://docs.powertools.aws.dev/lambda/typescript/latest/) 实现可观测性功能，包括日志记录、AWS X-Ray 追踪和 CloudWatch 指标，同时通过 [AWS Lambda Powertools 的 Parser 工具](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/) 提供可选的事件类型安全校验。

## 使用方式

### 生成 TypeScript Lambda 函数

您可以通过两种方式生成 Lambda 函数：

<RunGenerator generator="ts#lambda-function" />

### 配置选项

<GeneratorParameters generator="ts#lambda-function" />

## 生成器输出

生成器将在项目中添加以下文件：

<FileTree>

- \<project-name>
  - src/
    - \<lambda-function>.ts 函数实现

</FileTree>

生成器还会在 `packages/common/constructs/src/app/lambda-functions` 目录下创建用于部署函数的 CDK 构造。

若提供 `functionPath` 选项，生成器会将处理程序添加到项目源码目录的指定路径下：

<FileTree>

- \<project-name>
  - src/
    - \<custom-path>/
      - \<function-name>.ts 函数实现

</FileTree>

## 实现函数

主函数实现位于 `<function-name>.ts` 文件中。示例如下：

```typescript
import { parser } from '@aws-lambda-powertools/parser/middleware';
import { EventBridgeSchema } from '@aws-lambda-powertools/parser/schemas';
import middy from '@middy/core';
import { Tracer } from '@aws-lambda-powertools/tracer';
import { captureLambdaHandler } from '@aws-lambda-powertools/tracer/middleware';
import { injectLambdaContext } from '@aws-lambda-powertools/logger/middleware';
import { Logger } from '@aws-lambda-powertools/logger';
import { Metrics, MetricUnit } from '@aws-lambda-powertools/metrics';
import { logMetrics } from '@aws-lambda-powertools/metrics/middleware';

process.env.POWERTOOLS_METRICS_NAMESPACE = "MyFunction";
process.env.POWERTOOLS_SERVICE_NAME = "MyFunction";

const tracer = new Tracer();
const logger = new Logger();
const metrics = new Metrics();

export const handler = middy()
  .use(captureLambdaHandler(tracer))
  .use(injectLambdaContext(logger))
  .use(logMetrics(metrics))
  .use(parser({ schema: EventBridgeSchema }))
  .handler(async (event) => {
    logger.info("Received event", event);

    metrics.addMetric("InvocationCount", MetricUnit.Count, 1);

    try {
        // TODO: 实现业务逻辑
        metrics.addMetric("SuccessCount", MetricUnit.Count, 1);
        // TODO: 按需实现成功响应
    } catch (e) {
        logger.error("Error processing event", e as Error);
        metrics.addMetric("ErrorCount", MetricUnit.Count, 1);
        // TODO: 按需实现错误响应
    }
  });
```

生成器自动配置了以下功能：

1. **Middy 中间件栈** 增强 Lambda 功能
2. **AWS Lambda Powertools 集成** 实现可观测性
3. **CloudWatch 指标收集**
4. **类型安全** 通过解析器中间件
5. **esbuild 打包** 优化部署包

### 使用 AWS Lambda Powertools 实现可观测性

#### 日志记录

生成器通过 Middy 中间件自动配置结构化日志记录：

```typescript
export const handler = middy()
  .use(injectLambdaContext(logger))
  .handler(async (event) => {
    logger.info("Received event", event);
    logger.error("Error processing event", error);
  });
```

#### 追踪

通过 `captureLambdaHandler` 中间件自动配置 AWS X-Ray 追踪，可添加自定义子段：

```typescript
export const handler = middy()
  .use(captureLambdaHandler(tracer))
  .handler(async (event) => {
    // 创建新子段
    const subsegment = tracer.getSegment()?.addNewSubsegment('custom-operation');
    try {
      // 业务逻辑
    } catch (error) {
      subsegment?.addError(error as Error);
      throw error;
    } finally {
      subsegment?.close();
    }
  });
```

#### 指标

通过 `logMetrics` 中间件自动收集请求指标，可添加自定义指标：

```typescript
export const handler = middy()
  .use(logMetrics(metrics))
  .handler(async (event) => {
    metrics.addMetric("CustomMetric", MetricUnit.Count, 1);
    metrics.addMetric("ProcessingTime", MetricUnit.Milliseconds, processingTime);
  });
```

### 类型安全

若生成 Lambda 函数时选择了 `eventSource`，函数将集成 [AWS Lambda Powertools 的解析器中间件](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/)。例如：

```typescript {4}
export const handler = middy()
  .use(parser({ schema: EventBridgeSchema }))
  .handler(async (event) => {
    event.detail // <- 类型安全且支持 IDE 自动补全
  });
```

这为 Lambda 事件提供了编译时类型安全和运行时验证。

:::caution
若希望事件不符合 schema 时不抛出错误，可使用 [`safeParse` 选项](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/#safe-parsing)。
:::

:::tip
对于嵌套自定义数据（如 DynamoDB 流或 EventBridge 事件），可使用 [Envelopes](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/#envelopes) 实现类型安全。
:::

若不需要事件类型校验，可选择 `Any` 作为 `eventSource`，此时事件参数类型为 `any`。

## 打包部署

生成器自动配置 [esbuild](https://esbuild.github.io/) 优化 Lambda 部署包：

打包指定函数：

<NxCommands commands={['run <project-name>:bundle-<function-name>']} />

打包项目所有函数：

<NxCommands commands={['run <project-name>:bundle']} />

## 部署函数

生成器在 `common/constructs` 目录创建了 CDK 构造，可在 CDK 应用中使用：

```typescript {1, 6}
import { MyProjectMyFunction } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // 将函数加入堆栈
    const fn = new MyProjectMyFunction(this, 'MyFunction');
  }
}
```

该构造自动配置：

1. AWS Lambda 函数
2. CloudWatch 日志组
3. X-Ray 追踪配置
4. CloudWatch 指标命名空间

该函数可作为任何 Lambda [事件源](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/) 的目标：

:::note
请确保事件源与选择的 `eventSource` 选项匹配，以保证事件正确处理。
:::

以下示例演示使用 EventBridge 定时触发 Lambda 函数：

```typescript
import { Rule, Schedule } from 'aws-cdk-lib/aws-events';
import { LambdaFunction } from 'aws-cdk-lib/aws-events-targets';
import { MyProjectMyFunction } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // 将函数加入堆栈
    const fn = new MyProjectMyFunction(this, 'MyFunction');

    // 配置 EventBridge 定时规则
    const eventRule = new Rule(this, 'MyFunctionScheduleRule', {
      schedule: Schedule.cron({ minute: '15' }),
      targets: [new LambdaFunction(fn)],
    });
  }
}
```