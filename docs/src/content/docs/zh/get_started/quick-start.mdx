---
title: "å¿«é€Ÿå…¥é—¨æŒ‡å—"
description: "å…³äºå¦‚ä½•ä½¿ç”¨ @aws/nx-plugin çš„å¿«é€Ÿå…¥é—¨ã€‚"
---

import { Steps } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import Snippet from '@components/snippet.astro';
import CreateNxWorkspaceCommand from '@components/create-nx-workspace-command.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import InstallCommand from '@components/install-command.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import Infrastructure from '@components/infrastructure.astro';

æœ¬æŒ‡å—å°†å¼•å¯¼æ‚¨å®Œæˆå®‰è£…å’Œä½¿ç”¨ `@aws/nx-plugin` åœ¨ AWS ä¸Šå¿«é€Ÿæ„å»ºé¡¹ç›®çš„åŸºç¡€çŸ¥è¯†ã€‚

:::tip
å¦‚éœ€æ›´æ·±å…¥çš„å®Œæ•´åº”ç”¨æ„å»ºæ•™ç¨‹ï¼Œè¯·æŸ¥çœ‹ <Link path="get_started/tutorials/dungeon-game/overview">åœ°ç‰¢å†’é™©æ•™ç¨‹</Link>ã€‚
:::

## å‰ææ¡ä»¶

å¼€å§‹å‰éœ€è¦å®‰è£…ä»¥ä¸‹å…¨å±€ä¾èµ–ï¼š

<Snippet name="prerequisites" />

## æ­¥éª¤ 1ï¼šåˆå§‹åŒ–æ–°çš„ Nx å·¥ä½œåŒº

è¿è¡Œä»¥ä¸‹å‘½ä»¤ä½¿ç”¨æ‚¨é€‰æ‹©çš„åŒ…ç®¡ç†å™¨åˆ›å»º Nx å·¥ä½œåŒºï¼š

<CreateNxWorkspaceCommand workspace="my-project" />

:::tip
ç³»ç»Ÿä¼šæç¤ºæ‚¨é€‰æ‹©åŸºç¡€è®¾æ–½å³ä»£ç ï¼ˆIaCï¼‰æä¾›å•†ï¼Œå¯é€‰ [CDK](https://docs.aws.amazon.com/cdk/) æˆ– [Terraform](https://developer.hashicorp.com/terraform)ã€‚æ‚¨å¯ä»¥é€šè¿‡æ·»åŠ  `--iacProvider` å‚æ•°è·³è¿‡æç¤ºï¼š

<Infrastructure>
<Fragment slot="cdk">
<CreateNxWorkspaceCommand workspace="my-project" iacProvider="CDK" />
</Fragment>
<Fragment slot="terraform">
<CreateNxWorkspaceCommand workspace="my-project" iacProvider="Terraform" />
</Fragment>
</Infrastructure>
:::

å®Œæˆåè¿›å…¥é¡¹ç›®ç›®å½•ï¼š

```sh
cd my-project
```

## æ­¥éª¤ 2ï¼šä½¿ç”¨ç”Ÿæˆå™¨æ­å»ºé¡¹ç›®æ¡†æ¶

æœ¬å¿«é€Ÿå…¥é—¨æŒ‡å—å°†æ·»åŠ  tRPC APIã€React ç½‘ç«™ã€Cognito èº«ä»½éªŒè¯å’Œ CDK æˆ– Terraform åŸºç¡€è®¾æ–½ã€‚æ ¹æ®é¡¹ç›®ç±»å‹ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä»»æ„ç»„åˆçš„ç”Ÿæˆå™¨å¿«é€Ÿå¯åŠ¨é¡¹ç›®ã€‚æŸ¥çœ‹å·¦ä¾§å¯¼èˆªæ çš„ __æŒ‡å—__ è·å–å®Œæ•´é€‰é¡¹åˆ—è¡¨ã€‚

### æ·»åŠ  tRPC API

<RunGenerator generator="ts#trpc-api" requiredParameters={{ name: 'demo-api', auth: 'IAM' }} />

è¿™å°†åœ¨ `packages/demo-api` ç›®å½•ä¸‹åˆ›å»º APIã€‚

### æ·»åŠ  React ç½‘ç«™

<RunGenerator generator="ts#react-website" requiredParameters={{ name: 'demo-website' }} />

è¿™å°†åœ¨ `packages/demo-website` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ React ç½‘ç«™ã€‚

### æ·»åŠ  Cognito èº«ä»½éªŒè¯

<RunGenerator generator="ts#react-website#auth" requiredParameters={{ project: '@my-project/demo-website', cognitoDomain: 'my-demo' }} />

è¿™å°†è®¾ç½®å¿…è¦çš„åŸºç¡€è®¾æ–½å’Œ React ä»£ç ï¼Œä¸ºç½‘ç«™æ·»åŠ  Cognito èº«ä»½éªŒè¯ã€‚

### è¿æ¥å‰ç«¯ä¸åç«¯

<RunGenerator generator="connection" requiredParameters={{ sourceProject: '@my-project/demo-website', targetProject: '@my-project/demo-api' }} />

è¿™å°†é…ç½®å¿…è¦çš„æä¾›ç¨‹åºä»¥ç¡®ä¿ç½‘ç«™å¯ä»¥è°ƒç”¨ tRPC APIã€‚

### æ·»åŠ åŸºç¡€è®¾æ–½

æ ¹æ®é€‰æ‹©çš„ IaC æä¾›å•†æ·»åŠ åŸºç¡€è®¾æ–½é¡¹ç›®ï¼š

<Infrastructure>
<Fragment slot="cdk">
<RunGenerator generator="ts#infra" requiredParameters={{ name: 'infra' }} />

è¿™å°†é…ç½®ç”¨äºåœ¨ AWS ä¸Šéƒ¨ç½²åŸºç¡€è®¾æ–½çš„ CDK åº”ç”¨ã€‚
</Fragment>
<Fragment slot="terraform">
<RunGenerator generator="terraform#project" requiredParameters={{ name: 'infra' }} />

è¿™å°†é…ç½®ç”¨äºåœ¨ AWS ä¸Šéƒ¨ç½²åŸºç¡€è®¾æ–½çš„ Terraform é¡¹ç›®ã€‚
</Fragment>
</Infrastructure>

## æ­¥éª¤ 3ï¼šæœ¬åœ°è¿è¡Œç½‘ç«™å’Œ API

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ç½‘ç«™åŠå…¶è¿æ¥ API çš„æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼š

<NxCommands commands={['run demo-website:serve-local']} />

ç½‘ç«™å°†è¿è¡Œåœ¨ `http://localhost:4200`ã€‚

å¯¹ç½‘ç«™å’Œ API çš„ä¿®æ”¹å°†å®æ—¶ç”Ÿæ•ˆï¼Œæœ¬åœ°æœåŠ¡å™¨æ”¯æŒçƒ­é‡è½½ã€‚

## æ­¥éª¤ 4ï¼šå®šä¹‰äº‘èµ„æºå¹¶éƒ¨ç½²åˆ° AWS

<Infrastructure>
<Fragment slot="cdk">
æ‰“å¼€ `packages/infra/src/stacks/application-stack.ts` å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```typescript
import { Stack, StackProps } from 'aws-cdk-lib';
import { DemoApi, DemoWebsite, UserIdentity } from ':my-project/common-constructs';
import { Construct } from 'constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    const identity = new UserIdentity(this, 'identity');
    const api = new DemoApi(this, 'api', {
      integrations: DemoApi.defaultIntegrations(this).build(),
    });
    api.grantInvokeAccess(identity.identityPool.authenticatedRole);

    new DemoWebsite(this, 'website');
  }
}
```

è¿™æ˜¯éƒ¨ç½²å…¨æ ˆåº”ç”¨æ‰€éœ€çš„å…¨éƒ¨ CDK ä»£ç ã€‚
</Fragment>
<Fragment slot="terraform">
æ‰“å¼€ `packages/infra/src/main.tf` å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```hcl
# åŒ…å« @aws/nx-plugin ä½¿ç”¨æŒ‡æ ‡è·Ÿè¸ª
module "metrics" {
  source = "../../common/terraform/src/metrics"
}

# éƒ¨ç½²ç”¨æˆ·èº«ä»½
module "user_identity" {
  source = "../../common/terraform/src/core/user-identity"
}

# éƒ¨ç½² API
module "demo_api" {
  source = "../../common/terraform/src/app/apis/demo-api"
}

# æˆäºˆè®¤è¯ç”¨æˆ·è°ƒç”¨ API çš„æƒé™
resource "aws_iam_policy" "api_invoke_policy" {
  name        = "DemoApiInvokePolicy"
  description = "å…è®¸è®¤è¯ç”¨æˆ·è°ƒç”¨ API çš„ç­–ç•¥"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = "execute-api:Invoke"
        Resource = "${module.demo_api.api_execution_arn}/*/*"
      }
    ]
  })
}

resource "aws_iam_role_policy_attachment" "authenticated_api_access" {
  role       = module.user_identity.authenticated_role_name
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}

# éƒ¨ç½²ç½‘ç«™
provider "aws" {
  alias  = "us_east_1"
  region = "us-east-1"
}

module "demo_website" {
  source = "../../common/terraform/src/app/static-websites/demo-website"

  providers = {
    aws.us_east_1 = aws.us_east_1
  }

  depends_on = [module.user_identity, module.demo_api]
}
```

è¿™æ˜¯éƒ¨ç½²å…¨æ ˆåº”ç”¨æ‰€éœ€çš„å…¨éƒ¨ Terraform ä»£ç ã€‚
</Fragment>
</Infrastructure>

### æ„å»ºå¹¶éƒ¨ç½²åŸºç¡€è®¾æ–½

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ„å»ºé¡¹ç›®ï¼š

<PackageManagerShortCommand commands={["build"]} />

:::tip
å¦‚é‡ lint é”™è¯¯ï¼Œå¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š

<PackageManagerShortCommand commands={["lint"]} />
:::

åˆå§‹åŒ–åŸºç¡€è®¾æ–½ï¼š

<Infrastructure>
<Fragment slot="cdk">
<NxCommands commands={['run infra:bootstrap']} />

:::tip
CDK åˆå§‹åŒ–éœ€è¦åœ¨ç›®æ ‡éƒ¨ç½²åŒºåŸŸå’Œ `us-east-1` åŒºåŸŸæ‰§è¡Œï¼Œä»¥ä¾¿éƒ¨ç½²ç½‘ç«™çš„ AWS WAF WebACLã€‚
:::
</Fragment>
<Fragment slot="terraform">
<NxCommands commands={['run infra:bootstrap']} />

:::tip
Terraform åˆå§‹åŒ–ä¼šåˆ›å»ºå­˜å‚¨çŠ¶æ€æ–‡ä»¶çš„ S3 å­˜å‚¨æ¡¶ï¼Œæ¯ä¸ª AWS è´¦æˆ·/åŒºåŸŸç»„åˆåªéœ€æ‰§è¡Œä¸€æ¬¡ã€‚
:::
</Fragment>
</Infrastructure>

éƒ¨ç½²é¡¹ç›®ï¼š

<Infrastructure>
<Fragment slot="cdk">
<NxCommands commands={['run infra:deploy "my-project-sandbox/*"']} />
</Fragment>
<Fragment slot="terraform">
<NxCommands commands={['run infra:apply']} />

:::tip
æ­¤å‘½ä»¤ä¼šå…ˆæ‰§è¡Œ `terraform plan` æ˜¾ç¤ºå˜æ›´è®¡åˆ’ï¼Œç„¶ååº”ç”¨å˜æ›´éƒ¨ç½²åŸºç¡€è®¾æ–½ã€‚
:::
</Fragment>
</Infrastructure>

## æ­¥éª¤ 5ï¼šæµ‹è¯•å·²éƒ¨ç½²äº‘èµ„æºçš„ç½‘ç«™

<Steps>
1. è·å– `runtime-config.json` æ–‡ä»¶ï¼š

    <NxCommands commands={['run demo-website:load:runtime-config']} />

2. å¯åŠ¨æœ¬åœ°ç½‘ç«™æœåŠ¡å™¨

    <NxCommands commands={['run demo-website:serve']} />
</Steps>

ç½‘ç«™å°†è¿è¡Œåœ¨ `http://localhost:4200`ï¼Œå¹¶æŒ‡å‘å·²éƒ¨ç½²çš„ API å’Œèº«ä»½éªŒè¯èµ„æºã€‚

---

æ­å–œï¼ğŸ‰ æ‚¨å·²æˆåŠŸä½¿ç”¨ `@aws/nx-plugin` æ„å»ºå¹¶éƒ¨ç½²äº†å…¨æ ˆåº”ç”¨ï¼