---
title: "AIåœ°ç‰¢æ¸¸æˆ"
description: "ä½¿ç”¨ @aws/nx-plugin æ„å»ºäººå·¥æ™ºèƒ½é©±åŠ¨çš„åœ°ç‰¢å†’é™©æ¸¸æˆçš„æ¼”ç»ƒã€‚"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2EDiff from '@components/e2e-diff.astro';
import E2ECode from '@components/e2e-code.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## æ¨¡å—äºŒï¼šæ¸¸æˆAPIå®ç°

æˆ‘ä»¬å°†ä»å®ç°æ¸¸æˆAPIå¼€å§‹ã€‚ä¸ºæ­¤ï¼Œæ€»å…±éœ€è¦åˆ›å»º4ä¸ªAPIï¼š

1. `createGame` - åˆ›å»ºæ–°æ¸¸æˆå®ä¾‹
2. `queryGames` - è¿”å›åˆ†é¡µçš„å†å²æ¸¸æˆåˆ—è¡¨
3. `saveAction` - ä¿å­˜æŒ‡å®šæ¸¸æˆçš„æ“ä½œè®°å½•
4. `queryActions` - è¿”å›åˆ†é¡µçš„æŒ‡å®šæ¸¸æˆæ‰€æœ‰æ“ä½œè®°å½•

### APIæ¨¡å¼å®šä¹‰

ä½¿ç”¨[Zod](https://zod.dev/)åœ¨`packages/game-api/src/schema`ç›®å½•ä¸‹å®šä¹‰APIè¾“å…¥è¾“å‡ºæ¨¡å¼ï¼š

<Tabs>
  <TabItem label="action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/action.ts.template" />
  </TabItem>
  <TabItem label="common.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/common.ts.template" />
  </TabItem>
  <TabItem label="game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/game.ts.template" />
  </TabItem>
  <TabItem label="index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/schema/index.ts.old.template" after="dungeon-adventure/2/schema/index.ts.template" />
  </TabItem>
</Tabs>

å¯åˆ é™¤`packages/game-api/src/schema/echo.ts`æ–‡ä»¶ï¼Œæœ¬é¡¹ç›®ä¸å†ä½¿ç”¨ã€‚

<Aside type="tip">
å¦‚ä¸Šæ‰€ç¤ºï¼Œæ¯ä¸ªZodæ¨¡å¼å®šä¹‰éƒ½é€šè¿‡`z.TypeOf`è¯­æ³•å¯¼å‡ºæ¥å£ç±»å‹ã€‚è¿™å®ç°äº†Zodå®šä¹‰åˆ°TypeScriptæ¥å£çš„è‡ªåŠ¨è½¬æ¢ï¼Œæ— éœ€é‡å¤å·¥ä½œï¼
</Aside>

### å®ä½“å»ºæ¨¡

åº”ç”¨å®ä½“å…³ç³»å›¾å¦‚ä¸‹ï¼š

<Image class="centered-image white-bg" src={dungeonAdventureErPng} alt="dungeon-adventure-er.png" width="400" height="300" />

æˆ‘ä»¬å°†ä½¿ç”¨DynamoDBå®ç°æ•°æ®åº“ï¼Œå¹¶é€šè¿‡[ElectroDB](https://electrodb.dev/en/core-concepts/introduction/)å®¢æˆ·ç«¯åº“ç®€åŒ–æ“ä½œã€‚é¦–å…ˆå®‰è£…`electrodb`ï¼š

<InstallCommand pkg="electrodb @aws-sdk/client-dynamodb" />

<Aside>
æ‰€æœ‰ä¾èµ–é¡¹éƒ½æ·»åŠ åˆ°æ ¹ç›®å½•`package.json`ï¼Œå› `@aws/nx-plugin`éµå¾ª[å•ä¸€ç‰ˆæœ¬ç­–ç•¥](https://nx.dev/concepts/decisions/dependency-management#single-version-policy)ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<Link path="guides/typescript-project#dependencies">TSé¡¹ç›®æŒ‡å—</Link>ã€‚
</Aside>

åœ¨`packages/game-api/src/entities`ç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹æ–‡ä»¶å®šä¹‰ElectroDBå®ä½“ï¼š

<Tabs>
  <TabItem label="action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/action.ts.template" />
  </TabItem>
  <TabItem label="game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/game.ts.template" />
  </TabItem>
</Tabs>

ElectroDBä¸ä»…æ”¯æŒç±»å‹å®šä¹‰ï¼Œè¿˜èƒ½ä¸ºæ—¶é—´æˆ³ç­‰å­—æ®µæä¾›é»˜è®¤å€¼ã€‚åŒæ—¶éµå¾ªDynamoDBæœ€ä½³å®è·µâ€”â€”[å•è¡¨è®¾è®¡](https://electrodb.dev/en/core-concepts/single-table-relationships/)ã€‚

<Aside>
è™½ç„¶ElectroDBæ”¯æŒ[é›†åˆ](https://electrodb.dev/en/modeling/collections/)ï¼Œä½†æœ¬æ•™ç¨‹ä¸ºç®€åŒ–æµç¨‹æš‚ä¸ä½¿ç”¨ã€‚
</Aside>

### å°†DynamoDBå®¢æˆ·ç«¯æ³¨å…¥tRPCä¸Šä¸‹æ–‡

ä¸ºåœ¨æ‰€æœ‰æµç¨‹ä¸­å…±äº«DynamoDBå®¢æˆ·ç«¯å®ä¾‹ï¼Œéœ€é€šè¿‡ä¸Šä¸‹æ–‡ä¼ é€’ã€‚ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š

<Tabs>
  <TabItem label="middleware/dynamodb.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/middleware/dynamodb.ts.template" />

æ­¤æ’ä»¶ç”¨äºåˆ›å»º`DynamoDBClient`å¹¶æ³¨å…¥ä¸Šä¸‹æ–‡ã€‚
  </TabItem>
  <TabItem label="middleware/index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/middleware/index.ts.old.template" after="dungeon-adventure/2/middleware/index.ts.template" />

æ‰©å±•`IMiddlewareContext`æ·»åŠ `IDynamoDBContext`ã€‚
  </TabItem>
  <TabItem label="init.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/init.ts.old.template" after="dungeon-adventure/2/init.ts.template" />

DynamoDBæ’ä»¶å·²é›†æˆã€‚

<Aside>
`concat` APIå°†ä¸­é—´ä»¶ç»‘å®šåˆ°æµç¨‹å®šä¹‰ã€‚è¯¦æƒ…å‚è€ƒ[concatæŒ‡å—](https://trpc.io/docs/server/middlewares#concat)ã€‚
</Aside>
  </TabItem>
</Tabs>

### å®šä¹‰æµç¨‹

åœ¨`packages/game-api/src/procedures`ä¸­å®ç°APIæ–¹æ³•ï¼š

<Tabs>
  <TabItem label="query-actions.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-actions.ts.template" />
  </TabItem>
  <TabItem label="query-games.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-games.ts.template" />
  </TabItem>
  <TabItem label="save-action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-action.ts.template" />
  </TabItem>
  <TabItem label="save-game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-game.ts.template" />
  </TabItem>
</Tabs>

å¯åˆ é™¤`packages/game-api/src/procedures/echo.ts`æ–‡ä»¶ã€‚

### è·¯ç”±é…ç½®

æ›´æ–°è·¯ç”±æ–‡ä»¶æ•´åˆæµç¨‹ï¼š

<E2EDiff lang="typescript" before="dungeon-adventure/2/router.ts.old.template" after="dungeon-adventure/2/router.ts.template" />

### åŸºç¡€è®¾æ–½

æœ€åæ›´æ–°åŸºç¡€è®¾æ–½ä»¥åˆ›å»ºDynamoDBè¡¨å¹¶é…ç½®æƒé™ï¼š

<Tabs>
  <TabItem label="constructs/electrodb-table.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/constructs/electrodb-table.ts.template" />
  </TabItem>
  <TabItem label="stacks/application-stack.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/1/application-stack.ts.template" after="dungeon-adventure/2/stacks/application-stack.ts.template" />

:::note
ç”±äºæ¯ä¸ªæµç¨‹ç”±ç‹¬ç«‹Lambdaå‡½æ•°å¤„ç†ï¼Œå¯æ ¹æ®å®ç°æŒ‰éœ€åˆ†é…æœ€å°è¯»å†™æƒé™ã€‚
:::
  </TabItem>
</Tabs>

### éƒ¨ç½²ä¸æµ‹è¯•

é¦–å…ˆæ„å»ºä»£ç ï¼š

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
è‹¥å‡ºç°linté”™è¯¯ï¼Œå¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

éƒ¨ç½²åº”ç”¨ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/*']} />

é¦–æ¬¡éƒ¨ç½²çº¦éœ€8åˆ†é’Ÿï¼Œåç»­éƒ¨ç½²çº¦2åˆ†é’Ÿã€‚

:::tip
è¿­ä»£Lambdaä»£ç æ—¶ï¼Œæ„å»ºåä½¿ç”¨`--hotswap`æ ‡å¿—å¯å¤§å¹…ç¼©çŸ­éƒ¨ç½²æ—¶é—´ï¼ˆ2-3ç§’ï¼‰ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/* --hotswap']} />
:::

éƒ¨ç½²å®Œæˆåå°†çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼ˆéƒ¨åˆ†å€¼å·²è„±æ•ï¼‰ï¼š

```bash
dungeon-adventure-sandbox-Application
dungeon-adventure-sandbox-Application: deploying... [2/2]

 âœ…  dungeon-adventure-sandbox-Application

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-sandbox-Application.StoryApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

æµ‹è¯•æ–¹å¼ï¼š
<ul>
<li>æœ¬åœ°å¯åŠ¨tRPCåç«¯ï¼Œä½¿ç”¨`curl`è°ƒç”¨API</li>
<li>
<Drawer title="å¯ç”¨Sigv4çš„curl" trigger="è°ƒç”¨å·²éƒ¨ç½²APIï¼ˆéœ€Sigv4ç­¾åï¼‰">

<Tabs>
  <TabItem label="Bash/Linux/macOS">
å°†ä»¥ä¸‹è„šæœ¬åŠ å…¥`.bashrc`ï¼ˆéœ€`source`ï¼‰æˆ–ç›´æ¥ç²˜è´´åˆ°ç»ˆç«¯ï¼š
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### APIç½‘å…³
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### Lambdaå‡½æ•°URL
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
  <TabItem label="Windows PowerShell">
å°†å‡½æ•°åŠ å…¥PowerShellé…ç½®æ–‡ä»¶æˆ–å½“å‰ä¼šè¯ï¼š
```powershell
function acurl {
    param(
        [Parameter(Mandatory=$true)][string]$Region,
        [Parameter(Mandatory=$true)][string]$Service,
        [Parameter(ValueFromRemainingArguments=$true)][string[]]$CurlArgs
    )

    $AccessKey = aws configure get aws_access_key_id
    $SecretKey = aws configure get aws_secret_access_key
    $SessionToken = aws configure get aws_session_token

    & curl --aws-sigv4 "aws:amz:$Region`:$Service" --user "$AccessKey`:$SecretKey" -H "X-Amz-Security-Token: $SessionToken" @CurlArgs
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### APIç½‘å…³
```powershell
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### Lambdaå‡½æ•°URL
```powershell
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
</Tabs>

</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="æœ¬åœ°æµ‹è¯•">
    è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœ¬åœ°æœåŠ¡ï¼š

    <NxCommands highlights={['dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY']} env={{TABLE_NAME:"dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY"}} commands={["run @dungeon-adventure/game-api:serve"]} />

    <Aside type="caution">
    ä½¿ç”¨CDKéƒ¨ç½²è¾“å‡ºä¸­çš„`dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX`æ›¿æ¢é«˜äº®å ä½ç¬¦ã€‚
    </Aside>

    æœåŠ¡å¯åŠ¨åæ‰§è¡Œï¼š
    ```bash
    curl -X GET 'http://localhost:2022/games.query?input=%7B%7D'
    ```
  </TabItem>
  <TabItem label="äº‘ç«¯æµ‹è¯•">
```bash "https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/" "ap-southeast-2"
acurl ap-southeast-2 execute-api -X GET 'https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/games.query?input=%7B%7D'
```
    <Aside type="caution">
    ä½¿ç”¨CDKè¾“å‡ºä¸­çš„`dungeon-adventure-infra-sandbox-Application.GameApiGameApiEndpointXXX`æ›¿æ¢URLï¼Œå¹¶è®¾ç½®æ­£ç¡®åŒºåŸŸã€‚
    </Aside>
  </TabItem>
</Tabs>

:::note
`%7B%7D`æ˜¯URIç¼–ç çš„ç©ºJSONå¯¹è±¡`{}`ã€‚
:::

æˆåŠŸæ‰§è¡Œåå°†è¿”å›ï¼š
```json
{"result":{"data":{"items":[],"cursor":null}}}
```

æ­å–œï¼ä½ å·²æˆåŠŸä½¿ç”¨tRPCæ„å»ºå¹¶éƒ¨ç½²é¦–ä¸ªAPIï¼ğŸ‰ğŸ‰ğŸ‰