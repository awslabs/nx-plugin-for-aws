---
title: "ä»£ç†å¼AIåœ°ç‰¢æ¸¸æˆ"
description: "ä½¿ç”¨ @aws/nx-plugin æ„å»ºä»£ç†å¼AIé©±åŠ¨çš„åœ°ç‰¢å†’é™©æ¸¸æˆçš„æ¼”ç»ƒ"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2EDiff from '@components/e2e-diff.astro';
import E2ECode from '@components/e2e-code.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

import { getDungeonAdventureElectroDbDependencies } from '../../../../../../../../e2e/src/utils';

## æ¨¡å— 2ï¼šæ¸¸æˆ API ä¸åº“å­˜ MCP æœåŠ¡å®ç°

æˆ‘ä»¬å°†ä»å®ç°æ¸¸æˆ API å¼€å§‹ã€‚ä¸ºæ­¤éœ€è¦åˆ›å»º 5 ä¸ª API æ¥å£ï¼š

1. `saveGame` - åˆ›å»ºæˆ–æ›´æ–°æ¸¸æˆ
2. `queryGames` - è¿”å›åˆ†é¡µçš„å†å²æ¸¸æˆåˆ—è¡¨
3. `saveAction` - ä¿å­˜æŒ‡å®šæ¸¸æˆçš„æ“ä½œè®°å½•
4. `queryActions` - è¿”å›åˆ†é¡µçš„æŒ‡å®šæ¸¸æˆæ‰€æœ‰æ“ä½œè®°å½•
5. `queryInventory` - è¿”å›åˆ†é¡µçš„ç©å®¶åº“å­˜ç‰©å“åˆ—è¡¨

### API æ¨¡å¼å®šä¹‰

ä½¿ç”¨ [Zod](https://zod.dev/) åœ¨ `packages/game-api/src/schema` ç›®å½•ä¸‹å®šä¹‰ API è¾“å…¥è¾“å‡ºæ¨¡å¼ï¼š

<Tabs>
  <TabItem label="action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/action.ts.template" />
  </TabItem>
  <TabItem label="common.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/common.ts.template" />
  </TabItem>
  <TabItem label="game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/game.ts.template" />
  </TabItem>
  <TabItem label="inventory.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/inventory.ts.template" />
  </TabItem>
  <TabItem label="index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/schema/index.ts.old.template" after="dungeon-adventure/2/schema/index.ts.template" />
  </TabItem>
</Tabs>

å¯ä»¥åˆ é™¤ `packages/game-api/src/schema/echo.ts` æ–‡ä»¶ï¼Œå› ä¸ºæœ¬é¡¹ç›®ä¸ä¼šä½¿ç”¨å®ƒã€‚

<Aside type="tip">
å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ª Zod æ¨¡å¼å®šä¹‰éƒ½ä½¿ç”¨ `z.TypeOf` è¯­æ³•å¯¼å‡ºäº†æ¥å£ç±»å‹ã€‚è¿™è®©æˆ‘ä»¬æ— éœ€é‡å¤å·¥ä½œå°±èƒ½å°† Zod å®šä¹‰è½¬æ¢ä¸º TypeScript æ¥å£ï¼
</Aside>

### å®ä½“å»ºæ¨¡

åº”ç”¨çš„å®ä½“å…³ç³»å›¾å¦‚ä¸‹ï¼š

<Image class="centered-image white-bg" src={dungeonAdventureErPng} alt="åœ°ç‰¢å†’é™©ERå›¾" width="400" height="300" />

{/* ç”±ä»¥ä¸‹ PlantUML ç”Ÿæˆï¼š */}
{/*
@startuml Game API Entity Relationship Diagram

!theme plain

skinparam linetype ortho
skinparam roundcorner 10

entity "Game" as game {
  + playerName : string <<PK>>
  --
  genre : string
  lastUpdated : string
}

entity "Action" as action {
  + playerName : string <<PK>>
  + timestamp : string <<SK>>
  --
  role : string
  content : string
}

entity "Item" as item {
  + playerName : string <<PK>>
  + itemName : string
  --
  emoji : string (optional)
  lastUpdated : string
  quantity : number
}

game ||--o{ action
game ||--o{ item

@enduml
*/}

æˆ‘ä»¬å°†ä½¿ç”¨ DynamoDB å®ç°æ•°æ®åº“ï¼Œå¹¶é€šè¿‡ [ElectroDB](https://electrodb.dev/en/core-concepts/introduction/) å®¢æˆ·ç«¯åº“ç®€åŒ–æ“ä½œã€‚é¦–å…ˆéœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… `electrodb` å’Œ DynamoDB å®¢æˆ·ç«¯ï¼š

<InstallCommand pkg={getDungeonAdventureElectroDbDependencies()} />

<Aside>
æ‰€æœ‰ä¾èµ–éƒ½æ·»åŠ åˆ°æ ¹ç›®å½•çš„ `package.json`ï¼Œå› ä¸º `@aws/nx-plugin` éµå¾ª[å•ä¸€ç‰ˆæœ¬ç­–ç•¥](https://nx.dev/concepts/decisions/dependency-management#single-version-policy)åŸåˆ™ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<Link path="guides/typescript-project#dependencies">TypeScript é¡¹ç›®æŒ‡å—</Link>ã€‚
</Aside>

ç°åœ¨æ ¹æ®ä¸Šè¿° ER å›¾ï¼Œåœ¨ `packages/game-api/src/entities` ç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹æ–‡ä»¶å®šä¹‰ ElectroDB å®ä½“ï¼š

<Tabs>
  <TabItem label="action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/action.ts.template" />
  </TabItem>
  <TabItem label="game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/game.ts.template" />
  </TabItem>
  <TabItem label="inventory.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/inventory.ts.template" />
  </TabItem>
</Tabs>

ElectroDB ä¸ä»…å¯ä»¥å®šä¹‰ç±»å‹ï¼Œè¿˜èƒ½ä¸ºæ—¶é—´æˆ³ç­‰å­—æ®µæä¾›é»˜è®¤å€¼ã€‚æ­¤å¤–ï¼ŒElectroDB éµå¾ª DynamoDB æœ€ä½³å®è·µçš„[å•è¡¨è®¾è®¡](https://electrodb.dev/en/core-concepts/single-table-relationships/)ã€‚

<Aside>
è™½ç„¶ ElectroDB æ”¯æŒ[é›†åˆ](https://electrodb.dev/en/modeling/collections/)ï¼Œä½†æœ¬æ•™ç¨‹ä¸ºç®€åŒ–èµ·è§æš‚ä¸ä½¿ç”¨ã€‚
</Aside>

ä¸ºäº†è®© MCP æœåŠ¡èƒ½ä¸åº“å­˜äº¤äº’ï¼Œè¯·ç¡®ä¿åœ¨ `packages/game-api/src/index.ts` ä¸­å¯¼å‡ºåº“å­˜å®ä½“ï¼š

<Tabs>
<TabItem label="packages/game-api/src/index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/index.ts.old.template" after="dungeon-adventure/2/index.ts.template" />
</TabItem>
</Tabs>

:::note
è‹¥å°†å®ä½“é‡æ„åˆ°ç‹¬ç«‹çš„å…±äº«é¡¹ç›®ä¸­ï¼Œè®© MCP æœåŠ¡ä¸ä¾èµ– API ä¼šæ›´ç¬¦åˆåŒ…ç»“æ„è®¾è®¡ã€‚
:::

### å°† DynamoDB å®¢æˆ·ç«¯æ³¨å…¥ tRPC ä¸Šä¸‹æ–‡

ç”±äºæ¯ä¸ªæ“ä½œæµç¨‹éƒ½éœ€è¦è®¿é—® DynamoDB å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå•ä¸€å®ä¾‹å¹¶é€šè¿‡ä¸Šä¸‹æ–‡ä¼ é€’ã€‚åœ¨ `packages/game-api/src` ç›®å½•ä¸‹è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

<Tabs>
  <TabItem label="middleware/dynamodb.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/middleware/dynamodb.ts.template" />

è¿™æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»º `DynamoDBClient` å¹¶æ³¨å…¥ä¸Šä¸‹æ–‡çš„æ’ä»¶ã€‚
  </TabItem>
  <TabItem label="middleware/index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/middleware/index.ts.old.template" after="dungeon-adventure/2/middleware/index.ts.template" />

æ‰©å±• `IMiddlewareContext` ä»¥æ·»åŠ  `IDynamoDBContext`ã€‚
  </TabItem>
  <TabItem label="init.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/init.ts.old.template" after="dungeon-adventure/2/init.ts.template" />

DynamoDB æ’ä»¶å·²é…ç½®ã€‚

<Aside>
`concat` API å°†ä¸­é—´ä»¶ç»‘å®šåˆ°å®šä¹‰çš„æ“ä½œæµç¨‹ã€‚æ›´å¤šç»†èŠ‚è¯·å‚è€ƒ[concat æŒ‡å—](https://trpc.io/docs/server/middlewares#concat)ã€‚
</Aside>
  </TabItem>
</Tabs>

### å®šä¹‰æ“ä½œæµç¨‹

ç°åœ¨å¼€å§‹å®ç° API æ–¹æ³•ã€‚åœ¨ `packages/game-api/src/procedures` ç›®å½•ä¸‹è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

#### æŸ¥è¯¢æ“ä½œ

<Tabs>
  <TabItem label="query-actions.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-actions.ts.template" />
  </TabItem>
  <TabItem label="query-games.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-games.ts.template" />
  </TabItem>
  <TabItem label="query-inventory.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-inventory.ts.template" />
  </TabItem>
</Tabs>

#### å˜æ›´æ“ä½œ

<Tabs>
  <TabItem label="save-action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-action.ts.template" />
  </TabItem>
  <TabItem label="save-game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-game.ts.template" />
  </TabItem>
</Tabs>

å¯ä»¥åˆ é™¤ `packages/game-api/src/procedures` ä¸­çš„ `echo.ts` æ–‡ä»¶ï¼Œå› ä¸ºæœ¬é¡¹ç›®ä¸ä¼šä½¿ç”¨ã€‚

### è·¯ç”±é…ç½®

å®Œæˆæ“ä½œæµç¨‹å®šä¹‰åï¼Œç°åœ¨å°†å…¶æ¥å…¥ APIã€‚æ›´æ–°ä»¥ä¸‹æ–‡ä»¶ï¼š

<Tabs>
  <TabItem label="packages/game-api/src/router.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/router.ts.old.template" after="dungeon-adventure/2/router.ts.template" />
</TabItem>
</Tabs>

### åº“å­˜ MCP æœåŠ¡

ç°åœ¨åˆ›å»º MCP æœåŠ¡ï¼Œä½¿æ™ºèƒ½ä½“èƒ½ç®¡ç†ç©å®¶åº“å­˜ç‰©å“ã€‚

æˆ‘ä»¬å°†ä¸ºæ™ºèƒ½ä½“å®šä¹‰ä»¥ä¸‹å·¥å…·ï¼š

- `list-inventory-items` è·å–ç©å®¶å½“å‰åº“å­˜ç‰©å“
- `add-to-inventory` å‘åº“å­˜æ·»åŠ ç‰©å“
- `remove-from-inventory` ä»åº“å­˜ç§»é™¤ç‰©å“

ä¸ºèŠ‚çœæ—¶é—´ï¼Œæˆ‘ä»¬å°†å†…è”å®šä¹‰æ‰€æœ‰å·¥å…·ï¼š

<Tabs>
  <TabItem label="packages/inventory/src/mcp-server/server.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/mcp/server.ts.old.template" after="dungeon-adventure/2/mcp/server.ts.template" />
</TabItem>
</Tabs>

éšç€å·¥å…·æ•°é‡å¢åŠ ï¼Œå¯ä»¥æŒ‰éœ€å°†å…¶é‡æ„åˆ°ç‹¬ç«‹æ–‡ä»¶ä¸­ã€‚

ç°åœ¨å¯ä»¥åˆ é™¤ `packages/inventory/src/mcp-server` ä¸­æœªä½¿ç”¨çš„ `tools` å’Œ `resources` ç›®å½•ã€‚

### åŸºç¡€è®¾æ–½

æœ€åæ›´æ–°åŸºç¡€è®¾æ–½ä»¥åˆ›å»º DynamoDB è¡¨å¹¶æˆäºˆ Game API æ“ä½œæƒé™ã€‚æŒ‰ä»¥ä¸‹æ–¹å¼æ›´æ–° `packages/infra/src`ï¼š

<Tabs>
  <TabItem label="constructs/electrodb-table.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/constructs/electrodb-table.ts.template" />
  </TabItem>
  <TabItem label="stacks/application-stack.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/1/application-stack.ts.template" after="dungeon-adventure/2/stacks/application-stack.ts.template" />

:::note
æ³¨æ„æ­¤å¤„æ¯ä¸ªæ“ä½œæµç¨‹ç”±ç‹¬ç«‹ Lambda å‡½æ•°å¤„ç†ï¼Œå› æ­¤å¯ä»¥éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œæ ¹æ®å…·ä½“å®ç°åˆ†é…è¯»å†™æƒé™ã€‚
:::
  </TabItem>
</Tabs>

### éƒ¨ç½²ä¸æµ‹è¯•

é¦–å…ˆæ„å»ºä»£ç åº“ï¼š

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
è‹¥é‡åˆ° lint é”™è¯¯ï¼Œå¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

ç°åœ¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²åº”ç”¨ï¼š

<NxCommands commands={['deploy infra dungeon-adventure-infra-sandbox/*']} />

:::caution
å¯èƒ½éœ€è¦å…ˆåˆå§‹åŒ– AWS è´¦æˆ·ï¼Œè¿è¡Œï¼š

<NxCommands commands={['bootstrap infra']} />
:::

é¦–æ¬¡éƒ¨ç½²çº¦éœ€ 8 åˆ†é’Ÿï¼Œåç»­éƒ¨ç½²çº¦éœ€ 2 åˆ†é’Ÿã€‚

:::tip
è‹¥ä»…ä¿®æ”¹ Lambda å‡½æ•°ä»£ç ï¼Œæ„å»ºåä½¿ç”¨ `--hotswap` æ ‡å¿—éƒ¨ç½²å¯å¤§å¹…ç¼©çŸ­æ—¶é—´ï¼ˆ2-3 ç§’ï¼‰ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/* --hotswap']} />
:::

éƒ¨ç½²å®Œæˆåä¼šçœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹è¾“å‡ºï¼ˆéƒ¨åˆ†å€¼å·²è„±æ•ï¼‰ï¼š

```bash
dungeon-adventure-sandbox-Application
dungeon-adventure-sandbox-Application: deploying... [2/2]

 âœ…  dungeon-adventure-sandbox-Application

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-sandbox-Application.StoryApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯• APIï¼š
<ul>
<li>å¯åŠ¨ tRPC åç«¯æœ¬åœ°å®ä¾‹å¹¶ä½¿ç”¨ `curl` è°ƒç”¨ API</li>
<li>
<Drawer title="å¯ç”¨ Sigv4 ç­¾åçš„ curl" trigger="ä½¿ç”¨æ”¯æŒ sigv4 ç­¾åçš„ curl è°ƒç”¨å·²éƒ¨ç½² API">

<Tabs>
  <TabItem label="Bash/Linux/macOS">
å¯å°†ä»¥ä¸‹è„šæœ¬æ·»åŠ åˆ° `.bashrc` æ–‡ä»¶ï¼ˆå¹¶æ‰§è¡Œ `source`ï¼‰æˆ–ç›´æ¥åœ¨ç»ˆç«¯ç²˜è´´ï¼š
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### API ç½‘å…³
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### æµå¼ Lambda å‡½æ•° URL
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
  <TabItem label="Windows PowerShell">
å¯å°†ä»¥ä¸‹å‡½æ•°æ·»åŠ åˆ° PowerShell é…ç½®æ–‡ä»¶æˆ–ç›´æ¥ç²˜è´´åˆ°å½“å‰ä¼šè¯ï¼š
```powershell
function acurl {
    param(
        [Parameter(Mandatory=$true)][string]$Region,
        [Parameter(Mandatory=$true)][string]$Service,
        [Parameter(ValueFromRemainingArguments=$true)][string[]]$CurlArgs
    )

    $AccessKey = aws configure get aws_access_key_id
    $SecretKey = aws configure get aws_secret_access_key
    $SessionToken = aws configure get aws_session_token

    & curl --aws-sigv4 "aws:amz:$Region`:$Service" --user "$AccessKey`:$SecretKey" -H "X-Amz-Security-Token: $SessionToken" @CurlArgs
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### API ç½‘å…³
```powershell
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### æµå¼ Lambda å‡½æ•° URL
```powershell
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
</Tabs>

</Drawer>
</li>
</ul>


<Tabs>
  <TabItem label="æœ¬åœ°æµ‹è¯•">
    è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœ¬åœ° `game-api` æœåŠ¡ï¼š

    <NxCommands highlights={['dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY']} env={{TABLE_NAME:"dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY"}} commands={["run @dungeon-adventure/game-api:serve"]} />

    <Aside type="caution">
    è¯·ä½¿ç”¨ CDK éƒ¨ç½²è¾“å‡ºçš„ `dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX` å€¼æ›¿æ¢é«˜äº®å ä½ç¬¦ã€‚
    </Aside>

    æœåŠ¡å¯åŠ¨åå¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤è°ƒç”¨ï¼š

    ```bash
    curl -X GET 'http://localhost:2022/games.query?input=%7B%7D'
    ```
  </TabItem>
  <TabItem label="å·²éƒ¨ç½²ç¯å¢ƒ">
```bash "https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/" "ap-southeast-2"
acurl ap-southeast-2 execute-api -X GET 'https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/games.query?input=%7B%7D'
```
    <Aside type="caution">
    è¯·ä½¿ç”¨ CDK éƒ¨ç½²è¾“å‡ºçš„ `dungeon-adventure-infra-sandbox-Application.GameApiGameApiEndpointXXX` å€¼æ›¿æ¢é«˜äº®å ä½ç¬¦ï¼Œå¹¶è®¾ç½®æ­£ç¡®çš„åŒºåŸŸã€‚
    </Aside>
  </TabItem>
</Tabs>

:::note
æµ‹è¯• API æ—¶ä¼ é€’çš„ `%7B%7D` æ˜¯ URI ç¼–ç çš„ç©º JSON å¯¹è±¡ï¼ˆ`{}`ï¼‰ã€‚
:::

è‹¥å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œå°†çœ‹åˆ°å¦‚ä¸‹å“åº”ï¼š

```json
{"result":{"data":{"items":[],"cursor":null}}}
```

æ­å–œï¼Œæ‚¨å·²æˆåŠŸä½¿ç”¨ tRPC æ„å»ºå¹¶éƒ¨ç½²äº†ç¬¬ä¸€ä¸ª APIï¼ğŸ‰ğŸ‰ğŸ‰