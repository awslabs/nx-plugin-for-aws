---
title: "代理式AI地牢游戏"
description: "使用 @aws/nx-plugin 构建代理式AI驱动的地牢冒险游戏的演练"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## 模块四：用户界面实现

要开始构建用户界面，我们需要将本地开发服务器配置指向已部署的沙盒环境。运行以下命令：

<NxCommands commands={["run @dungeon-adventure/game-ui:load:runtime-config"]} />

该命令将拉取已部署的 `runtime-config.json` 文件，并存储在本地 `packages/game-ui/public` 目录中。

现在可以通过以下命令启动开发服务器：

<NxCommands commands={["run @dungeon-adventure/game-ui:serve"]} />

随后在浏览器中打开本地网站，系统将提示登录并创建新用户。完成后您将看到基础网站界面：

<Image src={baselineWebsitePng} alt="baseline-website.png" width="800" height="600" />

<Aside type="caution">
_开发服务器将在本模块剩余部分保持运行，以便自动热重载所有修改。_
</Aside>

:::tip
您也可以运行 <NxCommands commands={["run @dungeon-adventure/game-ui:serve-local"]} />，该命令会同时启动所有关联的API本地服务器，方便您同步迭代tRPC API和网站。
:::

### 创建新路由 '/game'

我们将通过创建类型安全路由来展示 `@tanstack/react-router` 的功能。在指定位置创建空文件：`packages/game-ui/src/routes/game/index.tsx`。您会注意到文件立即被更新。

`@tanstack/react-router` 已自动配置新路由，新建文件将包含以下路径定义：

```tsx
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/game/')({
  component: RouteComponent,
})

function RouteComponent() {
  return <div>Hello "/game/"!</div>
}
```

访问 `http://localhost:4200/game` 即可查看新页面：

<Image src={baselineGamePng} alt="baseline-game.png" width="800" height="600" />

更新 `index.tsx` 文件以默认加载新路由。注意修改 `to` 字段时，系统会提供类型安全的路由选项。

<Tabs>
<TabItem label="routes/index.tsx">
<E2EDiff before="dungeon-adventure/4/routes/index.tsx.old.template" after="dungeon-adventure/4/routes/index.tsx.template" lang="tsx" />
</TabItem>
</Tabs>

最后可删除不再需要的 `packages/game-ui/src/routes/welcome/` 目录。

### 布局更新

默认布局更适用于SaaS类商业应用。我们将重新配置布局和主题，使其符合地牢游戏风格。修改以下文件：

<Tabs>
<TabItem label="config.ts">
<E2EDiff before="dungeon-adventure/4/config.ts.old.template" after="dungeon-adventure/4/config.ts.template" lang="typescript" />
</TabItem>
<TabItem label="components/AppLayout/index.tsx">
<E2ECode path="dungeon-adventure/4/AppLayout/index.tsx.template" lang="tsx" />
</TabItem>
<TabItem label="styles.css">
<E2ECode path="dungeon-adventure/4/styles.css.template" lang="css" />
</TabItem>
</Tabs>

删除未使用的 `packages/game-ui/src/hooks/useAppLayout.tsx` 文件。

### 故事代理集成

创建用于初始化故事代理客户端的钩子：

<Tabs>
<TabItem label="hooks/useStoryAgent.tsx">
<E2ECode path="dungeon-adventure/4/hooks/useStoryAgent.tsx.template" lang="tsx" />
</TabItem>
</Tabs>

该钩子实现以下功能：
- 从 `runtime-config.json` 获取代理ARN
- 根据ARN构建代理运行时调用URL
- 使用用户JWT令牌和随机会话ID调用代理
- 返回异步迭代器用于处理流式消息

:::tip
游戏API集成已自动配置（得益于 `api-connection` 生成器）。如需类似代理体验，请为[此GitHub议题](https://github.com/awslabs/nx-plugin-for-aws/issues/326)点赞。
:::

### 游戏页面

创建调用API的最终游戏页面。更新以下文件：

<Tabs>
<TabItem label="index.tsx">
<E2ECode path="dungeon-adventure/4/routes/game/index.tsx.template" lang="tsx" />
</TabItem>
<TabItem label="$playerName.tsx">

<E2ECode path="dungeon-adventure/4/routes/game/$playerName.tsx.template" lang="tsx" />

<Aside type="tip">
`$playerName` 语法指示 `@tanstack/react-router` 将 `playerName` 作为[路径参数](https://tanstack.com/router/v1/docs/framework/react/guide/path-params)处理。`validateSearch` 方法确保 `genre` 查询参数严格匹配枚举类型。
</Aside>
</TabItem>
</Tabs>

完成修改后，本地开发服务器（http://localhost:4200/）即可运行完整游戏！

<Drawer title="构建与部署" trigger="您也可以选择构建并部署至Cloudfront">

构建命令：
<NxCommands commands={['run-many --target build --all']} />

部署命令：
<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/*']} />

部署完成后，通过CDK部署输出查看Cloudfront访问地址。

</Drawer>

<Image src={gameSelectPng} alt="game-select.png" width="500" height="400" />
<div style="margin-top: -100px; margin-left: 100px;">
<Image src={gameConversationPng} alt="game-conversation.png" width="500" height="400" />
</div>

恭喜！您已成功构建并部署智能地牢冒险游戏！🎉🎉🎉