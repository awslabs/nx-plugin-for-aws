---
title: "构建UI"
description: "使用 @aws/nx-plugin 构建代理式AI驱动的地牢冒险游戏的演练"
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## 任务一：配置本地开发服务器

要开始构建用户界面，我们需要将本地开发服务器配置指向已部署的沙盒环境。运行以下命令：

<NxCommands commands={["run @dungeon-adventure/game-ui:load:runtime-config"]} />

该命令将拉取已部署的 `runtime-config.json` 文件，并存储在本地 `packages/game-ui/public` 目录中。

要启动开发服务器，运行以下命令：

<NxCommands commands={["run @dungeon-adventure/game-ui:serve"]} />

在浏览器中打开本地网站，系统将提示登录并按照提示创建新用户。完成后，您将看到基础网站界面：

<Image src={baselineWebsitePng} alt="baseline-website.png" width="800" height="600" />

<Aside type="caution">
我们建议在本模块剩余部分保持开发服务器运行，因为它会自动热重载我们所做的任何修改。
</Aside>

:::tip
您也可以运行 Nx 命令来启动所有关联的 API 本地服务器，方便您同时迭代 tRPC API 和网站。<NxCommands commands={["run @dungeon-adventure/game-ui:serve-local"]} /> 
:::

## 任务二：创建新路由 '/game'

让我们通过创建类型安全路由来展示 `@tanstack/react-router` 的功能。
为此，在以下位置创建一个空文件：`packages/game-ui/src/routes/game/index.tsx`。您会注意到文件立即被更新。

`@tanstack/react-router` 会自动配置新路由，您刚创建的文件已包含路由路径定义：

```tsx
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/game/')({
  component: RouteComponent,
})

function RouteComponent() {
  return <div>Hello "/game/"!</div>
}
```

如果您访问 `http://localhost:4200/game`，将看到新页面已被渲染。

<Image src={baselineGamePng} alt="baseline-game.png" width="800" height="600" />

更新 `index.tsx` 文件以默认加载新的 `/game` 路由。当您更新 `to` 字段时，系统会提供类型安全的路由选项列表。

<Tabs>
<TabItem label="routes/index.tsx">
<E2EDiff before="dungeon-adventure/4/routes/index.tsx.old.template" after="dungeon-adventure/4/routes/index.tsx.template" lang="tsx" />
</TabItem>
</Tabs>

您可以删除不再需要的 `packages/game-ui/src/routes/welcome/` 目录。

## 任务三：更新布局

默认配置的布局更类似于 SaaS 风格的商业应用而非游戏。
要重新配置布局并将主题调整为更像地牢风格的游戏，请对 `packages/game-ui/src` 进行以下修改：

<Tabs>
<TabItem label="config.ts">
<E2EDiff before="dungeon-adventure/4/config.ts.old.template" after="dungeon-adventure/4/config.ts.template" lang="typescript" />
</TabItem>
<TabItem label="components/AppLayout/index.tsx">
<E2ECode path="dungeon-adventure/4/AppLayout/index.tsx.template" lang="tsx" />
</TabItem>
<TabItem label="styles.css">
<E2ECode path="dungeon-adventure/4/styles.css.template" lang="css" />
</TabItem>
</Tabs>

删除未使用的 `packages/game-ui/src/hooks/useAppLayout.tsx` 文件。

## 任务四：集成故事代理

让我们创建一个钩子来初始化与故事代理交互的客户端。

<Tabs>
<TabItem label="hooks/useStoryAgent.tsx">
<E2ECode path="dungeon-adventure/4/hooks/useStoryAgent.tsx.template" lang="tsx" />
</TabItem>
</Tabs>

该钩子：

- 从 `runtime-config.json` 获取代理 ARN，
- 根据 ARN 构建 AgentCore Runtime 调用 URL，
- 使用已登录用户的 JWT 令牌和随机会话 ID 调用代理，并
- 返回用于处理流式代理消息块的异步迭代器。

:::tip
游戏 API 集成已自动配置，因为我们使用了 `api-connection` 生成器。如果您希望代理也有类似的体验，请为[此 GitHub 议题](https://github.com/awslabs/nx-plugin-for-aws/issues/326)点赞。
:::

## 任务五：创建游戏页面

要创建调用 API 并完成游戏实现的游戏页面，请更新 `packages/game-ui/src/routes/game` 中的以下文件：

<Tabs>
<TabItem label="index.tsx">
<E2ECode path="dungeon-adventure/4/routes/game/index.tsx.template" lang="tsx" />
</TabItem>
<TabItem label="$playerName.tsx">

<E2ECode path="dungeon-adventure/4/routes/game/$playerName.tsx.template" lang="tsx" />

<Aside type="tip">
`$playerName` 语法将指示 `@tanstack/react-router` 将 `playerName` 作为[路径参数](https://tanstack.com/router/v1/docs/framework/react/guide/path-params)处理。此外，我们实现了 `validateSearch` 方法，确保 `genre` 查询参数严格类型化为我们的类型枚举。
</Aside>
</TabItem>
</Tabs>

完成这些修改后，您的本地开发服务器（http://localhost:4200/）现在应该已准备好游戏供您游玩。

<Drawer title="构建与部署" trigger="如果您愿意，也可以构建并部署代码到 Cloudfront。">

## 任务六：构建与部署

### 构建代码
要构建代码，运行以下命令：

<NxCommands commands={['run-many --target build --all']} />

### 部署应用程序
要部署应用程序，运行以下命令：

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/*']} />

部署完成后，访问您的 Cloudfront URL。要找到此 URL，请查看 CDK 部署输出。

</Drawer>

<Image src={gameSelectPng} alt="game-select.png" width="500" height="400" />
<div style="margin-top: -100px; margin-left: 100px;">
<Image src={gameConversationPng} alt="game-conversation.png" width="500" height="400" />
</div>

恭喜您。您已成功构建并部署智能地牢冒险游戏！🎉🎉🎉