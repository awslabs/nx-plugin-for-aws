---
title: "å®ç°å’Œé…ç½®Storyä»£ç†"
description: "ä½¿ç”¨ @aws/nx-plugin æ„å»ºä»£ç†å¼AIé©±åŠ¨çš„åœ°ç‰¢å†’é™©æ¸¸æˆçš„æ¼”ç»ƒ"
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## ä»»åŠ¡ 1ï¼šå®ç°æ•…äº‹ä»£ç†

æ•…äº‹ä»£ç†æ˜¯ä¸€ä¸ªåŸºäº [Strands](https://strandsagents.com/) çš„ä»£ç†ï¼Œåœ¨ç»™å®š `Game` å’Œ `Action` åˆ—è¡¨ä½œä¸ºä¸Šä¸‹æ–‡æ—¶ï¼Œèƒ½å¤Ÿæ¨è¿›æ•…äº‹æƒ…èŠ‚å‘å±•ã€‚æˆ‘ä»¬å°†é…ç½®è¯¥ä»£ç†ä¸åº“å­˜ç®¡ç†æ§åˆ¶åè®®ï¼ˆMCPï¼‰æœåŠ¡å™¨äº¤äº’ï¼Œä»¥ç®¡ç†ç©å®¶çš„å¯ç”¨ç‰©å“ã€‚

:::note
åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥"æ— çŠ¶æ€"æ–¹å¼å®ç°ä»£ç†ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½æ˜¯åŒ…å«å®Œæ•´æ¶ˆæ¯å†å²çš„ç‹¬ç«‹ä¼šè¯ã€‚ç”Ÿäº§ç¯å¢ƒä¸­å»ºè®®é›†æˆ [Bedrock AgentCore è®°å¿†ç³»ç»Ÿ](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html)ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…[åœ¨ Strands ä¸­ä½¿ç”¨ AgentCore è®°å¿†](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands)é¡µé¢ã€‚
:::

### ä»£ç†å®ç°

è¦å®ç°ä»£ç†ï¼Œè¯·æ›´æ–° `packages/story/dungeon_adventure_story/agent` ç›®å½•ä¸‹çš„ä»¥ä¸‹æ–‡ä»¶ï¼š

<Tabs>
  <TabItem label="main.py">
<E2EDiff lang="python" before="dungeon-adventure/3/main.py.old.template" after="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2EDiff lang="python" before="dungeon-adventure/3/agent.py.old.template" after="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

æ­¤é…ç½®å°†å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

- ä»ä»£ç†è´Ÿè½½ä¸­æå–ç©å®¶ä¿¡æ¯ã€æ¸¸æˆç±»å‹å’ŒåŠ¨ä½œåˆ—è¡¨ï¼Œ
- æ„å»ºä½¿ç”¨ SigV4 è®¤è¯è°ƒç”¨ MCP æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œä»¥åŠ
- é€šè¿‡ç³»ç»Ÿæç¤ºå’Œ MCP æœåŠ¡å™¨å·¥å…·æ„å»ºä»£ç†ã€‚

## ä»»åŠ¡ 2ï¼šéƒ¨ç½²ä¸æµ‹è¯•

### æ„å»ºä»£ç 

è¦æ„å»ºä»£ç ï¼š

<PackageManagerShortCommand commands={["build"]} />

<Aside type="tip">
è‹¥é‡åˆ° lint é”™è¯¯ï¼Œå¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ã€‚

<PackageManagerShortCommand commands={["lint"]} />
</Aside>

### éƒ¨ç½²åº”ç”¨ç¨‹åº
è¦éƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

<NxCommands commands={['deploy infra "dungeon-adventure-infra-sandbox/*"']} />

éƒ¨ç½²è¿‡ç¨‹çº¦éœ€ 2 åˆ†é’Ÿå®Œæˆã€‚

éƒ¨ç½²å®Œæˆåï¼Œå°†çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹è¾“å‡ºï¼ˆéƒ¨åˆ†å€¼å·²è„±æ•ï¼‰ï¼š

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox-Application

âœ¨  éƒ¨ç½²æ—¶é—´ï¼š354ç§’

è¾“å‡ºï¼š
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

### æµ‹è¯•ä»£ç†

å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•ä»£ç†ï¼š
<ul>
<li>å¯åŠ¨ä»£ç†æœåŠ¡å™¨æœ¬åœ°å®ä¾‹å¹¶ä½¿ç”¨ `curl` è°ƒç”¨ï¼Œæˆ–</li>
<li>ä½¿ç”¨æºå¸¦ JWT ä»¤ç‰Œçš„ curl è°ƒç”¨å·²éƒ¨ç½² APIã€‚</li>
</ul>

<Tabs>
  <TabItem label="æœ¬åœ°">
  è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨ï¼š
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    è¯·ä½¿ç”¨ CDK éƒ¨ç½²è¾“å‡ºçš„ `InventoryMcpArn` å€¼ï¼Œå¹¶æŒ‡å®šç›®æ ‡ `AWS_REGION`ã€‚
    :::

    ä»£ç†æœåŠ¡å™¨å¯åŠ¨å¹¶è¿è¡Œåï¼ˆæ— è¾“å‡ºæ˜¾ç¤ºï¼‰ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œè°ƒç”¨ï¼š

    ```bash
    curl -N -X POST http://127.0.0.1:8081/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="å·²éƒ¨ç½²">
    æµ‹è¯•å·²éƒ¨ç½²ä»£ç†éœ€é€šè¿‡ Cognito è®¤è¯è·å– JWT ä»¤ç‰Œã€‚é¦–å…ˆè®¾ç½®ç¯å¢ƒå˜é‡ï¼š

    ```bash
    # ä» CDK è¾“å‡ºä¸­è®¾ç½® Cognito ç”¨æˆ·æ±  ID å’Œå®¢æˆ·ç«¯ ID
    export POOL_ID="<CDK è¾“å‡ºçš„ UserPoolId>"
    export CLIENT_ID="<CDK è¾“å‡ºçš„ UserPoolClientId>"
    export REGION="<åŒºåŸŸ>"
    ```

    åˆ›å»ºæµ‹è¯•ç”¨æˆ·å¹¶è·å–è®¤è¯ä»¤ç‰Œï¼š

    ```bash
    # ç¦ç”¨ MFA ä»¥ç®€åŒ–ç”¨æˆ·åˆ›å»º
    aws cognito-idp set-user-pool-mfa-config \
      --mfa-configuration OFF \
      --user-pool-id $POOL_ID

    # åˆ›å»ºç”¨æˆ·
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "test" \
      --temporary-password "TempPass123-" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # è®¾ç½®æ°¸ä¹…å¯†ç ï¼ˆè¯·æ›¿æ¢ä¸ºæ›´å®‰å…¨çš„å¯†ç ï¼ï¼‰
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "test" \
      --password "PermanentPass123-" \
      --region $REGION \
      --permanent > /dev/null

    # ç”¨æˆ·è®¤è¯å¹¶è·å–è®¿é—®ä»¤ç‰Œ
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='test',PASSWORD='PermanentPass123-' \
      --region $REGION \
      --query "AuthenticationResult.AccessToken" \
      --output text)
    ```

    é€šè¿‡ Bedrock AgentCore è¿è¡Œæ—¶ URL è°ƒç”¨å·²éƒ¨ç½²ä»£ç†ï¼š

    ```bash
    # è®¾ç½® CDK è¾“å‡ºçš„ Story Agent ARN
    export AGENT_ARN="<CDK è¾“å‡ºçš„ StoryAgentArn>"

    # URL ç¼–ç  ARN
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # æ„é€ è°ƒç”¨ URL
    export AGENT_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # è°ƒç”¨ä»£ç†
    curl -N -X POST "$AGENT_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    URL ç¼–ç æ˜¯æ­£ç¡®æ ¼å¼åŒ– Bedrock AgentCore API ç«¯ç‚¹ ARN çš„å¿…è¦æ­¥éª¤ã€‚
    :::
  </TabItem>
</Tabs>

è‹¥å‘½ä»¤è¿è¡ŒæˆåŠŸï¼Œå°†å¼€å§‹çœ‹åˆ°åˆå§‹æ•…äº‹æ–‡æœ¬æµå¼è¾“å‡ºï¼š

```
You are a new superhero in the bustling metropolis of Metro City...
```

æ­å–œï¼æ‚¨å·²æˆåŠŸåœ¨ Bedrock AgentCore è¿è¡Œæ—¶ä¸Šæ„å»ºå¹¶éƒ¨ç½²é¦–ä¸ª Strands ä»£ç†ï¼ğŸ‰ğŸ‰ğŸ‰