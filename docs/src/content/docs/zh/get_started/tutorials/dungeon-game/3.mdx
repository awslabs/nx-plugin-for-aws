---
title: "代理式AI地牢游戏"
description: "使用 @aws/nx-plugin 构建代理式AI驱动的地牢冒险游戏的演练"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## 模块 3：故事代理实现

<Aside type="caution">
请确保您的 AWS 账户已按照[本指南](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html)所述步骤，在目标区域启用了对 Bedrock 中[Strands 默认模型](https://strandsagents.com/latest/documentation/docs/user-guide/concepts/model-providers/amazon-bedrock/)的访问。本文撰写时使用的模型是 Anthropic Claude Sonnet 4。
</Aside>

故事代理是一个 [Strands](https://strandsagents.com/) 代理，它基于给定的 `Game` 和 `Action` 列表作为上下文来推进故事情节。我们将配置该代理与库存管理服务器（MCP Server）交互，管理玩家可用物品。

:::note
为简化教程，我们以"无状态"方式实现代理，每次调用都是包含完整消息历史的独立会话。生产环境中建议集成 [Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html)。关于在 Strands 中使用 AgentCore Memory 的更多文档[可在此处获取](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands)。
:::

### 代理实现

让我们实现代理。更新 `packages/story/dungeon_adventure_story/agent` 目录下的文件：

<Tabs>
  <TabItem label="main.py">
<E2ECode lang="python" path="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2ECode lang="python" path="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

此配置实现了以下功能：
- 从代理负载中提取玩家信息、故事类型和动作
- 构建使用 SigV4 认证调用 MCP 服务器的客户端
- 通过系统提示和 MCP 服务器工具构建代理

### 部署与测试

首先构建代码库：

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
若遇到 lint 错误，可运行以下命令自动修复：

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

运行以下命令部署应用：

<NxCommands commands={['deploy infra dungeon-adventure-infra-sandbox/*']} />

部署过程约需 2 分钟。

部署完成后将看到类似输出（部分值已脱敏）：

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 ✅  dungeon-adventure-infra-sandbox-Application

✨  部署时间: 354s

输出:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

可通过以下方式测试 API：
<ul>
<li>启动代理服务器本地实例并使用 `curl` 调用</li>
<li>使用带 JWT 令牌的 curl 调用已部署 API</li>
</ul>

<Tabs>
  <TabItem label="本地测试">
  运行以下命令启动本地代理服务器：
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{PORT: '9999', INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    请使用 CDK 部署输出的 `InventoryMcpArn` 并指定目标 `AWS_REGION`。
    :::

    代理服务器启动后（无输出显示），运行以下命令调用：

    ```bash
    curl -N -X POST http://127.0.0.1:9999/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789"
    ```
  </TabItem>
  <TabItem label="云端测试">
    测试已部署代理需通过 Cognito 认证获取 JWT 令牌。首先设置环境变量：

    ```bash
    # 从 CDK 输出获取 Cognito 用户池 ID 和客户端 ID
    export POOL_ID="<CDK 输出的 UserPoolId>"
    export CLIENT_ID="<CDK 输出的 UserPoolClientId>"
    export REGION="<您的区域>"
    ```

    创建测试用户并获取认证令牌：

    ```bash
    # 创建用户
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --temporary-password "TempPass123!" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # 设置永久密码（请替换为更安全的密码！）
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --password "PermanentPass123!" \
      --region $REGION \
      --permanent > /dev/null

    # 用户认证并获取 ID 令牌
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='testuser',PASSWORD='PermanentPass123!' \
      --region $REGION | jq -r '.AuthenticationResult.IdToken')
    ```

    :::caution
    使用 CDK 输出的 `UserIdentityUserIdentityUserPoolIdXXX` 作为 `POOL_ID`，并确保使用对应的客户端 ID。
    :::

    调用已部署代理：

    ```bash
    # 设置 CDK 输出的 Story Agent ARN
    export AGENT_ARN="<CDK 输出的 StoryAgentArn>"

    # URL 编码 ARN
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # 构造调用 URL
    export MCP_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # 调用代理
    curl -N -X POST "$MCP_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    URL 编码是正确格式化 Bedrock AgentCore API 端点 ARN 的必要步骤。
    :::
  </TabItem>
</Tabs>

成功执行命令后，将看到类似事件流：

```
data: {"init_event_loop": true}

data: {"start": true}

data: {"start_event_loop": true}

data: {"event": {"messageStart": {"role": "assistant"}}}

data: {"event": {"contentBlockDelta": {"delta": {"text": "Welcome"}, "contentBlockIndex": 0}}}

...
```

恭喜！您已成功在 Bedrock AgentCore Runtime 上构建并部署首个 Strands 代理！🎉🎉🎉