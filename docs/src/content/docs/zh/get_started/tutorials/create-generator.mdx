---
title: "创建生成器"
description: "使用 @aws/nx-plugin 构建生成器的演练。"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## 构建生成器

让我们创建一个新的生成器。我们的目标是为 tRPC API 生成新的过程（procedure）。

### 获取插件

首先克隆插件仓库：

```bash
git clone git@github.com:awslabs/nx-plugin-for-aws.git
```

安装依赖并构建：

```bash
cd nx-plugin-for-aws
pnpm i
pnpm nx run-many --target build --all
```

### 创建空生成器

在 `packages/nx-plugin/src/trpc/procedure` 目录下创建新生成器。首先定义 schema 和生成器入口：

<FileTree>
  - packages/nx-plugin/src/trpc/procedure
    - schema.json 定义生成器输入
    - schema.d.ts 匹配 schema 的 TypeScript 接口
    - generator.ts Nx 运行的生成器函数
</FileTree>

为每个文件添加以下内容。

<Tabs>
  <TabItem label="schema.json">
    ```json
    {
      "$schema": "https://json-schema.org/schema",
      "$id": "tRPCProcedure",
      "title": "为 tRPC API 添加过程",
      "type": "object",
      "properties": {
        "project": {
          "type": "string",
          "description": "tRPC API 项目",
          "x-prompt": "选择要添加过程的 tRPC API 项目",
          "x-dropdown": "projects",
          "x-priority": "important"
        },
        "procedure": {
          "description": "新过程名称",
          "type": "string",
          "x-prompt": "新过程命名？",
          "x-priority": "important",
        },
        "type": {
          "description": "生成的过程类型",
          "type": "string",
          "x-prompt": "选择过程类型？",
          "x-priority": "important",
          "default": "query",
          "enum": ["query", "mutation"]
        }
      },
      "required": ["project", "procedure"]
    }
    ```
  </TabItem>
  <TabItem label="schema.d.ts">
    ```ts
    export interface TrpcProcedureSchema {
      project: string;
      procedure: string;
      type: 'query' | 'mutation';
    }
    ```
  </TabItem>
  <TabItem label="generator.ts">
    ```ts
    import { Tree } from '@nx/devkit';
    import { TrpcProcedureSchema } from './schema';

    export const trpcProcedureGenerator = async (tree: Tree, options: TrpcProcedureSchema) => {

    };

    export default trpcProcedureGenerator;

    ```
  </TabItem>
</Tabs>

:::note
注意生成器接收 `Tree` 对象和 schema 定义的选项。`Tree` 是虚拟文件系统，允许读写项目文件而不直接操作物理文件系统，这支持"干运行"模式。
:::

更新 `packages/nx-plugin/generators.json` 注册生成器：

```json
 ...
  "generators": {
    ...
    "ts#trpc-api#procedure": {
      "factory": "./src/trpc/procedure/generator",
      "schema": "./src/trpc/procedure/schema.json",
      "description": "为 tRPC API 添加过程"
    }
  },
...
```

### 实现生成器

实现步骤：

1. 创建新过程的 TypeScript 文件
2. 将过程添加到路由

#### 创建过程文件

使用 `generateFiles` 工具和 EJS 模板：

```ts title="files/procedures/__procedureNameKebabCase__.ts.template"
import { publicProcedure } from '../init.js';
import { z } from 'zod';

export const <%- procedureNameCamelCase %> = publicProcedure
  .input(z.object({
    // TODO: 定义输入
  }))
  .output(z.object({
    // TODO: 定义输出
  }))
  .<%- procedureType %>(async ({ input, ctx }) => {
    // TODO: 实现逻辑
    return {};
  });
```

:::tip
模板文件名中的 `__<变量>__` 会被替换，`.template` 扩展名会被移除。模板内容使用 EJS 语法。
:::

更新生成器代码生成文件：

```ts title="procedure/generator.ts" {8-19}
import { generateFiles, joinPathFragments, readProjectConfiguration, Tree } from '@nx/devkit';
import { TrpcProcedureSchema } from './schema';
import { formatFilesInSubtree } from '../../utils/format';
import camelCase from 'lodash.camelcase';
import kebabCase from 'lodash.kebabcase';

export const trpcProcedureGenerator = async (tree: Tree, options: TrpcProcedureSchema) => {
  const projectConfig = readProjectConfiguration(tree, options.project);

  const procedureNameCamelCase = camelCase(options.procedure);
  const procedureNameKebabCase = kebabCase(options.procedure);

  generateFiles(tree, joinPathFragments(__dirname, 'files'), projectConfig.sourceRoot, {
    procedureNameCamelCase,
    procedureNameKebabCase,
    procedureType: options.type,
  });

  await formatFilesInSubtree(tree);
};

export default trpcProcedureGenerator;
```

:::tip
`formatFilesInSubtree` 确保生成的文件符合用户的 Prettier 配置。
:::

#### 将过程加入路由

使用 TypeScript AST 操作更新路由文件：

```ts title="procedure/generator.ts" {6, 23-33}
import { generateFiles, joinPathFragments, readProjectConfiguration, Tree } from '@nx/devkit';
import { TrpcProcedureSchema } from './schema';
import { formatFilesInSubtree } from '../../utils/format';
import camelCase from 'lodash.camelcase';
import kebabCase from 'lodash.kebabcase';
import { destructuredImport, replace } from '../../utils/ast';
import { factory, ObjectLiteralExpression } from 'typescript';

export const trpcProcedureGenerator = async (tree: Tree, options: TrpcProcedureSchema) => {
  const projectConfig = readProjectConfiguration(tree, options.project);

  const procedureNameCamelCase = camelCase(options.procedure);
  const procedureNameKebabCase = kebabCase(options.procedure);

  generateFiles(tree, joinPathFragments(__dirname, 'files'), projectConfig.sourceRoot, {
    procedureNameCamelCase,
    procedureNameKebabCase,
    procedureType: options.type,
  });

  const routerPath = joinPathFragments(projectConfig.sourceRoot, 'router.ts');

  destructuredImport(tree, routerPath, [procedureNameCamelCase], `./procedures/${procedureNameKebabCase}.js`);

  replace(
    tree,
    routerPath,
    'CallExpression[expression.name="router"] > ObjectLiteralExpression',
    (node) => factory.createObjectLiteralExpression([
      ...(node as ObjectLiteralExpression).properties,
      factory.createShorthandPropertyAssignment(procedureNameCamelCase),
    ]),
  );

  await formatFilesInSubtree(tree);
};

export default trpcProcedureGenerator;
```

:::tip
使用 tsquery 选择器定位 `router` 函数的参数。可通过 [tsquery playground](https://tsquery-playground.firebaseapp.com/) 测试选择器。
:::

编译生成器：

```bash
pnpm nx run @aws/nx-plugin:compile
```

### 测试生成器

将本地插件链接到 <Link path="get_started/tutorials/dungeon-game/overview">dungeon-adventure</Link> 项目：

```bash
cd path/to/dungeon-adventure
pnpm link path/to/nx-plugin-for-aws/dist/packages/nx-plugin
```

运行生成器：

<RunGenerator generator="ts#trpc-api#procedure" />

:::note
若在 VSCode 中未显示新生成器，尝试刷新 Nx 工作区：

<NxCommands commands={['reset']} />
:::

成功执行后，新过程应被生成并添加到 `router.ts`。

### 扩展练习

1. **嵌套操作**
   - 支持点分隔的过程名（如 `games.query`）
   - 生成反向命名过程（如 `queryGames`）
   - 创建/更新嵌套路由

2. **输入验证**
   - 确保所选项目是有效的 tRPC API（参考 `api-connection` 生成器示例）

3. **单元测试**
   - 创建虚拟工作区树
   - 预置必要文件
   - 执行生成器
   - 验证文件变更

4. **端到端测试**
   - 更新现有测试包含新生成器

5. **贡献代码**
   - 若该生成器尚未合并，提交 PR
   - 或构思其他生成器进行贡献