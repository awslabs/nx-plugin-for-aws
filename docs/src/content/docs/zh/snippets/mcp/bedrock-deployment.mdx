---
title: "MCP基岩部署"
---

import Link from '@components/link.astro';
import Infrastructure from '@components/infrastructure.astro';

### 基础设施即代码

如果您为 `computeType` 选择了 `BedrockAgentCoreRuntime`，系统会生成相应的 CDK 或 Terraform 基础设施代码，您可以用其将 MCP 服务器部署到 [Amazon Bedrock AgentCore Runtime](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agents-tools-runtime.html)。

<Infrastructure>
<Fragment slot="cdk">
系统会为您的 MCP 服务器生成一个 CDK 构造，其名称基于生成器运行时指定的 `name`（默认为 `<ProjectName>McpServer`）。

您可以在 CDK 应用中使用该 CDK 构造：

```ts {6}
import { MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // 将 MCP 服务器添加到您的堆栈
    new MyProjectMcpServer(this, 'MyProjectMcpServer');
  }
}
```

:::note
此构造使用 [`@aws-cdk/aws-bedrock-agentcore-alpha` 模块](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-bedrock-agentcore-alpha-readme.html)。
:::
</Fragment>
<Fragment slot="terraform">
系统会基于生成器运行时指定的 `name`（默认为 `<ProjectName>-mcp-server`）生成一个 Terraform 模块。

您可以在 Terraform 项目中使用该模块：

```terraform
# MCP 服务器
module "my_project_mcp_server" {
  # 指向 common/terraform 项目中生成模块的相对路径
  source = "../../common/terraform/src/app/mcp-servers/my-project-mcp-server"
}
```
</Fragment>
</Infrastructure>

:::caution
构建和部署 MCP 服务器需要 [Docker](https://www.docker.com/)。请确保已安装并启动 Docker 以避免如下错误：

```
ERROR: Cannot connect to the Docker daemon at unix://path/to/docker.sock.
```
:::

### 认证

#### IAM 认证

默认情况下，您的 MCP 服务器将使用 IAM 认证进行保护，直接部署时无需额外参数：

<Infrastructure>
<Fragment slot="cdk">
```ts {5}
import { MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectMcpServer(this, 'MyProjectMcpServer');
  }
}
```

您可以使用 `grantInvoke` 方法授予调用 Bedrock AgentCore Runtime 上 MCP 的权限。例如，您可能希望允许通过 <Link path="/guides/py-strands-agent">`py#strands-agent`</Link> 生成器创建的代理调用您的 MCP 服务器：

```ts {8}
import { MyProjectAgent, MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const agent = new MyProjectAgent(this, 'MyProjectAgent');
    const mcpServer = new MyProjectMcpServer(this, 'MyProjectMcpServer');

    mcpServer.agentCoreRuntime.grantInvoke(agent.agentCoreRuntime);
  }
}
```
</Fragment>
<Fragment slot="terraform">
```terraform
# MCP 服务器
module "my_project_mcp_server" {
  # 指向 common/terraform 项目中生成模块的相对路径
  source = "../../common/terraform/src/app/mcp-servers/my-project-mcp-server"
}
```

要授予调用权限，您需要添加如下策略，并引用 `module.my_project_mcp_server.agent_core_runtime_arn` 输出值：

```terraform
{
  Effect = "Allow"
  Action = [
    "bedrock-agentcore:InvokeAgentRuntime"
  ]
  Resource = [
    module.my_project_mcp_server.agent_core_runtime_arn,
    "${module.my_project_mcp_server.agent_core_runtime_arn}/*"
  ]
}
```
</Fragment>
</Infrastructure>

#### Cognito JWT 认证

以下演示如何为代理配置 Cognito 认证。

<Infrastructure>
<Fragment slot="cdk">
要使用 Cognito 配置 JWT 认证，请使用 `RuntimeAuthorizerConfiguration.usingCognito()` 工厂方法：

```ts {14-17}
import { MyProjectMcpServer } from ':my-scope/common-constructs';
import { RuntimeAuthorizerConfiguration } from '@aws-cdk/aws-bedrock-agentcore-alpha';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const userPool = new UserPool(this, 'UserPool');
    const client = userPool.addClient('Client', {
      authFlows: {
        userPassword: true,
      },
    });

    new MyProjectMcpServer(this, 'MyProjectMcpServer', {
      authorizerConfiguration: RuntimeAuthorizerConfiguration.usingCognito(
        userPool,
        [client],
      ),
    });
  }
}
```

或者，对于使用您自己的 OIDC 提供商的自定义 JWT 认证，请使用 `RuntimeAuthorizerConfiguration.usingJWT()`：

```ts {6-10}
import { MyProjectMcpServer } from ':my-scope/common-constructs';
import { RuntimeAuthorizerConfiguration } from '@aws-cdk/aws-bedrock-agentcore-alpha';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectMcpServer(this, 'MyProjectMcpServer', {
      authorizerConfiguration: RuntimeAuthorizerConfiguration.usingJWT(
        'https://example.com/.well-known/openid-configuration',
        ['client1', 'client2'], // 允许的客户端 ID（可选）
        ['audience1'],          // 允许的受众（可选）
      ),
    });
  }
}
```
</Fragment>
<Fragment slot="terraform">
要配置 JWT 认证，您可以编辑 MCP 服务器模块来配置 `authorizer_configuration` 变量：

```terraform {18-23}
# packages/common/terraform/src/app/mcp-servers/my-project-mcp-server/my-project-mcp-server.tf

data "aws_region" "current" {}

locals {
  aws_region = data.aws_region.current.id

  # 替换为您的用户池和客户端 ID，或通过变量暴露
  user_pool_id = "xxx"
  user_pool_client_ids = ["yyy"]
}

module "agent_core_runtime" {
  source = "../../../core/agent-core"
  agent_runtime_name = "MyProjectMcpServer"
  docker_image_tag = "my-scope-my-project-mcp-server:latest"
  server_protocol = "MCP"
  authorizer_configuration = {
    custom_jwt_authorizer = {
      discovery_url = "https://cognito-idp.${local.aws_region}.amazonaws.com/${local.user_pool_id}/.well-known/openid-configuration"
      allowed_clients = local.user_pool_client_ids
    }
  }
  env = var.env
  additional_iam_policy_statements = var.additional_iam_policy_statements
  tags = var.tags
}
```
</Fragment>
</Infrastructure>