---
title: "Implementare e configurare l'agente Story"
description: "Una guida dettagliata su come costruire un gioco di avventura in dungeon alimentato da IA agentiva utilizzando @aws/nx-plugin."
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## Task 1: Implementare lo Story Agent

Lo Story Agent Ã¨ un agente [Strands](https://strandsagents.com/) che, dato un `Game` e una lista di `Action` come contesto, farÃ  progredire una storia. Configureremo l'agente per interagire con il nostro server MCP dell'inventario per gestire gli oggetti disponibili di un giocatore.

:::note
Per questo tutorial, implementeremo l'Agente in modo "senza stato", dove ogni invocazione Ã¨ una sessione indipendente che include l'intera cronologia dei messaggi. Per ambienti di produzione, considera l'integrazione con [Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html). Per ulteriori informazioni, consulta la pagina [using AgentCore Memory with Strands](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands).
:::

### Implementazione dell'agente

Per implementare il nostro agente, aggiorna i seguenti file in `packages/story/dungeon_adventure_story/agent`:

<Tabs>
  <TabItem label="main.py">
<E2EDiff lang="python" before="dungeon-adventure/3/main.py.old.template" after="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2EDiff lang="python" before="dungeon-adventure/3/agent.py.old.template" after="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

Questa configurazione implementa:

- L'estrazione del giocatore, genere e azioni dal payload dell'agente,
- La costruzione di un client che l'Agente puÃ² utilizzare per invocare il nostro server MCP con Autenticazione SigV4, e
- La costruzione dell'agente con un prompt di sistema e gli strumenti del server MCP.

## Task 2: Deployment e testing

### Compilare il codice

Per compilare il codice:

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
Se incontri errori di linting, esegui il seguente comando per correggerli automaticamente.

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

### Effettuare il deploy dell'applicazione
Per effettuare il deploy dell'applicazione, esegui il seguente comando:

<NxCommands commands={['deploy infra dungeon-adventure-infra-sandbox/*']} />

Il deployment richiederÃ  circa 2 minuti per completarsi.

Una volta completato il deployment, vedrai output simili ai seguenti _(alcuni valori sono stati oscurati)_:

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox-Application

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

### Testare la tua API

Puoi testare la tua API in due modi:
<ul>
<li>Avviando un'istanza locale del server Agent e invocandola con `curl`, oppure</li>
<li>Chiamando l'API deployata usando curl con un token JWT.</li>
</ul>

<Tabs>
  <TabItem label="Local">
  Avvia il server Agent locale eseguendo il seguente comando:
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    Utilizza l'output `InventoryMcpArn` del deploy CDK sopra, e specifica la tua `AWS_REGION` target.
    :::

    Una volta che il server Agent Ã¨ attivo e funzionante (non vedrai alcun output), invocalo eseguendo il seguente comando:

    ```bash
    curl -N -X POST http://127.0.0.1:8081/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="Deployed">
    Per testare l'agente deployato, dovrai autenticarti con Cognito e ottenere un token JWT. Prima, imposta le tue variabili d'ambiente:

    ```bash
    # Imposta User Pool ID e Client ID dagli output CDK
    export POOL_ID="<UserPoolId dagli output CDK>"
    export CLIENT_ID="<UserPoolClientId dagli output CDK>"
    export REGION="<tua-regione>"
    ```

    Crea un utente test e ottieni un token di autenticazione:

    ```bash
    # Crea Utente
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --temporary-password "TempPass123!" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # Imposta Password Permanente (sostituisci con qualcosa di piÃ¹ sicuro!)
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --password "PermanentPass123!" \
      --region $REGION \
      --permanent > /dev/null

    # Autentica l'Utente e cattura l'ID Token
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='testuser',PASSWORD='PermanentPass123!' \
      --region $REGION | jq -r '.AuthenticationResult.IdToken')
    ```

    :::caution
    Utilizza l'output `UserIdentityUserIdentityUserPoolIdXXX` per `POOL_ID` e assicurati di avere il Client ID corrispondente dagli output del deployment CDK.
    :::

    Invoca l'agente deployato usando l'URL Bedrock AgentCore runtime:

    ```bash
    # Imposta Story Agent ARN dagli output CDK
    export AGENT_ARN="<StoryAgentArn dagli output CDK>"

    # Codifica URL dell'ARN
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # Costruisci l'URL di invocazione
    export MCP_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # Invoca l'agente
    curl -N -X POST "$MCP_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    La codifica URL Ã¨ necessaria per formattare correttamente l'ARN per l'endpoint API di Bedrock AgentCore.
    :::
  </TabItem>
</Tabs>

Se il comando viene eseguito con successo, vedrai eventi in streaming simili a:

```
data: {"init_event_loop": true}

data: {"start": true}

data: {"start_event_loop": true}

data: {"event": {"messageStart": {"role": "assistant"}}}

data: {"event": {"contentBlockDelta": {"delta": {"text": "Welcome"}, "contentBlockIndex": 0}}}

...
```

Complimenti. Hai creato e deployato il tuo primo Strands Agent su Bedrock AgentCore Runtime!  ðŸŽ‰ðŸŽ‰ðŸŽ‰