---
title: "FastAPI"
description: "Documentazione di riferimento per FastAPI"
---

import { FileTree, AnchorHeading, Tabs, TabItem } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';

[FastAPI](https://fastapi.tiangolo.com/) è un framework per la creazione di API in Python.

Il generatore FastAPI crea una nuova applicazione FastAPI con configurazione dell'infrastruttura AWS CDK o Terraform. Il backend generato utilizza AWS Lambda per il deployment serverless, esposto tramite un'API AWS API Gateway. Configura [AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/python/latest/) per l'osservabilità, inclusi logging, tracciamento AWS X-Ray e metriche Cloudwatch.

## Utilizzo

### Generare una FastAPI

Puoi generare una nuova FastAPI in due modi:

<RunGenerator generator="py#fast-api" />

### Opzioni

<GeneratorParameters generator="py#fast-api" />

<Snippet name="api/api-choice-note" />

:::tip
Seleziona `ServerlessApiGatewayRestApi` (predefinito) come `computeType` se intendi implementare operazioni di streaming.
:::

## Output del Generatore

Il generatore creerà la seguente struttura del progetto nella directory `<directory>/<api-name>`:

<FileTree>

- project.json Configurazione del progetto e target di build
- pyproject.toml Configurazione del progetto Python e dipendenze
- run.sh Script di bootstrap Lambda Web Adapter per avviare l'app FastAPI tramite uvicorn
- \<module_name>
  - \_\_init\_\_.py Inizializzazione del modulo
  - init.py Configura l'app FastAPI e il middleware powertools
  - main.py Implementazione dell'API
- scripts
  - generate_open_api.py Script per generare uno schema OpenAPI dall'app FastAPI

</FileTree>

### Infrastruttura

<Snippet name="shared-constructs" />

<Snippet name="api/shared-constructs" />

## Implementare la tua FastAPI

L'implementazione principale dell'API si trova in `main.py`. Qui è dove definisci le route API e le relative implementazioni. Ecco un esempio:

```python
from pydantic import BaseModel
from .init import app, tracer

class Item(BaseModel):
  name: str

@app.get("/items/{item_id}")
@tracer.capture_method
def get_item(item_id: int) -> Item:
    return Item(name=...)

@app.post("/items")
@tracer.capture_method
def create_item(item: Item):
    return ...
```

Il generatore configura automaticamente diverse funzionalità:

1. Integrazione con AWS Lambda Powertools per l'osservabilità
2. Middleware per la gestione degli errori
3. Correlazione richiesta/risposta
4. Raccolta delle metriche
5. Deployment AWS Lambda tramite [Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) con uvicorn
6. Streaming type-safe (solo REST API)

### Osservabilità con AWS Lambda Powertools

#### Logging

Il generatore configura il logging strutturato utilizzando AWS Lambda Powertools. Puoi accedere al logger nei tuoi route handler:

```python
from .init import app, logger

@app.get("/items/{item_id}")
def read_item(item_id: int):
    logger.info("Fetching item", extra={"item_id": item_id})
    return {"item_id": item_id}
```

Il logger include automaticamente:

- ID di correlazione per il tracciamento delle richieste
- Percorso e metodo della richiesta
- Informazioni sul contesto Lambda
- Indicatori di cold start

#### Tracciamento

Il tracciamento AWS X-Ray è configurato automaticamente. Puoi aggiungere sottosegmenti personalizzati ai tuoi trace:

```python
from .init import app, tracer

@app.get("/items/{item_id}")
@tracer.capture_method
def read_item(item_id: int):
    # Crea un nuovo sottosegmento
    with tracer.provider.in_subsegment("fetch-item-details"):
        # La tua logica qui
        return {"item_id": item_id}
```

#### Metriche

Le metriche CloudWatch vengono raccolte automaticamente per ogni richiesta. Puoi aggiungere metriche personalizzate:

```python
from .init import app, metrics
from aws_lambda_powertools.metrics import MetricUnit

@app.get("/items/{item_id}")
def read_item(item_id: int):
    metrics.add_metric(name="ItemViewed", unit=MetricUnit.Count, value=1)
    return {"item_id": item_id}
```

Le metriche predefinite includono:

- Conteggio delle richieste
- Conteggio successi/fallimenti
- Metriche sui cold start
- Metriche per route specifica

### Gestione degli Errori

Il generatore include una gestione degli errori completa:

```python
from fastapi import HTTPException

@app.get("/items/{item_id}")
def read_item(item_id: int):
    if item_id < 0:
        raise HTTPException(status_code=400, detail="Item ID must be positive")
    return {"item_id": item_id}
```

Le eccezioni non gestite vengono intercettate dal middleware e:

1. Registrano l'eccezione completa con stack trace
2. Registrano una metrica di fallimento
3. Restituiscono una risposta sicura 500 al client
4. Mantengono l'ID di correlazione

:::tip
Si consiglia di specificare i modelli di risposta per le operazioni API per una migliore generazione del codice se si utilizza il generatore `connection`. <Link path="guides/connection/react-fastapi#errors">Vedi qui per maggiori dettagli</Link>.
:::

### Streaming

:::caution
Lo streaming è supportato solo quando `computeType` è `ServerlessApiGatewayRestApi` (predefinito), poiché le API Gateway HTTP non supportano lo streaming delle risposte.
:::

La FastAPI generata supporta risposte in streaming out of the box quando si utilizza una REST API. L'infrastruttura è configurata per utilizzare [AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) per eseguire la tua FastAPI tramite uvicorn all'interno di Lambda, con `ResponseTransferMode.STREAM` in API Gateway per tutte le operazioni REST API, il che consente allo streaming di funzionare insieme alle operazioni non in streaming.

#### Utilizzo di `JsonStreamingResponse`

Il file `init.py` generato esporta una classe `JsonStreamingResponse` che fornisce streaming type-safe con una corretta generazione dello schema OpenAPI. Ciò garantisce che il <Link path="guides/connection/react-fastapi">generatore `connection`</Link> possa produrre metodi client di streaming correttamente tipizzati.

```python
from pydantic import BaseModel
from .init import app, JsonStreamingResponse

class Chunk(BaseModel):
    message: str

async def generate_chunks():
    for i in range(100):
        yield Chunk(message=f"This is chunk {i}")

@app.post(
    "/stream",
    response_class=JsonStreamingResponse,
    responses={200: JsonStreamingResponse.openapi_response(Chunk, "Stream of chunks")},
)
async def my_stream() -> JsonStreamingResponse:
    return JsonStreamingResponse(generate_chunks())
```

La classe `JsonStreamingResponse`:

1. Serializza i modelli Pydantic nel formato [JSON Lines](https://jsonlines.org/) (`application/jsonl`)
2. Fornisce un helper `openapi_response` che genera lo schema OpenAPI corretto con `itemSchema`, consentendo al <Link path="guides/connection/react-fastapi#consuming-a-stream">generatore `connection`</Link> di produrre metodi client di streaming type-safe

#### Consumo

Per consumare uno stream di risposte, puoi utilizzare il <Link path="guides/connection/react-fastapi#consuming-a-stream">generatore `connection`</Link> che fornirà un metodo type-safe per iterare sui chunk dello stream.

## Distribuire la tua FastAPI

Il generatore FastAPI crea infrastruttura come codice CDK o Terraform in base al `iacProvider` selezionato. Puoi utilizzarlo per distribuire la tua FastAPI.

<Infrastructure>
<Fragment slot="cdk">
Il costrutto CDK per distribuire la tua API si trova nella cartella `common/constructs`. Puoi usarlo in un'applicazione CDK:

```ts {6-8}
import { MyApi } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // Aggiungi l'API allo stack
    const api = new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });
  }
}
```

Questo configura:

1. Una funzione AWS Lambda per ogni operazione nell'applicazione FastAPI
2. API Gateway HTTP/REST API come trigger della funzione
3. Ruoli e permessi IAM
4. Log group CloudWatch
5. Configurazione del tracciamento X-Ray
6. Namespace per le metriche CloudWatch

<Snippet name="api/cors-configuration-cdk-note" />

:::note
Se hai selezionato l'autenticazione `Cognito`, dovrai fornire la proprietà `identity` al costrutto API:

```ts {9}
import { MyApi, UserIdentity } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const identity = new UserIdentity(this, 'Identity');

    const api = new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
      identity,
    });
  }
}
```

Il costrutto `UserIdentity` può essere generato utilizzando il <Link path="/guides/react-website-auth">generatore `ts#react-website-auth`</Link>
:::
</Fragment>
<Fragment slot="terraform">
I moduli Terraform per distribuire la tua API si trovano nella cartella `common/terraform`. Puoi usarli in una configurazione Terraform:

```hcl {2}
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  # Variabili d'ambiente per la funzione Lambda
  env = {
    ENVIRONMENT = var.environment
    LOG_LEVEL   = "INFO"
  }

  # Policy IAM aggiuntive se necessarie
  additional_iam_policy_statements = [
    # Aggiungi eventuali permessi aggiuntivi richiesti dalla tua API
  ]

  tags = local.common_tags
}
```

Questo configura:

1. Una funzione AWS Lambda che serve tutte le route FastAPI
2. API Gateway HTTP/REST API come trigger della funzione
3. Ruoli e permessi IAM
4. Log group CloudWatch
5. Configurazione del tracciamento X-Ray
6. Configurazione CORS

<Snippet name="api/cors-configuration-terraform-note" />

:::note
Se hai selezionato l'autenticazione `Cognito`, dovrai fornire la configurazione Cognito:

```hcl {4-5}
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  user_pool_id         = local.user_pool_id
  user_pool_client_ids = [local.client_id]

  env = {
    ENVIRONMENT = var.environment
    LOG_LEVEL   = "INFO"
  }

  tags = local.common_tags
}
```

Puoi configurare User Pool e Client Cognito utilizzando le risorse o moduli Terraform appropriati.
:::

Il modulo Terraform fornisce diversi output utilizzabili:

```hcl
# Accedi all'endpoint API
output "api_url" {
  value = module.my_api.stage_invoke_url
}

# Accedi ai dettagli della funzione Lambda
output "lambda_function_name" {
  value = module.my_api.lambda_function_name
}

# Accedi al ruolo IAM per concedere permessi aggiuntivi
output "lambda_execution_role_arn" {
  value = module.my_api.lambda_execution_role_arn
}
```

Puoi personalizzare le impostazioni CORS passando variabili al modulo:

```hcl
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  # Configurazione CORS personalizzata
  cors_allow_origins = ["https://myapp.com", "https://staging.myapp.com"]
  cors_allow_methods = ["GET", "POST", "PUT", "DELETE"]
  cors_allow_headers = [
    "authorization",
    "content-type",
    "x-custom-header"
  ]

  tags = local.common_tags
}
```

:::caution
Se hai selezionato `None` per `auth` durante l'esecuzione del generatore, potresti vedere errori nei check Checkov come:

<Tabs syncKey="http-rest">
<TabItem label="HTTP API">
```
Check: CKV_AWS_309: "Ensure API GatewayV2 routes specify an authorization type"
 FAILED for resource: aws_apigatewayv2_route.proxy_routes["PUT"]
```
</TabItem>
<TabItem label="REST API">
```
Check: CKV_AWS_59: "Ensure there is no open access to back-end resources through API"
 FAILED for resource: aws_api_gateway_method.proxy_method
```
</TabItem>
</Tabs>

Puoi [aggiungere un commento di soppressione](https://www.checkov.io/2.Basics/Suppressing%20and%20Skipping%20Policies.html) se sei sicuro di volere la tua API pubblica.
:::
</Fragment>
</Infrastructure>

### Integrazioni

<Snippet name="api/type-safe-api-integrations" parentHeading="Integrazioni" />

#### Generazione del Codice

<Infrastructure>
<Fragment slot="cdk">
Poiché le operazioni in FastAPI sono definite in Python e l'infrastruttura CDK in TypeScript, strumentiamo la generazione del codice per fornire metadati al costrutto CDK e garantire un'interfaccia type-safe per le integrazioni.

Un target `generate:<ApiName>-metadata` viene aggiunto al `project.json` dei costrutti comuni per facilitare questa generazione, producendo un file come `packages/common/constructs/src/generated/my-api/metadata.gen.ts`. Essendo generato al momento della build, viene ignorato nel version control.

:::note
Dovrai eseguire una build ogni volta che modifichi la tua API per garantire che i tipi consumati dal costrutto CDK siano aggiornati.

<PackageManagerShortCommand commands={["build"]} />
:::

:::tip
Se stai lavorando attivamente sia sull'infrastruttura CDK che su FastAPI, puoi usare [`nx watch`](https://nx.dev/nx-api/nx/documents/watch) per rigenerare questi tipi ogni volta che apporti modifiche all'API:

<NxCommands
  commands={[
    'watch --projects=<FastAPIProject> -- \\ ',
    'run <InfraProject>:"generate:<ApiName>-metadata"',
  ]}
/>
:::
</Fragment>
<Fragment slot="terraform">
:::note
Non supportiamo integrazioni type-safe per Terraform, quindi nessun target di generazione codice viene configurato se hai selezionato Terraform come `iacProvider`.
:::
</Fragment>
</Infrastructure>

### Concessione dell'Accesso (Solo IAM)

Se hai selezionato l'autenticazione `IAM`, puoi usare il metodo `grantInvokeAccess` per concedere l'accesso alla tua API:

<Infrastructure>
<Fragment slot="cdk">
```ts
api.grantInvokeAccess(myIdentityPool.authenticatedRole);
```
</Fragment>
<Fragment slot="terraform">
```hcl
# Crea una policy IAM per consentire l'invocazione dell'API
resource "aws_iam_policy" "api_invoke_policy" {
  name        = "MyApiInvokePolicy"
  description = "Policy per consentire l'invocazione della FastAPI"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = "execute-api:Invoke"
        Resource = "${module.my_api.api_execution_arn}/*/*"
      }
    ]
  })
}

# Allega la policy a un ruolo IAM (es. per utenti autenticati)
resource "aws_iam_role_policy_attachment" "api_invoke_access" {
  role       = aws_iam_role.authenticated_user_role.name
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}

# O allega a un ruolo esistente per nome
resource "aws_iam_role_policy_attachment" "api_invoke_access_existing" {
  role       = "MyExistingRole"
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}
```

Gli output principali dal modulo API utilizzabili per le policy IAM sono:

- `module.my_api.api_execution_arn` - Per concedere permessi execute-api:Invoke
- `module.my_api.api_arn` - L'ARN di API Gateway
- `module.my_api.lambda_function_arn` - L'ARN della funzione Lambda
</Fragment>
</Infrastructure>

## Sviluppo Locale

Il generatore configura un server di sviluppo locale che puoi eseguire con:

<NxCommands commands={['run my-api:serve']} />

Questo avvia un server di sviluppo FastAPI locale con:

- Auto-reload alle modifiche del codice
- Documentazione API interattiva su `/docs` o `/redoc`
- Schema OpenAPI su `/openapi.json`

## Invocare la tua FastAPI

Per invocare la tua API da un sito React, puoi utilizzare il <Link path="guides/connection/react-fastapi">generatore `connection`</Link>.