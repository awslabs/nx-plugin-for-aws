---
title: "Infrastruttura Terraform"
description: "Documentazione di riferimento per l'Infrastruttura Terraform"
---



import { FileTree, Tabs, TabItem } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import Link from '@components/link.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';

[Terraform](https://www.terraform.io/) è uno strumento open-source per l'infrastruttura come codice che permette di creare, modificare e migliorare l'infrastruttura in modo sicuro e prevedibile.

Il generatore di infrastruttura Terraform crea un progetto infrastrutturale Terraform. L'applicazione generata include le migliori pratiche di sicurezza attraverso i controlli di [Checkov](https://www.checkov.io/).

## Utilizzo

### Generare un Progetto Terraform

Puoi generare un nuovo progetto Terraform in due modi:

<RunGenerator generator="terraform#project" requiredParameters={{ name: 'tf-infra' }} />

### Opzioni

<GeneratorParameters generator="terraform#project" />

## Output del Generatore

Il generatore crea strutture di file diverse in base al tipo di progetto:

### Tipo Applicazione

Per progetti di tipo applicazione (`--type=application`), il generatore crea un'applicazione Terraform completa con gestione dello stato remoto:

<FileTree>

  - src
    - main.tf File di configurazione principale Terraform
    - providers.tf Configurazione provider con backend S3
    - variables.tf Definizioni variabili di input
    - outputs.tf Definizioni valori di output
    - env File variabili specifici per ambiente
      - dev.tfvars Variabili ambiente di sviluppo
  - bootstrap Configurazione bootstrap per stato remoto
    - main.tf Bucket S3 e politiche per lo storage dello stato
    - providers.tf Configurazione provider AWS
    - variables.tf Definizioni variabili bootstrap
  - project.json Configurazione progetto e target di build

</FileTree>

:::note
Il generatore crea anche una libreria `packages/common/terraform` che inizialmente aggiunge solo un modulo metrics (crea uno stack Cloudformation vuoto con metadati) strumentato automaticamente per permettere al team `nx-plugin-for-aws` di tracciare le metriche d'uso.
:::

### Tipo Libreria

Per progetti di tipo libreria (`--type=library`), il generatore crea una struttura più semplice per moduli Terraform riutilizzabili:

<FileTree>

  - src
    - main.tf File principale modulo Terraform
  - project.json Configurazione progetto e target di build

</FileTree>

:::tip
I progetti applicazione includono capacità di deployment completo con gestione stato remoto, mentre i progetti libreria sono pensati per creare moduli Terraform riutilizzabili consumabili da altri progetti.
:::

## Implementare la tua Infrastruttura Terraform

Puoi iniziare a scrivere la tua infrastruttura Terraform nel file `src/main.tf`, ad esempio:

```diff title="src/main.tf" {2-4}
-locals {
-  account_id = data.aws_caller_identity.current.account_id
-  aws_region = data.aws_region.current.id
-}
-
-resource "null_resource" "print_info" {
-  # triggers = {
-  #   always_run = timestamp()
-  # }
-
-  provisioner "local-exec" {
-    command = "echo 'AWS Region: ${local.aws_region}, AWS Account: ${local.account_id}, Environment: ${var.environment}'"
-  }
-}
+
+# Dichiarare la propria infrastruttura qui
+resource "aws_s3_bucket" "my_bucket" {
+  bucket = "my-unique-bucket-name"
+}
```

### Dipendenze cross-project

Per eseguire un modulo da un progetto separato (lib), puoi farlo così:

```
module "lib_module" {
  source = "../../path/to/my-lib/src"
}
```

Questo aggiornerà automaticamente il grafo Nx aggiungendo una dipendenza tra l'applicazione consumatrice e la tua libreria.

### Configurazione Ambiente

Configura le variabili specifiche per ambiente nei file `src/env/*.tfvars`.

Per aggiungere nuovi ambienti, crea un nuovo file `src/env/<ambiente>.tfvars` con le variabili specifiche e aggiungi nuove voci per `apply, destroy, init, plan` nel `project.json` per la nuova configurazione ambiente. Esempio per aggiungere un ambiente `prod`:

<Tabs>
<TabItem label="src/env/prod.tfvars">
```hcl
# Variabili ambiente produzione
environment = "prod"
region      = "us-west-2"
```
</TabItem>
<TabItem label="project.json">
```diff
{
  "targets": {
        "apply": {
            "executor": "nx:run-commands",
            "defaultConfiguration": "dev",
            "configurations": {
                "dev": {
                    "command": "terraform apply ../../../dist/packages/infra/terraform/dev.tfplan"
                },
+                "prod": {
+                    "command": "terraform apply ../../../dist/packages/infra/terraform/prod.tfplan"
+                }
            },
            "options": {
                "forwardAllArgs": true,
                "cwd": "{projectRoot}/src"
            },
            "dependsOn": ["plan"]
        },
        "destroy": {
            "executor": "nx:run-commands",
            "defaultConfiguration": "dev",
            "configurations": {
                "dev": {
                    "command": "terraform destroy -var-file=env/dev.tfvars"
                },
+                "prod": {
+                    "command": "terraform destroy -var-file=env/prod.tfvars"
+                }
            },
            "options": {
                "forwardAllArgs": true,
                "cwd":"{projectRoot}/src"
            },
            "dependsOn": ["init"]
        },
        "init": {
            "executor": "nx:run-commands",
            "defaultConfiguration": "dev",
            "configurations": {
                "dev": {
                    "command": "terraform init -reconfigure -backend-config=\"region=$(aws configure get region)\" -backend-config=\"bucket=$(aws sts get-caller-identity --query Account --output text)-tf-state-$(aws configure get region)\" -backend-config=\"key=dev/terraform.tfstate\""
                },
+                "prod": {
+                    "command": "terraform init -reconfigure -backend-config=\"region=$(aws configure get region)\" -backend-config=\"bucket=$(aws sts get-caller-identity --query Account --output text)-tf-state-$(aws configure get region)\" -backend-config=\"key=prod/terraform.tfstate\""
+                }
            },
            "options": {
                "forwardAllArgs": true,
                "cwd": "{projectRoot}/src"
            }
        },
        "plan": {
            "executor": "nx:run-commands",
            "defaultConfiguration": "dev",
            "configurations": {
                "dev": {
                    "command": "terraform plan -var-file=env/dev.tfvars -out=../../../dist/packages/infra/terraform/dev.tfplan"
                },
+                "prod": {
+                    "command": "terraform plan -var-file=env/dev.tfvars -out=../../../dist/packages/infra/terraform/prod.tfplan"
+                }
            },
            "options": {
                "forwardAllArgs": true,
                "cwd": "{projectRoot}/src"
            },
            "dependsOn": ["init"]
        }
    }
}
```
</TabItem>
</Tabs>

:::tip
Per default tutti i target assumono l'ambiente `dev`, ma puoi specificare un ambiente con: <NxCommands commands={['run tf-infra:apply --configuration=prod']} />

Puoi cambiare ambiente in qualsiasi momento poiché lo stato separa automaticamente il tfstate tra ambienti.
:::

### Bootstrap Stato Remoto (Solo Progetti Applicazione)

Per i progetti applicazione, prima di deployare l'infrastruttura, devi eseguire il bootstrap del backend per lo stato remoto. Questo crea un bucket S3 per archiviare i file di stato Terraform:

<NxCommands commands={['run tf-infra:bootstrap']} />

:::note
Assicurati che il profilo AWS CLI sia configurato per l'account/regione dove vuoi deployare le risorse bootstrap.

Il target bootstrap è disponibile solo per progetti di tipo applicazione. I progetti libreria non richiedono gestione stato remoto essendo moduli riutilizzabili.
:::

## Target Disponibili

I target disponibili dipendono dal tipo di progetto:

### Target Comuni (Applicazione e Libreria)

#### Validazione Infrastruttura

Valida la configurazione Terraform con il target `validate`:

<NxCommands commands={['run tf-infra:validate']} />

#### Formattazione Codice

Formatta il codice Terraform con il target `fmt`:

<NxCommands commands={['run tf-infra:fmt']} />

#### Test Sicurezza

Esegui controlli sicurezza con Checkov usando il target `test`:

<NxCommands commands={['run tf-infra:test']} />

Troverai i risultati dei test sicurezza nella cartella `dist` principale, sotto `dist/packages/<my-terraform-project>/checkov`.

### Target Solo Applicazione

Questi target sono disponibili solo per progetti di tipo applicazione:

#### Pianificazione Infrastruttura

Prima di applicare modifiche, visualizza le azioni di Terraform con il target `plan`:

<NxCommands commands={['run tf-infra:plan']} />

Questo creerà un file di plan in `dist/packages/<my-terraform-project>/terraform/dev.tfplan`.

#### Inizializzazione Terraform

Inizializza la directory di lavoro Terraform con il target `init`:

<NxCommands commands={['run tf-infra:init']} />

#### Deploy su AWS

Dopo la pianificazione, deploya l'infrastruttura su AWS con il target `apply`:

<NxCommands commands={['run tf-infra:apply']} />

:::tip
Il comando sopra applica il plan creato dal target `plan`. Assicurati di eseguire prima `plan` per verificare le modifiche.
:::

#### Ottenere Output

Recupera i valori di output dalla configurazione Terraform:

<NxCommands commands={['run tf-infra:output']} />

#### Distruzione Infrastruttura

Per eliminare l'infrastruttura, usa il target `destroy`:

<NxCommands commands={['run tf-infra:destroy']} />

:::caution
Questo eliminerà permanentemente tutte le risorse gestite da questa configurazione Terraform. Usa con cautela!
:::

#### Distruzione Risorse Bootstrap

Per eliminare le risorse bootstrap (bucket S3 per lo stato):

<NxCommands commands={['run tf-infra:bootstrap-destroy']} />

## Ulteriori Informazioni

Per maggiori informazioni su Terraform, consulta la [Documentazione Terraform](https://www.terraform.io/docs) e la [Documentazione AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs).