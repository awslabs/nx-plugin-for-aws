---
title: "Infrastruttura CDK"
description: "Documentazione di riferimento per l'infrastruttura CDK"
---



import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import Link from '@components/link.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';

[AWS CDK](https://docs.aws.amazon.com/cdk/v2/guide/home.html) è un framework per definire infrastrutture cloud tramite codice e provisionarle attraverso AWS CloudFormation.

Il generatore di infrastruttura TypeScript crea un'applicazione AWS CDK scritta in TypeScript. L'applicazione generata include best practice di sicurezza attraverso controlli [Checkov](https://www.checkov.io/).

## Utilizzo

### Genera un progetto di infrastruttura

Puoi generare un nuovo progetto di infrastruttura in due modi:

<RunGenerator generator="ts#infra" />

### Opzioni

<GeneratorParameters generator="ts#infra" />

## Output del generatore

Il generatore creerà la seguente struttura del progetto nella directory `<directory>/<name>`:

<FileTree>

  - src
    - main.ts Punto d'ingresso dell'applicazione che istanzia gli stage CDK da deployare
    - stages Definizioni degli stage CDK
      - application-stage.ts Definisce una collezione di stack da deployare in uno stage
    - stacks Definizioni degli stack CDK
      - application-stack.ts Stack applicativo principale
  - cdk.json Configurazione CDK
  - project.json Configurazione del progetto e target di build
  - checkov.yml File di configurazione Checkov

</FileTree>

:::tip
La tua infrastruttura è un progetto TypeScript, puoi consultare la <Link path="guides/typescript-project">documentazione sui progetti TypeScript</Link> per dettagli sull'utilizzo generale.
:::

## Implementare la tua infrastruttura CDK

Puoi iniziare a scrivere la tua infrastruttura CDK in `src/stacks/application-stack.ts`, ad esempio:

```ts title="src/stacks/application-stack.ts" {9-10}
import { Stack, StackProps } from 'aws-cdk-lib';
import { Bucket } from 'aws-cdk-lib/aws-s3'
import { Construct } from 'constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // Dichiarare la propria infrastruttura qui
    new Bucket(this, 'MyBucket');
  }
}
```

### Stage e Stack

Noterai che il file principale `src/main.ts` istanzia uno [Stage](https://docs.aws.amazon.com/cdk/v2/guide/stages.html) CDK chiamato `<namespace>-sandbox`. Questo stage è pensato per sviluppo e testing.

```ts title="src/main.ts"
new ApplicationStage(app, 'project-sandbox', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  },
});
```

Puoi aggiungere altri stage, ad esempio potresti definire stage `beta` e `prod` che deployano su ambienti separati:

```ts title="src/main.ts"
new ApplicationStage(app, 'project-beta', {
  env: {
    account: '123456789012', // account beta
    region: 'us-west-2',
  },
});
new ApplicationStage(app, 'project-prod', {
  env: {
    account: '098765432109', // account prod
    region: 'us-west-2',
  },
});
```

Uno Stage definisce una collezione di stack da deployare insieme. Puoi istanziare quanti stack desideri all'interno di uno stage, ad esempio:

```ts title="src/stages/application-stage.ts"
import { Stage, StageProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { BackendStack } from '../stacks/backend-stack.js';
import { FrontendStack } from '../stacks/frontend-stack.js';

/**
 * Definisce una collezione di stack CDK che compongono l'applicazione
 */
export class ApplicationStage extends Stage {
  constructor(scope: Construct, id: string, props?: StageProps) {
    super(scope, id, props);

    new BackendStack(this, 'Backend', {
      crossRegionReferences: true,
    })

    new FrontendStack(this, 'Frontend', {
      crossRegionReferences: true,
    });
  }
}
```

### Infrastruttura per API

Se hai usato i generatori <Link path="guides/trpc">tRPC API</Link> o <Link path="guides/fastapi">FastAPI</Link>, noterai dei costrutti disponibili in `packages/common/constructs` per deployarli.

Ad esempio, se hai creato un'API tRPC chiamata `my-api`, puoi importare e istanziare il costrutto per aggiungere l'infrastruttura necessaria:

```ts title="src/stacks/application-stack.ts" {3, 9-12}
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyApi } from ':my-scope/common-constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Aggiungi infrastruttura per la tua API
    new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });
  }
}
```

### Infrastruttura per website

Se hai usato il generatore <Link path="guides/react-website">CloudScape website</Link>, troverai un costrutto in `packages/common/constructs` per il deploy. Esempio:

```ts title="src/stacks/application-stack.ts" {3, 9-10}
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyWebsite } from ':my-scope/common-constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Aggiungi infrastruttura per il website
    new MyWebsite(this, 'MyWebsite');
  }
}
```

:::warning
È importante dichiarare il website _dopo_ eventuali costrutti API per includere tutta la configurazione API nel <Link path="guides/react-website#runtime-configuration">Runtime Config</Link> del website.
:::

## Sintetizzare l'infrastruttura

Oltre ai <Link path="guides/typescript-project#building">target predefiniti di compilazione, lint e test</Link>, il target `build` sintetizza l'infrastruttura in CloudFormation. Puoi eseguire questa operazione separatamente con il target `synth`:

<NxCommands commands={['run <my-infra>:synth']} />

Troverai l'assembly cloud sintetizzato nella cartella `dist` principale, sotto `dist/packages/<my-infra-project>/cdk.out`.

## Test di sicurezza

Il target `checkov` esegue controlli di sicurezza sull'infrastruttura usando [Checkov](https://www.checkov.io/).

<NxCommands commands={['run <my-infra>:checkov']} />

I risultati dei test si trovano nella cartella `dist` principale, sotto `dist/packages/<my-infra-project>/checkov`.

:::note
Checkov viene eseguito con `uvx`, devi [installare `uv` se non l'hai già fatto](https://docs.astral.sh/uv/getting-started/installation/).
:::

:::caution
Alcune regole Checkov sono disabilitate di default via file `checkov.yml`. Si raccomanda di revisionarle in base al caso d'uso.
:::

### Disabilitare regole Checkov

Puoi disabilitare regole specifiche in due modi:

#### Disabilitare una regola su un costrutto

```typescript
import { suppressRules } from ':my-scope/common-constructs';

// sopprime la regola CKV_AWS_XXX per il costrutto
suppressRules(construct, ['CKV_AWS_XXX'], 'Motivazione');
```

#### Disabilitare una regola su costrutti discendenti

```typescript
import { suppressRules } from ':my-scope/common-constructs';

// Sopprime CKV_AWS_XXX per il costrutto o suoi discendenti se sono istanze di Bucket
suppressRules(construct, ['CKV_AWS_XXX'], 'Motivazione', (construct) => construct instanceof Bucket);
```

## Bootstrap dell'account AWS

Per deployare un'applicazione CDK in un account AWS per la prima volta, è necessario eseguire il bootstrap.

Prima, configura le [credenziali per il tuo account AWS](https://docs.aws.amazon.com/sdkref/latest/guide/access.html).

Poi usa il comando `cdk bootstrap`:

```bash
npx cdk bootstrap aws://<account-id>/<region>
```

Per dettagli, consulta la [documentazione CDK](https://docs.aws.amazon.com/cdk/v2/guide/bootstrapping-env.html).

## Deploy su AWS

Dopo una build, puoi deployare l'infrastruttura con il target `deploy`.

:::caution
Usa il target `deploy-ci` per deploy in pipeline CI/CD. Vedi sotto per dettagli.
:::

Prima, configura le [credenziali per il tuo account AWS](https://docs.aws.amazon.com/sdkref/latest/guide/access.html).

Poi esegui:

<NxCommands commands={['run <my-infra>:deploy <my-infra>-sandbox/*']} />

:::tip
Il comando sopra deploya _tutti_ gli stack dello stage `<my-infra>-sandbox`. Puoi specificare altri stage definiti in `main.ts`.

Puoi anche deployare singoli stack specificando il nome completo:

<NxCommands commands={['run <my-infra>:deploy <my-infra>-sandbox/Application']} />
:::

## Deploy su AWS in pipeline CI/CD

Usa il target `deploy-ci` per deploy in pipeline CI/CD:

<NxCommands commands={['run <my-infra>:deploy-ci my-stage/*']} />

Questo target utilizza l'assembly cloud pre-sintetizzato invece di sintetizzarlo al volo, evitando problemi di non-determinismo legati alle versioni dei pacchetti.

## Rimozione dell'infrastruttura AWS

Usa il target `destroy` per rimuovere le risorse:

<NxCommands commands={['run <my-infra>:destroy <my-infra>-sandbox/*']} />

## Ulteriori informazioni

Per maggiori dettagli su CDK, consulta la [CDK Developer Guide](https://docs.aws.amazon.com/cdk/v2/guide/core_concepts.html) e l'[API Reference](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html).