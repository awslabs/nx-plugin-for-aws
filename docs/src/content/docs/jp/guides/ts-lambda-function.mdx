---
title: "TypeScriptのLambda関数"
description: "TypeScriptのLambda関数を生成する"
---



import { FileTree } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';

TypeScript Lambda Function ジェネレータは、既存のTypeScriptプロジェクトにLambda関数を追加する機能を提供します。

このジェネレータはAWS CDKインフラストラクチャ設定を備えた新しいTypeScript Lambdaハンドラを作成します。生成されたハンドラは、[AWS Lambda Powertools for TypeScript](https://docs.powertools.aws.dev/lambda/typescript/latest/)を使用して、ロギング、AWS X-Rayトレーシング、CloudWatchメトリクスなどの観測可能性を実現し、[AWS Lambda PowertoolsのParser](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/)を使用したイベントの型安全性（オプション）を提供します。

## 使用方法

### TypeScript Lambda関数の生成

Lambda関数は2つの方法で生成できます：

<RunGenerator generator="ts#lambda-function" />

### オプション

<GeneratorParameters generator="ts#lambda-function" />

## ジェネレータの出力

ジェネレータはプロジェクトに以下のファイルを追加します：

<FileTree>

- \<project-name>
  - src/
    - \<lambda-function>.ts 関数実装

</FileTree>

ジェネレータはまた、関数のデプロイに使用できるCDKコンストラクトを`packages/common/constructs/src/app/lambda-functions`ディレクトリに作成します。

`functionPath`オプションが指定された場合、ジェネレータはプロジェクトソースディレクトリ内の指定パスにハンドラを追加します：

<FileTree>

- \<project-name>
  - src/
    - \<custom-path>/
      - \<function-name>.ts 関数実装

</FileTree>

## 関数の実装

メインの関数実装は`<function-name>.ts`にあります。以下は実装例です：

```typescript
import { parser } from '@aws-lambda-powertools/parser/middleware';
import { EventBridgeSchema } from '@aws-lambda-powertools/parser/schemas';
import middy from '@middy/core';
import { Tracer } from '@aws-lambda-powertools/tracer';
import { captureLambdaHandler } from '@aws-lambda-powertools/tracer/middleware';
import { injectLambdaContext } from '@aws-lambda-powertools/logger/middleware';
import { Logger } from '@aws-lambda-powertools/logger';
import { Metrics, MetricUnit } from '@aws-lambda-powertools/metrics';
import { logMetrics } from '@aws-lambda-powertools/metrics/middleware';

process.env.POWERTOOLS_METRICS_NAMESPACE = "MyFunction";
process.env.POWERTOOLS_SERVICE_NAME = "MyFunction";

const tracer = new Tracer();
const logger = new Logger();
const metrics = new Metrics();

export const handler = middy()
  .use(captureLambdaHandler(tracer))
  .use(injectLambdaContext(logger))
  .use(logMetrics(metrics))
  .use(parser({ schema: EventBridgeSchema }))
  .handler(async (event) => {
    logger.info("Received event", event);

    metrics.addMetric("InvocationCount", MetricUnit.Count, 1);

    try {
        // TODO: 実装
        metrics.addMetric("SuccessCount", MetricUnit.Count, 1);
        // TODO: 必要に応じて成功レスポンスを実装
    } catch (e) {
        logger.error("Error processing event", e as Error);
        metrics.addMetric("ErrorCount", MetricUnit.Count, 1);
        // TODO: 必要に応じてエラーレスポンスを実装
    }
  });
```

ジェネレータは以下の機能を自動的に設定します：

1. **Middyミドルウェアスタック** - Lambda機能拡張のため
2. **AWS Lambda Powertools統合** - 観測可能性のため
3. **CloudWatchメトリクス収集**
4. **型安全性** - パーサーミドルウェアを使用
5. **esbuildバンドリング** - 最適化されたデプロイパッケージのため

### AWS Lambda Powertoolsによる観測可能性

#### ロギング

ジェネレータはMiddyミドルウェアを使用した構造化ロギングを自動設定します：

```typescript
export const handler = middy()
  .use(injectLambdaContext(logger))
  .handler(async (event) => {
    logger.info("Received event", event);
    logger.error("Error processing event", error);
  });
```

#### トレーシング

AWS X-Rayトレーシングは`captureLambdaHandler`ミドルウェアで自動設定されます。カスタムサブセグメントを追加可能です：

```typescript
export const handler = middy()
  .use(captureLambdaHandler(tracer))
  .handler(async (event) => {
    // 新しいサブセグメントを作成
    const subsegment = tracer.getSegment()?.addNewSubsegment('custom-operation');
    try {
      // 処理を実装
    } catch (error) {
      subsegment?.addError(error as Error);
      throw error;
    } finally {
      subsegment?.close();
    }
  });
```

#### メトリクス

CloudWatchメトリクスは`logMetrics`ミドルウェアで自動収集されます。カスタムメトリクスを追加可能です：

```typescript
export const handler = middy()
  .use(logMetrics(metrics))
  .handler(async (event) => {
    metrics.addMetric("CustomMetric", MetricUnit.Count, 1);
    metrics.addMetric("ProcessingTime", MetricUnit.Milliseconds, processingTime);
  });
```

### 型安全性

Lambda関数生成時に`eventSource`を選択した場合、[AWS Lambda Powertoolsの`parser`ミドルウェア](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/)が組み込まれます：

```typescript {4}
export const handler = middy()
  .use(parser({ schema: EventBridgeSchema }))
  .handler(async (event) => {
    event.detail // <- IDEオートコンプリート対応の型安全なアクセス
  });
```

これによりコンパイル時の型安全性とランタイムバリデーションが実現されます。

:::caution
イベントがスキーマに適合しない場合にエラーをスローしたくない場合は、[`safeParse`オプション](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/#safe-parsing)を使用できます。
:::

:::tip
DynamoDBストリームやEventBridgeイベントなど、カスタムデータを含むイベントの場合、[Envelopes](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/#envelopes)を使用して型安全性を確保できます。
:::

イベントの型指定が必要ない場合は、`eventSource`に`Any`を選択すると、イベントパラメータは`any`型になります。

## バンドリング

ジェネレータは最適化されたLambdaデプロイパッケージのために[esbuild](https://esbuild.github.io/)を自動設定します：

特定のLambda関数をバンドル：

<NxCommands commands={['run <project-name>:bundle-<function-name>']} />

プロジェクト内の全Lambda関数をバンドル：

<NxCommands commands={['run <project-name>:bundle']} />

## 関数のデプロイ

TypeScript Lambda Functionジェネレータは`common/constructs`フォルダにCDKコンストラクトを作成します。CDKアプリケーションで使用可能です：

```typescript {1, 6}
import { MyProjectMyFunction } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // スタックに関数を追加
    const fn = new MyProjectMyFunction(this, 'MyFunction');
  }
}
```

これにより以下が設定されます：

1. AWS Lambda関数
2. CloudWatchロググループ
3. X-Rayトレーシング設定
4. CloudWatchメトリクスネームスペース

この関数は任意のLambda[イベントソース](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/)のターゲットとして使用可能です：

:::note
イベントソースが選択した`eventSource`オプションと一致することを確認してください。
:::

以下はEventBridgeスケジュールでLambda関数を起動するCDKコード例です：

```typescript
import { Rule, Schedule } from 'aws-cdk-lib/aws-events';
import { LambdaFunction } from 'aws-cdk-lib/aws-events-targets';
import { MyProjectMyFunction } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // スタックに関数を追加
    const fn = new MyProjectMyFunction(this, 'MyFunction');

    // EventBridgeスケジュールルールに関数を追加
    const eventRule = new Rule(this, 'MyFunctionScheduleRule', {
      schedule: Schedule.cron({ minute: '15' }),
      targets: [new LambdaFunction(fn)],
    });
  }
}
```