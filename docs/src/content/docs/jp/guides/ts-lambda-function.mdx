---
title: "TypeScriptのLambda関数"
description: "TypeScriptのLambda関数を生成する"
---



import { FileTree } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';

TypeScript Lambda関数ジェネレータは、既存のTypeScriptプロジェクトにLambda関数を追加する機能を提供します。

このジェネレータは、AWS CDKまたはTerraformのインフラストラクチャ設定を含む新しいTypeScript Lambdaハンドラを作成します。生成されたハンドラは、[AWS Lambda Powertools for TypeScript](https://docs.powertools.aws.dev/lambda/typescript/latest/)を使用して、ロギング、AWS X-Rayトレーシング、CloudWatchメトリクスなどの観測可能性を実現し、[AWS Lambda PowertoolsのParser](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/)を使用したイベントの型安全性（オプション）を提供します。

## 使用方法

### TypeScript Lambda関数の生成

Lambda関数は2つの方法で生成できます：

<RunGenerator generator="ts#lambda-function" />

### オプション

<GeneratorParameters generator="ts#lambda-function" />

## ジェネレータの出力

ジェネレータはプロジェクトに以下のファイルを追加します：

<FileTree>

- \<project-name>
  - src/
    - \<lambda-function>.ts 関数実装

</FileTree>

`functionPath`オプションが指定された場合、ジェネレータはプロジェクトソースディレクトリ内の指定パスにハンドラを追加します：

<FileTree>

- \<project-name>
  - src/
    - \<custom-path>/
      - \<function-name>.ts 関数実装

</FileTree>

### インフラストラクチャ

<Snippet name="shared-constructs" />

ジェネレータは選択した`iacProvider`に基づいて、関数をデプロイするためのインフラストラクチャコードを作成します：

<Infrastructure>
<Fragment slot="cdk">
ジェネレータはCDKコンストラクトを作成します。これは`packages/common/constructs/src/app/lambda-functions`ディレクトリに配置され、関数のデプロイに使用できます。
</Fragment>
<Fragment slot="terraform">
ジェネレータはTerraformモジュールを作成します。これは`packages/common/terraform/src/app/lambda-functions/<function-name>`ディレクトリに配置され、関数のデプロイに使用できます。
</Fragment>
</Infrastructure>

## 関数の実装

メインの関数実装は`<function-name>.ts`にあります。以下は実装例です：

```typescript
import { parser } from '@aws-lambda-powertools/parser/middleware';
import { EventBridgeSchema } from '@aws-lambda-powertools/parser/schemas';
import middy from '@middy/core';
import { Tracer } from '@aws-lambda-powertools/tracer';
import { captureLambdaHandler } from '@aws-lambda-powertools/tracer/middleware';
import { injectLambdaContext } from '@aws-lambda-powertools/logger/middleware';
import { Logger } from '@aws-lambda-powertools/logger';
import { Metrics } from '@aws-lambda-powertools/metrics';
import { logMetrics } from '@aws-lambda-powertools/metrics/middleware';
import { z } from 'zod';

process.env.POWERTOOLS_METRICS_NAMESPACE = 'MyFunction';
process.env.POWERTOOLS_SERVICE_NAME = 'MyFunction';

const tracer = new Tracer();
const logger = new Logger();
const metrics = new Metrics();

export const myFunction = async (
  event: z.infer<typeof EventBridgeSchema>,
): Promise<void> => {
  logger.info('Received event', event);

  // TODO: 実装を追加
};

export const handler = middy()
  .use(captureLambdaHandler(tracer))
  .use(injectLambdaContext(logger))
  .use(logMetrics(metrics))
  .use(parser({ schema: EventBridgeSchema }))
  .handler(myFunction);

```

ジェネレータは以下の機能を自動的に設定します：

1. **Middyミドルウェアスタック** - Lambda機能拡張のため
2. **AWS Lambda Powertools統合** - 観測可能性のため
3. **CloudWatchメトリクス収集**
4. **Parserミドルウェアを使用した型安全性**
5. **esbuildバンドリング** - 最適化されたデプロイパッケージのため

### AWS Lambda Powertoolsによる観測可能性

#### ロギング

ジェネレータはMiddyミドルウェアを使用した構造化ロギングをAWS Lambda Powertoolsで設定します。

```typescript
export const handler = middy()
  .use(injectLambdaContext(logger))
  .handler(myFunction);
```

#### トレーシング

AWS X-Rayトレーシングは`captureLambdaHandler`ミドルウェアで自動設定されます。カスタムサブセグメントを追加できます：

```typescript
const tracer = new Tracer();

export const myFunction = async (
  event: z.infer<typeof EventBridgeSchema>,
): Promise<void> => {
  // 新しいサブセグメントを作成
  const subsegment = tracer.getSegment()?.addNewSubsegment('custom-operation');
  try {
    // ロジックをここに実装
  } catch (error) {
    subsegment?.addError(error as Error);
    throw error;
  } finally {
    subsegment?.close();
  }
};

export const handler = middy()
  .use(captureLambdaHandler(tracer))
  .handler(myFunction);
```

#### メトリクス

`logMetrics`ミドルウェアでリクエストごとにCloudWatchメトリクスを自動収集します。カスタムメトリクスを追加できます：

```typescript
const metrics = new Metrics();

export const myFunction = async (
  event: z.infer<typeof EventBridgeSchema>,
): Promise<void> => {
  metrics.addMetric("CustomMetric", MetricUnit.Count, 1);
  metrics.addMetric("ProcessingTime", MetricUnit.Milliseconds, processingTime);
};

export const handler = middy()
  .use(logMetrics(metrics))
  .handler(myFunction);
```

### 型安全性

Lambda関数生成時に`eventSource`を選択した場合、[AWS Lambda Powertoolsの`parser`ミドルウェア](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/)が組み込まれます。例：

```typescript {4}
export const myFunction = async (
  event: z.infer<typeof EventBridgeSchema>,
): Promise<void> => {
  event.detail // <- IDEのオートコンプリートで型安全
};

export const handler = middy()
  .use(parser({ schema: EventBridgeSchema }))
  .handler(myFunction);
```

これにより、コンパイル時の型安全性とランタイムバリデーションが実現されます。

:::caution
イベントがスキーマに適合しない場合にハンドラがエラーをスローしないようにするには、[`safeParse`オプション](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/#safe-parsing)を使用できます。
:::

:::tip
DynamoDBストリームやEventBridgeイベント内のカスタムデータなど、ネストされたデータに型安全性を適用する場合は、[Envelopes](https://docs.powertools.aws.dev/lambda/typescript/latest/utilities/parser/#envelopes)の使用を検討してください。
:::

イベントの型指定が必要ない場合は、`eventSource`に`Any`を選択できます。これによりイベントパラメータは`any`型になります。

## バンドリング

ジェネレータは最適化されたLambdaデプロイパッケージのために[esbuild](https://esbuild.github.io/)を自動設定します：

特定のLambda関数をバンドルするには：

<NxCommands commands={['run <project-name>:bundle-<function-name>']} />

プロジェクト内の全Lambda関数をバンドルするには：

<NxCommands commands={['run <project-name>:bundle']} />

## 関数のデプロイ

<Snippet name="lambda-function/deploying-your-function" parentHeading="Deploying your Function" />