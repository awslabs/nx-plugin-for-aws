---
title: "Reactウェブサイト"
description: "Reactウェブサイトのリファレンスドキュメント"
---

import { FileTree, Steps } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';

このジェネレータは[React](https://react.dev/)ウェブサイトを新規作成し、デフォルトで[Cloudscape](http://cloudscape.design/)の設定と、静的ウェブサイトをクラウドにデプロイするためのAWS CDKまたはTerraformインフラストラクチャ（[S3](https://aws.amazon.com/s3/)ホスティング、[CloudFront](https://aws.amazon.com/cloudfront/)配信、[WAF](https://aws.amazon.com/waf/)保護）を構成します。

生成されるアプリケーションはビルドツールとバンドラーに[Vite](https://vite.dev/)を使用し、型安全なルーティングに[TanStack Router](https://tanstack.com/router/v1)を採用しています。

:::note
このジェネレータはデフォルトで[Cloudscape](http://cloudscape.design/)をセットアップしますが、別のコンポーネントライブラリやデザインシステムを使用したい場合は`uxProvider`として`None`を選択できます。
:::

## 使用方法

### Reactウェブサイトの生成

新しいReactウェブサイトは2つの方法で生成できます：

<RunGenerator generator="ts#react-website" />

### オプション

<GeneratorParameters generator="ts#react-website" />

## ジェネレータの出力

ジェネレータは`<directory>/<name>`ディレクトリに以下のプロジェクト構造を作成します：

<FileTree>
  - index.html HTMLエントリポイント
  - public 静的アセット
  - src
    - main.tsx Reactセットアップを含むアプリケーションエントリポイント
    - config.ts アプリケーション設定（ロゴなど）
    - components
      - AppLayout 全体のレイアウトとナビゲーションバー用コンポーネント
    - hooks
      - useAppLayout.tsx ネストされたコンポーネントからCloudscape AppLayoutを調整するフック（UX ProviderがCloudscapeに設定されている場合）
    - routes
      - index.tsx TanStack Router用のサンプルルート（ページ）
    - styles.css グローバルスタイル
  - vite.config.ts ViteとVitestの設定
  - tsconfig.json ソースとテスト用の基本TypeScript設定
  - tsconfig.app.json ソースコード用TypeScript設定
  - tsconfig.spec.json テスト用TypeScript設定
</FileTree>

:::note
[TanStack Router](https://tanstack.com/router/v1)を使用しない選択をした場合、`routes`ディレクトリの代わりにアプリケーションエントリポイントとしてシンプルな`src/app.tsx`ファイルが提供されます。
:::

### インフラストラクチャ

<Snippet name="shared-constructs" />

ジェネレータは選択した`iacProvider`に基づいてウェブサイトをデプロイするためのインフラストラクチャコードを作成します：

<Infrastructure>
<Fragment slot="cdk">
<FileTree>
  - packages/common/constructs/src
    - app
      - static-websites
        - \<name>.ts ウェブサイト固有のインフラストラクチャ
    - core
      - static-website.ts 汎用StaticWebsiteコンストラクト
</FileTree>
</Fragment>
<Fragment slot="terraform">
<FileTree>
  - packages/common/terraform/src
    - app
      - static-websites
        - \<name>
          - \<name>.tf ウェブサイト固有のモジュール
    - core
      - static-website
        - static-website.tf 汎用静的ウェブサイトモジュール
</FileTree>
</Fragment>
</Infrastructure>

## Reactウェブサイトの実装

[Reactドキュメント](https://react.dev/learn)はReact開発の基本を学ぶのに適しています。[Cloudscapeドキュメント](https://cloudscape.design/components/)では利用可能なコンポーネントとその使用方法を確認できます。

### ルート

#### ルート/ページの作成

Cloudscapeウェブサイトにはデフォルトで[TanStack Router](https://tanstack.com/router/v1)が設定されています。新しいルートを簡単に追加できます：

<Steps>
  1. [ローカル開発サーバーを起動](#local-development-server)
  2. `src/routes`に新しい`<page-name>.tsx`ファイルを作成（ファイルツリー内の位置がパスを表す）
  3. `Route`と`RouteComponent`が自動生成されます。ここでページの構築を開始できます
</Steps>

#### ページ間のナビゲーション

ページ間の移動には`Link`コンポーネントまたは`useNavigate`フックを使用します：

```tsx {1, 4, 8-9, 14}
import { Link, useNavigate } from '@tanstack/react-router';

export const MyComponent = () => {
  const navigate = useNavigate();

  const submit = async () => {
    const id = await ...
    // 非同期処理後のリダイレクトに`navigate`を使用
    navigate({ to: '/products/$id', { params: { id }} });
  };

  return (
    <>
      <Link to="/products">キャンセル</Link>
      <Button onClick={submit}>送信</Button>
    </>
  )
};
```

詳細は[TanStack Router](https://tanstack.com/router/latest/docs/framework/react/overview)ドキュメントを参照してください。

## ランタイム設定

インフラストラクチャからの設定はランタイム設定を通じてウェブサイトに提供されます。これにより、デプロイ時まで不明なAPI URLなどの詳細情報にアクセス可能になります。

### インフラストラクチャ

<Infrastructure>
<Fragment slot="cdk">
`RuntimeConfig` CDKコンストラクトを使用して設定の追加・取得が可能です。`@aws/nx-plugin`ジェネレータ（<Link path="guides/trpc">`ts#trpc-api`</Link>や<Link path="guides/fastapi">`py#fast-api`</Link>など）で生成されたCDKコンストラクトは自動的に`RuntimeConfig`に値を追加します。

ウェブサイトCDKコンストラクトはランタイム設定を`runtime-config.json`ファイルとしてS3バケットのルートにデプロイします。

```ts title="packages/infra/src/stacks/application-stack.ts" {9-12,14-15}
import { Stack } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyWebsite } from ':my-scope/common-constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string) {
    super(scope, id);

    // RuntimeConfigに自動的に値を追加
    new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });

    // runtime-config.jsonとして自動デプロイ
    new MyWebsite(this, 'MyWebsite');
  }
}
```

:::caution
`runtime-config.json`に設定が含まれるように、`RuntimeConfig`に追加するコンストラクトの後にウェブサイトを宣言する必要があります。
:::
</Fragment>
<Fragment slot="terraform">
Terraformではランタイム設定はruntime-configモジュールで管理されます。`@aws/nx-plugin`ジェネレータ（<Link path="guides/trpc">`ts#trpc-api`</Link>や<Link path="guides/fastapi">`py#fast-api`</Link>など）で生成されたTerraformモジュールは自動的にランタイム設定に値を追加します。

ウェブサイトTerraformモジュールはランタイム設定を`runtime-config.json`ファイルとしてS3バケットのルートにデプロイします。

```hcl title="packages/infra/src/main.tf" {14-15}
# ランタイム設定に自動的に値を追加
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"
}

# runtime-config.jsonとして自動デプロイ
module "my_website" {
  source = "../../common/terraform/src/app/static-websites/my-website"

  providers = {
    aws.us_east_1 = aws.us_east_1
  }

  # ランタイム設定追加のためAPIを先にデプロイ
  depends_on = [module.my_api]
}
```

:::caution
`runtime-config.json`に設定が含まれるよう、適切な`depends_on`を設定してウェブサイトモジュールを他のモジュールより後に宣言する必要があります。
:::
</Fragment>
</Infrastructure>

### ウェブサイトコード

ウェブサイトでは`useRuntimeConfig`フックを使用してランタイム設定値を取得できます：

```tsx {1,4}
import { useRuntimeConfig } from '../hooks/useRuntimeConfig';

const MyComponent = () => {
  const runtimeConfig = useRuntimeConfig();

  // ランタイム設定値にアクセス
  const apiUrl = runtimeConfig.apis.MyApi;
};
```

### ローカルランタイム設定

[ローカル開発サーバー](#local-development-server)を実行する際、バックエンドURLや認証設定などを認識させるため、`public`ディレクトリに`runtime-config.json`ファイルが必要です。

ウェブサイトプロジェクトにはデプロイ済みアプリケーションから`runtime-config.json`を取得する`load:runtime-config`ターゲットが設定されています：

<NxCommands commands={['run <my-website>:"load:runtime-config"']} />

:::note
<Infrastructure>
<Fragment slot="cdk">
インフラストラクチャプロジェクトの`src/main.ts`でステージ名のプレフィックスを変更した場合、ウェブサイトの`project.json`ファイルの`load:runtime-config`ターゲットを更新する必要があります。

また、このターゲットは単一ステージがAWS認証情報の環境にデプロイされていることを前提としています。同一アカウント/リージョンに複数ステージをデプロイする場合はコマンドを調整してください。
</Fragment>
<Fragment slot="terraform">
Terraformプロジェクトでは、`load:runtime-config`ターゲットは直近のローカル`terraform apply`で作成された`runtime-config.json`をコピーします。
</Fragment>
</Infrastructure>
:::

## ローカル開発サーバー

`serve`または`serve-local`ターゲットでローカル開発サーバーを起動できます。

### Serveターゲット

`serve`ターゲットはウェブサイトのローカル開発サーバーを起動します。このターゲットを使用するには、ウェブサイトが連携するインフラストラクチャのデプロイと[ローカルランタイム設定の読み込み](#local-runtime-config)が必要です。

次のコマンドで実行できます：

<NxCommands commands={['run <my-website>:serve']} />

このターゲットは「本番」デプロイされたAPIと連携しながらウェブサイトを変更する場合に有用です。

### Serve Localターゲット

`serve-local`ターゲットは[Viteの`MODE`](https://vite.dev/guide/env-and-mode)を`serve-local`に設定したローカル開発サーバーを起動し、<Link path="/guides/connection">接続ジェネレータ</Link>で接続したAPIのローカルサーバーも同時に起動します。

このターゲットでサーバーを起動すると、`runtime-config.json`がローカルAPIのURLを指すように自動的に上書きされます。

次のコマンドで実行できます：

<NxCommands commands={['run <my-website>:serve-local']} />

このターゲットはウェブサイトとAPIを同時に開発する際の迅速な反復処理に適しています。

:::warning
このモードで実行し`runtime-config.json`が存在しない場合、<Link path="/guides/react-website-auth">`ts#react-website#auth`ジェネレータ</Link>でCognito認証を設定していても、ログインがスキップされローカルサーバーへのリクエストに認証ヘッダーが含まれません。

`serve-local`で認証を有効化するには、インフラストラクチャをデプロイしランタイム設定を読み込んでください。
:::

:::tip
`serve-local`で実行する際、他のデプロイ済みAWSリソースを指すためにAPIが必要とする環境変数を指定できます。例：

<NxCommands env={{DYNAMODB_TABLE_NAME: 'xxxxx'}} commands={['run <my-website>:serve-local']} />

ローカルAPIサーバーはローカルに設定されたAWS認証情報で実行されることに注意してください。
:::

## ビルド

`build`ターゲットでウェブサイトをビルドできます。Viteを使用して本番用バンドルを`dist/packages/<my-website>/bundle`ディレクトリに生成し、型チェック、コンパイル、リンターを実行します。

<NxCommands commands={['run <my-website>:build']} />

## テスト

テストの作成方法は標準的なTypeScriptプロジェクトと同様です。詳細は<Link path="guides/typescript-project#testing">TypeScriptプロジェクトガイド</Link>を参照してください。

React固有のテストにはReact Testing Libraryが事前にインストールされています。使用方法は[React Testing Libraryドキュメント](https://testing-library.com/docs/react-testing-library/example-intro)を参照してください。

テストは`test`ターゲットで実行できます：

<NxCommands commands={['run <my-website>:test']} />

## ウェブサイトのデプロイ

Reactウェブサイトジェネレータは選択した`iacProvider`に基づいてCDKまたはTerraformのインフラストラクチャコードを作成します。これを使用してウェブサイトをデプロイできます。

<Infrastructure>
<Fragment slot="cdk">
ウェブサイトのデプロイには、CDKアプリケーション作成用の<Link path="guides/typescript-infrastructure">`ts#infra`ジェネレータ</Link>の使用を推奨します。

`packages/common/constructs`に生成されたCDKコンストラクトを使用してウェブサイトをデプロイできます。

```ts title="packages/infra/src/stacks/application-stack.ts" {3, 9}
import { Stack } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyWebsite } from ':my-scope/common-constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string) {
    super(scope, id);

    new MyWebsite(this, 'MyWebsite');
  }
}
```

この設定では以下が構成されます：

1. 静的ウェブサイトファイルホスティング用S3バケット
2. グローバルコンテンツ配信用CloudFrontディストリビューション
3. セキュリティ保護用WAF Web ACL
4. 安全なS3アクセスのためのOrigin Access Control
5. ウェブサイトファイルとランタイム設定の自動デプロイ
</Fragment>
<Fragment slot="terraform">
ウェブサイトのデプロイには、Terraformプロジェクト作成用の<Link path="guides/terraform-infrastructure">`terraform#project`ジェネレータ</Link>の使用を推奨します。

`packages/common/terraform`に生成されたTerraformモジュールを使用してウェブサイトをデプロイできます。

```hcl title="packages/infra/src/main.tf" {3}
# ウェブサイトのデプロイ
module "my_website" {
  source = "../../common/terraform/src/app/static-websites/my-website"

  providers = {
    aws.us_east_1 = aws.us_east_1
  }
}
```

この設定では以下が構成されます：

1. 静的ウェブサイトファイルホスティング用S3バケット
2. グローバルコンテンツ配信用CloudFrontディストリビューション
3. セキュリティ保護用WAF Web ACL（us-east-1にデプロイ）
4. 安全なS3アクセスのためのOrigin Access Control
5. ウェブサイトファイルとランタイム設定の自動デプロイ

:::note
CloudFrontとWAFリソースはus-east-1リージョンにデプロイする必要があるため、`aws.us_east_1`プロバイダが必須です。Terraform設定にこのプロバイダを含めてください：

```hcl title="packages/infra/src/providers.tf"
provider "aws" {
  alias  = "us_east_1"
  region = "us-east-1"
}
```
:::
</Fragment>
</Infrastructure>