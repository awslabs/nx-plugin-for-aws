---
title: "TypeScriptプロジェクト"
description: "TypeScriptプロジェクトのリファレンスドキュメント"
---



import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import InstallCommand from '@components/install-command.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import schema from '../../../../../../packages/nx-plugin/src/ts/lib/schema.json';

TypeScriptプロジェクトジェネレータは、[ECMAScript Modules (ESM)](https://www.typescriptlang.org/docs/handbook/modules/reference.html)、TypeScriptの[プロジェクトリファレンス](https://www.typescriptlang.org/docs/handbook/project-references.html)、テスト実行用の[Vitest](https://vitest.dev/)、静的解析用の[ESLint](https://eslint.org/)など、ベストプラクティスに基づいて構成されたモダンな[TypeScript](https://www.typescriptlang.org/)ライブラリやアプリケーションを作成するために使用できます。

## 使用方法

### TypeScriptプロジェクトの生成

新しいTypeScriptプロジェクトは2つの方法で生成できます：

<RunGenerator generator="ts#project" />

### オプション

<GeneratorParameters schema={schema} />

## ジェネレータの出力

ジェネレータは`<directory>/<name>`ディレクトリに以下のプロジェクト構造を作成します：

<FileTree>

  - src TypeScriptソースコード
    - index.ts
  - project.json プロジェクト設定とビルドターゲット
  - tsconfig.json このプロジェクトのベースTypeScript設定（ワークスペースルートのtsconfig.base.jsonを継承）
  - tsconfig.lib.json ライブラリ用TypeScript設定（ランタイムまたはパッケージ化されたソース）
  - tsconfig.spec.json テスト用TypeScript設定
  - vite.config.ts Vitestの設定
  - eslint.config.mjs ESLintの設定

</FileTree>

:::tip
`package.json`ファイルが作成されないことに注目してください！その理由は[後述](#dependencies)で説明します。
:::

ワークスペースルートの以下のファイルにも変更が加えられます：

<FileTree>

  - nx.json Nx設定が更新され、プロジェクトに@nx/js/typescriptプラグインが設定されます
  - tsconfig.base.json ワークスペース内の他のプロジェクトからインポートできるよう、プロジェクトのTypeScriptエイリアスが設定されます
  - tsconfig.json プロジェクトのTypeScriptプロジェクトリファレンスが追加されます

</FileTree>

## TypeScriptソースコードの作成

TypeScriptコードは`src`ディレクトリに追加します。

### ESMインポート構文

TypeScriptプロジェクトはESモジュールであるため、ファイル拡張子を明示的に指定した正しいESM構文でインポート文を作成してください：

```ts title="index.ts" ".js"
import { sayHello } from './hello.js';
```

:::note
TypeScriptを使用していて、`sayHello`が`hello.ts`で定義されていても、インポートでは`.js`ファイル拡張子を使用します。詳細は[こちら](https://www.typescriptlang.org/docs/handbook/modules/reference.html)で確認できます。
:::

### 他のTypeScriptプロジェクト向けのエクスポート

TypeScriptプロジェクトのエントリポイントは`src/index.ts`です。他のプロジェクトからインポート可能にする要素をここでエクスポートできます：

```ts title="src/index.ts"
export { sayHello } from './hello.js';
export * from './algorithms/index.js';
```

### 他のプロジェクトでのライブラリコードのインポート

ワークスペースの`tsconfig.base.json`で設定されたTypeScriptエイリアスを使用して、他のTypeScriptプロジェクトからプロジェクトを参照できます：

```ts title="packages/my-other-project/src/index.ts"
import { sayHello } from ':my-scope/my-library';
```

:::note
TypeScriptプロジェクトのエイリアスは、従来の`@`ではなく`:`で始まります。これにより、ワークスペース内のローカルパッケージと[NPM](https://www.npmjs.com/)のリモートパッケージ間での名前衝突を防ぎます。
:::

ワークスペース内の新しいプロジェクトを初めてインポートする場合、以下のようなエラーがIDEに表示される可能性があります：

<details>
<summary>インポートエラー</summary>

```bash wrap
File '/path/to/my/workspace/packages/my-library/src/index.ts' is not under 'rootDir' '/path/to/my/workspace/packages/my-consumer'. 'rootDir' is expected to contain all source files.
  File is ECMAScript module because '/path/to/my/workspace/package.json' has field "type" with value "module" ts(6059)
File '/path/to/my/workspace/packages/my-library/src/index.ts' is not listed within the file list of project '/path/to/my/workspace/packages/my-consumer/tsconfig.lib.json'. Projects must list all files or use an 'include' pattern.
  File is ECMAScript module because '/path/to/my/workspace/package.json' has field "type" with value "module" ts(6307)
```

</details>

これは[プロジェクトリファレンス](https://www.typescriptlang.org/docs/handbook/project-references.html)が設定されていないためです。

TypeScriptプロジェクトはNx TypeScript Syncジェネレータで事前に設定されているため、手動でのプロジェクトリファレンス設定が不要です。以下のコマンドを実行するだけで必要な設定が追加されます：

<NxCommands commands={['sync']} />

これによりIDEのエラーが解消され、ライブラリを使用できるようになります。

:::tip
プロジェクトをビルドするだけで、以下のようなメッセージが表示される場合もあります：

```bash wrap
[@nx/js:typescript-sync]: Some TypeScript configuration files are missing project references to the projects they depend on or contain outdated project references.

This will result in an error in CI.

? Would you like to sync the identified changes to get your workspace up to date?
Yes, sync the changes and run the tasks
No, run the tasks without syncing the changes
```

`Yes`を選択すると、Nxがプロジェクトリファレンスを更新します。
:::

### 依存関係

TypeScriptプロジェクトに`package.json`ファイルが存在しないことに気付くかもしれません。これは従来のTypeScriptモノレポに慣れている方には意外に思えるでしょう。

モノレポ内のTypeScriptパッケージに依存関係を追加するには、ワークスペースルートの`package.json`に依存関係を追加します。パッケージマネージャのコマンドラインから追加できます：

<InstallCommand pkg="some-npm-package" />

これにより、ワークスペース内のすべてのTypeScriptプロジェクトで依存関係が利用可能になります。

#### ランタイムコード

TypeScriptプロジェクトをランタイムコード（例：AWS Lambda関数のハンドラ）として使用する場合、[`esbuild`](https://esbuild.github.io/)などのツールを使用してプロジェクトをバンドルすることを推奨します。これにより、実際に参照されている依存関係のみを含める[ツリーシェイキング](https://esbuild.github.io/api/#tree-shaking)が可能になります。

`project.json`ファイルに以下のようなターゲットを追加することで実現できます：

```json
{
  ...
  "targets": {
    ...
    "bundle": {
      "cache": true,
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/packages/my-library/bundle"],
      "options": {
        "command": "esbuild packages/my-library/src/index.ts --bundle --outfile=dist/packages/my-library/bundle/index.js --platform=node --format=cjs"
      }
    },
  },
}
```

:::note
上記のターゲットでは、バンドルのエントリポイントとして`src/index.ts`を選択しています。つまり、このファイルからエクスポートされたコードとその依存関係がバンドルに含まれます。
:::

#### NPMへの公開

TypeScriptプロジェクトをNPMに公開する場合、`package.json`ファイルを作成する必要があります。

これにはプロジェクトが参照する依存関係を宣言する必要があります。ビルド時にはワークスペースルートの`package.json`にインストールされた依存関係が解決されるため、公開するプロジェクトの`package.json`に使用するすべての依存関係が含まれるように[Nx Dependency Checks ESLint Plugin](https://nx.dev/nx-api/eslint-plugin/documents/dependency-checks)を設定することを推奨します。

### ビルド

TypeScriptプロジェクトには`build`ターゲット（`project.json`で定義）が設定されており、以下のコマンドで実行できます：

<NxCommands commands={['run <project-name>:build']} />

`<project-name>`はプロジェクトの完全修飾名です。

`build`ターゲットはプロジェクトのコンパイル、リンティング、テストを実行します。

ビルド出力はワークスペースルートの`dist`フォルダ内に、例えば`dist/packages/<my-library>/tsc`のようなディレクトリ構造で生成されます。

## テスト

[Vitest](https://vitest.dev/)がプロジェクトのテスト用に設定されています。

### テストの作成

テストはプロジェクトの`src`フォルダ内に`.spec.ts`または`.test.ts`ファイルとして配置します。

例：

<FileTree>
  - src
    - hello.ts ライブラリソースコード
    - hello.spec.ts hello.tsのテスト
</FileTree>

VitestはJest風の構文を提供し、`describe`、`it`、`test`、`expect`などのユーティリティを使用できます。

```ts title="hello.spec.ts"
import { sayHello } from './hello.js';

describe('sayHello', () => {

  it('should greet the caller', () => {
    expect(sayHello('Darth Vader')).toBe('Hello, Darth Vader!');
  });

});
```

テストの作成方法やモックの使用など詳細については、[Vitestドキュメント](https://vitest.dev/guide/#writing-tests)を参照してください。

### テストの実行

テストはプロジェクトの`build`ターゲットの一部として実行されますが、`test`ターゲットを個別に実行することもできます：

<NxCommands commands={['run <project-name>:test']} />

`-t`フラグを使用して特定のテストを実行できます：

<NxCommands commands={["run <project-name>:test -t 'sayHello'"]} />

:::tip
VSCodeユーザーには、テストの実行・監視・デバッグが可能な[Vitest Runner for VSCode that actually works](https://marketplace.visualstudio.com/items?itemName=rluvaton.vscode-vitest)拡張機能のインストールを推奨します。
:::

## リンティング

TypeScriptプロジェクトはリンティングに[ESLint](https://eslint.org/)、フォーマットに[Prettier](https://prettier.io/)を使用します。

ESLintはワークスペースルートの`eslint.config.mjs`ファイルで設定することを推奨します。これにより変更がすべてのTypeScriptプロジェクトに適用され、一貫性が保たれます。

同様にPrettierはルートの`.prettierrc`ファイルで設定できます。

### リンターの実行

プロジェクトのリンターを実行するには`lint`ターゲットを使用します：

<NxCommands commands={["run <project-name>:lint"]} />

### リント問題の修正

ほとんどのリンティングやフォーマットの問題は自動修正可能です。`--configuration=fix`引数を付けて実行することで修正できます：

<NxCommands commands={["run <project-name>:lint --configuration=fix"]} />

ワークスペース内のすべてのパッケージのリント問題を修正するには：

<NxCommands commands={["run-many --target lint --all --configuration=fix"]} />