---
title: "TypeScriptプロジェクト"
description: "TypeScriptプロジェクトのリファレンスドキュメント"
---

import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import InstallCommand from '@components/install-command.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import Link from '@components/link.astro';

TypeScriptプロジェクトジェネレータは、[ECMAScript Modules (ESM)](https://www.typescriptlang.org/docs/handbook/modules/reference.html)、TypeScriptの[プロジェクト参照](https://www.typescriptlang.org/docs/handbook/project-references.html)、テスト実行用の[Vitest](https://vitest.dev/)、静的解析用の[ESLint](https://eslint.org/)など、ベストプラクティスで構成されたモダンな[TypeScript](https://www.typescriptlang.org/)ライブラリまたはアプリケーションを作成するために使用できます。

## 使用方法

### TypeScriptプロジェクトの生成

新しいTypeScriptプロジェクトを2つの方法で生成できます:

<RunGenerator generator="ts#project" />

### オプション

<GeneratorParameters generator="ts#project" />

## ジェネレータの出力

ジェネレータは`<directory>/<name>`ディレクトリに以下のプロジェクト構造を作成します:

<FileTree>

  - src TypeScriptソースコード
    - index.ts
  - project.json プロジェクト設定とビルドターゲット
  - tsconfig.json このプロジェクトの基本TypeScript設定（ワークスペースルートのtsconfig.base.jsonを継承）
  - tsconfig.lib.json ライブラリ用TypeScript設定（ランタイムまたはパッケージ化ソース用）
  - tsconfig.spec.json テスト用TypeScript設定
  - vite.config.ts Vitestの設定
  - eslint.config.mjs ESLintの設定

</FileTree>

:::tip
`package.json`ファイルが作成されていないことに注意してください！理由は[後述](#dependencies)をご覧ください。
:::

ワークスペースルートの以下のファイルにも変更が加えられます:

<FileTree>

  - nx.json Nx設定が更新され、@nx/js/typescriptプラグインがプロジェクト用に構成されます
  - tsconfig.base.json ワークスペース内の他のプロジェクトからインポート可能にするためのTypeScriptエイリアスが設定されます
  - tsconfig.json プロジェクト参照が追加されます

</FileTree>

## TypeScriptソースコードの記述

TypeScriptコードは`src`ディレクトリに追加します。

### ESMインポート構文

TypeScriptプロジェクトはESモジュールであるため、インポート文ではファイル拡張子を明示的に指定する必要があります:

```ts title="index.ts" ".js"
import { sayHello } from './hello.js';
```

:::note
TypeScriptを使用していても、`sayHello`が`hello.ts`で定義されている場合、インポートでは`.js`拡張子を使用します。詳細は[こちら](https://www.typescriptlang.org/docs/handbook/modules/reference.html)をご覧ください。
:::

### 他のTypeScriptプロジェクト向けのエクスポート

TypeScriptプロジェクトのエントリポイントは`src/index.ts`です。他のプロジェクトからインポート可能にする要素はここでエクスポートできます:

```ts title="src/index.ts"
export { sayHello } from './hello.js';
export * from './algorithms/index.js';
```

### 他のプロジェクトでのライブラリコードのインポート

ワークスペースの`tsconfig.base.json`で設定された[TypeScriptエイリアス](https://www.typescriptlang.org/docs/handbook/modules/reference.html#paths)を使用して、他のTypeScriptプロジェクトからプロジェクトを参照できます:

```ts title="packages/my-other-project/src/index.ts"
import { sayHello } from ':my-scope/my-library';
```

:::note
TypeScriptプロジェクトのエイリアスは従来の`@`ではなく`:`で始まります。これにより、ワークスペース内のローカルパッケージと[NPM](https://www.npmjs.com/)のリモートパッケージ間での名前衝突を防ぎます。
:::

ワークスペース内の新しいプロジェクトを初めてインポートする場合、以下のようなエラーがIDEに表示される可能性があります:

<details>
<summary>インポートエラー</summary>

```bash wrap
File '/path/to/my/workspace/packages/my-library/src/index.ts' is not under 'rootDir' '/path/to/my/workspace/packages/my-consumer'. 'rootDir' is expected to contain all source files.
  File is ECMAScript module because '/path/to/my/workspace/package.json' has field "type" with value "module" ts(6059)
File '/path/to/my/workspace/packages/my-library/src/index.ts' is not listed within the file list of project '/path/to/my/workspace/packages/my-consumer/tsconfig.lib.json'. Projects must list all files or use an 'include' pattern.
  File is ECMAScript module because '/path/to/my/workspace/package.json' has field "type" with value "module" ts(6307)
```

</details>

これは[プロジェクト参照](https://www.typescriptlang.org/docs/handbook/project-references.html)が設定されていないためです。

TypeScriptプロジェクトはNx TypeScript Syncジェネレータで事前設定されているため、手動での設定は不要です。以下のコマンドを実行するとNxが必要な設定を追加します:

<NxCommands commands={['sync']} />

これによりIDEのエラーが解消され、ライブラリを使用できるようになります。

:::tip
プロジェクトをビルドするだけで、以下のようなメッセージが表示される場合もあります:

```bash wrap
[@nx/js:typescript-sync]: Some TypeScript configuration files are missing project references to the projects they depend on or contain outdated project references.

This will result in an error in CI.

? Would you like to sync the identified changes to get your workspace up to date?
Yes, sync the changes and run the tasks
No, run the tasks without syncing the changes
```

`Yes`を選択するとNxがプロジェクト参照を更新します。
:::

### パスエイリアスの同期維持

プロジェクトの`tsconfig.json`にカスタムの`compilerOptions.paths`エントリを追加すると、TypeScriptは`tsconfig.base.json`で定義されたワークスペースエイリアスを継承しなくなります。隠れた`ts#sync`ジェネレータは`compile`ターゲットの前に実行され（`nx.json`で設定）、既に`paths`を宣言している`tsconfig.json`、`tsconfig.lib.json`、`tsconfig.app.json`ファイルに不足している基本エイリアスをコピーします。オプトアウトするには、`nx.json`の`targetDefaults.compile.syncGenerators`から`@aws/nx-plugin:ts#sync`を削除してください。

### 依存関係

TypeScriptプロジェクトに`package.json`ファイルが存在しないことに気付くかもしれません。これは従来のTypeScriptモノレポに慣れている場合、予期しないことでしょう。

モノレポ内のTypeScriptパッケージの依存関係を追加するには、ワークスペースルートの`package.json`に依存関係を追加します。パッケージマネージャのコマンドラインから追加できます:

<InstallCommand pkg="some-npm-package" />

これにより、ワークスペース内のすべてのTypeScriptプロジェクトで依存関係を使用できるようになります。

#### ランタイムコード

TypeScriptプロジェクトをランタイムコード（例：AWS Lambda関数のハンドラ）として使用する場合、[Rolldown](https://rolldown.rs/)などのツールを使用してプロジェクトをバンドルすることを推奨します。これにより、実際に参照されている依存関係のみが含まれるよう[ツリーシェイキング](https://rolldown.rs/guide/in-depth/why-bundlers)されます。

`project.json`ファイルに以下のようなターゲットを追加することで実現できます:

```json
{
  ...
  "targets": {
    ...
    "bundle": {
      "cache": true,
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/packages/my-library/bundle"],
      "options": {
        "command": "rolldown -c rolldown.config.ts"
      }
    },
  },
}
```

`rolldown.config.ts`ファイルは以下のように追加します:

```ts
// rolldown.config.ts
import { defineConfig } from 'rolldown';

export default defineConfig([
  {
    input: 'src/index.ts',
    output: {
      file: '../../dist/packages/my-library/bundle/index.js',
      format: 'cjs',
      inlineDynamicImports: true,
    },
  },
]);
```

:::note
上記のターゲットでは、バンドルのエントリポイントとして`src/index.ts`を選択しています。つまり、このファイルからエクスポートされたコードとその依存関係がバンドルに含まれます。
:::

:::tip
AWS Lambda関数を構築する場合は、<Link path="/guides/ts-lambda-function">`ts#lambda-function`</Link>ジェネレータを確認してください。バンドリングの設定に加え、インフラストラクチャの生成、可観測性、型安全性の追加が行われます。
:::

#### NPMへの公開

TypeScriptプロジェクトをNPMに公開する場合は、`package.json`ファイルを作成する必要があります。

このファイルにはプロジェクトが参照する依存関係を宣言する必要があります。ビルド時にはワークスペースルートの`package.json`経由でインストールされた依存関係が解決されるため、[Nx Dependency Checks ESLint Plugin](https://nx.dev/nx-api/eslint-plugin/documents/dependency-checks)を設定して、公開用の`package.json`にプロジェクトで使用するすべての依存関係が含まれるようにすることを推奨します。

### ビルド

TypeScriptプロジェクトには`build`ターゲット（`project.json`で定義）が設定されており、以下のコマンドで実行できます:

<NxCommands commands={['run <project-name>:build']} />

`<project-name>`はプロジェクトの完全修飾名です。

`build`ターゲットはプロジェクトのコンパイル、リンティング、テストを実行します。

ビルド出力はワークスペースルートの`dist`フォルダ内のパッケージディレクトリ（例: `dist/packages/<my-library>/tsc`）に生成されます。

## テスト

[Vitest](https://vitest.dev/)がプロジェクトのテスト用に設定されています。

### テストの記述

テストは`.spec.ts`または`.test.ts`ファイルに記述し、プロジェクトの`src`フォルダに配置します。

例:

<FileTree>
  - src
    - hello.ts ライブラリソースコード
    - hello.spec.ts hello.tsのテスト
</FileTree>

Vitestは`describe`、`it`、`test`、`expect`などのJest風の構文を提供します。

```ts title="hello.spec.ts"
import { sayHello } from './hello.js';

describe('sayHello', () => {

  it('should greet the caller', () => {
    expect(sayHello('Darth Vader')).toBe('Hello, Darth Vader!');
  });

});

```

テストの記述方法や依存関係のモック作成などの詳細については、[Vitestドキュメント](https://vitest.dev/guide/#writing-tests)を参照してください。

### テストの実行

テストはプロジェクトの`build`ターゲットの一部として実行されますが、`test`ターゲットを個別に実行することもできます:

<NxCommands commands={['run <project-name>:test']} />

`-t`フラグを使用して特定のテストを実行できます:

<NxCommands commands={["run <project-name>:test -t 'sayHello'"]} />

:::tip
VSCodeユーザーには、[実際に動作するVitest Runner for VSCode](https://marketplace.visualstudio.com/items?itemName=rluvaton.vscode-vitest)拡張機能のインストールをお勧めします。IDEからテストの実行、監視、デバッグが可能になります。
:::

## リンティング

TypeScriptプロジェクトでは、リンティングに[ESLint](https://eslint.org/)、フォーマットに[Prettier](https://prettier.io/)を使用します。

ワークスペースルートの`eslint.config.mjs`ファイルでESLintを構成することを推奨します。これにより、変更がワークスペース内のすべてのTypeScriptプロジェクトに適用され、一貫性が保たれます。

同様に、Prettierはルートの`.prettierrc`ファイルで設定できます。

### リンターの実行

プロジェクトのリンターをチェックするには`lint`ターゲットを実行します:

<NxCommands commands={["run <project-name>:lint"]} />

### リント問題の修正

ほとんどのリンティングやフォーマットの問題は自動修正可能です。`--configuration=fix`引数を付けてESLintを実行することで修正できます:

<NxCommands commands={["run <project-name>:lint --configuration=fix"]} />

ワークスペース内のすべてのパッケージのリント問題を修正するには:

<NxCommands commands={["run-many --target lint --all --configuration=fix"]} />