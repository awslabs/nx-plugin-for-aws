---
title: "Pythonストランドエージェント"
description: "ツールを使用してAIエージェントを構築し、Amazon Bedrock AgentCoreランタイムにデプロイするためのPythonストランドエージェントを生成"
---



import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import Link from '@components/link.astro';
import Snippet from '@components/snippet.astro';
import GeneratorParameters from '@components/generator-parameters.astro';

ツールを備えたAIエージェントを構築するためのPython [Strands Agent](https://strandsagents.com/)を生成し、オプションで[Amazon Bedrock AgentCore Runtime](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/)にデプロイできます。

## Strandsとは

[Strands](https://strandsagents.com/latest/documentation/docs/)は、AIエージェント構築のための軽量でプロダクションレディなPythonフレームワークです。主な特徴：

- **軽量でカスタマイズ可能**: 邪魔にならないシンプルなエージェントループ
- **プロダクションレディ**: 完全なオブザーバビリティ、トレーシング、スケール対応のデプロイオプション
- **モデル/プロバイダー非依存**: 様々なプロバイダーのモデルをサポート
- **コミュニティ駆動のツール**: 強力なコミュニティ提供ツールセット
- **マルチエージェントサポート**: エージェントチームや自律エージェントなどの高度な手法
- **柔軟なインタラクションモード**: 会話型、ストリーミング、非ストリーミング対応

## 使用方法

### Strandsエージェントの生成

2つの方法でPython Strandsエージェントを生成できます：

<RunGenerator generator="py#strands-agent" />

:::tip
最初に<Link path="/guides/python-project">`py#project`</Link>ジェネレーターを使用してプロジェクトを作成することを推奨します。
:::

### オプション

<GeneratorParameters generator="py#strands-agent" />

## ジェネレーターの出力

既存のPythonプロジェクトに以下のファイルが追加されます：

<FileTree>
  - your-project/
    - your_module/
      - agent/（カスタム名指定時は変更）
        - \_\_init\_\_.py Pythonパッケージ初期化
        - agent.py サンプルツール付きメインエージェント定義
        - main.py Bedrock AgentCore Runtime用エントリーポイント
        - agentcore_mcp_client.py MCPサーバー呼び出し用クライアントファクトリ
        - Dockerfile エージェントホスティング用Dockerfile（`computeType`が`None`の場合は生成されない）
    - pyproject.toml Strands依存関係が追加
    - project.json エージェントサーバーターゲットが更新
</FileTree>

:::note
`computeType`で`None`を選択しなかった場合、StrandsエージェントをデプロイするCDKコンストラクトも生成されます。
:::

## Strandsエージェントの操作

### ツールの追加

ツールはAIエージェントが操作を実行するために呼び出す関数です。Strandsフレームワークはデコレータベースのツール定義を採用しています。

[`agent.py`](packages/nx-plugin/src/py/strands-agent/files/agent.py.template:6)ファイルに新しいツールを追加：

```python
from strands import Agent, tool

@tool
def calculate_sum(numbers: list[int]) -> int:
    """数値リストの合計を計算"""
    return sum(numbers)

@tool
def get_weather(city: str) -> str:
    """都市の天気情報を取得"""
    # 天気API連携処理
    return f"{city}の天気: 晴れ、25°C"

# エージェントにツールを追加
agent = Agent(
    system_prompt="様々なツールを利用できる有益なアシスタントです。",
    tools=[calculate_sum, get_weather],
)
```

Strandsフレームワークが自動処理：
- 関数の型ヒントに基づく型検証
- ツール呼び出し用JSONスキーマ生成
- エラーハンドリングとレスポンスフォーマット

### プリビルドツールの利用

`strands-tools`パッケージでプリビルドツールを利用可能：

```python
from strands_tools import current_time, http_request, file_read

agent = Agent(
    system_prompt="有益なアシスタントです。",
    tools=[current_time, http_request, file_read],
)
```

### モデル設定

デフォルトでClaude 4 Sonnetを使用しますが、モデルプロバイダーをカスタマイズ可能。[Strandsモデルプロバイダー資料](https://strandsagents.com/latest/documentation/docs/user-guide/quickstart/#model-providers)参照：

```python
from strands import Agent
from strands.models import BedrockModel

# BedrockModelの作成
bedrock_model = BedrockModel(
    model_id="anthropic.claude-sonnet-4-20250514-v1:0",
    region_name="us-west-2",
    temperature=0.3,
)

agent = Agent(model=bedrock_model)
```

### MCPサーバーの利用

[Bedrock AgentCore Runtime上のMCPサーバーツール](https://strandsagents.com/latest/documentation/docs/user-guide/concepts/tools/mcp-tools/)を追加可能。

<Link path="/guides/py-mcp-server">`py#mcp-server`</Link>や<Link path="/guides/ts-mcp-server">`ts#mcp-server`</Link>ジェネレーターで作成したMCPサーバー（またはBedrock AgentCore Runtime上の他サーバー）を利用する場合、`agentcore_mcp_client.py`にクライアントファクトリが生成されます。

`agent.py`の`get_agent`メソッドを更新してMCPクライアントを作成しツールを追加。IAM（SigV4）認証の例：

```python
# agent.py
import os
from contextlib import contextmanager

import boto3
from strands import Agent

from .agentcore_mcp_client import AgentCoreMCPClient

# リージョンと認証情報取得
region = os.environ["AWS_REGION"]
boto_session = boto3.Session(region_name=region)
credentials = boto_session.get_credentials()

@contextmanager
def get_agent(session_id: str):
    mcp_client = AgentCoreMCPClient.with_iam_auth(
        agent_runtime_arn=os.environ["MCP_AGENTCORE_RUNTIME_ARN"],
        credentials=credentials,
        region=region,
        session_id=session_id,
    )

    with mcp_client:
        mcp_tools = mcp_client.list_tools_sync()

        yield Agent(
            system_prompt="..."
            tools=[*mcp_tools],
        )
```

:::tip
JWT認証を使用するMCPサーバーの場合、`AgentCoreMCPClient.with_jwt_auth`メソッドを使用できます。
:::

上記のIAM認証例では、CDKインフラで2つの設定が必要：
1. MCPサーバーのAgentCore Runtime ARN用環境変数設定
2. MCPサーバー呼び出し権限付与

実装例：

```ts {9, 13}
import { MyProjectAgent, MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const mcpServer = new MyProjectMcpServer(this, 'MyProjectMcpServer');

    const agent = new MyProjectAgent(this, 'MyProjectAgent', {
      environment: {
        MCP_AGENTCORE_RUNTIME_ARN: mcpServer.agentCoreRuntime.arn,
      },
    });

    mcpServer.agentCoreRuntime.grantInvoke(agent.agentCoreRuntime);
  }
}
```

### 詳細

Strandsエージェント開発の詳細は[公式ドキュメント](https://strandsagents.com/latest/documentation/docs/)を参照。

## Bedrock AgentCore Python SDK

ジェネレーターは[Bedrock AgentCore Python SDK](https://github.com/aws/bedrock-agentcore-sdk-python)を設定し、AgentCoreのHTTP契約を管理します。

SDKの詳細は[ドキュメント](https://aws.github.io/bedrock-agentcore-starter-toolkit/user-guide/runtime/quickstart.html)参照。

:::note
CDKコンストラクトがデプロイを管理するため、`bedrock-agentcore-starter-toolkit`は不要です。
:::

## Strandsエージェントの実行

### ローカル開発

`<your-agent-name>-serve`ターゲットが設定され、ローカルでエージェントを起動できます。

<NxCommands commands={['run your-project:agent-serve']} />

このコマンドは[Bedrock AgentCore Python SDK](https://github.com/aws/bedrock-agentcore-sdk-python)を使用し、`uv run`でエージェントを実行します。

## Bedrock AgentCore Runtimeへのデプロイ

### CDKコンストラクト

`computeType`で`BedrockAgentCoreRuntime`を選択した場合、[Amazon Bedrock AgentCore Runtime](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agents-tools-runtime.html)へのデプロイ用CDKコンストラクトが生成されます。

CDKコンストラクト名はジェネレーター実行時の`name`指定、またはデフォルトで`<ProjectName>Agent`となります。

CDKアプリケーションでの使用例：

```ts {6}
import { MyProjectAgent } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // エージェントをスタックに追加
    const agent = new MyProjectAgent(this, 'MyProjectAgent');

    // Bedrockモデル呼び出し権限付与
    agent.agentCoreRuntime.role.addToPolicy(
      new PolicyStatement({
        actions: [
          'bedrock:InvokeModel',
          'bedrock:InvokeModelWithResponseStream',
        ],
        resources: ['arn:aws:bedrock:*::foundation-model/*'],
      }),
    );
  }
}
```

:::note
Bedrock AgentCore Runtimeデプロイ時は、AWSアカウントで適切な基盤モデルが有効化されている必要があります。デフォルトはClaude 4 Sonnetですが、前述の方法でカスタマイズ可能。

モデルアクセスの有効化方法は[こちら](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html)参照。
:::

:::caution
Strandsエージェントのビルド/デプロイには[Docker](https://www.docker.com/)が必要です。以下のエラーを防ぐためDockerのインストールと起動を確認：

```
ERROR: Cannot connect to the Docker daemon at unix://path/to/docker.sock.
```
:::

### バンドルとDockerターゲット

Bedrock AgentCore Runtime向けビルド用に`bundle`ターゲットが追加され：

- `uv export`で依存関係を`requirements.txt`にエクスポート
- `uv pip install`でターゲットプラットフォーム（`aarch64-manylinux2014`）向け依存関係をインストール

エージェント固有の`docker`ターゲットも追加され：

- [Runtime契約](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-service-contract.html)に従い`Dockerfile`からイメージをビルド

:::tip
Dockerイメージはタグ（例：`my-scope-my-project-agent:latest`）でビルドされ、CDKコンストラクトの`Dockerfile`が継承します。
:::

### 認証設定

#### IAM

デフォルトでIAM認証が有効：

```ts {5}
import { MyProjectAgent } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectAgent(this, 'MyProjectAgent');
  }
}
```

`grantInvoke`メソッドで実行権限を付与：

```ts {8}
import { MyProjectAgent } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const agent = new MyProjectAgent(this, 'MyProjectAgent');
    const lambdaFunction = new Function(this, ...);

    agent.agentCoreRuntime.grantInvoke(lambdaFunction);
  }
}
```

#### Cognito JWT認証

JWT認証を設定するには`authorizerConfiguration`プロパティを使用。Cognitoユーザープールで保護する例：

```ts {13-18}
import { MyProjectAgent } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const userPool = new UserPool(this, 'UserPool');
    const client = userPool.addClient('Client', {
      authFlows: {
        userPassword: true,
      },
    });

    new MyProjectAgent(this, 'MyProjectAgent', {
      authorizerConfiguration: {
        customJWTAuthorizer: {
          discoveryUrl: `https://cognito-idp.${Stack.of(userPool).region}.amazonaws.com/${userPool.userPoolId}/.well-known/openid-configuration`,
          allowedClients: [client.userPoolClientId],
        },
      },
    });
  }
}
```

### オブザーバビリティ

[AWS Distro for Open Telemetry](https://aws.amazon.com/otel/)（ADOT）を使用したオブザーバビリティが`Dockerfile`の自動計装で設定されます。

トレースはCloudWatchコンソールの「GenAI Observability」から確認可能。[Transaction Search](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Transaction-Search.html)の有効化が必要。

詳細は[AgentCoreオブザーバビリティ資料](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/observability-configure.html)参照。