---
title: "Pythonストランドエージェント"
description: "ツールを使用してAIエージェントを構築し、Amazon Bedrock AgentCoreランタイムにデプロイするためのPythonストランドエージェントを生成"
---

import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import Link from '@components/link.astro';
import Snippet from '@components/snippet.astro';
import Infrastructure from '@components/infrastructure.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import Drawer from '@components/drawer.astro';

AIエージェントをツール付きで構築するためのPython [Strands Agent](https://strandsagents.com/)を生成し、オプションで[Amazon Bedrock AgentCore Runtime](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/)にデプロイします。

## Strandsとは

[Strands](https://strandsagents.com/latest/documentation/docs/)は、AIエージェントを構築するための軽量で本番環境対応のPythonフレームワークです。主な特徴：

- **軽量でカスタマイズ可能**：シンプルなエージェントループで邪魔になりません
- **本番環境対応**：フルオブザーバビリティ、トレーシング、スケール対応のデプロイオプション
- **モデル/プロバイダー非依存**：様々なプロバイダーのモデルをサポート
- **コミュニティ提供ツール**：強力なコミュニティ製ツールセット
- **マルチエージェント対応**：エージェントチームや自律エージェントなどの高度な手法
- **柔軟なインタラクションモード**：会話型、ストリーミング、非ストリーミング対応

## 使用方法

### Strandsエージェントの生成

2つの方法でPython Strandsエージェントを生成できます：

<RunGenerator generator="py#strands-agent" />

:::tip
最初に<Link path="/guides/python-project">`py#project`</Link>ジェネレーターを使用してプロジェクトを作成し、その中にStrandsエージェントを追加してください。
:::

### オプション

<GeneratorParameters generator="py#strands-agent" />

## ジェネレーターの出力

既存のPythonプロジェクトに以下のファイルが追加されます：

<FileTree>
  - your-project/
    - your_module/
      - agent/（指定した場合はカスタム名）
        - \_\_init\_\_.py Pythonパッケージ初期化ファイル
        - agent.py サンプルツール付きメインエージェント定義
        - main.py Bedrock AgentCore Runtime用エントリーポイント
        - agentcore_mcp_client.py Bedrock AgentCore Runtime上のMCPサーバー呼び出し用クライアントファクトリ
        - Dockerfile エージェントホスティング用Dockerfile（`computeType`が`None`の場合は生成されない）
    - pyproject.toml Strands依存関係が追加された設定ファイル
    - project.json エージェントサーブターゲットが追加された設定ファイル
</FileTree>

### インフラストラクチャ

:::note
`computeType`に`None`を選択した場合、インフラストラクチャコードは生成されません。
:::

<Snippet name="shared-constructs" />

Strandsエージェントのデプロイ用に以下のファイルが生成されます：

<Infrastructure>
<Fragment slot="cdk">
<FileTree>
  - packages/common/constructs/src
    - app
      - agents
        - \<project-name>
          - \<project-name>.ts エージェントデプロイ用CDKコンストラクト
          - Dockerfile CDKコンストラクトで使用されるDockerfile
</FileTree>
</Fragment>
<Fragment slot="terraform">
<FileTree>
  - packages/common/terraform/src
    - app
      - agents
        - \<project-name>
          - \<project-name>.tf エージェントデプロイ用Terraformモジュール
    - core
      - agent-core
        - runtime.tf Bedrock AgentCore Runtimeデプロイ用汎用モジュール
</FileTree>
</Fragment>
</Infrastructure>

## Strandsエージェントの操作

### ツールの追加

ツールはAIエージェントがアクションを実行するために呼び出す関数です。Strandsフレームワークはデコレータベースのシンプルなアプローチを採用しています。

[`agent.py`](packages/nx-plugin/src/py/strands-agent/files/agent.py.template:6)ファイルに新しいツールを追加できます：

```python
from strands import Agent, tool

@tool
def calculate_sum(numbers: list[int]) -> int:
    """数値リストの合計を計算"""
    return sum(numbers)

@tool
def get_weather(city: str) -> str:
    """都市の天気情報を取得"""
    # 天気API連携をここに実装
    return f"{city}の天気：晴れ、25°C"

# エージェントにツールを追加
agent = Agent(
    system_prompt="様々なツールにアクセスできる便利なアシスタントです。",
    tools=[calculate_sum, get_weather],
)
```

Strandsフレームワークが自動的に処理する機能：
- 関数の型ヒントに基づく型検証
- ツール呼び出し用JSONスキーマ生成
- エラーハンドリングとレスポンスフォーマット

### プリビルドツールの使用

`strands-tools`パッケージで提供されるプリビルドツール：

```python
from strands_tools import current_time, http_request, file_read

agent = Agent(
    system_prompt="便利なアシスタントです。",
    tools=[current_time, http_request, file_read],
)
```

### モデル設定

デフォルトではClaude 4 Sonnetを使用しますが、モデルプロバイダーをカスタマイズ可能。[Strandsドキュメントのモデルプロバイダー](https://strandsagents.com/latest/documentation/docs/user-guide/quickstart/#model-providers)を参照：

```python
from strands import Agent
from strands.models import BedrockModel

# BedrockModelの作成
bedrock_model = BedrockModel(
    model_id="anthropic.claude-sonnet-4-20250514-v1:0",
    region_name="us-west-2",
    temperature=0.3,
)

agent = Agent(model=bedrock_model)
```

### MCPサーバーの利用

[StrandsエージェントにMCPサーバーのツールを追加](https://strandsagents.com/latest/documentation/docs/user-guide/concepts/tools/mcp-tools/)できます。

<Link path="/guides/py-mcp-server">`py#mcp-server`</Link>や<Link path="/guides/ts-mcp-server">`ts#mcp-server`</Link>ジェネレーター（またはBedrock AgentCore Runtime上でホストされた他サーバー）で作成したMCPサーバーを利用する場合、`agentcore_mcp_client.py`にクライアントファクトリが生成されます。

`agent.py`の`get_agent`メソッドを更新してMCPクライアントを作成しツールを追加できます。IAM（SigV4）認証の例：

```python
# agent.py
import os
from contextlib import contextmanager

import boto3
from strands import Agent

from .agentcore_mcp_client import AgentCoreMCPClient

# リージョンと認証情報の取得
region = os.environ["AWS_REGION"]
boto_session = boto3.Session(region_name=region)
credentials = boto_session.get_credentials()

@contextmanager
def get_agent(session_id: str):
    mcp_client = AgentCoreMCPClient.with_iam_auth(
        agent_runtime_arn=os.environ["MCP_AGENTCORE_RUNTIME_ARN"],
        credentials=credentials,
        region=region,
        session_id=session_id,
    )

    with mcp_client:
        mcp_tools = mcp_client.list_tools_sync()

        yield Agent(
            system_prompt="..."
            tools=[*mcp_tools],
        )
```

:::tip
対象MCPサーバーがJWT認証を使用する場合、代わりに`AgentCoreMCPClient.with_jwt_auth`メソッドを使用できます。
:::

上記のIAM認証例では、インフラストラクチャで2つの設定が必要です。まず、MCPサーバーのAgentCore Runtime ARN用環境変数の追加、次にエージェントにMCPサーバー呼び出し権限の付与が必要です。以下のように実現できます：

<Infrastructure>
<Fragment slot="cdk">
```ts {9, 13}
import { MyProjectAgent, MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const mcpServer = new MyProjectMcpServer(this, 'MyProjectMcpServer');

    const agent = new MyProjectAgent(this, 'MyProjectAgent', {
      environmentVariables: {
        MCP_AGENTCORE_RUNTIME_ARN: mcpServer.agentCoreRuntime.agentRuntimeArn,
      },
    });

    mcpServer.agentCoreRuntime.grantInvoke(agent.agentCoreRuntime);
  }
}
```
</Fragment>
<Fragment slot="terraform">
```terraform
# MCPサーバー
module "my_project_mcp_server" {
  source = "../../common/terraform/src/app/mcp-servers/my-project-mcp-server"
}

# エージェント
module "my_project_agent" {
  source = "../../common/terraform/src/app/agents/my-project-agent"

  env = {
    MCP_AGENTCORE_RUNTIME_ARN = module.my_project_mcp_server.agent_core_runtime_arn
  }

  additional_iam_policy_statements = [
    {
      Effect = "Allow"
      Action = [
        "bedrock-agentcore:InvokeAgentRuntime"
      ]
      Resource = [
        module.my_project_mcp_server.agent_core_runtime_arn,
        "${module.my_project_mcp_server.agent_core_runtime_arn}/*"
      ]
    }
  ]
}
```
</Fragment>
</Infrastructure>

### 詳細

Strandsエージェントの詳細な作成方法は[Strandsドキュメント](https://strandsagents.com/latest/documentation/docs/)を参照してください。

## FastAPIサーバー

ジェネレーターは[FastAPI](https://fastapi.tiangolo.com/)を使用してStrandsエージェント用のHTTPサーバーを作成します。FastAPIは、自動APIドキュメント生成と型検証を備えた、PythonでAPIを構築するためのモダンで高速なWebフレームワークを提供します。

生成されるサーバーには以下が含まれます：
- CORSミドルウェア付きFastAPIアプリケーション設定
- エラーハンドリングミドルウェア
- OpenAPIスキーマ生成
- ヘルスチェックエンドポイント（`/ping`）
- エージェント呼び出しエンドポイント（`/invocations`）

### Pydanticによる呼び出し入出力のカスタマイズ

エージェントの呼び出しエンドポイントは[Pydantic](https://docs.pydantic.dev/)モデルを使用してリクエストとレスポンスのスキーマを定義・検証します。`main.py`でこれらのモデルをカスタマイズしてエージェントの要件に合わせることができます。

#### 入力モデルの定義

デフォルトの`InvokeInput`モデルはプロンプトとセッションIDを受け取ります。

```python
from pydantic import BaseModel

class InvokeInput(BaseModel):
    prompt: str
    session_id: str
```

このモデルを拡張して、エージェントに必要な追加フィールドを含めることができます。

:::caution
ユーザーがエージェントを直接呼び出す場合、呼び出し元からセッションIDの一部または全部を抽象化することをお勧めします。例えば、認証されたユーザーIDをセッションIDの一部として使用できます。

また、ユースケースによってはセッションの認可を実装する必要がある場合があります。例えば、ユーザーが自分のセッションのみにアクセスでき、他のユーザーのセッションにはアクセスできないようにするなどです。
:::

#### 出力モデルの定義

ストリーミングレスポンスの場合、ジェネレーターは`JsonStreamingResponse`を提供し、PydanticモデルをJSON Lines形式（`application/jsonl`）に自動的にシリアライズします。この形式はOpenAPI 3.2のストリーミング仕様と互換性があり、生成されたTypeScriptクライアントとシームレスに連携します。

デフォルトでは、エージェントはエージェントのレスポンステキストを含む`StreamChunk`オブジェクトを生成します：

```python
class StreamChunk(BaseModel):
    content: str
```

ニーズに合わせて`StreamChunk`モデルをカスタマイズできます：

```python
from pydantic import BaseModel

class StreamChunk(BaseModel):
    content: str
    timestamp: str
    token_count: int
```

:::note
FastAPIは現在ストリーミングレスポンスのOpenAPI仕様生成をサポートしていないため、各ストリーミング操作のレスポンスモデルを明示的に設定する必要があります：

```python
@app.post(
    "/invocations",
    response_class=JsonStreamingResponse,
    responses={200: JsonStreamingResponse.openapi_response(StreamChunk)},
)
async def invoke(input: InvokeInput) -> JsonStreamingResponse:
    return JsonStreamingResponse(handle_invoke(input))
```
:::

[FastAPIでのネイティブサポートのための機能リクエスト](https://github.com/fastapi/fastapi/discussions/14362)が公開されています。

## Bedrock AgentCore Python SDK

ジェネレーターには`PingStatus`定数用に[Bedrock AgentCore Python SDK](https://github.com/aws/bedrock-agentcore-sdk-python)への依存関係が含まれています。必要に応じて、FastAPIの代わりに`BedrockAgentCoreApp`を使用することも簡単ですが、型安全性が失われることに注意してください。

SDKの詳細は[ドキュメント](https://aws.github.io/bedrock-agentcore-starter-toolkit/user-guide/runtime/quickstart.html)を参照してください。

:::note
ジェネレーターがエージェントデプロイを管理するCDK/Terraformインフラストラクチャを生成するため、エージェントデプロイ用にドキュメントで言及されている`bedrock-agentcore-starter-toolkit`を使用する必要はありません。
:::

## Strandsエージェントの実行

### ローカル開発

ジェネレーターは`<your-agent-name>-serve`という名前のターゲットを設定し、開発とテストのためにStrandsエージェントをローカルで起動します。

<NxCommands commands={['run your-project:agent-serve']} />

このコマンドは`uv run`を使用して[Bedrock AgentCore Python SDK](https://github.com/aws/bedrock-agentcore-sdk-python)でStrandsエージェントを実行します。

## Bedrock AgentCore Runtimeへのデプロイ

<Snippet name="agent/bedrock-deployment" parentHeading="Bedrock AgentCore Runtimeへのデプロイ" />

### バンドルとDockerターゲット

Bedrock AgentCore Runtime向けにStrandsエージェントをビルドするため、プロジェクトに`bundle`ターゲットが追加されます：
- `uv export`でPython依存関係を`requirements.txt`ファイルにエクスポート
- `uv pip install`でターゲットプラットフォーム（`aarch64-manylinux2014`）向け依存関係をインストール

Strandsエージェント固有の`docker`ターゲットも追加されます：
- [AgentCore runtime契約](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/runtime-service-contract.html)に従ってエージェントを実行する`Dockerfile`からDockerイメージをビルド

:::tip
Dockerイメージはタグ（例：`my-scope-my-project-agent:latest`）を使用してビルドされ、CDK/Terraformインフラストラクチャで参照されるため、`Dockerfile`をStrandsエージェントプロジェクトと同じ場所に配置できます。
:::

### 認証

#### IAM

デフォルトでは、StrandsエージェントはIAM認証で保護されます。引数なしでデプロイするだけです：

<Infrastructure>
<Fragment slot="cdk">
```ts {5}
import { MyProjectAgent } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectAgent(this, 'MyProjectAgent');
  }
}
```

`grantInvoke`メソッドを使用して、Bedrock AgentCore Runtime上のエージェント呼び出しアクセスを付与できます。例：

```ts {8}
import { MyProjectAgent } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const agent = new MyProjectAgent(this, 'MyProjectAgent');
    const lambdaFunction = new Function(this, ...);

    agent.agentCoreRuntime.grantInvoke(lambdaFunction);
  }
}
```
</Fragment>
<Fragment slot="terraform">
```terraform
# エージェント
module "my_project_agent" {
  # common/terraformプロジェクト内の生成されたモジュールへの相対パス
  source = "../../common/terraform/src/app/agents/my-project-agent"
}
```

エージェント呼び出しアクセスを付与するには、`module.my_project_agent.agent_core_runtime_arn`出力を参照して以下のようなポリシーを追加する必要があります：

```terraform
{
  Effect = "Allow"
  Action = [
    "bedrock-agentcore:InvokeAgentRuntime"
  ]
  Resource = [
    module.my_project_agent.agent_core_runtime_arn,
    "${module.my_project_agent.agent_core_runtime_arn}/*"
  ]
}
```
</Fragment>
</Infrastructure>

#### Cognito JWT認証

以下はエージェントのCognito認証設定方法の例です。

<Infrastructure>
<Fragment slot="cdk">
CognitoによるJWT認証を設定するには、`RuntimeAuthorizerConfiguration.usingCognito()`ファクトリメソッドを使用します：

```ts {13-16}
import { MyProjectAgent } from ':my-scope/common-constructs';
import { RuntimeAuthorizerConfiguration } from '@aws-cdk/aws-bedrock-agentcore-alpha';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const userPool = new UserPool(this, 'UserPool');
    const client = userPool.addClient('Client', {
      authFlows: {
        userPassword: true,
      },
    });

    new MyProjectAgent(this, 'MyProjectAgent', {
      authorizerConfiguration: RuntimeAuthorizerConfiguration.usingCognito(
        userPool,
        [client],
      ),
    });
  }
}
```

または、独自のOIDCプロバイダーを使用したカスタムJWT認証の場合は、`RuntimeAuthorizerConfiguration.usingJWT()`を使用します：

```ts {6-10}
import { MyProjectAgent } from ':my-scope/common-constructs';
import { RuntimeAuthorizerConfiguration } from '@aws-cdk/aws-bedrock-agentcore-alpha';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectAgent(this, 'MyProjectAgent', {
      authorizerConfiguration: RuntimeAuthorizerConfiguration.usingJWT(
        'https://example.com/.well-known/openid-configuration',
        ['client1', 'client2'], // 許可されたクライアントID（オプション）
        ['audience1'],          // 許可されたオーディエンス（オプション）
      ),
    });
  }
}
```
</Fragment>
<Fragment slot="terraform">
JWT認証を設定するには、エージェントモジュールを編集して以下のように`authorizer_configuration`変数を設定します：

```terraform {18-23}
# packages/common/terraform/src/app/agents/my-project-agent/my-project-agent.tf

data "aws_region" "current" {}

locals {
  aws_region = data.aws_region.current.id

  # ユーザープールとクライアントIDに置き換えるか、変数として公開してください
  user_pool_id = "xxx"
  user_pool_client_ids = ["yyy"]
}

module "agent_core_runtime" {
  source = "../../../core/agent-core"
  agent_runtime_name = "MyProjectAgent"
  docker_image_tag = "my-scope-my-project-agent:latest"
  server_protocol = "HTTP"
  authorizer_configuration = {
    custom_jwt_authorizer = {
      discovery_url = "https://cognito-idp.${local.aws_region}.amazonaws.com/${local.user_pool_id}/.well-known/openid-configuration"
      allowed_clients = local.user_pool_client_ids
    }
  }
  env = var.env
  additional_iam_policy_statements = var.additional_iam_policy_statements
  tags = var.tags
}
```
</Fragment>
</Infrastructure>

### オブザーバビリティ

エージェントは`Dockerfile`で自動計装を設定することで、[AWS Distro for Open Telemetry](https://aws.amazon.com/otel/)（ADOT）を使用したオブザーバビリティが自動的に設定されます。

トレースはCloudWatch AWSコンソールのメニューから「GenAI Observability」を選択して確認できます。トレースが表示されるには[Transaction Search](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-Transaction-Search.html)を有効にする必要があります。

詳細は[AgentCoreオブザーバビリティドキュメント](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/observability-configure.html)を参照してください。

## Strandsエージェントの呼び出し

### ローカルサーバーの呼び出し

`<your-agent-name>-serve`ターゲット経由でローカル実行中のエージェントを呼び出すには、ローカルエージェントが実行されているポートの`/invocations`に単純なPOSTリクエストを送信できます。例えば、`curl`を使用：

```bash
curl -N -X POST http://localhost:8081/invocations \
  -d '{"prompt": "what is 3 + 5?", "session_id": "abcdefghijklmnopqrstuvwxyz0123456789"}' \
  -H "Content-Type: application/json"
```

:::note
`curl`に与えられる`-N`引数は出力ストリームのバッファリングを無効にするため、ストリーミングレスポンスをリアルタイムで確認できます。
:::

### デプロイされたエージェントの呼び出し

<Snippet name="agent/runtime-arn" parentHeading="デプロイされたエージェントの呼び出し" />

#### IAM認証

IAM認証の場合、リクエストはAWS Signature Version 4（SigV4）を使用して署名する必要があります。

```bash
acurl <region> bedrock-agentcore -N -X POST \
'https://bedrock
-agentcore.<region>.amazonaws.com/runtimes/<url-encoded-arn>/invocations' \
-d '{"prompt": "what is 3 + 5?", "session_id": "abcdefghijklmnopqrstuvwxyz0123456789"}' \
-H 'Content-Type: application/json'
```

<Drawer title="Sigv4対応curl" trigger="上記のacurlコマンドの設定詳細についてはこちらをクリック">
<Snippet name="tools/acurl" />
</Drawer>

#### JWT / Cognito認証

Cognito認証の場合、`Authorization`ヘッダーにCognitoアクセストークンを渡します：

```bash
curl -N -X POST 'https://bedrock
-agentcore.<region>.amazonaws.com/runtimes/<url-encoded-arn>/invocations' \
  -d '{"prompt": "what is 3 + 5?", "session_id": "abcdefghijklmnopqrstuvwxyz0123456789"}' \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <access-token>"
```

AWS CLIの`cognito-idp admin-initiate-auth`コマンドを使用してアクセストークンを取得できます。例：

```bash
aws cognito-idp admin-initiate-auth \
  --user-pool-id <user-pool-id> \
  --client-id <user-pool-client-id> \
  --auth-flow ADMIN_NO_SRP_AUTH \
  --auth-parameters USERNAME=<username>,PASSWORD=<password> \
  --region <region> \
  --query 'AuthenticationResult.AccessToken' \
  --output text
```