---
title: "Pythonのラムダ関数"
description: "Pythonのラムダ関数のリファレンスドキュメント"
---



import { FileTree } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';
import NxCommands from '@components/nx-commands.astro';

Python Lambda Functionジェネレータは、既存のPythonプロジェクトにLambda関数を追加する機能を提供します。

このジェネレータは、AWS CDKまたはTerraformのインフラストラクチャ設定を含む新しいPython Lambdaハンドラを作成します。生成されるバックエンドはサーバーレスデプロイメントにAWS Lambdaを使用し、[AWS Lambda PowertoolsのParser](https://docs.powertools.aws.dev/lambda/python/latest/utilities/parser/)を使用した型安全性をオプションで提供します。ロギング、AWS X-Rayトレーシング、Cloudwatchメトリクスを含む可観測性のために[AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/python/latest/)を設定します。

## 使用方法

### Lambda関数の生成

Lambda関数は2つの方法で生成できます:

<RunGenerator generator="py#lambda-function" />

### オプション

<GeneratorParameters generator="py#lambda-function" />

## ジェネレータの出力

ジェネレータはプロジェクトに以下のファイルを追加します:

<FileTree>

- \<module-name>
  - \<lambda-function>.py 関数実装

</FileTree>

`functionPath`オプションが指定された場合、ジェネレータは指定されたパスに必要なファイルを追加します:

<FileTree>

- \<module-name>
  - \<custom-path>
    - \<function-name>.py 関数実装

</FileTree>

### インフラストラクチャ

<Snippet name="shared-constructs" />

ジェネレータは選択した`iacProvider`に基づいて関数をデプロイするためのIaC（Infrastructure as Code）を作成します:

<Infrastructure>
<Fragment slot="cdk">
ジェネレータはCDKコンストラクトを作成します。これらは`packages/common/constructs`ディレクトリに配置され、関数のデプロイに使用できます。
</Fragment>
<Fragment slot="terraform">
ジェネレータはTerraformモジュールを作成します。これは`packages/common/terraform/src/app/lambda-functions/<function-name>`ディレクトリに配置され、関数のデプロイに使用できます。
</Fragment>
</Infrastructure>

## 関数の実装

メインの関数実装は`<function-name>.py`にあります。以下は実装例です:

```python
import os

from aws_lambda_powertools import Logger, Metrics, Tracer
from aws_lambda_powertools.metrics import MetricUnit
from aws_lambda_powertools.utilities.parser import event_parser
from aws_lambda_powertools.utilities.parser.models import EventBridgeModel
from aws_lambda_powertools.utilities.typing import LambdaContext

os.environ["POWERTOOLS_METRICS_NAMESPACE"] = "Foo"
os.environ["POWERTOOLS_SERVICE_NAME"] = "Foo"

logger: Logger = Logger()
metrics: Metrics = Metrics()
tracer: Tracer = Tracer()

@tracer.capture_lambda_handler
@metrics.log_metrics
@event_parser(model=EventBridgeModel)
def lambda_handler(event: EventBridgeModel, context: LambdaContext):
    logger.info("Received event", extra={"event": event.model_dump() })
    metrics.add_metric(name="InvocationCount", unit=MetricUnit.Count, value=1)

    try:
        # TODO: 実装
        metrics.add_metric(name="SuccessCount", unit=MetricUnit.Count, value=1)
        # TODO: 必要に応じて成功レスポンスを実装
    except Exception as e:
        logger.exception(e)
        metrics.add_metric(name="ErrorCount", unit=MetricUnit.Count, value=1)
        # TODO: 必要に応じてエラーレスポンスを実装
```

ジェネレータは以下の機能を自動的に設定します:

1. 可観測性のためのAWS Lambda Powertools統合
2. メトリクス収集
3. `@event_parser`を使用した型安全性

### AWS Lambda Powertoolsによる可観測性

#### ロギング

ジェネレータはAWS Lambda Powertoolsを使用した構造化ロギングを設定します。

```python
def lambda_handler(event: EventBridgeModel, context: LambdaContext):
    logger.info("Received event", extra={"event": event.model_dump()})
```

:::tip
デバッグと監視を容易にするため、すべてのユニークなリクエストに相関IDを設定することを推奨します。相関IDのベストプラクティスについては[aws powertools logger](https://docs.powertools.aws.dev/lambda/python/2.22.0/core/logger/#setting-a-correlation-id)ドキュメントを参照してください。
:::

ロガーには自動的に以下が含まれます:
- イベントリクエスト
- Lambdaコンテキスト情報
- コールドスタートインジケータ

#### トレーシング

AWS X-Rayトレーシングが自動的に設定されます。トレースにカスタムサブセグメントを追加できます:

```python
def lambda_handler(event: EventBridgeModel, context: LambdaContext):
    # 新しいサブセグメントを作成
    with tracer.provider.in_subsegment("function-subsegment"):
        # ここにロジックを実装
        return ....
```

#### メトリクス

CloudWatchメトリクスは各リクエストごとに自動収集されます。カスタムメトリクスを追加できます:

```python
def lambda_handler(event: EventBridgeModel, context: LambdaContext):
    metrics.add_metric(name="NewMetric", unit=MetricUnit.Count, value=1)
    return ...
```

デフォルトで収集されるメトリクス:
- 起動回数
- 成功/失敗回数
- コールドスタートメトリクス

### 型安全性

Lambda関数生成時に`eventSource`を選択した場合、関数は[AWS Lambda Powertoolsの`@event_parser`](https://docs.powertools.aws.dev/lambda/python/latest/utilities/parser/)で計装されます。例:

```python {3}
@event_parser(model=EventBridgeModel)
def lambda_handler(event: EventBridgeModel, context: LambdaContext):
    event.detail_type # <- IDEのオートコンプリートが効く型安全なアクセス
```

これは<Link path="guides/fastapi">Fast API</Link>と同様に、[Pydantic](https://docs.pydantic.dev/latest/)を使用してデータモデルを定義できるようにします。

:::tip
DynamoDBストリームやEventBridgeイベント内のカスタムデータなど、イベント内にネストされたカスタムデータがある場合、[Envelopes](https://docs.powertools.aws.dev/lambda/python/latest/utilities/parser/#envelopes)を使用して型安全性を確保できます。
:::

イベントの型指定が必要ない場合は、`eventSource`で`Any`を選択できます。

## バンドリング

ジェネレータは[uv](https://docs.astral.sh/uv/)を使用してLambdaデプロイメントパッケージのPythonバンドリングを自動設定します:

<NxCommands commands={['run <project-name>:bundle']} />

:::note
デプロイメントサイズを最小化するため、複数のLambda関数を<Link path="guides/python-project">`py#project`</Link>ジェネレータで生成した複数のPythonプロジェクトに分割することを検討してください。
:::

このプロセスでは以下を使用します:
1. [`uv export`](https://docs.astral.sh/uv/reference/cli/#uv-export)でPython依存関係を`requirements.txt`にエクスポート
2. [`uv pip install`](https://docs.astral.sh/uv/reference/cli/#uv-pip-install)でLambdaデプロイメント用ターゲットプラットフォーム（`x86_64-manylinux2014`）に依存関係をインストール

:::note
[LambdaアーキテクチャをARMに変更](https://docs.aws.amazon.com/lambda/latest/dg/foundation-arch.html)する場合、バンドルターゲットを`aarch64-manylinux2014`に変更する必要があります。
:::

## 関数のデプロイ

<Snippet name="lambda-function/deploying-your-function" parentHeading="Deploying your Function" />