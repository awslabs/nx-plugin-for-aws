---
title: "CDKインフラストラクチャ"
description: "CDKインフラストラクチャのリファレンスドキュメント"
---



import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import Link from '@components/link.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';

[AWS CDK](https://docs.aws.amazon.com/cdk/v2/guide/home.html)は、クラウドインフラストラクチャをコードで定義しAWS CloudFormationを通じてプロビジョニングするフレームワークです。

TypeScriptインフラストラクチャジェネレータは、TypeScriptで記述されたAWS CDKインフラストラクチャアプリケーションを作成します。生成されたアプリケーションには[Checkov](https://www.checkov.io/)セキュリティチェックによるセキュリティベストプラクティスが含まれています。

## 使用方法

### インフラストラクチャプロジェクトの生成

新しいインフラストラクチャプロジェクトは2つの方法で生成できます:

<RunGenerator generator="ts#infra" />

### オプション

<GeneratorParameters generator="ts#infra" />

## ジェネレータの出力

ジェネレータは`<directory>/<name>`ディレクトリに以下のプロジェクト構造を作成します:

<FileTree>

  - src
    - main.ts CDKステージをデプロイするためのアプリケーションエントリポイント
    - stages CDKステージ定義
      - application-stage.ts ステージでデプロイするスタックの集合を定義
    - stacks CDKスタック定義
      - application-stack.ts メインアプリケーションスタック
  - cdk.json CDK設定ファイル
  - project.json プロジェクト設定とビルドターゲット
  - .checkov.yml Checkov設定ファイル

</FileTree>

:::tip
インフラストラクチャはTypeScriptプロジェクトです。一般的な使用方法については<Link path="guides/typescript-project">TypeScriptプロジェクトドキュメント</Link>を参照してください。
:::

## CDKインフラストラクチャの実装

`src/stacks/application-stack.ts`内でCDKインフラストラクチャの記述を開始できます。例:

```ts title="src/stacks/application-stack.ts" {9-10}
import { Stack, StackProps } from 'aws-cdk-lib';
import { Bucket } from 'aws-cdk-lib/aws-s3'
import { Construct } from 'constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // インフラストラクチャをここに記述
    new Bucket(this, 'MyBucket');
  }
}
```

### ステージとスタック

トップレベルの`src/main.ts`ファイルが`<namespace>-sandbox`という名前のCDK[Stage](https://docs.aws.amazon.com/cdk/v2/guide/stages.html)をインスタンス化していることに気付くでしょう。このステージは開発とテスト用です。

```ts title="src/main.ts"
new ApplicationStage(app, 'project-sandbox', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  },
});
```

`beta`や`prod`ステージを追加して別環境にデプロイすることも可能です:

```ts title="src/main.ts"
new ApplicationStage(app, 'project-beta', {
  env: {
    account: '123456789012', // betaアカウント
    region: 'us-west-2',
  },
});
new ApplicationStage(app, 'project-prod', {
  env: {
    account: '098765432109', // prodアカウント
    region: 'us-west-2',
  },
});
```

ステージはアプリケーションを構成するスタックの集合を定義します。ステージ内で任意の数のスタックをインスタンス化できます:

```ts title="src/stages/application-stage.ts"
import { Stage, StageProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { BackendStack } from '../stacks/backend-stack.js';
import { FrontendStack } from '../stacks/frontend-stack.js';

/**
 * アプリケーションを構成するCDKスタックの集合を定義
 */
export class ApplicationStage extends Stage {
  constructor(scope: Construct, id: string, props?: StageProps) {
    super(scope, id, props);

    new BackendStack(this, 'Backend', {
      crossRegionReferences: true,
    })

    new FrontendStack(this, 'Frontend', {
      crossRegionReferences: true,
    });
  }
}
```

### APIインフラストラクチャ

<Link path="guides/trpc">tRPC API</Link>または<Link path="guides/fastapi">FastAPI</Link>ジェネレータを使用してAPIを作成した場合、`packages/common/constructs`にデプロイ用のコンストラクトが既に存在します。

`my-api`というtRPC APIを作成した場合、コンストラクトをインポートしてインスタンス化するだけで必要なインフラを追加できます:

```ts title="src/stacks/application-stack.ts" {3, 9-12}
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyApi } from ':my-scope/common-constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // APIのインフラストラクチャを追加
    new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });
  }
}
```

### ウェブサイトインフラストラクチャ

<Link path="guides/react-website">CloudScapeウェブサイト</Link>ジェネレータを使用した場合、`packages/common/constructs`にデプロイ用のコンストラクトが存在します:

```ts title="src/stacks/application-stack.ts" {3, 9-10}
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyWebsite } from ':my-scope/common-constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // ウェブサイトのインフラストラクチャを追加
    new MyWebsite(this, 'MyWebsite');
  }
}
```

:::warning
ウェブサイトの<Link path="guides/react-website#runtime-configuration">ランタイム設定</Link>にすべてのAPI設定を含めるためには、APIコンストラクトの*後*に宣言することが重要です。
:::

## インフラストラクチャの合成

`build`ターゲットの一部として、<Link path="guides/typescript-project#building">デフォルトのコンパイル、リンター、テスト</Link>に加え、インフラストラクチャプロジェクトをCloudFormationに合成します。単体で実行するには`synth`ターゲットを使用します:

<NxCommands commands={['run <my-infra>:synth']} />

合成されたクラウドアセンブリはルート`dist`フォルダの`dist/packages/<my-infra-project>/cdk.out`に生成されます。

## セキュリティテスト

プロジェクトに`checkov`ターゲットが追加され、[Checkov](https://www.checkov.io/)を使用してインフラストラクチャのセキュリティチェックが実行されます。

<NxCommands commands={['run <my-infra>:checkov']} />

セキュリティテスト結果はルート`dist`フォルダの`dist/packages/<my-infra-project>/checkov`に保存されます。

:::note
Checkovは`uvx`を使用して実行されるため、[事前に`uv`をインストール](https://docs.astral.sh/uv/getting-started/installation/)する必要があります。
:::

:::caution
一部のCheckovルールはデフォルトで`.checkov.yml`ファイルを通じて無効化されています。使用ケースに基づいてこれらの設定を見直すことを推奨します。
:::

### Checkovチェックの無効化

特定のルールをリソースで無効化する方法は2つあります:

#### コンストラクトのルールを無効化

```typescript
import { suppressRules } from ':my-scope/common-constructs';

// 指定したコンストラクトのCKV_AWS_XXXルールを無効化
suppressRules(construct, ['CKV_AWS_XXX'], '理由');
```

#### 子コンストラクトのルールを無効化

```typescript
import { suppressRules } from ':my-scope/common-constructs';

// Bucketインスタンスの場合、コンストラクトまたはその子要素のCKV_AWS_XXXルールを無効化
suppressRules(construct, ['CKV_AWS_XXX'], '理由', (construct) => construct instanceof Bucket);
```

## AWSアカウントのブートストラップ

AWSアカウントに初めてCDKアプリケーションをデプロイする場合、事前にブートストラップが必要です。

まず、[AWSアカウントの認証情報を設定](https://docs.aws.amazon.com/sdkref/latest/guide/access.html)してください。

次に`cdk bootstrap`コマンドを使用します:

```bash
npx cdk bootstrap aws://<account-id>/<region>
```

詳細は[CDKドキュメント](https://docs.aws.amazon.com/cdk/v2/guide/bootstrapping-env.html)を参照してください。

## AWSへのデプロイ

ビルド後、`deploy`ターゲットを使用してインフラストラクチャをAWSにデプロイできます。

:::caution
CI/CDパイプラインでのデプロイには`deploy-ci`ターゲットを使用してください。詳細は後述します。
:::

まず、[AWSアカウントの認証情報を設定](https://docs.aws.amazon.com/sdkref/latest/guide/access.html)してください。

次にデプロイターゲットを実行します:

<NxCommands commands={['run <my-infra>:deploy <my-infra>-sandbox/*']} />

:::tip
上記コマンドは`<my-infra>-sandbox`ステージの全スタックをデプロイします。`main.ts`で定義されている他のステージも指定可能です。

個別のスタックをデプロイするには完全なスタック名を指定します:

<NxCommands commands={['run <my-infra>:deploy <my-infra>-sandbox/Application']} />
:::

## CI/CDパイプラインでのAWSデプロイ

CI/CDパイプライン経由でAWSにデプロイする場合は`deploy-ci`ターゲットを使用します。

<NxCommands commands={['run <my-infra>:deploy-ci my-stage/*']} />

このターゲットは通常の`deploy`と異なり、事前合成済みのクラウドアセンブリを使用します。これによりパッケージバージョンの変更による非決定性の問題を回避し、すべてのパイプラインステージで同一のアセンブリをデプロイできます。

## AWSインフラストラクチャの削除

`destroy`ターゲットでリソースを削除します:

<NxCommands commands={['run <my-infra>:destroy <my-infra>-sandbox/*']} />

## 詳細情報

CDKの詳細については[CDK Developer Guide](https://docs.aws.amazon.com/cdk/v2/guide/core_concepts.html)と[API Reference](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html)を参照してください。