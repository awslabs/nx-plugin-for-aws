---
title: "FastAPI"
description: "FastAPIのリファレンスドキュメント"
---

import { FileTree, AnchorHeading, Tabs, TabItem } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';

[FastAPI](https://fastapi.tiangolo.com/) は Python で API を構築するためのフレームワークです。

FastAPI ジェネレータは、AWS CDK または Terraform のインフラストラクチャ設定を備えた新しい FastAPI を作成します。生成されるバックエンドはサーバーレスデプロイ用に AWS Lambda を使用し、AWS API Gateway API を介して公開されます。[AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/python/latest/) を設定し、ロギング、AWS X-Ray トレーシング、Cloudwatch メトリクスを含むオブザーバビリティを実現します。

## 使用方法

### FastAPI の生成

新しい FastAPI は2つの方法で生成できます:

<RunGenerator generator="py#fast-api" />

### オプション

<GeneratorParameters generator="py#fast-api" />

<Snippet name="api/api-choice-note" />

:::tip
ストリーミング操作を構築する予定がある場合は、`computeType` として `ServerlessApiGatewayRestApi` (デフォルト) を選択してください。
:::

## ジェネレータの出力

ジェネレータは `<directory>/<api-name>` ディレクトリに以下のプロジェクト構造を作成します:

<FileTree>

- project.json プロジェクト設定とビルドターゲット
- pyproject.toml Python プロジェクト設定と依存関係
- run.sh uvicorn 経由で FastAPI アプリを起動する Lambda Web Adapter ブートストラップスクリプト
- \<module_name>
  - \_\_init\_\_.py モジュール初期化
  - init.py FastAPI アプリのセットアップと powertools ミドルウェアの設定
  - main.py API 実装
- scripts
  - generate_open_api.py FastAPI アプリから OpenAPI スキーマを生成するスクリプト

</FileTree>

### インフラストラクチャ

<Snippet name="shared-constructs" />

<Snippet name="api/shared-constructs" />

## FastAPI の実装

メインの API 実装は `main.py` にあります。ここで API ルートとその実装を定義します。例:

```python
from pydantic import BaseModel
from .init import app, tracer

class Item(BaseModel):
  name: str

@app.get("/items/{item_id}")
@tracer.capture_method
def get_item(item_id: int) -> Item:
    return Item(name=...)

@app.post("/items")
@tracer.capture_method
def create_item(item: Item):
    return ...
```

ジェネレータは以下の機能を自動的に設定します:

1. オブザーバビリティのための AWS Lambda Powertools 統合
2. エラーハンドリングミドルウェア
3. リクエスト/レスポンス相関ID
4. メトリクス収集
5. [Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) と uvicorn による AWS Lambda デプロイ
6. タイプセーフなストリーミング (REST API のみ)

### AWS Lambda Powertools によるオブザーバビリティ

#### ロギング

ジェネレータは AWS Lambda Powertools を使用した構造化ロギングを設定します。ルートハンドラでロガーにアクセスできます:

```python
from .init import app, logger

@app.get("/items/{item_id}")
def read_item(item_id: int):
    logger.info("Fetching item", extra={"item_id": item_id})
    return {"item_id": item_id}
```

ロガーには自動的に以下が含まれます:

- リクエストトレーシング用の相関ID
- リクエストパスとメソッド
- Lambda コンテキスト情報
- コールドスタートインジケータ

#### トレーシング

AWS X-Ray トレーシングが自動的に設定されます。トレースにカスタムサブセグメントを追加できます:

```python
from .init import app, tracer

@app.get("/items/{item_id}")
@tracer.capture_method
def read_item(item_id: int):
    # 新しいサブセグメントを作成
    with tracer.provider.in_subsegment("fetch-item-details"):
        # ロジックをここに記述
        return {"item_id": item_id}
```

#### メトリクス

リクエストごとに CloudWatch メトリクスが自動収集されます。カスタムメトリクスを追加できます:

```python
from .init import app, metrics
from aws_lambda_powertools.metrics import MetricUnit

@app.get("/items/{item_id}")
def read_item(item_id: int):
    metrics.add_metric(name="ItemViewed", unit=MetricUnit.Count, value=1)
    return {"item_id": item_id}
```

デフォルトのメトリクスには以下が含まれます:

- リクエストカウント
- 成功/失敗カウント
- コールドスタートメトリクス
- ルート別メトリクス

### エラーハンドリング

ジェネレータは包括的なエラーハンドリングを含みます:

```python
from fastapi import HTTPException

@app.get("/items/{item_id}")
def read_item(item_id: int):
    if item_id < 0:
        raise HTTPException(status_code=400, detail="Item ID must be positive")
    return {"item_id": item_id}
```

未処理の例外はミドルウェアで捕捉され:

1. スタックトレース付きで例外をログ記録
2. 失敗メトリクスを記録
3. クライアントに安全な 500 レスポンスを返却
4. 相関IDを保持

:::tip
`connection` ジェネレータを使用する場合、より良いコード生成のため API 操作のレスポンスモデルを指定することを推奨します。<Link path="guides/connection/react-fastapi#errors">詳細はこちら</Link>
:::

### ストリーミング

:::caution
ストリーミングは `computeType` が `ServerlessApiGatewayRestApi` (デフォルト) の場合のみサポートされます。API Gateway HTTP API はレスポンスストリーミングをサポートしていません。
:::

生成された FastAPI は、REST API を使用する場合、標準でストリーミングレスポンスをサポートします。インフラストラクチャは [AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) を使用して Lambda 内で uvicorn 経由で FastAPI を実行するように設定されており、すべての REST API 操作に対して API Gateway で `ResponseTransferMode.STREAM` が設定されているため、ストリーミング操作と非ストリーミング操作を併用できます。

#### `JsonStreamingResponse` の使用

生成された `init.py` は、適切な OpenAPI スキーマ生成を伴うタイプセーフなストリーミングを提供する `JsonStreamingResponse` クラスをエクスポートします。これにより、<Link path="guides/connection/react-fastapi">`connection` ジェネレータ</Link>が正しく型付けされたストリーミングクライアントメソッドを生成できます。

```python
from pydantic import BaseModel
from .init import app, JsonStreamingResponse

class Chunk(BaseModel):
    message: str

async def generate_chunks():
    for i in range(100):
        yield Chunk(message=f"This is chunk {i}")

@app.post(
    "/stream",
    response_class=JsonStreamingResponse,
    responses={200: JsonStreamingResponse.openapi_response(Chunk, "Stream of chunks")},
)
async def my_stream() -> JsonStreamingResponse:
    return JsonStreamingResponse(generate_chunks())
```

`JsonStreamingResponse` クラスは:

1. Pydantic モデルを [JSON Lines](https://jsonlines.org/) 形式 (`application/jsonl`) にシリアライズします
2. `itemSchema` を含む正しい OpenAPI スキーマを生成する `openapi_response` ヘルパーを提供し、<Link path="guides/connection/react-fastapi#consuming-a-stream">`connection` ジェネレータ</Link>がタイプセーフなストリーミングクライアントメソッドを生成できるようにします

#### 消費

ストリームレスポンスを消費するには、<Link path="guides/connection/react-fastapi#consuming-a-stream">`connection` ジェネレータ</Link>を使用してストリームチャンクを反復処理するタイプセーフなメソッドを利用できます。

## FastAPI のデプロイ

FastAPI ジェネレータは選択した `iacProvider` に基づき CDK または Terraform のインフラストラクチャコードを作成します。これを使用して FastAPI をデプロイできます。

<Infrastructure>
<Fragment slot="cdk">
API デプロイ用の CDK コンストラクトは `common/constructs` フォルダにあります。CDK アプリケーションで使用できます:

```ts {6-8}
import { MyApi } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // スタックにAPIを追加
    const api = new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });
  }
}
```

これにより以下が設定されます:

1. FastAPI アプリケーションの各操作用 AWS Lambda 関数
2. 関数トリガーとしての API Gateway HTTP/REST API
3. IAM ロールと権限
4. CloudWatch ロググループ
5. X-Ray トレーシング設定
6. CloudWatch メトリクスネームスペース

<Snippet name="api/cors-configuration-cdk-note" />

:::note
`Cognito` 認証を選択した場合、API コンストラクトに `identity` プロパティを指定する必要があります:

```ts {9}
import { MyApi, UserIdentity } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const identity = new UserIdentity(this, 'Identity');

    const api = new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
      identity,
    });
  }
}
```

`UserIdentity` コンストラクトは <Link path="/guides/react-website-auth">`ts#react-website-auth` ジェネレータ</Link> を使用して生成できます
:::
</Fragment>
<Fragment slot="terraform">
API デプロイ用の Terraform モジュールは `common/terraform` フォルダにあります。Terraform 設定で使用できます:

```hcl {2}
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  # Lambda関数用環境変数
  env = {
    ENVIRONMENT = var.environment
    LOG_LEVEL   = "INFO"
  }

  # 追加IAMポリシー（必要な場合）
  additional_iam_policy_statements = [
    # APIに必要な追加権限をここに記述
  ]

  tags = local.common_tags
}
```

これにより以下が設定されます:

1. 全FastAPIルートを処理するAWS Lambda関数
2. 関数トリガーとしてのAPI Gateway HTTP/REST API
3. IAMロールと権限
4. CloudWatchロググループ
5. X-Rayトレーシング設定
6. CORS設定

<Snippet name="api/cors-configuration-terraform-note" />

:::note
`Cognito` 認証を選択した場合、Cognito設定を指定する必要があります:

```hcl {4-5}
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  user_pool_id         = local.user_pool_id
  user_pool_client_ids = [local.client_id]

  env = {
    ENVIRONMENT = var.environment
    LOG_LEVEL   = "INFO"
  }

  tags = local.common_tags
}
```

適切なTerraformリソースまたはモジュールを使用してCognitoユーザープールとクライアントを設定できます
:::

モジュールはいくつかの出力を提供します:

```hcl
# APIエンドポイントにアクセス
output "api_url" {
  value = module.my_api.stage_invoke_url
}

# Lambda関数詳細にアクセス
output "lambda_function_name" {
  value = module.my_api.lambda_function_name
}

# 追加権限付与用IAMロール
output "lambda_execution_role_arn" {
  value = module.my_api.lambda_execution_role_arn
}
```

CORS設定をカスタマイズ:

```hcl
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  # カスタムCORS設定
  cors_allow_origins = ["https://myapp.com", "https://staging.myapp.com"]
  cors_allow_methods = ["GET", "POST", "PUT", "DELETE"]
  cors_allow_headers = [
    "authorization",
    "content-type",
    "x-custom-header"
  ]

  tags = local.common_tags
}
```

:::caution
ジェネレータ実行時に `auth` に `None` を選択した場合、以下のようなCheckovチェック失敗が発生する可能性があります:

<Tabs syncKey="http-rest">
<TabItem label="HTTP API">
```
Check: CKV_AWS_309: "Ensure API GatewayV2 routes specify an authorization type"
 FAILED for resource: aws_apigatewayv2_route.proxy_routes["PUT"]
```
</TabItem>
<TabItem label="REST API">
```
Check: CKV_AWS_59: "Ensure there is no open access to back-end resources through API"
 FAILED for resource: aws_api_gateway_method.proxy_method
```
</TabItem>
</Tabs>

APIを公開したい場合は[抑制コメントを追加](https://www.checkov.io/2.Basics/Suppressing%20and%20Skipping%20Policies.html)できます
:::
</Fragment>
</Infrastructure>

### 統合

<Snippet name="api/type-safe-api-integrations" parentHeading="Integrations" />

#### コード生成

<Infrastructure>
<Fragment slot="cdk">
FastAPI の操作は Python で定義され、CDK インフラストラクチャは TypeScript で記述されるため、統合のタイプセーフなインターフェースを提供するためコード生成を実施します。

共通コンストラクトの `project.json` に `generate:<ApiName>-metadata` ターゲットが追加され、このコード生成を容易にします。これは `packages/common/constructs/src/generated/my-api/metadata.gen.ts` のようなファイルを生成します。ビルド時に生成されるためバージョン管理対象外です。

:::note
API を変更する際は、CDK コンストラクトが消費する型が最新であることを保証するためビルドを実行する必要があります。

<PackageManagerShortCommand commands={["build"]} />
:::

:::tip
CDK インフラストラクチャと FastAPI を同時に開発する場合、[`nx watch`](https://nx.dev/nx-api/nx/documents/watch) を使用して API 変更のたびに型を再生成できます:

<NxCommands
  commands={[
    'watch --projects=<FastAPIProject> -- \\ ',
    'run <InfraProject>:"generate:<ApiName>-metadata"',
  ]}
/>
:::
</Fragment>
<Fragment slot="terraform">
:::note
Terraform のタイプセーフ統合はサポートしていないため、`iacProvider` に Terraform を選択した場合コード生成ターゲットは設定されません
:::
</Fragment>
</Infrastructure>

### アクセス権限付与（IAMのみ）

`IAM` 認証を選択した場合、`grantInvokeAccess` メソッドを使用して API へのアクセスを許可できます:

<Infrastructure>
<Fragment slot="cdk">
```ts
api.grantInvokeAccess(myIdentityPool.authenticatedRole);
```
</Fragment>
<Fragment slot="terraform">
```hcl
# API呼び出しを許可するIAMポリシーを作成
resource "aws_iam_policy" "api_invoke_policy" {
  name        = "MyApiInvokePolicy"
  description = "FastAPI呼び出しを許可するポリシー"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = "execute-api:Invoke"
        Resource = "${module.my_api.api_execution_arn}/*/*"
      }
    ]
  })
}

# ポリシーをIAMロールにアタッチ（例: 認証済みユーザーロール）
resource "aws_iam_role_policy_attachment" "api_invoke_access" {
  role       = aws_iam_role.authenticated_user_role.name
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}

# 既存ロールにアタッチ（名前指定）
resource "aws_iam_role_policy_attachment" "api_invoke_access_existing" {
  role       = "MyExistingRole"
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}
```

IAMポリシーで使用する主要な出力:

- `module.my_api.api_execution_arn` - execute-api:Invoke 権限付与用
- `module.my_api.api_arn` - API Gateway ARN
- `module.my_api.lambda_function_arn` - Lambda関数ARN
</Fragment>
</Infrastructure>

## ローカル開発

ジェネレータはローカル開発サーバーを設定します。以下で起動できます:

<NxCommands commands={['run my-api:serve']} />

これにより以下を含むローカル FastAPI 開発サーバーが起動します:

- コード変更時の自動リロード
- `/docs` または `/redoc` のインタラクティブAPIドキュメント
- `/openapi.json` のOpenAPIスキーマ

## FastAPI の呼び出し

React ウェブサイトから API を呼び出すには <Link path="guides/connection/react-fastapi">`connection` ジェネレータ</Link>を使用できます。