---
title: "クイックスタートガイド"
description: "@aws/nx-pluginの使い方に関するクイックスタート。"
---



import { Steps } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import Snippet from '@components/snippet.astro';
import CreateNxWorkspaceCommand from '@components/create-nx-workspace-command.astro';
import InstallCommand from '@components/install-command.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import Infrastructure from '@components/infrastructure.astro';

このガイドでは、`@aws/nx-plugin` をインストールして AWS 上でプロジェクトを迅速に構築する基本手順を説明します。

:::tip
より詳細なフルスタックアプリケーション構築チュートリアルについては、<Link path="get_started/tutorials/dungeon-game/overview">ダンジョンアドベンチャーチュートリアル</Link>をご覧ください。
:::

## 前提条件

始める前に以下のグローバル依存関係が必要です：

<Snippet name="prerequisites" />

## ステップ1: 新しいNxワークスペースの初期化

次のコマンドを実行して、任意のパッケージマネージャーでNxワークスペースを作成します：

<CreateNxWorkspaceCommand workspace="my-project" />

:::tip
IaC（Infrastructure as Code）プロバイダーとして[CDK](https://docs.aws.amazon.com/cdk/)または[Terraform](https://developer.hashicorp.com/terraform)を選択するプロンプトが表示されます。`--iacProvider`オプションを付けて実行するとプロンプトをスキップできます：

<Infrastructure>
<Fragment slot="cdk">
<CreateNxWorkspaceCommand workspace="my-project" iacProvider="CDK" />
</Fragment>
<Fragment slot="terraform">
<CreateNxWorkspaceCommand workspace="my-project" iacProvider="Terraform" />
</Fragment>
</Infrastructure>
:::

完了したらプロジェクトディレクトリに移動します：

```sh
cd my-project
```

## ステップ2: ジェネレータを使ったプロジェクトのスキャフォールディング

このクイックスタートではtRPC API、Reactウェブサイト、Cognito認証、CDK/Terraformインフラを追加します。左側のナビゲーションバーにある__ガイド__から、利用可能なジェネレータの完全なリストを確認できます。

### tRPC APIの追加

<RunGenerator generator="ts#trpc-api" requiredParameters={{ name: 'demo-api', auth: 'IAM' }} />

APIは`packages/demo-api`フォルダ内に作成されます。

### Reactウェブサイトの追加

<RunGenerator generator="ts#react-website" requiredParameters={{ name: 'demo-website' }} />

新しいReactウェブサイトが`packages/demo-website`にスキャフォールドされます。

### Cognito認証の追加

<RunGenerator generator="ts#react-website#auth" requiredParameters={{ project: '@my-project/demo-website', cognitoDomain: 'my-demo' }} />

ウェブサイトにCognito認証を追加するためのインフラとReactコードを設定します。

### フロントエンドとバックエンドの接続

<RunGenerator generator="api-connection" requiredParameters={{ sourceProject: '@my-project/demo-website', targetProject: '@my-project/demo-api' }} />

ウェブサイトがtRPC APIを呼び出せるように必要なプロバイダーを設定します。

### インフラの追加

選択したIaCプロバイダーに基づいてインフラプロジェクトを追加します。

<Infrastructure>
<Fragment slot="cdk">
<RunGenerator generator="ts#infra" requiredParameters={{ name: 'infra' }} />

AWSにインフラをデプロイするためのCDKアプリを設定します。
</Fragment>
<Fragment slot="terraform">
<RunGenerator generator="terraform#project" requiredParameters={{ name: 'infra' }} />

AWSにインフラをデプロイするためのTerraformプロジェクトを設定します。
</Fragment>
</Infrastructure>

## ステップ3: ローカル環境でのウェブサイトとAPIの実行

次のコマンドでウェブサイトと接続されたAPIのローカル開発サーバーを起動します：

<NxCommands commands={['run demo-website:serve-local']} />

ウェブサイトは`http://localhost:4200`で利用可能になります。ウェブサイトとAPIへの変更はホットリロードで即時反映されます。

## ステップ4: クラウドリソースの定義とAWSへのデプロイ

<Infrastructure>
<Fragment slot="cdk">
`packages/infra/src/stacks/application-stack.ts`を開き、以下のコードを追加します：

```typescript
import * as cdk from 'aws-cdk-lib';
import { DemoApi, DemoWebsite, UserIdentity } from ':my-project/common-constructs';
import { Construct } from 'constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    const identity = new UserIdentity(this, 'identity');
    const api = new DemoApi(this, 'api', {
      integrations: DemoApi.defaultIntegrations(this).build(),
    });
    api.grantInvokeAccess(identity.identityPool.authenticatedRole);

    new DemoWebsite(this, 'website');
  }
}
```

これがフルスタックアプリケーションをデプロイするために必要なCDKコードの全量です。
</Fragment>
<Fragment slot="terraform">
`packages/infra/src/main.tf`を開き、以下のコードを追加します：

```hcl
# @aws/nx-pluginの利用状況追跡モジュール
module "metrics" {
  source = "../../common/terraform/src/metrics"
}

# ユーザーアイデンティティのデプロイ
module "user_identity" {
  source = "../../common/terraform/src/core/user-identity"
}

# APIのデプロイ
module "demo_api" {
  source = "../../common/terraform/src/app/apis/demo-api"
}

# 認証ユーザーへのAPI呼び出し権限付与
resource "aws_iam_policy" "api_invoke_policy" {
  name        = "DemoApiInvokePolicy"
  description = "Policy to allow authenticated users to invoke the API"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = "execute-api:Invoke"
        Resource = "${module.demo_api.api_execution_arn}/*/*"
      }
    ]
  })
}

resource "aws_iam_role_policy_attachment" "authenticated_api_access" {
  role       = module.user_identity.authenticated_role_name
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}

# ウェブサイトのデプロイ
provider "aws" {
  alias  = "us_east_1"
  region = "us-east-1"
}

module "demo_website" {
  source = "../../common/terraform/src/app/static-websites/demo-website"

  providers = {
    aws.us_east_1 = aws.us_east_1
  }

  depends_on = [module.user_identity, module.demo_api]
}
```

これがフルスタックアプリケーションをデプロイするために必要なTerraformコードの全量です。
</Fragment>
</Infrastructure>

### インフラのビルドとデプロイ

プロジェクトをビルドします：

<NxCommands commands={['run-many --target build --all']} />

:::tip
リンターエラーが発生した場合は、次のコマンドで自動修正できます：

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
:::

インフラのブートストラップを実行します：

<Infrastructure>
<Fragment slot="cdk">
<NxCommands commands={['run infra:bootstrap']} />

:::tip
CDKブートストラップは、デプロイ対象のAWSリージョンとウェブサイト用AWS WAF WebACLのデプロイに必要な`us-east-1`の両方で実行する必要があります。
:::
</Fragment>
<Fragment slot="terraform">
<NxCommands commands={['run infra:bootstrap']} />

:::tip
TerraformブートストラップはTerraform状態ファイルを保存するS3バケットを作成します。これはAWSアカウント/リージョン組み合わせごとに1回のみ実行すれば十分です。
:::
</Fragment>
</Infrastructure>

プロジェクトをデプロイします：

<Infrastructure>
<Fragment slot="cdk">
<NxCommands commands={['run infra:deploy my-project-sandbox/*']} />
</Fragment>
<Fragment slot="terraform">
<NxCommands commands={['run infra:apply']} />

:::tip
このコマンドは最初に`terraform plan`を実行して変更内容を表示し、その後変更を適用してインフラをデプロイします。
:::
</Fragment>
</Infrastructure>

## ステップ5: デプロイ済みクラウドリソースを使ったウェブサイトのテスト

<Steps>
1. `runtime-config.json`ファイルを取得：

    <NxCommands commands={['run demo-website:load:runtime-config']} />

2. ローカルウェブサイトサーバーを起動

    <NxCommands commands={['run demo-website:serve']} />
</Steps>

ウェブサイトは`http://localhost:4200`で利用可能になり、デプロイしたAPIと認証リソースを指すようになります。

---

おめでとうございます！🎉 `@aws/nx-plugin`を使ったフルスタックアプリケーションの構築とデプロイに成功しました！