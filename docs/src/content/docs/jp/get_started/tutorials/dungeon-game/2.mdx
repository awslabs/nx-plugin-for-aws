---
title: "エージェント型AIダンジョンゲーム"
description: "@aws/nx-pluginを使用したエージェント型AI搭載のダンジョン冒険ゲームの作り方のチュートリアル"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2EDiff from '@components/e2e-diff.astro';
import E2ECode from '@components/e2e-code.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

import { getDungeonAdventureElectroDbDependencies } from '../../../../../../../../e2e/src/utils';

## モジュール2: ゲームAPIとインベントリMCPサーバーの実装

まずゲームAPIの実装から始めます。これには合計5つのAPIを作成する必要があります:

1. `saveGame` - ゲームの作成または更新
2. `queryGames` - 保存済みゲームのページネーション付きリストを返す
3. `saveAction` - 指定したゲームのアクションを保存
4. `queryActions` - ゲームに関連する全アクションのページネーション付きリストを返す
5. `queryInventory` - プレイヤーのインベントリ内アイテムのページネーション付きリストを返す

### APIスキーマ

APIの入力と出力を定義するため、`packages/game-api/src/schema`ディレクトリ内で[Zod](https://zod.dev/)を使用してスキーマを作成します:

<Tabs>
  <TabItem label="action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/action.ts.template" />
  </TabItem>
  <TabItem label="common.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/common.ts.template" />
  </TabItem>
  <TabItem label="game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/game.ts.template" />
  </TabItem>
  <TabItem label="inventory.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/inventory.ts.template" />
  </TabItem>
  <TabItem label="index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/schema/index.ts.old.template" after="dungeon-adventure/2/schema/index.ts.template" />
  </TabItem>
</Tabs>

このプロジェクトで使用しないため、`packages/game-api/src/schema/echo.ts`ファイルは削除できます。

<Aside type="tip">
上記のように、Zodで定義した各スキーマに対して`z.TypeOf`構文を使用してインターフェースをエクスポートしています。これにより、重複作業なしにZod定義をTypeScriptインターフェースに変換できます！
</Aside>

### エンティティモデリング

アプリケーションのER図は以下の通りです:

<Image class="centered-image white-bg" src={dungeonAdventureErPng} alt="dungeon-adventure-er.png" width="400" height="300" />

{/* Generated from the following PlantUML: */}
{/*
@startuml Game API Entity Relationship Diagram

!theme plain

skinparam linetype ortho
skinparam roundcorner 10

entity "Game" as game {
  + playerName : string <<PK>>
  --
  genre : string
  lastUpdated : string
}

entity "Action" as action {
  + playerName : string <<PK>>
  + timestamp : string <<SK>>
  --
  role : string
  content : string
}

entity "Item" as item {
  + playerName : string <<PK>>
  + itemName : string
  --
  emoji : string (optional)
  lastUpdated : string
  quantity : number
}

game ||--o{ action
game ||--o{ item

@enduml
*/}

DynamoDBでデータベースを実装し、[ElectroDB](https://electrodb.dev/en/core-concepts/introduction/) DynamoDBクライアントライブラリを使用して簡素化します。まず`electrodb`とDynamoDBクライアントを次のコマンドでインストールします:

<InstallCommand pkg={getDungeonAdventureElectroDbDependencies()} />

<Aside>
すべての依存関係はルート`package.json`に追加されます。これは`@aws/nx-plugin`が[シングルバージョンポリシー](https://nx.dev/concepts/decisions/dependency-management#single-version-policy)原則に従うためです。詳細は<Link path="guides/typescript-project#dependencies">tsプロジェクトガイド</Link>を参照してください。
</Aside>

上記のER図に従ってElectroDBエンティティを定義するため、`packages/game-api/src/entities`フォルダ内に以下のファイルを作成します:

<Tabs>
  <TabItem label="action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/action.ts.template" />
  </TabItem>
  <TabItem label="game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/game.ts.template" />
  </TabItem>
  <TabItem label="inventory.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/inventory.ts.template" />
  </TabItem>
</Tabs>

ElectroDBでは型定義だけでなく、タイムスタンプなどのデフォルト値も設定できます。またElectroDBはDynamoDB使用時のベストプラクティスである[シングルテーブル設計](https://electrodb.dev/en/core-concepts/single-table-relationships/)に従います。

<Aside>
ElectroDBは[コレクション](https://electrodb.dev/en/modeling/collections/)をサポートしていますが、このチュートリアルでは簡略化のため使用しません。
</Aside>

MCPサーバーがインベントリと連携できるよう、`packages/game-api/src/index.ts`でインベントリエンティティをエクスポートします:

<Tabs>
<TabItem label="packages/game-api/src/index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/index.ts.old.template" after="dungeon-adventure/2/index.ts.template" />
</TabItem>
</Tabs>

:::note
エンティティを別の共有プロジェクトにリファクタリングすれば、MCPサーバーがAPIに依存せず、パッケージ構造が改善されます。
:::

### tRPCコンテキストへのDynamoDBクライアント追加

各プロシージャでDynamoDBクライアントにアクセスするため、コンテキスト経由で渡せるクライアントの単一インスタンスを作成します。これを行うため、`packages/game-api/src`内で以下の変更を加えます:

<Tabs>
  <TabItem label="middleware/dynamodb.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/middleware/dynamodb.ts.template" />

`DynamoDBClient`を作成しコンテキストに注入するプラグインです。
  </TabItem>
  <TabItem label="middleware/index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/middleware/index.ts.old.template" after="dungeon-adventure/2/middleware/index.ts.template" />

`IMiddlewareContext`を拡張して`IDynamoDBContext`を追加します。
  </TabItem>
  <TabItem label="init.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/init.ts.old.template" after="dungeon-adventure/2/init.ts.template" />

DynamoDBプラグインを組み込みます。

<Aside>
`concat` APIは定義したプロシージャにミドルウェアをバインドします。詳細は[concatガイド](https://trpc.io/docs/server/middlewares#concat)を参照してください。
</Aside>
  </TabItem>
</Tabs>

### プロシージャの定義

APIメソッドを実装します。`packages/game-api/src/procedures`内で以下の変更を加えます:

#### クエリ

<Tabs>
  <TabItem label="query-actions.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-actions.ts.template" />
  </TabItem>
  <TabItem label="query-games.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-games.ts.template" />
  </TabItem>
  <TabItem label="query-inventory.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-inventory.ts.template" />
  </TabItem>
</Tabs>

#### ミューテーション

<Tabs>
  <TabItem label="save-action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-action.ts.template" />
  </TabItem>
  <TabItem label="save-game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-game.ts.template" />
  </TabItem>
</Tabs>

このプロジェクトで使用しないため、`echo.ts`ファイル（`packages/game-api/src/procedures`内）も削除できます。

### ルーター設定

プロシージャをAPIに接続するため、以下のファイルを更新します:

<Tabs>
  <TabItem label="packages/game-api/src/router.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/router.ts.old.template" after="dungeon-adventure/2/router.ts.template" />
</TabItem>
</Tabs>

### インベントリMCPサーバー

エージェントがプレイヤーのインベントリを管理できるMCPサーバーを作成します。

エージェント用に以下のツールを定義します:

- `list-inventory-items` - プレイヤーの現在のインベントリアイテムを取得
- `add-to-inventory` - インベントリにアイテムを追加
- `remove-from-inventory` - インベントリからアイテムを削除

時間節約のため、すべてのツールをインラインで定義します:

<Tabs>
  <TabItem label="packages/inventory/src/mcp-server/server.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/mcp/server.ts.old.template" after="dungeon-adventure/2/mcp/server.ts.template" />
</TabItem>
</Tabs>

ツール数が増えた場合、必要に応じて別ファイルにリファクタリングできます。

`packages/inventory/src/mcp-server`内の未使用の`tools`と`resources`ディレクトリは削除できます。

### インフラストラクチャ

最後にDynamoDBテーブルを作成し、Game APIからの操作権限を付与するため、`packages/infra/src`を以下のように更新します:

<Tabs>
  <TabItem label="constructs/electrodb-table.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/constructs/electrodb-table.ts.template" />
  </TabItem>
  <TabItem label="stacks/application-stack.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/1/application-stack.ts.template" after="dungeon-adventure/2/stacks/application-stack.ts.template" />

:::note
各プロシージャは個別のLambda関数で提供されるため、最小権限の原則に従い、プロシージャの実装に基づいて必要な読み取り/書き込み権限のみを割り当てられます。
:::
  </TabItem>
</Tabs>

### デプロイとテスト

まずコードベースをビルドします:

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
リンターエラーが発生した場合、以下のコマンドで自動修正できます。

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

次のコマンドでアプリケーションをデプロイできます:

<NxCommands commands={['deploy infra dungeon-adventure-infra-sandbox/*']} />

:::caution
AWSアカウントのブートストラップが必要な場合:

<NxCommands commands={['bootstrap infra']} />
:::

初回デプロイは約8分かかります。以降のデプロイは約2分です。

:::tip
Lambda関数コードの変更を反復する場合、コードベースをビルドした後`--hotswap`フラグ付きでデプロイすると、大幅に短縮（2-3秒）できます。

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/* --hotswap']} />
:::

デプロイ完了後、以下のような出力が表示されます（一部値は編集済み）:

```bash
dungeon-adventure-sandbox-Application
dungeon-adventure-sandbox-Application: deploying... [2/2]

 ✅  dungeon-adventure-sandbox-Application

✨  Deployment time: 354s

Outputs:
dungeon-adventure-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-sandbox-Application.StoryApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

APIは以下の方法でテストできます:
<ul>
<li>tRPCバックエンドのローカルインスタンスを起動し`curl`でAPIを呼び出す</li>
<li>
<Drawer title="Sigv4対応curl" trigger="デプロイ済みAPIをsigv4対応curlで呼び出す">

<Tabs>
  <TabItem label="Bash/Linux/macOS">
`.bashrc`ファイルに以下のスクリプトを追加（`source`で適用）するか、コマンドを実行するターミナルに直接貼り付けます。
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

sigv4認証済みcurlリクエストの実行例:

###### API Gateway
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### ストリーミングLambda関数URL
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
  <TabItem label="Windows PowerShell">
PowerShellプロファイルに関数を追加するか、現在のセッションに直接貼り付けます。
```powershell
function acurl {
    param(
        [Parameter(Mandatory=$true)][string]$Region,
        [Parameter(Mandatory=$true)][string]$Service,
        [Parameter(ValueFromRemainingArguments=$true)][string[]]$CurlArgs
    )

    $AccessKey = aws configure get aws_access_key_id
    $SecretKey = aws configure get aws_secret_access_key
    $SessionToken = aws configure get aws_session_token

    & curl --aws-sigv4 "aws:amz:$Region`:$Service" --user "$AccessKey`:$SecretKey" -H "X-Amz-Security-Token: $SessionToken" @CurlArgs
}
```

実行例:

###### API Gateway
```powershell
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### ストリーミングLambda関数URL
```powershell
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
</Tabs>

</Drawer>
</li>
</ul>


<Tabs>
  <TabItem label="ローカル">
    以下のコマンドで`game-api`サーバーを起動:

    <NxCommands highlights={['dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY']} env={{TABLE_NAME:"dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY"}} commands={["run @dungeon-adventure/game-api:serve"]} />

    <Aside type="caution">
    `dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX`のCDKデプロイ出力値でハイライト部分を置き換えてください。
    </Aside>

    サーバー起動後、次のコマンドで呼び出せます:

    ```bash
    curl -X GET 'http://localhost:2022/games.query?input=%7B%7D'
    ```
  </TabItem>
  <TabItem label="デプロイ済み">
```bash "https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/" "ap-southeast-2"
acurl ap-southeast-2 execute-api -X GET 'https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/games.query?input=%7B%7D'
```
    <Aside type="caution">
    `dungeon-adventure-infra-sandbox-Application.GameApiGameApiEndpointXXX`のCDKデプロイ出力値でURLを置き換え、リージョンを適切に設定してください。
    </Aside>
  </TabItem>
</Tabs>

:::note
APIテストで渡す`%7B%7D`はURIエンコードされた空のJSONオブジェクト（`{}`）です。
:::

コマンドが成功すると、以下のようなレスポンスが返ります:

```json
{"result":{"data":{"items":[],"cursor":null}}}
```

おめでとうございます！tRPCを使用した最初のAPIの構築とデプロイに成功しました！ 🎉🎉🎉