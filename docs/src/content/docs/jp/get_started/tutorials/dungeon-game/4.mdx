---
title: "UIの構築"
description: "@aws/nx-pluginを使用したエージェント型AI搭載のダンジョン冒険ゲームの作り方チュートリアル"
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## タスク1: ローカル開発サーバーの設定

UIの構築を開始するには、ローカル開発サーバーをデプロイされたサンドボックス環境に向ける設定が必要です。以下のコマンドを実行してください:

<NxCommands commands={["run @dungeon-adventure/game-ui:load:runtime-config"]} />

このコマンドはデプロイ済みの`runtime-config.json`を取得し、`packages/game-ui/public`フォルダ内にローカル保存します。

開発サーバーを起動するには、以下のコマンドを実行します:

<NxCommands commands={["run @dungeon-adventure/game-ui:serve"]} />

ブラウザでローカルウェブサイトを開くと、ログインが促され、新規ユーザー作成のプロンプトが表示されます。完了するとベースラインのウェブサイトが表示されます:

<Image src={baselineWebsitePng} alt="baseline-website.png" width="800" height="600" />

<Aside type="caution">
本モジュールの残りの作業中は開発サーバーを起動したままにすることをお勧めします。変更は自動的にホットリロードされます。
</Aside>

:::tip
代わりにNxコマンドを実行して、接続されたAPIローカルサーバーを起動することで、tRPC APIとウェブサイトの同時開発が可能になります。<NxCommands commands={["run @dungeon-adventure/game-ui:serve-local"]} env={{TABLE_NAME:"dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY"}} />
:::

## タスク2: 新しい'/game'ルートの作成

`@tanstack/react-router`の機能を活用するため、型安全な新規ルートを作成しましょう。
これを行うには、`packages/game-ui/src/routes/game/index.tsx`に空ファイルを作成します。ファイルが即座に更新されることに気づくでしょう。

`@tanstack/react-router`が自動的に新規ルートを設定し、作成したファイルには既にルートパスが設定されています:

```tsx
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/game/')({
  component: RouteComponent,
})

function RouteComponent() {
  return <div>Hello "/game/"!</div>
}
```

`http://localhost:4200/game`にアクセスすると、新しいページが表示されます。

<Image src={baselineGamePng} alt="baseline-game.png" width="800" height="600" />

`index.tsx`ファイルを更新してデフォルトで`/game`ルートを読み込むようにします。`to`フィールドを更新する際、型安全なルートのリストから選択できます。

<Tabs>
<TabItem label="routes/index.tsx">
<E2EDiff before="dungeon-adventure/4/routes/index.tsx.old.template" after="dungeon-adventure/4/routes/index.tsx.template" lang="tsx" />
</TabItem>
</Tabs>

## タスク3: レイアウトの更新

デフォルトのレイアウトはゲームというよりSaaS型ビジネスアプリケーション向けの設定になっています。
ダンジョン風ゲーム用にレイアウトを再設定し、テーマを変更するには、`packages/game-ui/src`以下を変更します:

<Tabs>
<TabItem label="config.ts">
<E2EDiff before="dungeon-adventure/4/config.ts.old.template" after="dungeon-adventure/4/config.ts.template" lang="typescript" />
</TabItem>
<TabItem label="components/AppLayout/index.tsx">
<E2ECode path="dungeon-adventure/4/AppLayout/index.tsx.template" lang="tsx" />
</TabItem>
<TabItem label="styles.css">
<E2ECode path="dungeon-adventure/4/styles.css.template" lang="css" />
</TabItem>
</Tabs>

使用されていない`packages/game-ui/src/hooks/useAppLayout.tsx`ファイルは削除します。

## タスク4: ストーリーエージェントの統合

ストーリーエージェントとの連携用クライアントを初期化するフックを作成しましょう。

<Tabs>
<TabItem label="hooks/useStoryAgent.tsx">
<E2ECode path="dungeon-adventure/4/hooks/useStoryAgent.tsx.template" lang="tsx" />
</TabItem>
</Tabs>

このフックは以下を実行します:

- `runtime-config.json`からAgent ARNを取得し、
- ARNからAgentCore Runtimeの呼び出しURLを構築し、
- ログインユーザーのJWTトークンとランダムセッションIDでAgentを呼び出し、
- ストリーミングされるエージェントメッセージチャンクを消費するための非同期イテレータを返します。

:::tip
`connection`ジェネレータを使用したため、Game APIとの統合は既に設定済みです。同様のエージェント体験を希望される場合は[このGitHubイシュー](https://github.com/awslabs/nx-plugin-for-aws/issues/326)へ+1をお願いします。
:::

## タスク5: ゲームページの作成

APIを呼び出してゲーム実装を完成させるゲームページを作成するには、`packages/game-ui/src/routes/game`内の以下のファイルを更新します:

<Tabs>
<TabItem label="index.tsx">
<E2ECode path="dungeon-adventure/4/routes/game/index.tsx.template" lang="tsx" />
</TabItem>
<TabItem label="$playerName.tsx">

<E2ECode path="dungeon-adventure/4/routes/game/$playerName.tsx.template" lang="tsx" />

<Aside type="tip">
`$playerName`構文は`@tanstack/react-router`に`playerName`を[パスパラメータ](https://tanstack.com/router/v1/docs/framework/react/guide/path-params)として扱うよう指示します。さらに、`validateSearch`メソッドを実装することで、`genre`クエリパラメータがジャンル列挙型に厳密に型付けされます。
</Aside>
</TabItem>
</Tabs>

これらの変更を行うと、ローカル開発サーバー(http://localhost:4200/)でゲームをプレイできるようになります。

<Drawer title="ビルドとデプロイ" trigger="Cloudfrontへのコードのビルド＆デプロイも可能です">

## タスク6: ビルドとデプロイ

### コードのビルド
コードをビルドするには、以下のコマンドを実行します:

<PackageManagerShortCommand commands={["build"]} />

### アプリケーションのデプロイ
アプリケーションをデプロイするには、以下のコマンドを実行します:

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/*']} />

デプロイ後、Cloudfront URLに移動します。このURLを見つけるには、CDKデプロイ出力を確認してください。

</Drawer>

<Image src={gameSelectPng} alt="game-select.png" width="500" height="400" />
<div style="margin-top: -100px; margin-left: 100px;">
<Image src={gameConversationPng} alt="game-conversation.png" width="500" height="400" />
</div>

おめでとうございます。エージェント型ダンジョンアドベンチャーゲームの構築とデプロイが完了しました! 🎉🎉🎉