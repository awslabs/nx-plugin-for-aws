---
title: "Story ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…ã¨è¨­å®š"
description: "@aws/nx-pluginã‚’ä½¿ç”¨ã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‹AIæ­è¼‰ã®ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³å†’é™ºã‚²ãƒ¼ãƒ ã®ä½œã‚Šæ–¹ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«"
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## ã‚¿ã‚¹ã‚¯1: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè£…

ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯[Strands](https://strandsagents.com/)ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã€`Game`ã¨`Action`ã®ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ç‰©èªã‚’é€²è¡Œã—ã¾ã™ã€‚ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªMCPã‚µãƒ¼ãƒãƒ¼ã¨é€£æºã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰€æŒã‚¢ã‚¤ãƒ†ãƒ ã‚’ç®¡ç†ã™ã‚‹ã‚ˆã†è¨­å®šã—ã¾ã™ã€‚

:::note
æœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€å„å‘¼ã³å‡ºã—ãŒå®Œå…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’å«ã‚€ç‹¬ç«‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ãªã‚‹ã€Œã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ã€ãªå®Ÿè£…ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯[Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html)ã®çµ±åˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Strandsã¨AgentCore Memoryã®é€£æº](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands)ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
:::

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè£…

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ã€`packages/story/dungeon_adventure_story/agent`é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã™ï¼š

<Tabs>
  <TabItem label="main.py">
<E2EDiff lang="python" before="dungeon-adventure/3/main.py.old.template" after="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2EDiff lang="python" before="dungeon-adventure/3/agent.py.old.template" after="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

ã“ã®å®Ÿè£…ã§ã¯ä»¥ä¸‹ã‚’æ§‹æˆã—ã¾ã™ï¼š

- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã€ã‚¸ãƒ£ãƒ³ãƒ«ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡ºã€
- SigV4èªè¨¼ã§MCPã‚µãƒ¼ãƒãƒ¼ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ§‹ç¯‰ã€ãŠã‚ˆã³
- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨MCPã‚µãƒ¼ãƒãƒ¼ãƒ„ãƒ¼ãƒ«ã‚’å‚™ãˆãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆã€‚

## ã‚¿ã‚¹ã‚¯2: ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ†ã‚¹ãƒˆ

### ã‚³ãƒ¼ãƒ‰ã®ãƒ“ãƒ«ãƒ‰

ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã«ã¯ï¼š

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
ãƒªãƒ³ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è‡ªå‹•ä¿®æ­£ã§ãã¾ã™ã€‚

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

<NxCommands commands={['deploy infra "dungeon-adventure-infra-sandbox/*"']} />

ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ç´„2åˆ†ã§å®Œäº†ã—ã¾ã™ã€‚

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆä¸€éƒ¨ã®å€¤ã¯ç·¨é›†æ¸ˆã¿ï¼‰ï¼š

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox-Application

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆæ–¹æ³•ã¯2é€šã‚Šã‚ã‚Šã¾ã™ï¼š
<ul>
<li>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—`curl`ã§å‘¼ã³å‡ºã™ã€ã¾ãŸã¯</li>
<li>ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿APIã‚’JWTãƒˆãƒ¼ã‚¯ãƒ³ä»˜ãã®curlã§å‘¼ã³å‡ºã™ã€‚</li>
</ul>

<Tabs>
  <TabItem label="ãƒ­ãƒ¼ã‚«ãƒ«">
  ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ï¼š
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã¯CDKãƒ‡ãƒ—ãƒ­ã‚¤å‡ºåŠ›ã®`InventoryMcpArn`ã‚’ä½¿ç”¨ã—ã€å¯¾è±¡`AWS_REGION`ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
    :::

    ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾Œï¼ˆå‡ºåŠ›ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‘¼ã³å‡ºã—ã¾ã™ï¼š

    ```bash
    curl -N -X POST http://127.0.0.1:8081/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿">
    ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆã«ã¯ã€Cognitoèªè¨¼ã«ã‚ˆã‚‹JWTãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãŒå¿…è¦ã§ã™ã€‚ã¾ãšç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ï¼š

    ```bash
    # CDKå‡ºåŠ›ã‹ã‚‰Cognito User Pool IDã¨Client IDã‚’è¨­å®š
    export POOL_ID="<CDKå‡ºåŠ›ã®UserPoolId>"
    export CLIENT_ID="<CDKå‡ºåŠ›ã®UserPoolClientId>"
    export REGION="<ãƒªãƒ¼ã‚¸ãƒ§ãƒ³>"
    ```

    ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ï¼š

    ```bash
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚’ç°¡ç´ åŒ–ã™ã‚‹ãŸã‚MFAã‚’ç„¡åŠ¹åŒ–
    aws cognito-idp set-user-pool-mfa-config \
      --mfa-configuration OFF \
      --user-pool-id $POOL_ID

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "test" \
      --temporary-password "TempPass123-" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ã‚ˆã‚Šå®‰å…¨ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "test" \
      --password "PermanentPass123-" \
      --region $REGION \
      --permanent > /dev/null

    # èªè¨¼ã¨IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='test',PASSWORD='PermanentPass123-' \
      --region $REGION \
      --query "AuthenticationResult.IdToken" \
      --output text)
    ```

    Bedrock AgentCoreãƒ©ãƒ³ã‚¿ã‚¤ãƒ URLã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ï¼š

    ```bash
    # CDKå‡ºåŠ›ã‹ã‚‰Story Agent ARNã‚’è¨­å®š
    export AGENT_ARN="<CDKå‡ºåŠ›ã®StoryAgentArn>"

    # ARNã‚’URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # å‘¼ã³å‡ºã—URLã‚’æ§‹ç¯‰
    export MCP_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘¼ã³å‡ºã—
    curl -N -X POST "$MCP_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    ARNã®URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã¯ã€Bedrock AgentCore APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¿…è¦ã§ã™ã€‚
    :::
  </TabItem>
</Tabs>

ã‚³ãƒãƒ³ãƒ‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®å†’é ­ãƒ†ã‚­ã‚¹ãƒˆãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã•ã‚Œå§‹ã‚ã¾ã™ï¼š

```
You are a new superhero in the bustling metropolis of Metro City...
```

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚Bedrock AgentCore Runtimeä¸Šã«åˆã‚ã¦ã®Strandsã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ§‹ç¯‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã—ãŸï¼ ğŸ‰ğŸ‰ğŸ‰