---
title: "エージェント型AIダンジョンゲーム"
description: "@aws/nx-pluginを使用したエージェント型AI搭載のダンジョン冒険ゲームの作り方のチュートリアル"
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## モジュール3: ストーリーエージェントの実装

ストーリーエージェントは[Strands](https://strandsagents.com/)のエージェントで、`Game`と`Action`のリストをコンテキストとして物語を進行します。インベントリMCPサーバーと連携してプレイヤーの所持アイテムを管理するよう設定します。

:::note
本チュートリアルでは簡略化のため、各呼び出しが完全なメッセージ履歴を含む独立セッションとなる「ステートレス」な実装を採用しています。本番環境では[Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html)の統合を検討してください。StrandsとAgentCore Memoryの連携に関する詳細は[こちら](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands)をご覧ください。
:::

### エージェント実装

`packages/story/dungeon_adventure_story/agent`配下のファイルを更新してエージェントを実装します：

<Tabs>
  <TabItem label="main.py">
<E2EDiff lang="python" before="dungeon-adventure/3/main.py.old.template" after="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2EDiff lang="python" before="dungeon-adventure/3/agent.py.old.template" after="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

この実装では以下を構成します：

- エージェントペイロードからプレイヤー情報、ジャンル、アクションを抽出
- SigV4認証でMCPサーバーを呼び出すクライアントの構築
- システムプロンプトとMCPサーバーツールを備えたエージェントの作成

### デプロイとテスト

まずコードベースをビルドします：

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
リンターエラーが発生した場合、以下のコマンドで自動修正可能です。

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

以下のコマンドでアプリケーションをデプロイできます：

<NxCommands commands={['deploy infra dungeon-adventure-infra-sandbox/*']} />

デプロイは約2分で完了します。

デプロイが完了すると以下のような出力が表示されます（一部の値は編集済み）：

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 ✅  dungeon-adventure-infra-sandbox-Application

✨  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

APIのテスト方法は2通りあります：
<ul>
<li>エージェントサーバーをローカルで起動し`curl`で呼び出す</li>
<li>デプロイ済みAPIをJWTトークン付きのcurlで呼び出す</li>
</ul>

<Tabs>
  <TabItem label="ローカル">
  以下のコマンドでローカルエージェントサーバーを起動：
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    上記コマンドではCDKデプロイ出力の`InventoryMcpArn`を使用し、対象`AWS_REGION`を指定してください
    :::

    サーバー起動後（出力は表示されません）、以下のコマンドで呼び出し：

    ```bash
    curl -N -X POST http://127.0.0.1:8081/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="デプロイ済み">
    デプロイ済みエージェントのテストにはCognito認証によるJWTトークン取得が必要です。まず環境変数を設定：

    ```bash
    # CDK出力からCognito User Pool IDとClient IDを設定
    export POOL_ID="<CDK出力のUserPoolId>"
    export CLIENT_ID="<CDK出力のUserPoolClientId>"
    export REGION="<リージョン>"
    ```

    テストユーザー作成と認証トークン取得：

    ```bash
    # ユーザー作成
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --temporary-password "TempPass123!" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # パスワード設定（本番環境ではより安全なパスワードを使用）
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --password "PermanentPass123!" \
      --region $REGION \
      --permanent > /dev/null

    # 認証とIDトークン取得
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='testuser',PASSWORD='PermanentPass123!' \
      --region $REGION | jq -r '.AuthenticationResult.IdToken')
    ```

    :::caution
    `POOL_ID`にはCDK出力の`UserIdentityUserIdentityUserPoolIdXXX`を、Client IDはCDKデプロイ出力から取得してください
    :::

    Bedrock AgentCoreランタイムURLを使用してエージェントを呼び出し：

    ```bash
    # CDK出力からStory Agent ARNを設定
    export AGENT_ARN="<CDK出力のStoryAgentArn>"

    # ARNをURLエンコード
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # 呼び出しURLを構築
    export MCP_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # エージェント呼び出し
    curl -N -X POST "$MCP_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    ARNのURLエンコードはBedrock AgentCore APIエンドポイントの正しいフォーマットに必要です
    :::
  </TabItem>
</Tabs>

コマンドが成功すると、以下のようなストリーミングイベントが表示されます：

```
data: {"init_event_loop": true}

data: {"start": true}

data: {"start_event_loop": true}

data: {"event": {"messageStart": {"role": "assistant"}}}

data: {"event": {"contentBlockDelta": {"delta": {"text": "Welcome"}, "contentBlockIndex": 0}}}

...
```

おめでとうございます！Bedrock AgentCore Runtime上に初めてのStrandsエージェントを構築・デプロイできました！ 🎉🎉🎉