---
title: ジェネレーターの作成
description: '@aws/nx-pluginを使用してジェネレーターを構築する方法のチュートリアル。'
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## ジェネレーターの構築

新しいジェネレーターを作成しましょう。目標は、tRPC API用の新しいプロシージャを生成することです。

### プラグインのチェックアウト

まず、プラグインをクローンします：

```bash
git clone git@github.com:awslabs/nx-plugin-for-aws.git
```

次に、インストールしてビルドします：

```bash
cd nx-plugin-for-aws
pnpm i
pnpm nx run-many --target build --all
```

### 空のジェネレーターを作成する

新しいジェネレーターを`packages/nx-plugin/src/trpc/procedure`に作成しましょう。まずスキーマとジェネレーターのエントリーポイントを作成します：

<FileTree>
  - packages/nx-plugin/src/trpc/procedure
    - schema.json ジェネレーターの入力を定義します
    - schema.d.ts スキーマに一致するTypeScriptインターフェース
    - generator.ts Nxがジェネレーターとして実行する関数
</FileTree>

以下の内容を各ファイルに追加します。

<Tabs>
  <TabItem label="schema.json">
    ```json
    {
      "$schema": "https://json-schema.org/schema",
      "$id": "tRPCProcedure",
      "title": "Adds a procedure to a tRPC API",
      "type": "object",
      "properties": {
        "project": {
          "type": "string",
          "description": "tRPC API project",
          "x-prompt": "Select the tRPC API project to add the procedure to",
          "x-dropdown": "projects",
          "x-priority": "important"
        },
        "procedure": {
          "description": "The name of the new procedure",
          "type": "string",
          "x-prompt": "What would you like to call your new procedure?",
          "x-priority": "important",
        },
        "type": {
          "description": "The type of procedure to generate",
          "type": "string",
          "x-prompt": "What type of procedure would you like to generate?",
          "x-priority": "important",
          "default": "query",
          "enum": ["query", "mutation"]
        }
      },
      "required": ["project", "procedure"]
    }
    ```
  </TabItem>
  <TabItem label="schema.d.ts">
    ```ts
    export interface TrpcProcedureSchema {
      project: string;
      procedure: string;
      type: 'query' | 'mutation';
    }
    ```
  </TabItem>
  <TabItem label="generator.ts">
    ```ts
    import { Tree } from '@nx/devkit';
    import { TrpcProcedureSchema } from './schema';

    export const trpcProcedureGenerator = async (tree: Tree, options: TrpcProcedureSchema) => {

    };

    export default trpcProcedureGenerator;

    ```
  </TabItem>
</Tabs>

:::note
ジェネレーターには入力として`Tree`と、スキーマで定義したオプションが与えられることに注目してください。`Tree`は基本的に仮想ファイルシステムであり、プロジェクトファイルを作成または更新するために読み書きできます。ユーザーが「ドライラン」モードでジェネレーターを実行した場合に変更を加えたくないため、ファイルシステムに直接触れることは避けます。
:::

次に、`packages/nx-plugin/generators.json`を更新して、ジェネレーターを接続しましょう：

```json
 ...
  "generators": {
    ...
    "ts#trpc-api#procedure": {
      "factory": "./src/trpc/procedure/generator",
      "schema": "./src/trpc/procedure/schema.json",
      "description": "Adds a procedure to a tRPC API"
    }
  },
...
```

### ジェネレーターの実装

tRPC APIにプロシージャを追加するには、次の2つのことを行う必要があります：

1. 新しいプロシージャ用のTypeScriptファイルを作成する
2. ルーターにプロシージャを追加する

#### 新しいプロシージャの作成

新しいプロシージャ用のTypeScriptファイルを作成するために、`generateFiles`というユーティリティを使用します。これを使用して、ユーザーが選択したオプションに基づいて変数をレンダリングできる[EJS](https://ejs.co/)テンプレートを定義できます。

まず、`packages/nx-plugin/src/trpc/procedure/files/procedures/__procedureNameKebabCase__.ts.template`にテンプレートを定義します：

```ts title="files/procedures/__procedureNameKebabCase__.ts.template"
import { publicProcedure } from '../init.js';
import { z } from 'zod';

export const <%- procedureNameCamelCase %> = publicProcedure
  .input(z.object({
    // TODO: define input
  }))
  .output(z.object({
    // TODO: define output
  }))
  .<%- procedureType %>(async ({ input, ctx }) => {
    // TODO: implement!
    return {};
  });
```

:::tip
`generateFiles`がテンプレートを処理する際、ファイル/ディレクトリ名の`__<変数>__`への参照を提供された値に置き換え、ファイル名から`.template`を削除します。

テンプレートの内容は[EJS](https://ejs.co/)で、変数は`<% ... %>`構文を使用して参照されます。
:::

テンプレートでは、3つの変数を参照しました：

* `procedureNameCamelCase`
* `procedureNameKebabCase`
* `procedureType`

したがって、これらを`generateFiles`に渡す必要があります。また、ファイルを生成するディレクトリ、つまりジェネレーターの入力としてユーザーが選択したtRPCプロジェクトのソースファイルの場所（`sourceRoot`）も指定する必要があります。これはプロジェクト設定から抽出できます。

ジェネレーターを更新してこれを行いましょう：

```ts title="procedure/generator.ts" {8-19}
import { generateFiles, joinPathFragments, readProjectConfiguration, Tree } from '@nx/devkit';
import { TrpcProcedureSchema } from './schema';
import { formatFilesInSubtree } from '../../utils/format';
import camelCase from 'lodash.camelcase';
import kebabCase from 'lodash.kebabcase';

export const trpcProcedureGenerator = async (tree: Tree, options: TrpcProcedureSchema) => {
  const projectConfig = readProjectConfiguration(tree, options.project);

  const procedureNameCamelCase = camelCase(options.procedure);
  const procedureNameKebabCase = kebabCase(options.procedure);

  generateFiles(tree, joinPathFragments(__dirname, 'files'), projectConfig.sourceRoot, {
    procedureNameCamelCase,
    procedureNameKebabCase,
    procedureType: options.type,
  });

  await formatFilesInSubtree(tree);
};

export default trpcProcedureGenerator;
```

:::tip
ジェネレーターの最後に`formatFilesInSubtree`を呼び出しています。これにより、作成または変更したファイルがユーザーの[prettier](https://prettier.io/)設定に従ってフォーマットされます。
:::

#### ルーターへのプロシージャの追加

次に、ジェネレーターが新しいプロシージャをルーターに接続するようにします。これはユーザーのソースコードを読み取り、更新することを意味します！

TypeScript ASTの操作を使用して、TypeScriptソースファイルの関連部分を更新します。これを少し簡単にするために、`replace`と`destructuredImport`というヘルパーがあります。

```ts title="procedure/generator.ts" {6, 23-33}
import { generateFiles, joinPathFragments, readProjectConfiguration, Tree } from '@nx/devkit';
import { TrpcProcedureSchema } from './schema';
import { formatFilesInSubtree } from '../../utils/format';
import camelCase from 'lodash.camelcase';
import kebabCase from 'lodash.kebabcase';
import { destructuredImport, replace } from '../../utils/ast';
import { factory, ObjectLiteralExpression } from 'typescript';

export const trpcProcedureGenerator = async (tree: Tree, options: TrpcProcedureSchema) => {
  const projectConfig = readProjectConfiguration(tree, options.project);

  const procedureNameCamelCase = camelCase(options.procedure);
  const procedureNameKebabCase = kebabCase(options.procedure);

  generateFiles(tree, joinPathFragments(__dirname, 'files'), projectConfig.sourceRoot, {
    procedureNameCamelCase,
    procedureNameKebabCase,
    procedureType: options.type,
  });

  const routerPath = joinPathFragments(projectConfig.sourceRoot, 'router.ts');

  destructuredImport(tree, routerPath, [procedureNameCamelCase], `./procedures/${procedureNameKebabCase}.js`);

  replace(
    tree,
    routerPath,
    'CallExpression[expression.name="router"] > ObjectLiteralExpression',
    (node) => factory.createObjectLiteralExpression([
      ...(node as ObjectLiteralExpression).properties,
      factory.createShorthandPropertyAssignment(procedureNameCamelCase),
    ]),
  );

  await formatFilesInSubtree(tree);
};

export default trpcProcedureGenerator;
```

:::tip
上記のコードスニペットでは、`replace`は[tsquery](https://github.com/phenomnomnominal/tsquery)セレクターを使用して、`router`関数に追加された引数を見つけます。

[tsqueryプレイグラウンド](https://tsquery-playground.firebaseapp.com/)は、異なるセレクターをテストするのに役立つツールです。
:::

ジェネレーターを実装したので、コンパイルして、ダンジョンアドベンチャープロジェクトでテストできるようにしましょう。

```bash
pnpm nx run @aws/nx-plugin:compile
```

### ジェネレーターのテスト

ジェネレーターをテストするために、ローカルプラグインを<Link path="get_started/tutorials/dungeon-game/overview">dungeon-adventure</Link>コードベースにリンクします。

::::note
ダンジョンアドベンチャーチュートリアルを完了していなくても心配ありません。これは任意のnx対応コードベースでも機能します。
::::

コードベースで、ローカルの`@aws/nx-plugin`をリンクしましょう：

```bash
cd path/to/dungeon-adventure
pnpm link path/to/nx-plugin-for-aws/dist/packages/nx-plugin
```

:::note
上記では、ソースコードではなく、`dist/packages/nx-plugin`にコンパイルされたプラグインにリンクしていることに注意してください。
:::

新しいジェネレーターを試してみましょう：

<RunGenerator generator="ts#trpc-api#procedure" />

:::note
VSCodeのリストに新しいジェネレーターが表示されない場合は、Nxワークスペースをリフレッシュする必要があるかもしれません：

<NxCommands commands={['reset']} />
:::

成功すると、新しいプロシージャが生成され、`router.ts`のルーターにプロシージャが追加されているはずです。

### 演習

ここまで来て、まだNxジェネレーターを試す時間がある場合は、プロシージャジェネレーターに追加する機能のいくつかの提案があります：

#### 1. ネストされた操作

ダンジョンアドベンチャーゲームでは、関連する操作をグループ化するためにネストされたルーターを使用しました。以下を行うことでジェネレーターを更新してこれをサポートしてみてください：

* `procedure`入力にドット表記を受け入れる（例：`games.query`）
* 逆ドット表記に基づいた名前でプロシージャを生成する（例：`queryGames`）
* 適切なネストされたルーターを追加する（または既に存在する場合は更新する！）

#### 2. バリデーション

ジェネレーターは、ユーザーがtRPC APIではない`project`を選択するなどの潜在的な問題から守るべきです。例として`api-connection`ジェネレーターを参照してください。

#### 3. ユニットテスト

ジェネレーターのユニットテストを書きましょう。これらは実装が比較的簡単で、ほとんどが一般的なフローに従います：

1. `createTreeUsingTsSolutionSetup()`を使用して空のワークスペースツリーを作成する
2. ツリーに既に存在するはずのファイルを追加する（例：tRPCバックエンド用の`project.json`と`src/router.ts`）
3. テスト対象のジェネレーターを実行する
4. 期待される変更がツリーに加えられていることを検証する

#### 4. エンドツーエンドテスト

現在、すべてのジェネレーターを実行してビルドが成功することを確認する単一の「スモークテスト」があります。これを更新して、新しいジェネレーターを含めるべきです。

#### 5. 貢献する！

誰も`@aws/nx-plugin`にこのジェネレーターを貢献していない場合は、プルリクエストを送ってください！既にある場合は、貢献できる別のジェネレーターを考えてみてください。
