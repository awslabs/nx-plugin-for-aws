---
title: CDK Infrastructure
description: Reference documentation for CDK Infrastructure
---
import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import Link from '@components/link.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';

[AWS CDK](https://docs.aws.amazon.com/cdk/v2/guide/home.html) is a framework for defining cloud infrastructure in code and provisioning it through AWS CloudFormation.

The TypeScript infrastructure generator creates an AWS CDK infrastructure application written in TypeScript. The generated application includes security best practices through [Checkov](https://www.checkov.io/) security checks.

## Usage

### Generate an Infrastructure Project

You can generate a new infrastructure project in two ways:

<RunGenerator generator="ts#infra" />

### Options

<GeneratorParameters generator="ts#infra" />

## Generator Output

The generator will create the following project structure in the `<directory>/<name>` directory:

<FileTree>

  - src
    - main.ts Application entry point instantiating CDK stages to deploy
    - stages CDK Stage definitions
      - application-stage.ts Defines a collection of stacks to deploy in a stage
    - stacks CDK Stack definitions
      - application-stack.ts Main application stack
  - cdk.json CDK configuration
  - project.json Project configuration and build targets
  - .checkov.yml Checkov configuration file

</FileTree>

:::tip
Your infrastructure is a TypeScript project, so you can refer to the <Link path="guides/typescript-project">TypeScript project documentation</Link> for more details about their general usage.
:::

## Implementing your CDK Infrastructure

You can start writing your CDK infrastructure inside `src/stacks/application-stack.ts`, for example:

```ts title="src/stacks/application-stack.ts" {9-10}
import { Stack, StackProps } from 'aws-cdk-lib';
import { Bucket } from 'aws-cdk-lib/aws-s3'
import { Construct } from 'constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // Declare your infrastructure here
    new Bucket(this, 'MyBucket');
  }
}
```

### Stages and Stacks

You will notice that the top level `src/main.ts` file instantiates a CDK [Stage](https://docs.aws.amazon.com/cdk/v2/guide/stages.html) named `<namespace>-sandbox`. This stage is intended for your own development and testing.

```ts title="src/main.ts"
new ApplicationStage(app, 'project-sandbox', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  },
});
```

You can add more stages, for example you may wish to define `beta` and `prod` stages which deploy to separate environments:

```ts title="src/main.ts"
new ApplicationStage(app, 'project-beta', {
  env: {
    account: '123456789012', // beta account
    region: 'us-west-2',
  },
});
new ApplicationStage(app, 'project-prod', {
  env: {
    account: '098765432109', // prod account
    region: 'us-west-2',
  },
});
```

A Stage defines a collection of stacks that should be deployed together to make up your application. You can instantiate as many stacks as you like within a stage, for example:

```ts title="src/stages/application-stage.ts"
import { Stage, StageProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { BackendStack } from '../stacks/backend-stack.js';
import { FrontendStack } from '../stacks/frontend-stack.js';

/**
 * Defines a collection of CDK Stacks which make up your application
 */
export class ApplicationStage extends Stage {
  constructor(scope: Construct, id: string, props?: StageProps) {
    super(scope, id, props);

    new BackendStack(this, 'Backend', {
      crossRegionReferences: true,
    })

    new FrontendStack(this, 'Frontend', {
      crossRegionReferences: true,
    });
  }
}
```

### API Infrastructure

If you have used the <Link path="guides/trpc">tRPC API</Link> or <Link path="guides/fastapi">FastAPI</Link> generators to create APIs, you will notice you already have some constructs available in `packages/common/constructs` to deploy them.

If, for example, you created a tRPC API called `my-api`, you can simply import and instantiate the construct to add all necessary infrastructure to deploy it:

```ts title="src/stacks/application-stack.ts" {3, 9-12}
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyApi } from ':my-scope/common-constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Add infrastructure for your API
    new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });
  }
}
```

### Website Infrastructure

If you have used the <Link path="guides/react-website">CloudScape website</Link> generator, you will notice you already have a construct in `packages/common/constructs` to deploy it. For example:

```ts title="src/stacks/application-stack.ts" {3, 9-10}
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyWebsite } from ':my-scope/common-constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Add infrastructure for your website
    new MyWebsite(this, 'MyWebsite');
  }
}
```

:::warning
It is important to ensure that the website is declared _after_ any API constructs in order for the website <Link path="guides/react-website#runtime-configuration">Runtime Config</Link> to include all API config.
:::

## Synthesizing your Infrastructure

As part of your `build` target, as well as running the <Link path="guides/typescript-project#building">default compile, lint and test targets</Link>, your infrastructure project is _synthesized_ to CloudFormation. This can also be executed in a standalone fashion, by running the `synth` target:

<NxCommands commands={['run <my-infra>:synth']} />

You will find your synthesized cloud assembly in the root `dist` folder, under `dist/packages/<my-infra-project>/cdk.out`.

## Security Testing

A `checkov` target is added to your project which runs security checks are run on your infrastructure using [Checkov](https://www.checkov.io/).

<NxCommands commands={['run <my-infra>:checkov']} />

You will find your security test results in the root `dist` folder, under `dist/packages/<my-infra-project>/checkov`.

:::note
Checkov is run using `uvx`, so you will need to [install `uv` if you haven't already](https://docs.astral.sh/uv/getting-started/installation/).
:::

:::caution
Some Checkov rules are suppressed by default via the `.checkov.yml` file. It is recommended that you review these based on your use case.
:::

### Suppressing Checkov Checks

There may be instances where you want to suppress certain rules on resources. You can do this in two ways:

#### Supress a rule on a given construct

```typescript
import { suppressRules } from ':my-scope/common-constructs';

// suppresses the CKV_AWS_XXX for the given construct.
suppressRules(construct, ['CKV_AWS_XXX'], 'Reason');
```

#### Supress a rule on a descendant construct

```typescript
import { suppressRules } from ':my-scope/common-constructs';

// Supresses the CKV_AWS_XXX for the construct or any of its descendants if it is an instance of Bucket
suppressRules(construct, ['CKV_AWS_XXX'], 'Reason', (construct) => construct instanceof Bucket);
```

## Bootstrapping your AWS Account(s)

If you are deploying a CDK application to an AWS Account for the first time, it will need to be bootstrapped first.

First, ensure that you have [configured credentials for your AWS account](https://docs.aws.amazon.com/sdkref/latest/guide/access.html).

Next, you can use the `cdk bootstrap` command:

```bash
npx cdk bootstrap aws://<account-id>/<region>
```

For more details, please refer to the [CDK documentation](https://docs.aws.amazon.com/cdk/v2/guide/bootstrapping-env.html).

## Deploying to AWS

After a build, you can deploy your infrastructure to AWS using the `deploy` target.

:::caution
Use the `deploy-ci` target if deploying in a CI/CD pipeline. See below for more details.
:::

First, ensure that you have [configured credentials for your AWS account](https://docs.aws.amazon.com/sdkref/latest/guide/access.html).

Next, run the deploy target:

<NxCommands commands={['run <my-infra>:deploy <my-infra>-sandbox/*']} />

:::tip
The above command deploys _all_ stacks for the `<my-infra>-sandbox` stage. You can specify other stages so long as they are defined in `main.ts`.

You can also deploy individual stacks by specifying the full stack name, for example:

<NxCommands commands={['run <my-infra>:deploy <my-infra>-sandbox/Application']} />
:::

## Deploying to AWS in a CI/CD Pipeline

Use the `deploy-ci` target if you are deploying to AWS as part of a CI/CD pipeline.

<NxCommands commands={['run <my-infra>:deploy-ci my-stage/*']} />

This target differs slightly from the regular `deploy` target in that it ensures pre-synthesized cloud-assembly is deployed, rather than synthesizing on the fly. This helps to avoid potential issues with non-determinism due to changes package versions, ensuring that every pipeline stage deploys using the same cloud-assembly.

## Tearing Down AWS Infrastructure

Use the `destroy` target to tear down your resources:

<NxCommands commands={['run <my-infra>:destroy <my-infra>-sandbox/*']} />

## More Information

For more information about CDK, please refer to the [CDK Developer Guide](https://docs.aws.amazon.com/cdk/v2/guide/core_concepts.html) and [API Reference](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html).
