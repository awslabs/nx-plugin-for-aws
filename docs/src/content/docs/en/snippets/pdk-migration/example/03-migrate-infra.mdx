---
title: Migrate the Infrastruture
---
import { Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import CreateNxWorkspaceCommand from '@components/create-nx-workspace-command.astro';
import RunGenerator from '@components/run-generator.astro';
import Link from '@components/link.astro';
import NxCommands from '@components/nx-commands.astro';
import Drawer from '@components/drawer.astro';
import InstallCommand from '@components/install-command.astro';

The last project we need to migrate for our shopping list application is the `InfrastructureTsProject`. This is a TypeScript CDK project, for which the Nx Plugin for AWS equivalent is the <Link path="/guides/typescript-infrastructure">`ts#infra` generator</Link>.

As well as the Projen projects, PDK also vended CDK constructs which these projects depend on. We will migrate the shopping list application from these CDK constructs too, in favour of the ones generated by the Nx Plugin for AWS.

:::tip
A big advantage of the Nx Plugin for AWS over PDK is that the CDK constructs it vends are source code added to your project rather than imported via a third party package. This gives you the control and flexibility to customise them beyond what PDK suppported.
:::

#### Generate a TypeScript CDK Infrastructure Project

Run the <Link path="/guides/typescript-infrastructure">`ts#infra` generator</Link> to set up your infrastructure project in `packages/infra`:

<RunGenerator generator="ts#infra" noInteractive requiredParameters={{ name: 'infra' }} />

#### Migrate the CDK Infrastructure

The PDK shopping list application instantiated the following constructs within the CDK application stack:

- `DatabaseConstruct` for the DynamoDB table storing shopping lists
- `UserIdentity` for Cognito resources, imported directly from PDK
- `MyApi` for deploying the Smithy API, which used the generated TypeScript CDK construct with type-safe integrations, depending on PDK's `TypeSafeRestApi` CDK construct under the hood.
- `Website` for deploying the Website, wrapping PDK's `StaticWebsite` CDK construct.

Next, we will migrate each of these to the new project.

##### Copy the Application Stack

Copy `packages/infra/src/stacks/application-stack.ts` from the PDK shopping list application to the exact same location in your new project. You'll see some TypeScript errors which we'll address below.

##### Copy the Database Construct

The PDK shopping list application had a `Database` construct in `packages/src/constructs/database.ts`. Copy this to the exact same location in your new project.

Since the Nx Plugin for AWS uses [Checkov](https://www.checkov.io/) for security tests which is a little stricter than PDK Nag, we also need to add some suppressions:

```diff lang="ts"
// constructs/database.ts
+import { suppressRules } from ':shopping-list/common-constructs';
...
+suppressRules(
+  this.shoppingListTable,
+  ['CKV_AWS_28', 'CKV_AWS_119'],
+  'Backup and KMS key not required for this project',
+);
```

In `application-stack.ts`, update the import for the `DatabaseConstruct` to use ESM syntax:

```diff lang="ts"
// stacks/application-stack.ts
-import { DatabaseConstruct } from '../constructs/database';
+import { DatabaseConstruct } from '../constructs/database.js';
```

##### Migrate the UserIdentity Construct

The `UserIdentity` construct can generally be swapped out without changes by adjusting the imports.

```diff lang="ts"
-import { UserIdentity } from "@aws/pdk/identity";
+import { UserIdentity } from ':shopping-list/common-constructs';
...
const userIdentity = new UserIdentity(this, `${id}UserIdentity`);
```

Note that the underlying constructs used by the new `UserIdentity` construct are vended directly from `aws-cdk-lib`, where PDK used `@aws-cdk/aws-cognito-identitypool-alpha`.

##### Migrate the API Construct

The PDK shopping list application had a construct in `constructs/apis/myapi.ts` which instantiated a CDK construct which Type Safe API generated from your Smithy model.

As well as this construct, since the PDK project used the `@handler` trait, generated lambda function CDK constructs were also generated.

Like Type Safe API, the Nx Plugin for AWS provides type-safety for integrations based on your Smithy model, however it's achieved in a much simpler and more flexible way. Instead of generating an entire CDK construct at build time, only minimal "metadata" is generated, which the `packages/common/constructs/src/app/apis/api.ts` uses in a generic fashion. You can learn more about how to use the construct in the <Link path="/guides/ts-smithy-api">`ts#smithy-api` generator guide</Link>.

Follow the below steps:

<Steps>

1. Instantiate the `Api` construct in `application-stack.ts`

    ```diff lang="ts"
    // stacks/application-stack.ts
    -import { MyApi } from "../constructs/apis/myapi";
    +import { Api } from ':shopping-list/common-constructs';
    ...
    -const myapi = new MyApi(this, "MyApi", {
    -  databaseConstruct,
    -  userIdentity,
    -});
    +const api = new Api(this, 'MyApi', {
    +  integrations: Api.defaultIntegrations(this).build(),
    +});
    ```

    Notice here we use `Api.defaultIntegrations(this).build()` - the default behaviour is to create a lambda function for each operation in our API, which is the same behaviour we had in `myapi.ts`.

1. Grant permissions for the lambda functions to access the DynamoDB table.

    In the PDK shopping list application, the `DatabaseConsruct` was passed into `MyApi`, and it managed adding the relevant permissions to each generated function construct. We'll do this directly in the `application-stack.ts` file by accessing the `Api` construct's type-safe `integrations` property:

    ```ts
    // stacks/application-stack.ts
    // Grant our lambda functions scoped access to call Dynamo
    databaseConstruct.shoppingListTable.grantReadData(
      api.integrations.getShoppingLists.handler,
    );
    [
      api.integrations.putShoppingList.handler,
      api.integrations.deleteShoppingList.handler,
    ].forEach((f) => databaseConstruct.shoppingListTable.grantWriteData(f));
    ```

1. Grant permissions for authenticated users to invoke the API.

    Within the PDK application's `myapi.ts`, authenticated users were also granted IAM permissions to invoke the API. We will do the equivalent in `application-stack.ts`:

    ```ts
    // stacks/application-stack.ts
    api.grantInvokeAccess(userIdentity.identityPool.authenticatedRole);
    ```

</Steps>

##### Migrate the Website Construct

Finally, we add the `Website` construct from `packages/common/constructs/src/app/static-websites/website.ts` to `application-stack.ts`, since this is the equivalent of the PDK shopping list application's `packages/infra/src/constructs/websites/website.ts`.

```diff lang="ts"
-import { Website } from "../constructs/websites/website";
+import { Website } from ':shopping-list/common-constructs';
...
-new Website(this, "Website", {
-  userIdentity,
-  myapi,
-});
+new Website(this, 'Website');
```

Notice that we don't pass the identity or API to the website - runtime config is managed within each construct vended by the Nx Plugin for AWS, where `UserIdentity` and `Api` register the necessary values, and `Website` manages deploying it to `/runtime-config.json` on your static website.

Let's build the project now that we've migrated all the relevant parts of the codebase to our new project.

<NxCommands commands={["run-many --target build"]} />

:::caution
You may see a build failure due to lint issues. These can usually be automatically fixed:

<NxCommands commands={["run-many --target lint --fix"]} />
:::