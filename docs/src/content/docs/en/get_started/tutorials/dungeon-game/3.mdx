---
title: Implement and configure the Story agent
description: A walkthrough of how to build an agentic AI-powered dungeon adventure game using the @aws/nx-plugin.
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## Task 1: Implement the Story Agent

The Story Agent is a [Strands](https://strandsagents.com/) agent which, given a `Game` and a list of `Action`s for context, will progress a story. We will configure the agent to interact with our Inventory MCP Server to manage a player's available items.

:::note
For this tutorial, we will implement the Agent in a "stateless" fashion, where each invocation is an independent session including the full message history. For production, consider integrating with [Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html). For more information, refer to the [using AgentCore Memory with Strands](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands) page.
:::

### Agent implementation

To implement our agent, update the following files in `packages/story/dungeon_adventure_story/agent`:

<Tabs>
  <TabItem label="main.py">
<E2EDiff lang="python" before="dungeon-adventure/3/main.py.old.template" after="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2EDiff lang="python" before="dungeon-adventure/3/agent.py.old.template" after="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

This will configure the following:

- Extracting the player, genre and actions from the agent payload,
- Constructing a client which the Agent can use to invoke our MCP server with SigV4 Authentication, and
- Constructing the agent with a system prompt and the MCP server's tools.

## Task 2: Deployment and testing

### Build the code

To build the code:

<PackageManagerShortCommand commands={["build"]} />

<Aside type="tip">
If you encounter any lint errors, run the following command to automatically fix them.

<PackageManagerShortCommand commands={["lint"]} />
</Aside>

### Deploy your application
To deploy your application, run the following command:

<NxCommands commands={['deploy infra "dungeon-adventure-infra-sandbox/*"']} />

This deployment will take around 2 minutes to complete.

Once the deployment completes, you will see outputs similar to the following _(some values have been redacted)_:

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox-Application

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

### Test your Agent

You can test your Agent by either:
<ul>
<li>Starting a local instance of the Agent server and invoking it using `curl`, or</li>
<li>Calling the deployed API using curl with a JWT token.</li>
</ul>

<Tabs>
  <TabItem label="Local">
  Start your local Agent server by running the following command:
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    Use the CDK deploy `InventoryMcpArn` output in the above, and specify your target `AWS_REGION`.
    :::

    Once the Agent server is up and running (you won't see any output), call it by running the following command:

    ```bash
    curl -N -X POST http://127.0.0.1:8081/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="Deployed">
    To test the deployed agent, you'll need to authenticate with Cognito and obtain a JWT token. First, set up your environment variables:

    ```bash
    # Set your Cognito User Pool ID and Client ID from the CDK outputs
    export POOL_ID="<UserPoolId from CDK outputs>"
    export CLIENT_ID="<UserPoolClientId from CDK outputs>"
    export REGION="<your-region>"
    ```

    Create a test user and obtain an authentication token:

    ```bash
    # Disable MFA to simplify user creation
    aws cognito-idp set-user-pool-mfa-config \
      --mfa-configuration OFF \
      --user-pool-id $POOL_ID

    # Create User
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "test" \
      --temporary-password "TempPass123-" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # Set Permanent Password (replace with something more secure!)
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "test" \
      --password "PermanentPass123-" \
      --region $REGION \
      --permanent > /dev/null

    # Authenticate User and capture ID Token
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='test',PASSWORD='PermanentPass123-' \
      --region $REGION \
      --query "AuthenticationResult.AccessToken" \
      --output text)
    ```

    Invoke the deployed agent using the Bedrock AgentCore runtime URL:

    ```bash
    # Set the Story Agent ARN from CDK outputs
    export AGENT_ARN="<StoryAgentArn from CDK outputs>"

    # URL-encode the ARN
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # Construct the invocation URL
    export AGENT_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # Invoke the agent
    curl -N -X POST "$AGENT_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    The URL encoding is necessary to properly format the ARN for the Bedrock AgentCore API endpoint.
    :::
  </TabItem>
</Tabs>

If the command runs successfully, you should start to see the initial story text being streamed:

```
You are a new superhero in the bustling metropolis of Metro City...
```

Congratulations. You have built and deployed your first Strands Agent on Bedrock AgentCore Runtime!  ðŸŽ‰ðŸŽ‰ðŸŽ‰
