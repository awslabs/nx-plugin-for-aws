---
title: "Jeu de Donjon d'IA Agentique"
description: "Un guide pas √† pas pour construire un jeu d'aventure de donjon aliment√© par une IA agentique en utilisant le @aws/nx-plugin."
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## Module 3 : Impl√©mentation de l'agent narratif

<Aside type="caution">
V√©rifiez que votre compte AWS a activ√© l'acc√®s au [mod√®le par d√©faut Strands](https://strandsagents.com/latest/documentation/docs/user-guide/concepts/model-providers/amazon-bedrock/) dans Bedrock pour votre r√©gion cible en suivant les √©tapes d√©crites dans [ce guide](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html). Au moment de la r√©daction, il s'agit d'Anthropic Claude Sonnet 4.
</Aside>

Le Story Agent est un agent [Strands](https://strandsagents.com/) qui, √©tant donn√© un `Game` et une liste d'`Action`s comme contexte, fait progresser une histoire. Nous configurerons l'agent pour interagir avec notre Inventory MCP Server afin de g√©rer les objets disponibles du joueur.

:::note
Pour simplifier ce tutoriel, nous impl√©mentons l'agent de mani√®re "sans √©tat" o√π chaque invocation est une session ind√©pendante incluant l'historique complet des messages. Pour la production, envisagez d'int√©grer [Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html). Plus de documentation sur l'utilisation de AgentCore Memory avec Strands est [disponible ici](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands).
:::

### Impl√©mentation de l'agent

Impl√©mentons notre agent. Mettez √† jour les fichiers suivants dans `packages/story/dungeon_adventure_story/agent` :

<Tabs>
  <TabItem label="main.py">
<E2ECode lang="python" path="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2ECode lang="python" path="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

Ceci configure les √©l√©ments suivants :

- Extraction du joueur, du genre et des actions depuis le payload de l'agent
- Construction d'un client que l'agent peut utiliser pour invoquer notre serveur MCP avec une authentification SigV4
- Construction de l'agent avec un prompt syst√®me et les outils du serveur MCP

### D√©ploiement et test

D'abord, compilons la base de code :

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
Si vous rencontrez des erreurs de linting, vous pouvez ex√©cuter cette commande pour les corriger automatiquement.

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

Votre application peut maintenant √™tre d√©ploy√©e en ex√©cutant la commande suivante :

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/*']} />

Ce d√©ploiement prendra environ 2 minutes.

Une fois le d√©ploiement termin√©, vous devriez voir des sorties similaires √† ceci _(certaines valeurs ont √©t√© masqu√©es)_ :

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 ‚úÖ  dungeon-adventure-infra-sandbox-Application

‚ú®  Temps de d√©ploiement : 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

Nous pouvons tester notre API de deux mani√®res :
<ul>
<li>D√©marrer une instance locale du serveur d'agents et l'invoquer avec `curl`.</li>
<li>Appeler l'API d√©ploy√©e avec curl en utilisant un token JWT.</li>
</ul>

<Tabs>
  <TabItem label="Local">
  D√©marrez votre serveur d'agents local avec la commande :
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    Utilisez la sortie `InventoryMcpArn` du d√©ploiement CDK ci-dessus, ainsi que votre `AWS_REGION` cible.
    :::

    Une fois le serveur d√©marr√© (aucun message ne s'affichera !), invoquez-le avec :

    ```bash
    curl -N -X POST http://127.0.0.1:8080/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789"
    ```
  </TabItem>
  <TabItem label="D√©ploy√©">
    Pour tester l'agent d√©ploy√©, authentifiez-vous avec Cognito pour obtenir un token JWT. Configurez d'abord les variables d'environnement :

    ```bash
    export POOL_ID="<UserPoolId des sorties CDK>"
    export CLIENT_ID="<UserPoolClientId des sorties CDK>"
    export REGION="<votre-r√©gion>"
    ```

    Cr√©ez un utilisateur de test et r√©cup√©rez un token :

    ```bash
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --temporary-password "TempPass123!" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --password "PermanentPass123!" \
      --region $REGION \
      --permanent > /dev/null

    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='testuser',PASSWORD='PermanentPass123!' \
      --region $REGION | jq -r '.AuthenticationResult.IdToken')
    ```

    :::caution
    Utilisez la sortie `UserIdentityUserIdentityUserPoolIdXXX` pour `POOL_ID` et v√©rifiez le Client ID correspondant dans les sorties CDK.
    :::

    Invoquez l'agent d√©ploy√© via l'URL Bedrock AgentCore :

    ```bash
    export AGENT_ARN="<StoryAgentArn des sorties CDK>"
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')
    export MCP_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    curl -N -X POST "$MCP_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    L'encodage URL est n√©cessaire pour formater correctement l'ARN dans l'endpoint Bedrock AgentCore.
    :::
  </TabItem>
</Tabs>

Si la commande r√©ussit, vous devriez voir un flux d'√©v√©nements similaire √† :

```
data: {"init_event_loop": true}

data: {"start": true}

data: {"start_event_loop": true}

data: {"event": {"messageStart": {"role": "assistant"}}}

data: {"event": {"contentBlockDelta": {"delta": {"text": "Welcome"}, "contentBlockIndex": 0}}}

...
```

F√©licitations. Vous avez d√©ploy√© votre premier agent Strands sur Bedrock AgentCore Runtime ! üéâüéâüéâ