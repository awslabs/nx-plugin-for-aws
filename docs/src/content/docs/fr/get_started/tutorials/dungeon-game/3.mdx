---
title: "Jeu de Donjon IA"
description: "Un guide pas √† pas pour construire un jeu d'aventure de donjon aliment√© par l'IA en utilisant le @aws/nx-plugin."
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## Module 3 : Impl√©mentation de l'API Story

<Aside type="caution">
Assurez-vous d'avoir accord√© l'acc√®s au mod√®le **Anthropic Claude 3.5 Sonnet v2** en suivant les √©tapes d√©crites dans [ce guide](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html).
</Aside>

La StoryApi comprend une unique API `generate_story` qui, √©tant donn√© un `Game` et une liste d'`Action` comme contexte, fera progresser une histoire. Cette API sera impl√©ment√©e comme une API de streaming en Python/FastAPI et d√©montrera √©galement comment modifier le code g√©n√©r√© pour l'adapter √† son usage.

### Impl√©mentation de l'API

Pour cr√©er notre API, nous devons d'abord installer quelques d√©pendances suppl√©mentaires :

- `boto3` sera utilis√© pour appeler Amazon Bedrock ;
- `uvicorn` sera utilis√© pour d√©marrer notre API en conjonction avec le [Lambda Web Adapter (LWA)](https://github.com/awslabs/aws-lambda-web-adapter) ;
- `copyfiles` est une d√©pendance npm n√©cessaire pour supporter la copie multiplateforme de fichiers lors de la mise √† jour de notre t√¢che `bundle`.

Pour installer ces d√©pendances, ex√©cutez les commandes suivantes :

<NxCommands commands={["run dungeon_adventure.story_api:add --args boto3 uvicorn"]} />
<InstallCommand pkg="copyfiles" dev />

Maintenant rempla√ßons le contenu des fichiers suivants dans `packages/story_api/story_api` :

<Tabs>
<TabItem label="main.py">
<E2ECode path="dungeon-adventure/3/main.py.template" lang="python" />
</TabItem>
<TabItem label="init.py">
<E2ECode path="dungeon-adventure/3/init.py.template" lang="python" />

:::note
La modification ci-dessus apport√©e √† `init.py` supprime simplement le middleware CORS pour √©viter les conflits avec la gestion des en-t√™tes CORS de l'URL de fonction Lambda.
:::

</TabItem>
</Tabs>

Analyse du code :

- Nous utilisons le param√®tre `x-streaming` pour indiquer qu'il s'agit d'une API de streaming lors de la g√©n√©ration de notre SDK client. Cela permet de consommer cette API en streaming tout en conservant le typage fort !
- Notre API renvoie simplement un flux texte comme d√©fini par `media_type="text/plain"` et `response_class=PlainTextResponse`

:::note
√Ä chaque modification de votre FastAPI, vous devez reconstruire votre projet pour voir les changements refl√©t√©s dans le client g√©n√©r√© de votre site web.

Nous apporterons quelques modifications suppl√©mentaires ci-dessous avant de reconstruire.
:::

### Infrastructure

L'<Link path="get_started/tutorials/dungeon-game/1#game-ui-infrastructure">infrastructure configur√©e pr√©c√©demment</Link> suppose que toutes les APIs utilisent une API Gateway int√©gr√©e √† des fonctions Lambda. Pour notre `story_api`, nous ne souhaitons pas utiliser API Gateway car il ne supporte pas les r√©ponses en streaming. Nous utiliserons plut√¥t une [URL de fonction Lambda configur√©e avec le streaming de r√©ponse](https://docs.aws.amazon.com/lambda/latest/dg/configuration-response-streaming.html).

Pour cela, mettons d'abord √† jour nos constructs CDK :

<Tabs>
<TabItem label="story-api.ts">
<E2ECode path="dungeon-adventure/3/story-api.ts.template" lang="typescript" />
</TabItem>
<TabItem label="application-stack.ts">
<E2EDiff before="dungeon-adventure/2/stacks/application-stack.ts.template" after="dungeon-adventure/3/application-stack.ts.template" lang="typescript" />
</TabItem>
</Tabs>

Maintenant mettons √† jour la `story_api` pour supporter le d√©ploiement avec [Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter).

<Tabs>
<TabItem label="run.sh">
<E2ECode path="dungeon-adventure/3/run.sh.template" lang="bash" />
</TabItem>
<TabItem label="project.json">
```diff lang="json"
// packages/story_api/project.json
{
  "name": "dungeon_adventure.story_api",
  ...
  "targets": {
    ...
    "bundle": {
      "cache": true,
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/packages/story_api/bundle"],
      "options": {
        "commands": [
          "uv export --frozen --no-dev --no-editable --project story_api -o dist/packages/story_api/bundle/requirements.txt",
          "uv pip install -n --no-installer-metadata --no-compile-bytecode --python-platform x86_64-manylinux2014 --target dist/packages/story_api/bundle -r dist/packages/story_api/bundle/requirements.txt",
+          "copyfiles -f packages/story_api/run.sh dist/packages/story_api/bundle"
        ],
        "parallel": false
      },
      "dependsOn": ["compile"]
    },
    ...
  }
}
```
</TabItem>
</Tabs>

### D√©ploiement et tests

D'abord, construisons le codebase :

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
Si vous rencontrez des erreurs de lint, vous pouvez ex√©cuter cette commande pour les corriger automatiquement :

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

Vous pouvez maintenant d√©ployer l'application avec :

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox']} />

Ce d√©ploiement prendra environ 2 minutes.

<Drawer title="Commande de d√©ploiement" trigger="Vous pouvez aussi d√©ployer toutes les piles en une fois. Cliquez ici pour plus de d√©tails.">

Vous pouvez √©galement d√©ployer toutes les piles de l'application CDK avec :

<NxCommands commands={['run @dungeon-adventure/infra:deploy --all']} />

Ceci n'est **pas recommand√©** car vous pourriez choisir de s√©parer vos √©tapes de d√©ploiement en piles distinctes (ex: `infra-prod`). Dans ce cas, le flag `--all` tentera de tout d√©ployer, ce qui peut entra√Æner des d√©ploiements ind√©sirables !

</Drawer>

Une fois le d√©ploiement termin√©, vous devriez voir des sorties similaires √† ceci (certaines valeurs ont √©t√© masqu√©es) :

```bash
dungeon-adventure-infra-sandbox
dungeon-adventure-infra-sandbox: deploying... [2/2]

 ‚úÖ  dungeon-adventure-infra-sandbox

‚ú®  Dur√©e du d√©ploiement : 354s

Outputs:
dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX = https://xxx.lambda-url.ap-southeast-2.on.aws/
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

Nous pouvons tester notre API de deux mani√®res :
<ul>
<li>D√©marrer une instance locale du serveur FastApi et appeler les APIs avec `curl`</li>
<li>
<Drawer title="curl avec Sigv4" trigger="Appeler l'API d√©ploy√©e directement avec curl activ√© pour Sigv4">
Vous pouvez ajouter ce script √† votre fichier `.bashrc` (puis `source`), ou simplement le coller dans le terminal o√π vous ex√©cuterez la commande.
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

Exemples d'utilisation :

###### API Gateway
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### URL de fonction Lambda avec streaming
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="Local">
  D√©marrez le serveur FastAPI local avec :
    <NxCommands commands={["run dungeon_adventure.story_api:serve"]} />

    Une fois le serveur d√©marr√©, appelez-le avec :

    ```bash
    curl -N -X POST http://127.0.0.1:8000/story/generate \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="D√©ploy√©">
```bash "https://xxx.lambda-url.ap-southeast-2.on.aws/" "ap-southeast-2"
acurl ap-southeast-2 lambda -N -X POST \
  https://xxx.lambda-url.ap-southeast-2.on.aws/story/generate \
  -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
  -H "Content-Type: application/json"
```
    <Aside type="caution">
    Utilisez la valeur de sortie `dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX` du d√©ploiement CDK pour remplacer l'URL surlign√©e et ajustez la r√©gion si n√©cessaire.
    </Aside>
  </TabItem>
</Tabs>

Si la commande r√©ussit, vous devriez voir une r√©ponse en streaming similaire √† :

```
UnnamedHero se tenait droit, sa cape flottant au vent....
```

F√©licitations. Vous avez d√©ploy√© votre premi√®re API avec FastAPI ! üéâüéâüéâ