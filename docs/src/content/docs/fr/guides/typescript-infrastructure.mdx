---
title: "Infrastructure CDK"
description: "Documentation de référence pour l'infrastructure CDK"
---



import { FileTree } from '@astrojs/starlight/components';
import RunGenerator from '@components/run-generator.astro';
import Link from '@components/link.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';

[AWS CDK](https://docs.aws.amazon.com/cdk/v2/guide/home.html) est un framework permettant de définir une infrastructure cloud via du code et de la déployer via AWS CloudFormation.

Le générateur d'infrastructure TypeScript crée une application d'infrastructure AWS CDK écrite en TypeScript. L'application générée intègre des bonnes pratiques de sécurité grâce aux vérifications de [Checkov](https://www.checkov.io/).

## Utilisation

### Générer un projet d'infrastructure

Vous pouvez générer un nouveau projet d'infrastructure de deux manières :

<RunGenerator generator="ts#infra" />

### Options

<GeneratorParameters generator="ts#infra" />

## Résultat du générateur

Le générateur créera la structure de projet suivante dans le répertoire `<directory>/<name>` :

<FileTree>

  - src
    - main.ts Point d'entrée de l'application instanciant les stages CDK à déployer
    - stages Définitions des stages CDK
      - application-stage.ts Définit un ensemble de stacks à déployer dans un stage
    - stacks Définitions des stacks CDK
      - application-stack.ts Stack principale de l'application
  - cdk.json Configuration CDK
  - project.json Configuration du projet et cibles de build
  - checkov.yml Fichier de configuration Checkov

</FileTree>

:::tip
Votre infrastructure étant un projet TypeScript, vous pouvez consulter la <Link path="guides/typescript-project">documentation des projets TypeScript</Link> pour plus de détails sur leur utilisation générale.
:::

## Implémentation de votre infrastructure CDK

Vous pouvez commencer à écrire votre infrastructure CDK dans `src/stacks/application-stack.ts`, par exemple :

```ts title="src/stacks/application-stack.ts" {9-10}
import { Stack, StackProps } from 'aws-cdk-lib';
import { Bucket } from 'aws-cdk-lib/aws-s3'
import { Construct } from 'constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // Déclarez votre infrastructure ici
    new Bucket(this, 'MyBucket');
  }
}
```

### Stages et Stacks

Vous remarquerez que le fichier principal `src/main.ts` instancie un [Stage](https://docs.aws.amazon.com/cdk/v2/guide/stages.html) CDK nommé `<namespace>-sandbox`. Ce stage est destiné à vos propres développements et tests.

```ts title="src/main.ts"
new ApplicationStage(app, 'project-sandbox', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  },
});
```

Vous pouvez ajouter d'autres stages, par exemple définir des stages `beta` et `prod` déployés dans des environnements distincts :

```ts title="src/main.ts"
new ApplicationStage(app, 'project-beta', {
  env: {
    account: '123456789012', // compte beta
    region: 'us-west-2',
  },
});
new ApplicationStage(app, 'project-prod', {
  env: {
    account: '098765432109', // compte prod
    region: 'us-west-2',
  },
});
```

Un Stage définit un ensemble de stacks à déployer conjointement pour composer votre application. Vous pouvez instancier autant de stacks que nécessaire dans un stage, par exemple :

```ts title="src/stages/application-stage.ts"
import { Stage, StageProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { BackendStack } from '../stacks/backend-stack.js';
import { FrontendStack } from '../stacks/frontend-stack.js';

/**
 * Définit un ensemble de stacks CDK composant votre application
 */
export class ApplicationStage extends Stage {
  constructor(scope: Construct, id: string, props?: StageProps) {
    super(scope, id, props);

    new BackendStack(this, 'Backend', {
      crossRegionReferences: true,
    })

    new FrontendStack(this, 'Frontend', {
      crossRegionReferences: true,
    });
  }
}
```

### Infrastructure d'API

Si vous avez utilisé les générateurs <Link path="guides/trpc">tRPC API</Link> ou <Link path="guides/fastapi">FastAPI</Link>, vous remarquerez que des constructs sont déjà disponibles dans `packages/common/constructs` pour les déployer.

Par exemple, si vous avez créé une API tRPC nommée `my-api`, vous pouvez simplement importer et instancier le construct pour ajouter l'infrastructure nécessaire :

```ts title="src/stacks/application-stack.ts" {3, 9-12}
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyApi } from ':my-scope/common-constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Ajoutez l'infrastructure pour votre API
    new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });
  }
}
```

### Infrastructure de site web

Si vous avez utilisé le générateur <Link path="guides/react-website">site web CloudScape</Link>, un construct est déjà disponible dans `packages/common/constructs`. Par exemple :

```ts title="src/stacks/application-stack.ts" {3, 9-10}
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { MyWebsite } from ':my-scope/common-constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // Ajoutez l'infrastructure pour votre site web
    new MyWebsite(this, 'MyWebsite');
  }
}
```

:::warning
Il est important de déclarer le site web _après_ les constructs d'API pour que la <Link path="guides/react-website#runtime-configuration">Configuration d'exécution</Link> du site inclue toutes les configs d'API.
:::

## Synthèse de votre infrastructure

En plus des <Link path="guides/typescript-project#building">cibles de compilation, lint et test par défaut</Link>, votre projet d'infrastructure est _synthétisé_ en CloudFormation lors du build. Cette opération peut aussi être exécutée séparément via la cible `synth` :

<NxCommands commands={['run <my-infra>:synth']} />

Vous trouverez l'assembly cloud synthétisée dans le dossier `dist` racine, sous `dist/packages/<my-infra-project>/cdk.out`.

## Tests de sécurité

Une cible `checkov` est ajoutée pour exécuter des vérifications de sécurité sur votre infrastructure via [Checkov](https://www.checkov.io/).

<NxCommands commands={['run <my-infra>:checkov']} />

Les résultats des tests de sécurité se trouvent dans le dossier `dist` racine, sous `dist/packages/<my-infra-project>/checkov`.

:::note
Checkov utilise `uvx`, vous devez donc [installer `uv` si ce n'est pas déjà fait](https://docs.astral.sh/uv/getting-started/installation/).
:::

:::caution
Certaines règles Checkov sont désactivées par défaut via le fichier `checkov.yml`. Il est recommandé de les revoir selon votre cas d'usage.
:::

### Suppression de vérifications Checkov

Il peut être nécessaire de supprimer certaines règles sur des ressources. Deux méthodes sont possibles :

#### Supprimer une règle sur un construct donné

```typescript
import { suppressRules } from ':my-scope/common-constructs';

// Supprime la règle CKV_AWS_XXX pour le construct donné
suppressRules(construct, ['CKV_AWS_XXX'], 'Raison');
```

#### Supprimer une règle sur un construct descendant

```typescript
import { suppressRules } from ':my-scope/common-constructs';

// Supprime CKV_AWS_XXX pour le construct ou ses descendants de type Bucket
suppressRules(construct, ['CKV_AWS_XXX'], 'Raison', (construct) => construct instanceof Bucket);
```

## Bootstrap de votre(vos) compte(s) AWS

Si vous déployez une application CDK sur un compte AWS pour la première fois, celui-ci doit être bootstrappé.

Assurez-vous d'abord d'avoir [configuré les credentials pour votre compte AWS](https://docs.aws.amazon.com/sdkref/latest/guide/access.html).

Utilisez ensuite la commande `cdk bootstrap` :

```bash
npx cdk bootstrap aws://<account-id>/<region>
```

Pour plus de détails, consultez la [documentation CDK](https://docs.aws.amazon.com/cdk/v2/guide/bootstrapping-env.html).

## Déploiement sur AWS

Après un build, vous pouvez déployer votre infrastructure via la cible `deploy`.

:::caution
Utilisez la cible `deploy-ci` pour les pipelines CI/CD. Voir ci-dessous pour plus de détails.
:::

Assurez-vous d'avoir [configuré les credentials pour votre compte AWS](https://docs.aws.amazon.com/sdkref/latest/guide/access.html).

Exécutez ensuite la cible de déploiement :

<NxCommands commands={['run <my-infra>:deploy <my-infra>-sandbox/*']} />

:::tip
Cette commande déploie _toutes_ les stacks du stage `<my-infra>-sandbox`. Vous pouvez spécifier d'autres stages s'ils sont définis dans `main.ts`.

Vous pouvez aussi déployer des stacks individuelles en spécifiant leur nom complet :

<NxCommands commands={['run <my-infra>:deploy <my-infra>-sandbox/Application']} />
:::

## Déploiement sur AWS dans un pipeline CI/CD

Utilisez la cible `deploy-ci` pour les déploiements dans un pipeline CI/CD :

<NxCommands commands={['run <my-infra>:deploy-ci my-stage/*']} />

Cette cible diffère légèrement en déployant l'assembly cloud pré-synthétisée plutôt que de synthétiser à la volée. Cela évite les problèmes de non-déterminisme liés aux versions de packages, garantissant que chaque étape du pipeline déploie la même assembly cloud.

## Suppression de l'infrastructure AWS

Utilisez la cible `destroy` pour supprimer vos ressources :

<NxCommands commands={['run <my-infra>:destroy <my-infra>-sandbox/*']} />

## Informations complémentaires

Pour en savoir plus sur CDK, consultez le [Guide développeur CDK](https://docs.aws.amazon.com/cdk/v2/guide/core_concepts.html) et la [Référence API](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html).