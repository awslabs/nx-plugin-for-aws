---
title: "FastAPI"
description: "FastAPI에 대한 참조 문서"
---

import { FileTree } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import schema from '../../../../../../packages/nx-plugin/src/py/fast-api/schema.json';

[FastAPI](https://fastapi.tiangolo.com/)는 Python에서 API를 구축하기 위한 프레임워크입니다.

FastAPI 생성기는 AWS CDK 인프라 설정과 함께 새로운 FastAPI를 생성합니다. 생성된 백엔드는 AWS Lambda를 사용하여 서버리스 배포를 수행하며, AWS API Gateway HTTP API를 통해 노출됩니다. [AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/python/latest/)를 사용하여 로깅, AWS X-Ray 추적 및 Cloudwatch 메트릭을 포함한 관찰 가능성을 설정합니다.

## 사용법

### FastAPI 생성

다음 두 가지 방법으로 새로운 FastAPI를 생성할 수 있습니다:

<RunGenerator generator="py#fast-api" />

### 옵션

<GeneratorParameters schema={schema} />

## 생성기 출력

생성기는 `<directory>/<api-name>` 디렉터리에 다음과 같은 프로젝트 구조를 생성합니다:

<FileTree>

- project.json 프로젝트 구성 및 빌드 대상
- pyproject.toml Python 프로젝트 구성 및 종속성
- \<module_name>
  - \_\_init\_\_.py 모듈 초기화
  - init.py FastAPI 앱 설정 및 powertools 미들웨어 구성
  - main.py API 구현

</FileTree>

생성기는 또한 `packages/common/constructs` 디렉터리에 있는 API를 배포하는 데 사용할 수 있는 CDK 구조체를 생성합니다.

## FastAPI 구현하기

주요 API 구현은 `main.py`에 있습니다. 이곳에서 API 라우트와 해당 구현을 정의합니다. 다음은 예시입니다:

```python
from .init import app, tracer
from pydantic import BaseModel

class Item(BaseModel):
  name: str

@app.get("/items/{item_id}")
def get_item(item_id: int) -> Item:
    return Item(name=...)

@app.post("/items")
def create_item(item: Item):
    return ...
```

제너레이터는 자동으로 여러 기능을 설정합니다:

1. 관찰성을 위한 AWS Lambda Powertools 통합
2. 오류 처리 미들웨어
3. 요청/응답 상관관계
4. 메트릭 수집
5. Mangum을 사용한 AWS Lambda 핸들러

### AWS Lambda Powertools로 관찰성 확보

#### 로깅

제너레이터는 AWS Lambda Powertools를 사용하여 구조화된 로깅을 구성합니다. 라우트 핸들러에서 로거에 접근할 수 있습니다:

```python
from .init import app, logger

@app.get("/items/{item_id}")
def read_item(item_id: int):
    logger.info("Fetching item", extra={"item_id": item_id})
    return {"item_id": item_id}
```

로거는 자동으로 다음을 포함합니다:

- 요청 추적을 위한 상관관계 ID
- 요청 경로 및 메서드
- Lambda 컨텍스트 정보
- 콜드 스타트 표시기

#### 추적

AWS X-Ray 추적이 자동으로 구성됩니다. 추적에 사용자 지정 하위 세그먼트를 추가할 수 있습니다:

```python
from .init import app, tracer

@app.get("/items/{item_id}")
@tracer.capture_method
def read_item(item_id: int):
    # 새 하위 세그먼트 생성
    with tracer.provider.in_subsegment("fetch-item-details"):
        # 여기에 로직 작성
        return {"item_id": item_id}
```

#### 메트릭

CloudWatch 메트릭이 각 요청에 대해 자동으로 수집됩니다. 사용자 지정 메트릭을 추가할 수 있습니다:

```python
from .init import app, metrics
from aws_lambda_powertools.metrics import MetricUnit

@app.get("/items/{item_id}")
def read_item(item_id: int):
    metrics.add_metric(name="ItemViewed", unit=MetricUnit.Count, value=1)
    return {"item_id": item_id}
```

기본 메트릭은 다음을 포함합니다:

- 요청 수
- 성공/실패 수
- 콜드 스타트 메트릭
- 라우트별 메트릭

### 오류 처리

제너레이터는 포괄적인 오류 처리를 포함합니다:

```python
from fastapi import HTTPException

@app.get("/items/{item_id}")
def read_item(item_id: int):
    if item_id < 0:
        raise HTTPException(status_code=400, detail="Item ID must be positive")
    return {"item_id": item_id}
```

처리되지 않은 예외는 미들웨어에 의해 포착되어:

1. 전체 예외를 스택 추적과 함께 로깅
2. 실패 메트릭 기록
3. 클라이언트에 안전한 500 응답 반환
4. 상관관계 ID 유지

:::tip
`api-connection` 제너레이터를 사용할 때 더 나은 코드 생성을 위해 API 작업에 대한 응답 모델을 지정하는 것이 좋습니다. <Link path="guides/api-connection/react-fastapi#errors">자세한 내용은 여기를 참조하세요</Link>.
:::

(나머지 부분은 동일한 방식으로 번역됩니다)

## FastAPI 배포하기

FastAPI 생성기는 `common/constructs` 폴더에 API를 배포하기 위한 CDK 구성을 생성합니다. CDK 애플리케이션에서 이를 사용할 수 있습니다:

```ts
import { MyApi } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // 스택에 API 추가
    const api = new MyApi(this, 'MyApi');
  }
}
```

다음 사항을 설정합니다:

1. FastAPI 애플리케이션을 실행하는 AWS Lambda 함수
2. 함수 트리거로서의 API Gateway HTTP API
3. IAM 역할 및 권한
4. CloudWatch 로그 그룹
5. X-Ray 추적 구성
6. CloudWatch 메트릭 네임스페이스

### 액세스 권한 부여

`grantInvokeAccess` 메서드를 사용하여 API에 대한 액세스 권한을 부여할 수 있습니다:

```ts
api.grantInvokeAccess(myIdentityPool.authenticatedRole);
```

## 로컬 개발

제너레이터는 다음과 같이 실행할 수 있는 로컬 개발 서버를 구성합니다:

<NxCommands commands={['run my-api:serve']} />

이렇게 하면 다음과 같은 로컬 FastAPI 개발 서버가 시작됩니다:

- 코드 변경 시 자동 재로드
- `/docs` 또는 `/redoc`에서 대화형 API 문서
- `/openapi.json`에서 OpenAPI 스키마

## FastAPI 호출하기

React 웹사이트에서 API를 호출하려면 <Link path="guides/api-connection/react-fastapi">`api-connection`</Link> 생성기를 사용할 수 있습니다.