---
title: "FastAPI"
description: "FastAPI에 대한 참조 문서"
---

import { FileTree, AnchorHeading, Tabs, TabItem } from '@astrojs/starlight/components';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import GeneratorParameters from '@components/generator-parameters.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import Infrastructure from '@components/infrastructure.astro';
import Snippet from '@components/snippet.astro';

[FastAPI](https://fastapi.tiangolo.com/)는 Python으로 API를 구축하기 위한 프레임워크입니다.

FastAPI 생성기는 AWS CDK 또는 Terraform 인프라 설정이 포함된 새로운 FastAPI를 생성합니다. 생성된 백엔드는 서버리스 배포를 위해 AWS Lambda를 사용하며 AWS API Gateway API를 통해 노출됩니다. [AWS Lambda Powertools](https://docs.powertools.aws.dev/lambda/python/latest/)를 설정하여 로깅, AWS X-Ray 추적, Cloudwatch 메트릭을 포함한 관측 가능성을 제공합니다.

## 사용 방법

### FastAPI 생성

다음 두 가지 방법으로 새로운 FastAPI를 생성할 수 있습니다:

<RunGenerator generator="py#fast-api" />

### 옵션

<GeneratorParameters generator="py#fast-api" />

<Snippet name="api/api-choice-note" />

:::tip
스트리밍 작업을 구축하려는 경우 `computeType`으로 `ServerlessApiGatewayRestApi`(기본값)를 선택하세요.
:::

## 생성기 출력

생성기는 `<directory>/<api-name>` 디렉토리에 다음 프로젝트 구조를 생성합니다:

<FileTree>

- project.json 프로젝트 구성 및 빌드 대상
- pyproject.toml Python 프로젝트 구성 및 의존성
- run.sh uvicorn을 통해 FastAPI 앱을 시작하는 Lambda Web Adapter 부트스트랩 스크립트
- \<module_name>
  - \_\_init\_\_.py 모듈 초기화
  - init.py FastAPI 앱 설정 및 powertools 미들웨어 구성
  - main.py API 구현
- scripts
  - generate_open_api.py FastAPI 앱에서 OpenAPI 스키마 생성 스크립트

</FileTree>

### 인프라

<Snippet name="shared-constructs" />

<Snippet name="api/shared-constructs" />

## FastAPI 구현

주요 API 구현은 `main.py`에 있습니다. 여기서 API 경로와 구현을 정의합니다. 예시:

```python
from pydantic import BaseModel
from .init import app, tracer

class Item(BaseModel):
  name: str

@app.get("/items/{item_id}")
@tracer.capture_method
def get_item(item_id: int) -> Item:
    return Item(name=...)

@app.post("/items")
@tracer.capture_method
def create_item(item: Item):
    return ...
```

생성기는 자동으로 여러 기능을 설정합니다:

1. 관측 가능성을 위한 AWS Lambda Powertools 통합
2. 오류 처리 미들웨어
3. 요청/응답 상관 관계
4. 메트릭 수집
5. uvicorn과 함께 [Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)를 통한 AWS Lambda 배포
6. 타입 세이프 스트리밍 (REST API 전용)

### AWS Lambda Powertools를 이용한 관측 가능성

#### 로깅

생성기는 AWS Lambda Powertools를 사용해 구조화된 로깅을 구성합니다. 라우트 핸들러에서 로거에 접근할 수 있습니다:

```python
from .init import app, logger

@app.get("/items/{item_id}")
def read_item(item_id: int):
    logger.info("Fetching item", extra={"item_id": item_id})
    return {"item_id": item_id}
```

로거는 자동으로 다음을 포함합니다:

- 요청 추적을 위한 상관 ID
- 요청 경로 및 메서드
- Lambda 컨텍스트 정보
- 콜드 스타트 표시기

#### 추적

AWS X-Ray 추적이 자동으로 구성됩니다. 추적에 커스텀 하위 세그먼트를 추가할 수 있습니다:

```python
from .init import app, tracer

@app.get("/items/{item_id}")
@tracer.capture_method
def read_item(item_id: int):
    # 새로운 하위 세그먼트 생성
    with tracer.provider.in_subsegment("fetch-item-details"):
        # 로직 구현
        return {"item_id": item_id}
```

#### 메트릭

각 요청에 대한 CloudWatch 메트릭이 자동으로 수집됩니다. 커스텀 메트릭을 추가할 수 있습니다:

```python
from .init import app, metrics
from aws_lambda_powertools.metrics import MetricUnit

@app.get("/items/{item_id}")
def read_item(item_id: int):
    metrics.add_metric(name="ItemViewed", unit=MetricUnit.Count, value=1)
    return {"item_id": item_id}
```

기본 메트릭 포함 사항:

- 요청 수
- 성공/실패 수
- 콜드 스타트 메트릭
- 경로별 메트릭

### 오류 처리

생성기는 포괄적인 오류 처리를 포함합니다:

```python
from fastapi import HTTPException

@app.get("/items/{item_id}")
def read_item(item_id: int):
    if item_id < 0:
        raise HTTPException(status_code=400, detail="Item ID must be positive")
    return {"item_id": item_id}
```

처리되지 않은 예외는 미들웨어에 의해 포착되어:

1. 스택 트레이스와 함께 전체 예외 기록
2. 실패 메트릭 기록
3. 클라이언트에 안전한 500 응답 반환
4. 상관 ID 유지

:::tip
`connection` 생성기를 사용하는 경우 더 나은 코드 생성을 위해 API 작업에 응답 모델을 지정하는 것이 좋습니다. <Link path="guides/connection/react-fastapi#errors">자세한 내용 참조</Link>.
:::

### 스트리밍

:::caution
API Gateway HTTP API는 응답 스트리밍을 지원하지 않으므로, 스트리밍은 `computeType`이 `ServerlessApiGatewayRestApi`(기본값)일 때만 지원됩니다.
:::

생성된 FastAPI는 REST API를 사용할 때 기본적으로 스트리밍 응답을 지원합니다. 인프라는 [AWS Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)를 사용하여 Lambda 내에서 uvicorn을 통해 FastAPI를 실행하도록 구성되어 있으며, 모든 REST API 작업에 대해 API Gateway에서 `ResponseTransferMode.STREAM`을 사용하여 스트리밍이 비스트리밍 작업과 함께 작동할 수 있도록 합니다.

#### `JsonStreamingResponse` 사용

생성된 `init.py`는 적절한 OpenAPI 스키마 생성과 함께 타입 세이프 스트리밍을 제공하는 `JsonStreamingResponse` 클래스를 내보냅니다. 이를 통해 <Link path="guides/connection/react-fastapi">`connection` 생성기</Link>가 올바르게 타입이 지정된 스트리밍 클라이언트 메서드를 생성할 수 있습니다.

```python
from pydantic import BaseModel
from .init import app, JsonStreamingResponse

class Chunk(BaseModel):
    message: str

async def generate_chunks():
    for i in range(100):
        yield Chunk(message=f"This is chunk {i}")

@app.post(
    "/stream",
    response_class=JsonStreamingResponse,
    responses={200: JsonStreamingResponse.openapi_response(Chunk, "Stream of chunks")},
)
async def my_stream() -> JsonStreamingResponse:
    return JsonStreamingResponse(generate_chunks())
```

`JsonStreamingResponse` 클래스는:

1. Pydantic 모델을 [JSON Lines](https://jsonlines.org/) 형식(`application/jsonl`)으로 직렬화
2. `itemSchema`가 포함된 올바른 OpenAPI 스키마를 생성하는 `openapi_response` 헬퍼를 제공하여, <Link path="guides/connection/react-fastapi#consuming-a-stream">`connection` 생성기</Link>가 타입 세이프 스트리밍 클라이언트 메서드를 생성할 수 있도록 함

#### 소비

스트리밍 응답을 소비하려면 <Link path="guides/connection/react-fastapi#consuming-a-stream">`connection` 생성기</Link>를 사용하여 스트리밍 청크를 반복하는 타입 세이프 메서드를 제공할 수 있습니다.

## FastAPI 배포

FastAPI 생성기는 선택한 `iacProvider`에 따라 CDK 또는 Terraform 인프라 코드를 생성합니다. 이를 사용해 FastAPI를 배포할 수 있습니다.

<Infrastructure>
<Fragment slot="cdk">
`common/constructs` 폴더에 API 배포를 위한 CDK 구성이 있습니다. CDK 애플리케이션에서 사용할 수 있습니다:

```ts {6-8}
import { MyApi } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // 스택에 API 추가
    const api = new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
    });
  }
}
```

이 설정은 다음을 구성합니다:

1. FastAPI 애플리케이션의 각 작업에 대한 AWS Lambda 함수
2. 함수 트리거로 API Gateway HTTP/REST API
3. IAM 역할 및 권한
4. CloudWatch 로그 그룹
5. X-Ray 추적 구성
6. CloudWatch 메트릭 네임스페이스

<Snippet name="api/cors-configuration-cdk-note" />

:::note
`Cognito` 인증을 선택한 경우 API 구성에 `identity` 속성을 제공해야 합니다:

```ts {9}
import { MyApi, UserIdentity } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const identity = new UserIdentity(this, 'Identity');

    const api = new MyApi(this, 'MyApi', {
      integrations: MyApi.defaultIntegrations(this).build(),
      identity,
    });
  }
}
```

`UserIdentity` 구성은 <Link path="/guides/react-website-auth">`ts#react-website-auth` 생성기</Link>를 사용해 생성할 수 있습니다.
:::
</Fragment>
<Fragment slot="terraform">
`common/terraform` 폴더에 API 배포를 위한 Terraform 모듈이 있습니다. Terraform 구성에서 사용할 수 있습니다:

```hcl {2}
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  # Lambda 함수를 위한 환경 변수
  env = {
    ENVIRONMENT = var.environment
    LOG_LEVEL   = "INFO"
  }

  # 필요한 경우 추가 IAM 정책
  additional_iam_policy_statements = [
    # API에 필요한 추가 권한
  ]

  tags = local.common_tags
}
```

이 설정은 다음을 구성합니다:

1. 모든 FastAPI 경로를 제공하는 AWS Lambda 함수
2. 함수 트리거로 API Gateway HTTP/REST API
3. IAM 역할 및 권한
4. CloudWatch 로그 그룹
5. X-Ray 추적 구성
6. CORS 구성

<Snippet name="api/cors-configuration-terraform-note" />

:::note
`Cognito` 인증을 선택한 경우 Cognito 구성을 제공해야 합니다:

```hcl {4-5}
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  user_pool_id         = local.user_pool_id
  user_pool_client_ids = [local.client_id]

  env = {
    ENVIRONMENT = var.environment
    LOG_LEVEL   = "INFO"
  }

  tags = local.common_tags
}
```

적절한 Terraform 리소스나 모듈을 사용해 Cognito User Pool 및 Client를 설정할 수 있습니다.
:::

Terraform 모듈은 사용 가능한 여러 출력을 제공합니다:

```hcl
# API 엔드포인트 접근
output "api_url" {
  value = module.my_api.stage_invoke_url
}

# Lambda 함수 상세 정보 접근
output "lambda_function_name" {
  value = module.my_api.lambda_function_name
}

# 추가 권한 부여를 위한 IAM 역할 접근
output "lambda_execution_role_arn" {
  value = module.my_api.lambda_execution_role_arn
}
```

모듈에 변수를 전달해 CORS 설정을 커스터마이즈할 수 있습니다:

```hcl
module "my_api" {
  source = "../../common/terraform/src/app/apis/my-api"

  # 커스텀 CORS 구성
  cors_allow_origins = ["https://myapp.com", "https://staging.myapp.com"]
  cors_allow_methods = ["GET", "POST", "PUT", "DELETE"]
  cors_allow_headers = [
    "authorization",
    "content-type",
    "x-custom-header"
  ]

  tags = local.common_tags
}
```

:::caution
생성기를 실행할 때 `auth`로 `None`을 선택한 경우 다음과 같은 Checkov 검사 실패가 발생할 수 있습니다:

<Tabs syncKey="http-rest">
<TabItem label="HTTP API">
```
Check: CKV_AWS_309: "Ensure API GatewayV2 routes specify an authorization type"
 FAILED for resource: aws_apigatewayv2_route.proxy_routes["PUT"]
```
</TabItem>
<TabItem label="REST API">
```
Check: CKV_AWS_59: "Ensure there is no open access to back-end resources through API"
 FAILED for resource: aws_api_gateway_method.proxy_method
```
</TabItem>
</Tabs>

API를 공개로 유지하려는 경우 [suppression comment 추가](https://www.checkov.io/2.Basics/Suppressing%20and%20Skipping%20Policies.html)할 수 있습니다.
:::
</Fragment>
</Infrastructure>

### 통합

<Snippet name="api/type-safe-api-integrations" parentHeading="Integrations" />

#### 코드 생성

<Infrastructure>
<Fragment slot="cdk">
FastAPI 작업은 Python으로 정의되고 CDK 인프라는 TypeScript로 작성되므로, 통합을 위한 타입 세이프 인터페이스를 제공하기 위해 메타데이터를 CDK 구성에 제공하는 코드 생성을 도입합니다.

타입 세이프 코드 생성을 위해 `common/constructs`의 `project.json`에 `generate:<ApiName>-metadata` 대상이 추가됩니다. 이는 `packages/common/constructs/src/generated/my-api/metadata.gen.ts`와 같은 파일을 생성하며, 빌드 시 생성되므로 버전 관리에서 제외됩니다.

:::note
API를 변경할 때마다 CDK 구성에서 사용되는 타입이 최신 상태인지 확인하려면 빌드를 실행해야 합니다.

<PackageManagerShortCommand commands={["build"]} />
:::

:::tip
CDK 인프라와 FastAPI를 동시에 작업하는 경우 [`nx watch`](https://nx.dev/nx-api/nx/documents/watch)를 사용해 API 변경 시마다 타입을 재생성할 수 있습니다:

<NxCommands
  commands={[
    'watch --projects=<FastAPIProject> -- \\ ',
    'run <InfraProject>:"generate:<ApiName>-metadata"',
  ]}
/>
:::
</Fragment>
<Fragment slot="terraform">
:::note
Terraform에 대한 타입 세이프 통합을 지원하지 않으므로 `iacProvider`로 Terraform을 선택한 경우 코드 생성 대상이 구성되지 않습니다.
:::
</Fragment>
</Infrastructure>

### 접근 권한 부여 (IAM 전용)

`IAM` 인증을 선택한 경우 `grantInvokeAccess` 메서드를 사용해 API 접근 권한을 부여할 수 있습니다:

<Infrastructure>
<Fragment slot="cdk">
```ts
api.grantInvokeAccess(myIdentityPool.authenticatedRole);
```
</Fragment>
<Fragment slot="terraform">
```hcl
# API 호출을 허용하는 IAM 정책 생성
resource "aws_iam_policy" "api_invoke_policy" {
  name        = "MyApiInvokePolicy"
  description = "FastAPI 호출을 허용하는 정책"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = "execute-api:Invoke"
        Resource = "${module.my_api.api_execution_arn}/*/*"
      }
    ]
  })
}

# 정책을 IAM 역할에 연결 (예: 인증된 사용자)
resource "aws_iam_role_policy_attachment" "api_invoke_access" {
  role       = aws_iam_role.authenticated_user_role.name
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}

# 기존 역할에 정책 연결
resource "aws_iam_role_policy_attachment" "api_invoke_access_existing" {
  role       = "MyExistingRole"
  policy_arn = aws_iam_policy.api_invoke_policy.arn
}
```

IAM 정책에 사용할 수 있는 API 모듈의 주요 출력:

- `module.my_api.api_execution_arn` - execute-api:Invoke 권한 부여용
- `module.my_api.api_arn` - API Gateway ARN
- `module.my_api.lambda_function_arn` - Lambda 함수 ARN
</Fragment>
</Infrastructure>

## 로컬 개발

생성기는 다음 명령으로 실행할 수 있는 로컬 개발 서버를 구성합니다:

<NxCommands commands={['run my-api:serve']} />

이 명령은 다음 기능이 포함된 로컬 FastAPI 개발 서버를 시작합니다:

- 코드 변경 시 자동 리로드
- `/docs` 또는 `/redoc`에서 대화형 API 문서
- `/openapi.json`에서 OpenAPI 스키마

## FastAPI 호출

React 웹사이트에서 API를 호출하려면 <Link path="guides/connection/react-fastapi">`connection` 생성기</Link>를 사용할 수 있습니다.