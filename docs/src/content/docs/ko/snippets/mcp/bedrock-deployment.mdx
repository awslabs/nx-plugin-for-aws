---
title: "MCP 베드락 배포"
---

import Link from '@components/link.astro';
import Infrastructure from '@components/infrastructure.astro';

### 인프라스트럭처 코드

`computeType`으로 `BedrockAgentCoreRuntime`을 선택한 경우 관련 CDK 또는 Terraform 인프라스트럭처가 생성되며, 이를 사용하여 MCP 서버를 [Amazon Bedrock AgentCore Runtime](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agents-tools-runtime.html)에 배포할 수 있습니다.

<Infrastructure>
<Fragment slot="cdk">
생성기 실행 시 선택한 `name`을 기반으로 MCP 서버용 CDK 구성 요소가 생성되며, 기본값은 `<ProjectName>McpServer`입니다.

이 CDK 구성 요소를 CDK 애플리케이션에서 사용할 수 있습니다:

```ts {6}
import { MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // 스택에 MCP 서버 추가
    new MyProjectMcpServer(this, 'MyProjectMcpServer');
  }
}
```

:::note
이 구성 요소는 [`@aws-cdk/aws-bedrock-agentcore-alpha` 모듈](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-bedrock-agentcore-alpha-readme.html)을 사용합니다.
:::
</Fragment>
<Fragment slot="terraform">
생성기 실행 시 선택한 `name`을 기반으로 Terraform 모듈이 생성되며, 기본값은 `<ProjectName>-mcp-server`입니다.

이 Terraform 모듈을 Terraform 프로젝트에서 사용할 수 있습니다:

```terraform
# MCP 서버
module "my_project_mcp_server" {
  # common/terraform 프로젝트 내 생성된 모듈의 상대 경로
  source = "../../common/terraform/src/app/mcp-servers/my-project-mcp-server"
}
```
</Fragment>
</Infrastructure>

:::caution
MCP 서버 빌드 및 배포를 위해 [Docker](https://www.docker.com/)가 필요합니다. 다음 오류를 방지하려면 Docker가 설치되어 실행 중인지 확인하세요:

```
ERROR: Cannot connect to the Docker daemon at unix://path/to/docker.sock.
```
:::

### 인증

#### IAM

기본적으로 MCP 서버는 IAM 인증을 사용하여 보호됩니다. 인수 없이 배포하면 됩니다:

<Infrastructure>
<Fragment slot="cdk">
```ts {5}
import { MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectMcpServer(this, 'MyProjectMcpServer');
  }
}
```

`grantInvoke` 메서드를 사용하여 Bedrock AgentCore Runtime에서 MCP 서버 호출 권한을 부여할 수 있습니다. 예를 들어 <Link path="/guides/py-strands-agent">`py#strands-agent`</Link> 생성기로 생성된 에이전트가 MCP 서버를 호출하도록 허용할 수 있습니다:

```ts {8}
import { MyProjectAgent, MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const agent = new MyProjectAgent(this, 'MyProjectAgent');
    const mcpServer = new MyProjectMcpServer(this, 'MyProjectMcpServer');

    mcpServer.agentCoreRuntime.grantInvoke(agent.agentCoreRuntime);
  }
}
```
</Fragment>
<Fragment slot="terraform">
```terraform
# MCP 서버
module "my_project_mcp_server" {
  # common/terraform 프로젝트 내 생성된 모듈의 상대 경로
  source = "../../common/terraform/src/app/mcp-servers/my-project-mcp-server"
}
```

호출 권한을 부여하려면 `module.my_project_mcp_server.agent_core_runtime_arn` 출력을 참조하는 다음과 같은 정책을 추가해야 합니다:

```terraform
{
  Effect = "Allow"
  Action = [
    "bedrock-agentcore:InvokeAgentRuntime"
  ]
  Resource = [
    module.my_project_mcp_server.agent_core_runtime_arn,
    "${module.my_project_mcp_server.agent_core_runtime_arn}/*"
  ]
}
```
</Fragment>
</Infrastructure>

#### Cognito JWT 인증

다음은 에이전트에 Cognito 인증을 구성하는 방법을 보여줍니다.

<Infrastructure>
<Fragment slot="cdk">
Cognito를 사용하여 JWT 인증을 구성하려면 `RuntimeAuthorizerConfiguration.usingCognito()` 팩토리 메서드를 사용하세요:

```ts {14-17}
import { MyProjectMcpServer } from ':my-scope/common-constructs';
import { RuntimeAuthorizerConfiguration } from '@aws-cdk/aws-bedrock-agentcore-alpha';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const userPool = new UserPool(this, 'UserPool');
    const client = userPool.addClient('Client', {
      authFlows: {
        userPassword: true,
      },
    });

    new MyProjectMcpServer(this, 'MyProjectMcpServer', {
      authorizerConfiguration: RuntimeAuthorizerConfiguration.usingCognito(
        userPool,
        [client],
      ),
    });
  }
}
```

또는 자체 OIDC 공급자를 사용한 사용자 정의 JWT 인증의 경우 `RuntimeAuthorizerConfiguration.usingJWT()`를 사용하세요:

```ts {6-10}
import { MyProjectMcpServer } from ':my-scope/common-constructs';
import { RuntimeAuthorizerConfiguration } from '@aws-cdk/aws-bedrock-agentcore-alpha';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectMcpServer(this, 'MyProjectMcpServer', {
      authorizerConfiguration: RuntimeAuthorizerConfiguration.usingJWT(
        'https://example.com/.well-known/openid-configuration',
        ['client1', 'client2'], // 허용된 클라이언트 ID (선택 사항)
        ['audience1'],          // 허용된 대상 (선택 사항)
      ),
    });
  }
}
```
</Fragment>
<Fragment slot="terraform">
JWT 인증을 구성하려면 MCP 서버 모듈의 `authorizer_configuration` 변수를 다음과 같이 편집할 수 있습니다:

```terraform {18-23}
# packages/common/terraform/src/app/mcp-servers/my-project-mcp-server/my-project-mcp-server.tf

data "aws_region" "current" {}

locals {
  aws_region = data.aws_region.current.id

  # 사용자 풀 및 클라이언트 ID로 교체하거나 변수로 노출
  user_pool_id = "xxx"
  user_pool_client_ids = ["yyy"]
}

module "agent_core_runtime" {
  source = "../../../core/agent-core"
  agent_runtime_name = "MyProjectMcpServer"
  docker_image_tag = "my-scope-my-project-mcp-server:latest"
  server_protocol = "MCP"
  authorizer_configuration = {
    custom_jwt_authorizer = {
      discovery_url = "https://cognito-idp.${local.aws_region}.amazonaws.com/${local.user_pool_id}/.well-known/openid-configuration"
      allowed_clients = local.user_pool_client_ids
    }
  }
  env = var.env
  additional_iam_policy_statements = var.additional_iam_policy_statements
  tags = var.tags
}
```
</Fragment>
</Infrastructure>