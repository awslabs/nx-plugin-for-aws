---
title: "Triển khai MCP Bedrock"
---

import Link from '@components/link.astro';
import Infrastructure from '@components/infrastructure.astro';

### Cơ sở hạ tầng dưới dạng mã (Infrastructure as Code)

Nếu bạn đã chọn `BedrockAgentCoreRuntime` cho `computeType`, cơ sở hạ tầng CDK hoặc Terraform tương ứng sẽ được tạo ra, bạn có thể sử dụng để triển khai MCP server của mình lên [Amazon Bedrock AgentCore Runtime](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/agents-tools-runtime.html).

<Infrastructure>
<Fragment slot="cdk">
Một CDK construct được tạo cho MCP Server của bạn, được đặt tên dựa trên `name` bạn đã chọn khi chạy trình tạo, hoặc `<ProjectName>McpServer` theo mặc định.

Bạn có thể sử dụng CDK construct này trong một ứng dụng CDK:

```ts {6}
import { MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    // Thêm MCP server vào stack của bạn
    new MyProjectMcpServer(this, 'MyProjectMcpServer');
  }
}
```

:::note
Construct này sử dụng [module `@aws-cdk/aws-bedrock-agentcore-alpha`](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-bedrock-agentcore-alpha-readme.html).
:::
</Fragment>
<Fragment slot="terraform">
Một Terraform module được tạo cho bạn, được đặt tên dựa trên `name` bạn đã chọn khi chạy trình tạo, hoặc `<ProjectName>-mcp-server` theo mặc định.

Bạn có thể sử dụng terraform module này trong một dự án Terraform:

```terraform
# MCP Server
module "my_project_mcp_server" {
  # Đường dẫn tương đối đến module được tạo trong dự án common/terraform
  source = "../../common/terraform/src/app/mcp-servers/my-project-mcp-server"
}
```
</Fragment>
</Infrastructure>

:::caution
[Docker](https://www.docker.com/) là bắt buộc để xây dựng và triển khai MCP server của bạn. Hãy đảm bảo bạn đã cài đặt và khởi chạy Docker để tránh các lỗi như:

```
ERROR: Cannot connect to the Docker daemon at unix://path/to/docker.sock.
```
:::

### Xác thực

#### IAM

Theo mặc định, MCP server của bạn sẽ được bảo mật bằng xác thực IAM, chỉ cần triển khai nó mà không cần tham số nào:

<Infrastructure>
<Fragment slot="cdk">
```ts {5}
import { MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectMcpServer(this, 'MyProjectMcpServer');
  }
}
```

Bạn có thể cấp quyền truy cập để gọi MCP của mình trên Bedrock AgentCore Runtime bằng phương thức `grantInvoke`. Ví dụ, bạn có thể muốn một agent được tạo bằng trình tạo <Link path="/guides/py-strands-agent">`py#strands-agent`</Link> gọi MCP server của bạn:

```ts {8}
import { MyProjectAgent, MyProjectMcpServer } from ':my-scope/common-constructs';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const agent = new MyProjectAgent(this, 'MyProjectAgent');
    const mcpServer = new MyProjectMcpServer(this, 'MyProjectMcpServer');

    mcpServer.agentCoreRuntime.grantInvoke(agent.agentCoreRuntime);
  }
}
```
</Fragment>
<Fragment slot="terraform">
```terraform
# MCP Server
module "my_project_mcp_server" {
  # Đường dẫn tương đối đến module được tạo trong dự án common/terraform
  source = "../../common/terraform/src/app/mcp-servers/my-project-mcp-server"
}
```

Để cấp quyền truy cập gọi agent của bạn, bạn sẽ cần thêm một policy như sau, tham chiếu đến output `module.my_project_mcp_server.agent_core_runtime_arn`:

```terraform
{
  Effect = "Allow"
  Action = [
    "bedrock-agentcore:InvokeAgentRuntime"
  ]
  Resource = [
    module.my_project_mcp_server.agent_core_runtime_arn,
    "${module.my_project_mcp_server.agent_core_runtime_arn}/*"
  ]
}
```
</Fragment>
</Infrastructure>

#### Xác thực Cognito JWT

Phần dưới đây minh họa cách cấu hình xác thực Cognito cho agent của bạn.

<Infrastructure>
<Fragment slot="cdk">
Để cấu hình xác thực JWT sử dụng Cognito, sử dụng phương thức factory `RuntimeAuthorizerConfiguration.usingCognito()`:

```ts {14-17}
import { MyProjectMcpServer } from ':my-scope/common-constructs';
import { RuntimeAuthorizerConfiguration } from '@aws-cdk/aws-bedrock-agentcore-alpha';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    const userPool = new UserPool(this, 'UserPool');
    const client = userPool.addClient('Client', {
      authFlows: {
        userPassword: true,
      },
    });

    new MyProjectMcpServer(this, 'MyProjectMcpServer', {
      authorizerConfiguration: RuntimeAuthorizerConfiguration.usingCognito(
        userPool,
        [client],
      ),
    });
  }
}
```

Ngoài ra, để xác thực JWT tùy chỉnh với OIDC provider của riêng bạn, sử dụng `RuntimeAuthorizerConfiguration.usingJWT()`:

```ts {6-10}
import { MyProjectMcpServer } from ':my-scope/common-constructs';
import { RuntimeAuthorizerConfiguration } from '@aws-cdk/aws-bedrock-agentcore-alpha';

export class ExampleStack extends Stack {
  constructor(scope: Construct, id: string) {
    new MyProjectMcpServer(this, 'MyProjectMcpServer', {
      authorizerConfiguration: RuntimeAuthorizerConfiguration.usingJWT(
        'https://example.com/.well-known/openid-configuration',
        ['client1', 'client2'], // Allowed Client IDs (tùy chọn)
        ['audience1'],          // Allowed Audiences (tùy chọn)
      ),
    });
  }
}
```
</Fragment>
<Fragment slot="terraform">
Để cấu hình xác thực JWT, bạn có thể chỉnh sửa MCP Server module của mình để cấu hình biến `authorizer_configuration` như sau:

```terraform {18-23}
# packages/common/terraform/src/app/mcp-servers/my-project-mcp-server/my-project-mcp-server.tf

data "aws_region" "current" {}

locals {
  aws_region = data.aws_region.current.id

  # Thay thế bằng user pool và client ids của bạn hoặc expose dưới dạng biến
  user_pool_id = "xxx"
  user_pool_client_ids = ["yyy"]
}

module "agent_core_runtime" {
  source = "../../../core/agent-core"
  agent_runtime_name = "MyProjectMcpServer"
  docker_image_tag = "my-scope-my-project-mcp-server:latest"
  server_protocol = "MCP"
  authorizer_configuration = {
    custom_jwt_authorizer = {
      discovery_url = "https://cognito-idp.${local.aws_region}.amazonaws.com/${local.user_pool_id}/.well-known/openid-configuration"
      allowed_clients = local.user_pool_client_ids
    }
  }
  env = var.env
  additional_iam_policy_statements = var.additional_iam_policy_statements
  tags = var.tags
}
```
</Fragment>
</Infrastructure>