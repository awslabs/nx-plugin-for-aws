---
title: "Triá»ƒn khai"
---

import { Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import CreateNxWorkspaceCommand from '@components/create-nx-workspace-command.astro';
import RunGenerator from '@components/run-generator.astro';
import Link from '@components/link.astro';
import NxCommands from '@components/nx-commands.astro';
import Drawer from '@components/drawer.astro';
import InstallCommand from '@components/install-command.astro';


BÃ¢y giá» chÃºng ta Ä‘Ã£ cÃ³ codebase Ä‘Æ°á»£c di chuyá»ƒn hoÃ n toÃ n, chÃºng ta cÃ³ thá»ƒ xem xÃ©t viá»‡c triá»ƒn khai nÃ³. CÃ³ hai hÆ°á»›ng Ä‘i mÃ  chÃºng ta cÃ³ thá»ƒ thá»±c hiá»‡n táº¡i thá»i Ä‘iá»ƒm nÃ y.

#### TÃ i NguyÃªn HoÃ n ToÃ n Má»›i (ÄÆ¡n Giáº£n)

CÃ¡ch tiáº¿p cáº­n Ä‘Æ¡n giáº£n nháº¥t lÃ  coi Ä‘Ã¢y lÃ  má»™t á»©ng dá»¥ng hoÃ n toÃ n má»›i, cÃ³ nghÄ©a lÃ  chÃºng ta sáº½ "báº¯t Ä‘áº§u láº¡i" vá»›i má»™t báº£ng DynamoDB má»›i vÃ  Cognito User Pool má»›i - máº¥t táº¥t cáº£ ngÆ°á»i dÃ¹ng vÃ  danh sÃ¡ch mua sáº¯m cá»§a há». Vá»›i cÃ¡ch tiáº¿p cáº­n nÃ y, chá»‰ cáº§n:

<Steps>

1. XÃ³a báº£ng DynamoDB cÃ³ tÃªn `shopping_list`

1. Triá»ƒn khai á»©ng dá»¥ng má»›i:

    <NxCommands commands={["deploy infra shopping-list-infra-sandbox/*"]} />

</Steps>

ğŸ‰ VÃ  chÃºng ta Ä‘Ã£ hoÃ n thÃ nh! ğŸ‰

#### Di Chuyá»ƒn CÃ¡c TÃ i NguyÃªn Stateful Hiá»‡n CÃ³ mÃ  KhÃ´ng CÃ³ Thá»i Gian Ngá»«ng Hoáº¡t Äá»™ng (Phá»©c Táº¡p HÆ¡n)

TrÃªn thá»±c táº¿, nhiá»u kháº£ nÄƒng báº¡n sáº½ muá»‘n di chuyá»ƒn cÃ¡c tÃ i nguyÃªn AWS hiá»‡n cÃ³ Ä‘á»ƒ chÃºng Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi codebase má»›i, Ä‘á»“ng thá»i trÃ¡nh báº¥t ká»³ thá»i gian ngá»«ng hoáº¡t Ä‘á»™ng nÃ o cho khÃ¡ch hÃ ng cá»§a báº¡n.

:::danger
CÃ¡ch tiáº¿p cáº­n nÃ y phá»©c táº¡p vÃ  tinh táº¿ hÆ¡n má»™t chÃºt, vÃ  Ä‘Ã¢y chá»‰ lÃ  má»™t vÃ­ dá»¥, vÃ¬ váº­y KHUYáº¾N CÃO Máº NH Máº¼ lÃ  hÃ£y thá»±c hÃ nh trong mÃ´i trÆ°á»ng khÃ´ng pháº£i production (lÃ½ tÆ°á»Ÿng nháº¥t lÃ  táº¡o má»™t sandbox stack má»›i) vÃ  ghi láº¡i cÃ¡c bÆ°á»›c chÃ­nh xÃ¡c cho á»©ng dá»¥ng cá»§a báº¡n. CÅ©ng Ä‘Æ°á»£c khuyáº¿n nghá»‹ viáº¿t cÃ¡c káº¿ hoáº¡ch dá»± phÃ²ng/rollback trong trÆ°á»ng há»£p cÃ¡c bÆ°á»›c tháº¥t báº¡i hoáº·c táº¡o ra káº¿t quáº£ khÃ´ng mong Ä‘á»£i.
:::

:::note
á»¨ng dá»¥ng shopping list PDK cá»§a chÃºng ta khÃ´ng Ä‘á»‹nh nghÄ©a báº¥t ká»³ custom domain hoáº·c DNS nÃ o. TrÃªn thá»±c táº¿, báº¡n ráº¥t cÃ³ thá»ƒ Ä‘Ã£ cáº¥u hÃ¬nh domain cho website vÃ  API cá»§a mÃ¬nh. Vá»›i má»¥c Ä‘Ã­ch cá»§a pháº§n nÃ y trong hÆ°á»›ng dáº«n, chÃºng ta sáº½ giáº£ Ä‘á»‹nh ráº±ng chÃºng ta Ä‘Ã£ thiáº¿t láº­p Route53 vá»›i tÃªn DNS tÃ¹y chá»‰nh cho website vÃ  API.
:::

Äá»‘i vá»›i á»©ng dá»¥ng shopping list cá»§a chÃºng ta, cÃ¡c tÃ i nguyÃªn stateful mÃ  chÃºng ta quan tÃ¢m lÃ  báº£ng DynamoDB chá»©a danh sÃ¡ch mua sáº¯m cá»§a ngÆ°á»i dÃ¹ng vÃ  User Pool chá»©a thÃ´ng tin chi tiáº¿t cá»§a táº¥t cáº£ ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng kÃ½. Káº¿ hoáº¡ch tá»•ng thá»ƒ cá»§a chÃºng ta sáº½ lÃ  giá»¯ láº¡i hai tÃ i nguyÃªn chÃ­nh nÃ y vÃ  di chuyá»ƒn chÃºng sao cho chÃºng Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi stack má»›i cá»§a chÃºng ta, sau Ä‘Ã³ cáº­p nháº­t DNS Ä‘á»ƒ trá» Ä‘áº¿n website má»›i (vÃ  API náº¿u Ä‘Æ°á»£c expose cho khÃ¡ch hÃ ng).

<Steps>

1. Cáº­p nháº­t á»©ng dá»¥ng má»›i cá»§a báº¡n Ä‘á»ƒ tham chiáº¿u cÃ¡c tÃ i nguyÃªn hiá»‡n cÃ³ mÃ  báº¡n muá»‘n giá»¯ láº¡i.

    Äá»‘i vá»›i á»©ng dá»¥ng shopping list, chÃºng ta thá»±c hiá»‡n Ä‘iá»u nÃ y cho báº£ng DynamoDB

    ```diff lang="ts"
    // constructs/database.ts
    -this.shoppingListTable = new Table(this, 'ShoppingList', {
    -  ...
    +this.shoppingListTable = Table.fromTableName(
    +  this,
    +  'ShoppingList',
    +  'shopping_list',
    +);
    ```

    VÃ  cho Cognito User Pool

    ```diff lang="ts"
    // packages/common/constructs/src/core/user-identity.ts
    -this.userPool = this.createUserPool();
    +this.userPool = UserPool.fromUserPoolId(
    +  this,
    +  'UserPool',
    +  '<your-user-pool-id>',
    +);
    ```

1. Build vÃ  triá»ƒn khai á»©ng dá»¥ng má»›i:

    <NxCommands commands={["run-many --target build"]} />

    <NxCommands commands={["deploy infra shopping-list-infra-sandbox/*"]} />

    BÃ¢y giá» chÃºng ta cÃ³ á»©ng dá»¥ng má»›i Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p tham chiáº¿u cÃ¡c tÃ i nguyÃªn hiá»‡n cÃ³, chÆ°a nháº­n báº¥t ká»³ traffic nÃ o.

1. Thá»±c hiá»‡n kiá»ƒm tra tÃ­ch há»£p Ä‘áº§y Ä‘á»§ Ä‘á»ƒ Ä‘áº£m báº£o á»©ng dá»¥ng má»›i hoáº¡t Ä‘á»™ng nhÆ° mong Ä‘á»£i. Äá»‘i vá»›i á»©ng dá»¥ng shopping list, táº£i website vÃ  kiá»ƒm tra xem báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p vÃ  táº¡o, xem, chá»‰nh sá»­a vÃ  xÃ³a danh sÃ¡ch mua sáº¯m khÃ´ng.

1. HoÃ n nguyÃªn cÃ¡c thay Ä‘á»•i tham chiáº¿u cÃ¡c tÃ i nguyÃªn hiá»‡n cÃ³ trong á»©ng dá»¥ng má»›i cá»§a báº¡n, nhÆ°ng chÆ°a triá»ƒn khai chÃºng.

    ```diff lang="ts"
    // constructs/database.ts
    +this.shoppingListTable = new Table(this, 'ShoppingList', {
    +  ...
    -this.shoppingListTable = Table.fromTableName(
    -  this,
    -  'ShoppingList',
    -  'shopping_list',
    -);
    ```

    VÃ  cho Cognito User Pool

    ```diff lang="ts"
    // packages/common/constructs/src/core/user-identity.ts
    +this.userPool = this.createUserPool();
    -this.userPool = UserPool.fromUserPoolId(
    -  this,
    -  'UserPool',
    -  '<your-user-pool-id>',
    -);
    ```

    VÃ  sau Ä‘Ã³ cháº¡y build

    <NxCommands commands={["run-many --target build"]} />

1. Sá»­ dá»¥ng `cdk import` trong thÆ° má»¥c `packages/infra` cá»§a á»©ng dá»¥ng má»›i Ä‘á»ƒ xem cÃ¡c tÃ i nguyÃªn nÃ o chÃºng ta sáº½ Ä‘Æ°á»£c nháº¯c import.

    ```bash title="New Application"
    cd packages/infra
    pnpm exec cdk import shopping-list-infra-sandbox/Application --force
    ```

    BÆ°á»›c qua cÃ¡c lá»i nháº¯c báº±ng cÃ¡ch nháº¥n enter. Import sáº½ tháº¥t báº¡i vÃ¬ cÃ¡c tÃ i nguyÃªn Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi má»™t stack khÃ¡c - Ä‘iá»u nÃ y lÃ  mong Ä‘á»£i, chÃºng ta chá»‰ thá»±c hiá»‡n bÆ°á»›c nÃ y Ä‘á»ƒ xÃ¡c nháº­n cÃ¡c tÃ i nguyÃªn nÃ o chÃºng ta sáº½ cáº§n giá»¯ láº¡i. Báº¡n sáº½ tháº¥y output nhÆ° tháº¿ nÃ y:

    ```bash wrap
    shopping-list-infra-sandbox/Application/ApplicationUserIdentity/UserPool/smsRole/Resource (AWS::IAM::Role): enter RoleName (empty to skip)
    shopping-list-infra-sandbox/Application/ApplicationUserIdentity/UserPool/Resource (AWS::Cognito::UserPool): enter UserPoolId (empty to skip)
    shopping-list-infra-sandbox/Application/Database/ShoppingList/Resource (AWS::DynamoDB::Table): import with TableName=shopping_list (y/n) y
    ```

    Äiá»u nÃ y cho chÃºng ta biáº¿t ráº±ng thá»±c sá»± cÃ³ 3 tÃ i nguyÃªn mÃ  chÃºng ta sáº½ cáº§n import vÃ o stack má»›i cá»§a mÃ¬nh.

1. Cáº­p nháº­t dá»± Ã¡n PDK cÅ© cá»§a báº¡n Ä‘á»ƒ Ä‘áº·t `RemovalPolicy` thÃ nh `RETAIN` cho cÃ¡c tÃ i nguyÃªn Ä‘Æ°á»£c phÃ¡t hiá»‡n tá»« bÆ°á»›c trÆ°á»›c. Táº¡i thá»i Ä‘iá»ƒm viáº¿t bÃ i nÃ y, Ä‘Ã¢y lÃ  máº·c Ä‘á»‹nh cho cáº£ User Pool vÃ  báº£ng DynamoDB, nhÆ°ng chÃºng ta cáº§n cáº­p nháº­t nÃ³ cho SMS Role mÃ  chÃºng ta Ä‘Ã£ phÃ¡t hiá»‡n á»Ÿ trÃªn:

    ```diff lang="ts"
    // application-stack.ts
    const userIdentity = new UserIdentity(this, `${id}UserIdentity`, {
      userPool,
    });

    +const smsRole = userIdentity.userPool.node.findAll().filter(
    +  c => CfnResource.isCfnResource(c) &&
    +    c.node.path.includes('/smsRole/'))[0] as CfnResource;
    +smsRole.applyRemovalPolicy(RemovalPolicy.RETAIN);
    ```

1. Triá»ƒn khai dá»± Ã¡n PDK cá»§a báº¡n Ä‘á»ƒ cÃ¡c removal policy Ä‘Æ°á»£c Ã¡p dá»¥ng

    ```bash title="PDK Application"
    cd packages/infra
    npx projen deploy
    ```

1. Xem console CloudFormation vÃ  ghi láº¡i cÃ¡c giÃ¡ trá»‹ mÃ  báº¡n Ä‘Æ°á»£c nháº¯c trong bÆ°á»›c `cdk import` á»Ÿ trÃªn

    1. User Pool ID, vÃ­ dá»¥ `us-west-2_XXXXX`
    2. SMS Role Name, vÃ­ dá»¥ `infra-sandbox-UserIdentityUserPoolsmsRoleXXXXXX`

1. Cáº­p nháº­t dá»± Ã¡n PDK cá»§a báº¡n Ä‘á»ƒ tham chiáº¿u cÃ¡c tÃ i nguyÃªn hiá»‡n cÃ³ thay vÃ¬ táº¡o chÃºng

    ```diff lang="ts"
    // constructs/database.ts
    -this.shoppingListTable = new Table(this, 'ShoppingList', {
    -  ...
    +this.shoppingListTable = Table.fromTableName(
    +  this,
    +  'ShoppingList',
    +  'shopping_list',
    +);
    ```

    VÃ  cho Cognito User Pool

    ```diff lang="ts"
    // application-stack.ts
    +const userPool = UserPool.fromUserPoolId(
    +  this,
    +  'UserPool',
    +  '<your-user-pool-id>',
    +);
    const userIdentity = new UserIdentity(this, `${id}UserIdentity`, {
    +  // PDK construct accepts UserPool not IUserPool, but this still works!
    +  userPool: userPool as any,
    });
    ```

1. Triá»ƒn khai láº¡i dá»± Ã¡n PDK cá»§a báº¡n, Ä‘iá»u nÃ y cÃ³ nghÄ©a lÃ  cÃ¡c tÃ i nguyÃªn khÃ´ng cÃ²n Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi CloudFormation stack cá»§a dá»± Ã¡n PDK cá»§a chÃºng ta.

    ```bash title="PDK Application"
    cd packages/infra
    npx projen deploy
    ```

1. BÃ¢y giá» cÃ¡c tÃ i nguyÃªn khÃ´ng Ä‘Æ°á»£c quáº£n lÃ½, chÃºng ta cÃ³ thá»ƒ cháº¡y `cdk import` trong á»©ng dá»¥ng má»›i cá»§a mÃ¬nh Ä‘á»ƒ thá»±c sá»± thá»±c hiá»‡n import:

    ```bash title="New Application"
    cd packages/infra
    pnpm exec cdk import shopping-list-infra-sandbox/Application --force
    ```

    Nháº­p cÃ¡c giÃ¡ trá»‹ khi Ä‘Æ°á»£c nháº¯c, import sáº½ hoÃ n thÃ nh thÃ nh cÃ´ng.

1. Triá»ƒn khai láº¡i á»©ng dá»¥ng má»›i Ä‘á»ƒ Ä‘áº£m báº£o ráº±ng má»i thay Ä‘á»•i Ä‘á»‘i vá»›i cÃ¡c tÃ i nguyÃªn hiá»‡n cÃ³ nÃ y (hiá»‡n Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi stack má»›i cá»§a báº¡n) Ä‘Æ°á»£c thá»±c hiá»‡n:

    <NxCommands commands={["deploy infra shopping-list-infra-sandbox/*"]} />

1. Thá»±c hiá»‡n kiá»ƒm tra Ä‘áº§y Ä‘á»§ á»©ng dá»¥ng má»›i cá»§a báº¡n má»™t láº§n ná»¯a

1. Cáº­p nháº­t cÃ¡c báº£n ghi DNS Ä‘á»ƒ trá» Ä‘áº¿n Website má»›i cá»§a báº¡n (vÃ  API náº¿u cáº§n).

    ChÃºng tÃ´i khuyáº¿n nghá»‹ má»™t cÃ¡ch tiáº¿p cáº­n tá»«ng bÆ°á»›c báº±ng cÃ¡ch sá»­ dá»¥ng Route53 [Weighted Routing](https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy-weighted.html), theo Ä‘Ã³ má»™t pháº§n nhá» cÃ¡c request Ä‘Æ°á»£c chuyá»ƒn Ä‘áº¿n á»©ng dá»¥ng má»›i Ä‘á»ƒ báº¯t Ä‘áº§u. Khi báº¡n theo dÃµi cÃ¡c metrics cá»§a mÃ¬nh, báº¡n cÃ³ thá»ƒ tÄƒng trá»ng sá»‘ cho á»©ng dá»¥ng má»›i cho Ä‘áº¿n khi khÃ´ng cÃ³ traffic nÃ o Ä‘Æ°á»£c gá»­i Ä‘áº¿n á»©ng dá»¥ng PDK cÅ© cá»§a báº¡n.

    Náº¿u báº¡n khÃ´ng cÃ³ DNS nÃ o vÃ  Ä‘Ã£ sá»­ dá»¥ng cÃ¡c domain Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng cho website vÃ  API, báº¡n luÃ´n cÃ³ thá»ƒ xem xÃ©t viá»‡c proxy cÃ¡c request (vÃ­ dá»¥: thÃ´ng qua [CloudFront HTTP origin](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_cloudfront_origins-readme.html#from-an-http-endpoint) hoáº·c [API Gateway HTTP integration(s)](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_apigateway.HttpIntegration.html)).

1. Theo dÃµi cÃ¡c metrics cá»§a á»©ng dá»¥ng PDK Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng cÃ³ traffic, vÃ  cuá»‘i cÃ¹ng há»§y CloudFormation stack cÅ©:

    ```bash
    cd packages/infra
    npx projen destroy
    ```

</Steps>

Äiá»u Ä‘Ã³ phá»©c táº¡p hÆ¡n khÃ¡ nhiá»u, nhÆ°ng chÃºng ta Ä‘Ã£ di chuyá»ƒn thÃ nh cÃ´ng ngÆ°á»i dÃ¹ng cá»§a mÃ¬nh má»™t cÃ¡ch liá»n máº¡ch sang á»©ng dá»¥ng má»›i! ğŸ‰ğŸ‰ğŸ‰

BÃ¢y giá» chÃºng ta cÃ³ nhá»¯ng lá»£i Ã­ch má»›i cá»§a Nx Plugin for AWS so vá»›i PDK:

- Build nhanh hÆ¡n
- Há»— trá»£ phÃ¡t triá»ƒn API cá»¥c bá»™
- Codebase thÃ¢n thiá»‡n vá»›i vibe-coding (<Link path="/get_started/building-with-ai">thá»­ MCP server cá»§a chÃºng tÃ´i!</Link>)
- Code client/server type-safe trá»±c quan hÆ¡n
- VÃ  nhiá»u hÆ¡n ná»¯a!