---
title: "Tri·ªÉn khai v√† c·∫•u h√¨nh Story agent"
description: "H∆∞·ªõng d·∫´n chi ti·∫øt c√°ch x√¢y d·ª±ng tr√≤ ch∆°i phi√™u l∆∞u h·∫ßm ng·ª•c ƒë∆∞·ª£c h·ªó tr·ª£ b·ªüi AI agentic s·ª≠ d·ª•ng @aws/nx-plugin."
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## Nhi·ªám v·ª• 1: Tri·ªÉn khai Story Agent

Story Agent l√† m·ªôt agent [Strands](https://strandsagents.com/) m√† khi ƒë∆∞·ª£c cung c·∫•p m·ªôt `Game` v√† danh s√°ch c√°c `Action` l√†m ng·ªØ c·∫£nh, s·∫Ω ph√°t tri·ªÉn c√¢u chuy·ªán. Ch√∫ng ta s·∫Ω c·∫•u h√¨nh agent ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi Inventory MCP Server c·ªßa ch√∫ng ta nh·∫±m qu·∫£n l√Ω c√°c v·∫≠t ph·∫©m kh·∫£ d·ª•ng c·ªßa ng∆∞·ªùi ch∆°i.

:::note
ƒê·ªëi v·ªõi h∆∞·ªõng d·∫´n n√†y, ch√∫ng ta s·∫Ω tri·ªÉn khai Agent theo c√°ch "kh√¥ng tr·∫°ng th√°i", trong ƒë√≥ m·ªói l·∫ßn g·ªçi l√† m·ªôt phi√™n ƒë·ªôc l·∫≠p bao g·ªìm to√†n b·ªô l·ªãch s·ª≠ tin nh·∫Øn. ƒê·ªëi v·ªõi m√¥i tr∆∞·ªùng s·∫£n xu·∫•t, h√£y xem x√©t t√≠ch h·ª£p v·ªõi [Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html). ƒê·ªÉ bi·∫øt th√™m th√¥ng tin, tham kh·∫£o trang [s·ª≠ d·ª•ng AgentCore Memory v·ªõi Strands](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands).
:::

### Tri·ªÉn khai Agent

ƒê·ªÉ tri·ªÉn khai agent c·ªßa ch√∫ng ta, c·∫≠p nh·∫≠t c√°c file sau trong `packages/story/dungeon_adventure_story/agent`:

<Tabs>
  <TabItem label="main.py">
<E2EDiff lang="python" before="dungeon-adventure/3/main.py.old.template" after="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2EDiff lang="python" before="dungeon-adventure/3/agent.py.old.template" after="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

ƒêi·ªÅu n√†y s·∫Ω c·∫•u h√¨nh nh·ªØng th·ª© sau:

- Tr√≠ch xu·∫•t player, genre v√† actions t·ª´ agent payload,
- X√¢y d·ª±ng m·ªôt client m√† Agent c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë·ªÉ g·ªçi MCP server c·ªßa ch√∫ng ta v·ªõi SigV4 Authentication, v√†
- X√¢y d·ª±ng agent v·ªõi system prompt v√† c√°c c√¥ng c·ª• c·ªßa MCP server.

## Nhi·ªám v·ª• 2: Tri·ªÉn khai v√† ki·ªÉm th·ª≠

### Build code

ƒê·ªÉ build code:

<PackageManagerShortCommand commands={["build"]} />

<Aside type="tip">
N·∫øu b·∫°n g·∫∑p b·∫•t k·ª≥ l·ªói lint n√†o, h√£y ch·∫°y l·ªánh sau ƒë·ªÉ t·ª± ƒë·ªông s·ª≠a ch√∫ng.

<PackageManagerShortCommand commands={["lint"]} />
</Aside>

### Tri·ªÉn khai ·ª©ng d·ª•ng c·ªßa b·∫°n
ƒê·ªÉ tri·ªÉn khai ·ª©ng d·ª•ng c·ªßa b·∫°n, ch·∫°y l·ªánh sau:

<NxCommands commands={['deploy infra "dungeon-adventure-infra-sandbox/*"']} />

Qu√° tr√¨nh tri·ªÉn khai n√†y s·∫Ω m·∫•t kho·∫£ng 2 ph√∫t ƒë·ªÉ ho√†n th√†nh.

Khi qu√° tr√¨nh tri·ªÉn khai ho√†n t·∫•t, b·∫°n s·∫Ω th·∫•y c√°c output t∆∞∆°ng t·ª± nh∆∞ sau _(m·ªôt s·ªë gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c ·∫©n)_:

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 ‚úÖ  dungeon-adventure-infra-sandbox-Application

‚ú®  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

### Ki·ªÉm th·ª≠ Agent c·ªßa b·∫°n

B·∫°n c√≥ th·ªÉ ki·ªÉm th·ª≠ Agent c·ªßa m√¨nh b·∫±ng m·ªôt trong hai c√°ch:
<ul>
<li>Kh·ªüi ƒë·ªông m·ªôt instance c·ª•c b·ªô c·ªßa Agent server v√† g·ªçi n√≥ b·∫±ng `curl`, ho·∫∑c</li>
<li>G·ªçi API ƒë√£ tri·ªÉn khai b·∫±ng curl v·ªõi JWT token.</li>
</ul>

<Tabs>
  <TabItem label="Local">
  Kh·ªüi ƒë·ªông Agent server c·ª•c b·ªô c·ªßa b·∫°n b·∫±ng c√°ch ch·∫°y l·ªánh sau:
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    S·ª≠ d·ª•ng output `InventoryMcpArn` t·ª´ CDK deploy ·ªü tr√™n v√† ch·ªâ ƒë·ªãnh `AWS_REGION` m·ª•c ti√™u c·ªßa b·∫°n.
    :::

    Khi Agent server ƒë√£ ch·∫°y (b·∫°n s·∫Ω kh√¥ng th·∫•y b·∫•t k·ª≥ output n√†o), g·ªçi n√≥ b·∫±ng c√°ch ch·∫°y l·ªánh sau:

    ```bash
    curl -N -X POST http://127.0.0.1:8081/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="Deployed">
    ƒê·ªÉ ki·ªÉm th·ª≠ agent ƒë√£ tri·ªÉn khai, b·∫°n c·∫ßn x√°c th·ª±c v·ªõi Cognito v√† l·∫•y JWT token. ƒê·∫ßu ti√™n, thi·∫øt l·∫≠p c√°c bi·∫øn m√¥i tr∆∞·ªùng c·ªßa b·∫°n:

    ```bash
    # ƒê·∫∑t Cognito User Pool ID v√† Client ID t·ª´ c√°c output c·ªßa CDK
    export POOL_ID="<UserPoolId t·ª´ CDK outputs>"
    export CLIENT_ID="<UserPoolClientId t·ª´ CDK outputs>"
    export REGION="<your-region>"
    ```

    T·∫°o m·ªôt test user v√† l·∫•y authentication token:

    ```bash
    # V√¥ hi·ªáu h√≥a MFA ƒë·ªÉ ƒë∆°n gi·∫£n h√≥a vi·ªác t·∫°o user
    aws cognito-idp set-user-pool-mfa-config \
      --mfa-configuration OFF \
      --user-pool-id $POOL_ID

    # T·∫°o User
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "test" \
      --temporary-password "TempPass123-" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # ƒê·∫∑t Permanent Password (thay th·∫ø b·∫±ng m·ªôt m·∫≠t kh·∫©u an to√†n h∆°n!)
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "test" \
      --password "PermanentPass123-" \
      --region $REGION \
      --permanent > /dev/null

    # X√°c th·ª±c User v√† l·∫•y Access Token
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='test',PASSWORD='PermanentPass123-' \
      --region $REGION \
      --query "AuthenticationResult.AccessToken" \
      --output text)
    ```

    G·ªçi agent ƒë√£ tri·ªÉn khai b·∫±ng URL runtime c·ªßa Bedrock AgentCore:

    ```bash
    # ƒê·∫∑t Story Agent ARN t·ª´ CDK outputs
    export AGENT_ARN="<StoryAgentArn t·ª´ CDK outputs>"

    # URL-encode ARN
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # X√¢y d·ª±ng invocation URL
    export AGENT_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # G·ªçi agent
    curl -N -X POST "$AGENT_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    URL encoding l√† c·∫ßn thi·∫øt ƒë·ªÉ ƒë·ªãnh d·∫°ng ƒë√∫ng ARN cho endpoint API c·ªßa Bedrock AgentCore.
    :::
  </TabItem>
</Tabs>

N·∫øu l·ªánh ch·∫°y th√†nh c√¥ng, b·∫°n s·∫Ω b·∫Øt ƒë·∫ßu th·∫•y vƒÉn b·∫£n c√¢u chuy·ªán ban ƒë·∫ßu ƒë∆∞·ª£c streaming:

```
You are a new superhero in the bustling metropolis of Metro City...
```

Ch√∫c m·ª´ng. B·∫°n ƒë√£ x√¢y d·ª±ng v√† tri·ªÉn khai Strands Agent ƒë·∫ßu ti√™n c·ªßa m√¨nh tr√™n Bedrock AgentCore Runtime!  üéâüéâüéâ