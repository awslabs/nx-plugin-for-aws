---
title: "Triá»ƒn khai Game API vÃ  Inventory MCP server"
description: "HÆ°á»›ng dáº«n chi tiáº¿t cÃ¡ch xÃ¢y dá»±ng trÃ² chÆ¡i phiÃªu lÆ°u háº§m ngá»¥c Ä‘Æ°á»£c há»— trá»£ bá»Ÿi AI agentic sá»­ dá»¥ng @aws/nx-plugin."
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2EDiff from '@components/e2e-diff.astro';
import E2ECode from '@components/e2e-code.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

import { getDungeonAdventureElectroDbDependencies } from '../../../../../../../../e2e/src/utils';

## Nhiá»‡m vá»¥ 1: Triá»ƒn khai Game API

ChÃºng ta sáº½ triá»ƒn khai cÃ¡c API sau trong pháº§n nÃ y:

1. `saveGame` - táº¡o hoáº·c cáº­p nháº­t má»™t trÃ² chÆ¡i.
2. `queryGames` - tráº£ vá» danh sÃ¡ch phÃ¢n trang cÃ¡c trÃ² chÆ¡i Ä‘Ã£ lÆ°u trÆ°á»›c Ä‘Ã³.
3. `saveAction` - lÆ°u má»™t hÃ nh Ä‘á»™ng cho má»™t trÃ² chÆ¡i nháº¥t Ä‘á»‹nh.
4. `queryActions` - tráº£ vá» danh sÃ¡ch phÃ¢n trang táº¥t cáº£ cÃ¡c hÃ nh Ä‘á»™ng liÃªn quan Ä‘áº¿n má»™t trÃ² chÆ¡i.
5. `queryInventory` - tráº£ vá» danh sÃ¡ch phÃ¢n trang cÃ¡c váº­t pháº©m trong kho cá»§a ngÆ°á»i chÆ¡i.

### Schema API

Äá»ƒ Ä‘á»‹nh nghÄ©a Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra cá»§a API, hÃ£y táº¡o schema cá»§a chÃºng ta báº±ng [Zod](https://zod.dev/) trong file `packages/game-api/src/schema/index.ts` nhÆ° sau:

<E2EDiff lang="typescript" before="dungeon-adventure/2/schema/index.ts.old.template" after="dungeon-adventure/2/schema/index.ts.template" />

XÃ³a file `packages/game-api/src/schema/echo.ts` vÃ¬ chÃºng ta sáº½ khÃ´ng sá»­ dá»¥ng nÃ³ trong dá»± Ã¡n nÃ y.

<Aside type="tip">
Äá»‘i vá»›i má»—i schema chÃºng ta Ä‘á»‹nh nghÄ©a trong Zod, chÃºng ta cÅ©ng xuáº¥t má»™t interface báº±ng cÃ¡ch sá»­ dá»¥ng cÃº phÃ¡p `z.TypeOf`. Äiá»u nÃ y chuyá»ƒn Ä‘á»•i Ä‘á»‹nh nghÄ©a Zod cá»§a chÃºng ta thÃ nh má»™t interface Typescript mÃ  khÃ´ng cáº§n pháº£i trÃ¹ng láº·p cÃ´ng sá»©c.
</Aside>

### MÃ´ hÃ¬nh hÃ³a thá»±c thá»ƒ

ÄÃ¢y lÃ  sÆ¡ Ä‘á»“ ER cho á»©ng dá»¥ng cá»§a chÃºng ta.

<Image class="centered-image white-bg" src={dungeonAdventureErPng} alt="dungeon-adventure-er.png" width="400" height="300" />

{/* Generated from the following PlantUML: */}
{/*
@startuml Game API Entity Relationship Diagram

!theme plain

skinparam linetype ortho
skinparam roundcorner 10

entity "Game" as game {
  + playerName : string <<PK>>
  --
  genre : string
  lastUpdated : string
}

entity "Action" as action {
  + playerName : string <<PK>>
  + timestamp : string <<SK>>
  --
  role : string
  content : string
}

entity "Item" as item {
  + playerName : string <<PK>>
  + itemName : string
  --
  emoji : string (optional)
  lastUpdated : string
  quantity : number
}

game ||--o{ action
game ||--o{ item

@enduml
*/}

ChÃºng ta sáº½ triá»ƒn khai cÆ¡ sá»Ÿ dá»¯ liá»‡u trong DynamoDB vÃ  sáº½ sá»­ dá»¥ng thÆ° viá»‡n client DynamoDB [ElectroDB](https://electrodb.dev/en/core-concepts/introduction/) Ä‘á»ƒ Ä‘Æ¡n giáº£n hÃ³a má»i thá»©. Äá»ƒ cÃ i Ä‘áº·t `electrodb` vÃ  DynamoDB Client, cháº¡y lá»‡nh nÃ y:

<InstallCommand pkg={getDungeonAdventureElectroDbDependencies()} />

<Aside>
Táº¥t cáº£ cÃ¡c dependencies Ä‘Æ°á»£c thÃªm vÃ o `package.json` gá»‘c vÃ¬ `@aws/nx-plugin` tuÃ¢n theo nguyÃªn táº¯c [single version policy](https://nx.dev/concepts/decisions/dependency-management#single-version-policy). Äá»ƒ biáº¿t thÃªm thÃ´ng tin, tham kháº£o <Link path="guides/typescript-project#dependencies">hÆ°á»›ng dáº«n ts#project</Link>.
</Aside>

Äá»ƒ Ä‘á»‹nh nghÄ©a cÃ¡c thá»±c thá»ƒ ElectroDB tá»« SÆ¡ Ä‘á»“ ER, hÃ£y táº¡o file `packages/game-api/src/entities/index.ts`:

<E2ECode lang="typescript" path="dungeon-adventure/2/entities/index.ts.template" />

ElectroDB cho phÃ©p chÃºng ta khÃ´ng chá»‰ Ä‘á»‹nh nghÄ©a cÃ¡c kiá»ƒu cá»§a mÃ¬nh mÃ  cÃ²n cÃ³ thá»ƒ cung cáº¥p giÃ¡ trá»‹ máº·c Ä‘á»‹nh cho cÃ¡c giÃ¡ trá»‹ nháº¥t Ä‘á»‹nh nhÆ° timestamps. NgoÃ i ra, ElectroDB tuÃ¢n theo [single-table design](https://electrodb.dev/en/core-concepts/single-table-relationships/) lÃ  best practice khi sá»­ dá»¥ng DynamoDB.

<Aside>
Máº·c dÃ¹ ElectroDB há»— trá»£ [collections](https://electrodb.dev/en/modeling/collections/), chÃºng ta Ä‘Ã£ chá»n khÃ´ng sá»­ dá»¥ng chÃºng trong hÆ°á»›ng dáº«n nÃ y Ä‘á»ƒ Ä‘Æ¡n giáº£n.
</Aside>

Äá»ƒ chuáº©n bá»‹ cho MCP server tÆ°Æ¡ng tÃ¡c vá»›i inventory, hÃ£y Ä‘áº£m báº£o chÃºng ta xuáº¥t inventory entity trong `packages/game-api/src/index.ts`:

<Tabs>
<TabItem label="packages/game-api/src/index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/index.ts.old.template" after="dungeon-adventure/2/index.ts.template" />
</TabItem>
</Tabs>

:::note
Cáº¥u trÃºc package sáº½ tá»‘t hÆ¡n náº¿u chÃºng ta tÃ¡i cáº¥u trÃºc cÃ¡c entities thÃ nh dá»± Ã¡n chia sáº» riÃªng cá»§a chÃºng Ä‘á»ƒ MCP server khÃ´ng cáº§n phá»¥ thuá»™c vÃ o API.
:::

### Äá»‹nh nghÄ©a cÃ¡c procedures

Äá»ƒ triá»ƒn khai cÃ¡c phÆ°Æ¡ng thá»©c API, thá»±c hiá»‡n cÃ¡c thay Ä‘á»•i sau trong `packages/game-api/src/procedures`:

<Tabs>
  <TabItem label="actions.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/actions.ts.template" />
  </TabItem>
  <TabItem label="games.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/games.ts.template" />
  </TabItem>
  <TabItem label="inventory.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/inventory.ts.template" />
  </TabItem>
</Tabs>

XÃ³a file `echo.ts` (tá»« `packages/game-api/src/procedures`) vÃ¬ chÃºng ta sáº½ khÃ´ng sá»­ dá»¥ng nÃ³ trong dá»± Ã¡n nÃ y.

### Thiáº¿t láº­p Router

Sau khi chÃºng ta Ä‘á»‹nh nghÄ©a cÃ¡c procedures, Ä‘á»ƒ káº¿t ná»‘i chÃºng vÃ o API cá»§a chÃºng ta, cáº­p nháº­t file sau:

<Tabs>
  <TabItem label="packages/game-api/src/router.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/router.ts.old.template" after="dungeon-adventure/2/router.ts.template" />
</TabItem>
</Tabs>

## Nhiá»‡m vá»¥ 2: Táº¡o Inventory MCP server

HÃ£y táº¡o má»™t MCP server cho phÃ©p agent cá»§a chÃºng ta quáº£n lÃ½ cÃ¡c váº­t pháº©m trong kho cá»§a ngÆ°á»i chÆ¡i.

ChÃºng ta sáº½ Ä‘á»‹nh nghÄ©a cÃ¡c cÃ´ng cá»¥ sau cho agent cá»§a chÃºng ta:

- `list-inventory-items` Ä‘á»ƒ láº¥y cÃ¡c váº­t pháº©m kho hiá»‡n táº¡i cá»§a ngÆ°á»i chÆ¡i
- `add-to-inventory` Ä‘á»ƒ thÃªm váº­t pháº©m vÃ o kho cá»§a ngÆ°á»i chÆ¡i
- `remove-from-inventory` Ä‘á»ƒ xÃ³a váº­t pháº©m khá»i kho cá»§a ngÆ°á»i chÆ¡i

Äá»ƒ tiáº¿t kiá»‡m thá»i gian, chÃºng ta sáº½ Ä‘á»‹nh nghÄ©a táº¥t cáº£ cÃ¡c cÃ´ng cá»¥ inline:

<Tabs>
  <TabItem label="packages/inventory/src/mcp-server/server.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/mcp/server.ts.old.template" after="dungeon-adventure/2/mcp/server.ts.template" />
</TabItem>
</Tabs>

Khi sá»‘ lÆ°á»£ng cÃ´ng cá»¥ tÄƒng lÃªn, báº¡n cÃ³ thá»ƒ tÃ¡i cáº¥u trÃºc chÃºng thÃ nh cÃ¡c file riÃªng biá»‡t náº¿u muá»‘n.

XÃ³a cÃ¡c thÆ° má»¥c `tools` vÃ  `resources` trong `packages/inventory/src/mcp-server` vÃ¬ chÃºng sáº½ khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng.

## Nhiá»‡m vá»¥ 3: Cáº­p nháº­t cÆ¡ sá»Ÿ háº¡ táº§ng

BÆ°á»›c cuá»‘i cÃ¹ng lÃ  cáº­p nháº­t cÆ¡ sá»Ÿ háº¡ táº§ng cá»§a chÃºng ta Ä‘á»ƒ táº¡o báº£ng DynamoDB vÃ  cáº¥p quyá»n thá»±c hiá»‡n cÃ¡c thao tÃ¡c tá»« Game API.
Äá»ƒ lÃ m Ä‘iá»u nÃ y, cáº­p nháº­t `packages/infra/src` nhÆ° sau:

<Tabs>
  <TabItem label="constructs/electrodb-table.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/constructs/electrodb-table.ts.template" />
  </TabItem>
  <TabItem label="stacks/application-stack.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/1/application-stack.ts.template" after="dungeon-adventure/2/stacks/application-stack.ts.template" />

:::note
LÆ°u Ã½ á»Ÿ Ä‘Ã¢y ráº±ng vÃ¬ má»—i procedure Ä‘Æ°á»£c phá»¥c vá»¥ bá»Ÿi má»™t lambda function riÃªng láº», chÃºng ta cÃ³ thá»ƒ tuÃ¢n theo nguyÃªn táº¯c least privilege vÃ  chá»‰ gÃ¡n cÃ¡c quyá»n Ä‘á»c/ghi cáº§n thiáº¿t dá»±a trÃªn triá»ƒn khai cá»§a procedure.
:::
  </TabItem>
</Tabs>

## Nhiá»‡m vá»¥ 4: Triá»ƒn khai vÃ  kiá»ƒm thá»­

Äáº§u tiÃªn, sá»­a má»i váº¥n Ä‘á» lint:

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />

Sau Ä‘Ã³ build codebase:

<NxCommands commands={['run-many --target build --all']} />

### Triá»ƒn khai á»©ng dá»¥ng cá»§a báº¡n
Äá»ƒ triá»ƒn khai á»©ng dá»¥ng cá»§a báº¡n, cháº¡y lá»‡nh sau:

<NxCommands commands={['deploy infra "dungeon-adventure-infra-sandbox/*"']} />

:::caution
Äá»ƒ bootstrap AWS Account cá»§a báº¡n trÆ°á»›c, cháº¡y:

<NxCommands commands={['bootstrap infra']} />
:::

Triá»ƒn khai Ä‘áº§u tiÃªn cá»§a báº¡n sáº½ máº¥t khoáº£ng 8 phÃºt Ä‘á»ƒ hoÃ n thÃ nh. CÃ¡c láº§n triá»ƒn khai tiáº¿p theo sáº½ máº¥t khoáº£ng 2 phÃºt.

:::tip
Náº¿u báº¡n Ä‘ang láº·p láº¡i cÃ¡c thay Ä‘á»•i code Lambda function, báº¡n cÃ³ thá»ƒ triá»ƒn khai vá»›i cá» `--hotswap` sau khi build codebase Ä‘á»ƒ cÃ³ thá»i gian triá»ƒn khai ngáº¯n hÆ¡n nhiá»u (2-3 giÃ¢y).

<NxCommands commands={['run @dungeon-adventure/infra:deploy "dungeon-adventure-infra-sandbox/*" --hotswap']} />
:::

Khi triá»ƒn khai hoÃ n táº¥t, báº¡n sáº½ tháº¥y cÃ¡c outputs tÆ°Æ¡ng tá»± nhÆ° sau _(má»™t sá»‘ giÃ¡ trá»‹ Ä‘Ã£ Ä‘Æ°á»£c che Ä‘i)_:

```bash
dungeon-adventure-sandbox-Application
dungeon-adventure-sandbox-Application: deploying... [2/2]

 âœ…  dungeon-adventure-sandbox-Application

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-sandbox-Application.StoryApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```
### Kiá»ƒm thá»­ API
Báº¡n cÃ³ thá»ƒ kiá»ƒm thá»­ API báº±ng cÃ¡ch:
<ul>
<li>Khá»Ÿi Ä‘á»™ng má»™t instance local cá»§a tRPC backend vÃ  gá»i cÃ¡c API báº±ng `curl`.</li>
<li>
<Drawer title="Sigv4 enabled curl" trigger="Gá»i API Ä‘Ã£ triá»ƒn khai báº±ng curl há»— trá»£ sigv4">

<Tabs>
  <TabItem label="Bash/Linux/macOS">
Báº¡n cÃ³ thá»ƒ thÃªm script sau vÃ o file `.bashrc` cá»§a báº¡n (vÃ  `source` nÃ³) hoáº·c paste ná»™i dung sau vÃ o cÃ¹ng terminal mÃ  báº¡n muá»‘n cháº¡y lá»‡nh.
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

Äá»ƒ thá»±c hiá»‡n yÃªu cáº§u curl vá»›i xÃ¡c thá»±c `sigv4`, gá»i `acurl` báº±ng cÃ¡c vÃ­ dá»¥ sau:

###### API Gateway
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### Streaming Lambda function url
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
  <TabItem label="Windows PowerShell">
Báº¡n cÃ³ thá»ƒ thÃªm function sau vÃ o PowerShell profile cá»§a báº¡n hoáº·c paste ná»™i dung sau vÃ o cÃ¹ng phiÃªn PowerShell mÃ  báº¡n muá»‘n cháº¡y lá»‡nh.
```powershell
# PowerShell profile or current session
function acurl {
    param(
        [Parameter(Mandatory=$true)][string]$Region,
        [Parameter(Mandatory=$true)][string]$Service,
        [Parameter(ValueFromRemainingArguments=$true)][string[]]$CurlArgs
    )

    $AccessKey = aws configure get aws_access_key_id
    $SecretKey = aws configure get aws_secret_access_key
    $SessionToken = aws configure get aws_session_token

    & curl --aws-sigv4 "aws:amz:$Region`:$Service" --user "$AccessKey`:$SecretKey" -H "X-Amz-Security-Token: $SessionToken" @CurlArgs
}
```

Äá»ƒ thá»±c hiá»‡n yÃªu cáº§u curl vá»›i xÃ¡c thá»±c `sigv4`, gá»i `acurl` báº±ng cÃ¡c vÃ­ dá»¥ sau:

###### API Gateway
```powershell
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### Streaming Lambda function url
```powershell
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
</Tabs>

</Drawer>
</li>
</ul>


<Tabs>
  <TabItem label="Local">
    Äá»ƒ khá»Ÿi Ä‘á»™ng server `game-api` local cá»§a báº¡n, cháº¡y lá»‡nh sau:

    <NxCommands highlights={['dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY']} env={{TABLE_NAME:"dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY"}} commands={["run @dungeon-adventure/game-api:serve"]} />

    <Aside type="caution">
    Sá»­ dá»¥ng giÃ¡ trá»‹ output CDK deploy cá»§a `dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX` Ä‘á»ƒ thay tháº¿ placeholder Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u.
    </Aside>

    Khi server cá»§a báº¡n Ä‘Ã£ cháº¡y, báº¡n cÃ³ thá»ƒ gá»i nÃ³ báº±ng cÃ¡ch cháº¡y lá»‡nh sau:

    ```bash
    curl -X GET 'http://localhost:2022/games.query?input=%7B%7D'
    ```
  </TabItem>
  <TabItem label="Deployed">
```bash "https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/" "ap-southeast-2"
acurl ap-southeast-2 execute-api -X GET 'https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/games.query?input=%7B%7D'
```
    <Aside type="caution">
    Sá»­ dá»¥ng giÃ¡ trá»‹ output CDK deploy cá»§a `dungeon-adventure-infra-sandbox-Application.GameApiGameApiEndpointXXX` Ä‘á»ƒ thay tháº¿ placeholder Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u vÃ  Ä‘áº·t region tÆ°Æ¡ng á»©ng.
    </Aside>
  </TabItem>
</Tabs>

:::note
`%7B%7D` mÃ  chÃºng ta truyá»n Ä‘á»ƒ kiá»ƒm thá»­ API lÃ  má»™t Ä‘á»‘i tÆ°á»£ng JSON rá»—ng Ä‘Æ°á»£c mÃ£ hÃ³a URI (`{}`).
:::

Náº¿u lá»‡nh cháº¡y thÃ nh cÃ´ng, báº¡n sáº½ tháº¥y pháº£n há»“i nhÆ° sau:

```json
{"result":{"data":{"items":[],"cursor":null}}}
```

ChÃºc má»«ng, báº¡n Ä‘Ã£ xÃ¢y dá»±ng vÃ  triá»ƒn khai API Ä‘áº§u tiÃªn cá»§a mÃ¬nh báº±ng tRPC!  ğŸ‰ğŸ‰ğŸ‰