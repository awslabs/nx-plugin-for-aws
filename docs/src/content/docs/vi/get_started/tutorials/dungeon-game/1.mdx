---
title: "Thiáº¿t láº­p monorepo"
description: "HÆ°á»›ng dáº«n chi tiáº¿t cÃ¡ch xÃ¢y dá»±ng trÃ² chÆ¡i phiÃªu lÆ°u háº§m ngá»¥c Ä‘Æ°á»£c há»— trá»£ bá»Ÿi AI agentic sá»­ dá»¥ng @aws/nx-plugin."
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import CreateNxWorkspaceCommand from '@components/create-nx-workspace-command.astro';
import PackageManagerShortCommand from '@components/package-manager-short-command.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## Nhiá»‡m vá»¥ 1: Táº¡o má»™t monorepo

Äá»ƒ táº¡o má»™t monorepo má»›i, tá»« thÆ° má»¥c mong muá»‘n cá»§a báº¡n, cháº¡y lá»‡nh sau:

<CreateNxWorkspaceCommand workspace="dungeon-adventure" iacProvider="CDK" />

:::note
ChÃºng ta sá»­ dá»¥ng `--iacProvider=CDK` vÃ¬ chÃºng ta sáº½ sá»­ dá»¥ng CDK cho cÆ¡ sá»Ÿ háº¡ táº§ng dÆ°á»›i dáº¡ng mÃ£ trong hÆ°á»›ng dáº«n nÃ y. Nx Plugin cho AWS cÅ©ng há»— trá»£ `Terraform`.
:::

Äiá»u nÃ y sáº½ thiáº¿t láº­p má»™t NX monorepo trong thÆ° má»¥c `dungeon-adventure`. Khi báº¡n má»Ÿ thÆ° má»¥c trong VSCode, báº¡n sáº½ tháº¥y cáº¥u trÃºc tá»‡p nÃ y:

<FileTree>
- .nx/
- .vscode/
- node_modules/
- packages/ Ä‘Ã¢y lÃ  nÆ¡i cÃ¡c dá»± Ã¡n con cá»§a báº¡n sáº½ náº±m
- .gitignore
- .prettierignore
- .prettierrc
- nx.json cáº¥u hÃ¬nh Nx CLI vÃ  cÃ¡c giÃ¡ trá»‹ máº·c Ä‘á»‹nh cá»§a monorepo
- package.json táº¥t cáº£ cÃ¡c phá»¥ thuá»™c node Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ Ä‘Ã¢y
- pnpm-lock.yaml hoáº·c bun.lock, yarn.lock, package-lock.json tÃ¹y thuá»™c vÃ o trÃ¬nh quáº£n lÃ½ gÃ³i
- pnpm-workspace.yaml náº¿u sá»­ dá»¥ng pnpm
- README.md
- tsconfig.base.json táº¥t cáº£ cÃ¡c dá»± Ã¡n con dá»±a trÃªn node Ä‘á»u má»Ÿ rá»™ng tá»« tá»‡p nÃ y
- tsconfig.json
- aws-nx-plugin.config.mts cáº¥u hÃ¬nh cho Nx Plugin cho AWS
</FileTree>

BÃ¢y giá» chÃºng ta cÃ³ thá»ƒ báº¯t Ä‘áº§u táº¡o cÃ¡c dá»± Ã¡n con khÃ¡c nhau báº±ng cÃ¡ch sá»­ dá»¥ng `@aws/nx-plugin`.

<Aside type="tip">CÃ¡ch tá»‘t nháº¥t lÃ  Ä‘áº£m báº£o táº¥t cáº£ cÃ¡c tá»‡p chÆ°a Ä‘Æ°á»£c stage cá»§a báº¡n Ä‘Æ°á»£c commit trong Git trÆ°á»›c khi cháº¡y báº¥t ká»³ trÃ¬nh táº¡o nÃ o. Äiá»u nÃ y cho phÃ©p báº¡n xem nhá»¯ng gÃ¬ Ä‘Ã£ thay Ä‘á»•i sau khi cháº¡y trÃ¬nh táº¡o thÃ´ng qua `git diff`.</Aside>

## Nhiá»‡m vá»¥ 2: Táº¡o má»™t Game API

Äáº§u tiÃªn, hÃ£y táº¡o Game API cá»§a chÃºng ta. Äá»ƒ lÃ m Ä‘iá»u nÃ y, táº¡o má»™t tRPC API cÃ³ tÃªn `GameApi` báº±ng cÃ¡c bÆ°á»›c sau:

<RunGenerator generator="ts#trpc-api" requiredParameters={{ name: "GameApi" }} noInteractive />

<br />

Báº¡n sáº½ tháº¥y má»™t sá»‘ tá»‡p má»›i xuáº¥t hiá»‡n trong cÃ¢y tá»‡p cá»§a mÃ¬nh.

<Aside>
`package.json` gá»‘c hiá»‡n Ä‘Æ°á»£c cáº¥u hÃ¬nh vá»›i `type` lÃ  `module`, cÃ³ nghÄ©a lÃ  ESM lÃ  loáº¡i module máº·c Ä‘á»‹nh cho táº¥t cáº£ cÃ¡c dá»± Ã¡n con dá»±a trÃªn node Ä‘Æ°á»£c cung cáº¥p bá»Ÿi `@aws/nx-plugin`.
Äá»ƒ biáº¿t thÃªm chi tiáº¿t vá» lÃ m viá»‡c vá»›i cÃ¡c dá»± Ã¡n TypeScript, hÃ£y tham kháº£o <Link path="guides/typescript-project">hÆ°á»›ng dáº«n trÃ¬nh táº¡o ts#project</Link>.
</Aside>

<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi ts#trpc-api" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
DÆ°á»›i Ä‘Ã¢y lÃ  danh sÃ¡ch táº¥t cáº£ cÃ¡c tá»‡p Ä‘Ã£ Ä‘Æ°á»£c táº¡o bá»Ÿi trÃ¬nh táº¡o `ts#trpc-api`. ChÃºng ta sáº½ xem xÃ©t má»™t sá»‘ tá»‡p chÃ­nh Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u trong cÃ¢y tá»‡p:
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - app/ cÃ¡c cdk construct cá»¥ thá»ƒ cho á»©ng dá»¥ng
          - apis/
            - **game-api.ts** cdk construct Ä‘á»ƒ táº¡o tRPC API cá»§a báº¡n
            - index.ts
            - ...
          - index.ts
        - core/ cÃ¡c cdk construct chung
          - api/
            - rest-api.ts cdk construct cÆ¡ sá»Ÿ cho API Gateway Rest API
            - trpc-utils.ts tiá»‡n Ã­ch cho cÃ¡c cdk construct cá»§a trpc API
            - utils.ts tiá»‡n Ã­ch cho cÃ¡c API construct
          - index.ts
          - runtime-config.ts
        - index.ts
      - project.json
      - ...
  - game-api/ tRPC API
    - src/
      - client/ vanilla client thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng cho cÃ¡c cuá»™c gá»i mÃ¡y mÃ³c vá»›i mÃ¡y mÃ³c báº±ng ts
        - index.ts
      - middleware/ cÃ´ng cá»¥ Ä‘o lÆ°á»ng powertools
        - error.ts
        - index.ts
        - logger.ts
        - metrics.ts
        - tracer.ts
      - schema/ Ä‘á»‹nh nghÄ©a Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra cho API cá»§a báº¡n
        - index.ts
        - **echo.ts** schema Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra máº«u
        - z-async-iterable.ts wrapper Zod schema cho tRPC subscription output
      - procedures/ triá»ƒn khai cá»¥ thá»ƒ cho cÃ¡c thá»§ tá»¥c/tuyáº¿n Ä‘Æ°á»ng API cá»§a báº¡n
        - **echo.ts** triá»ƒn khai thá»§ tá»¥c máº«u
      - index.ts
      - init.ts thiáº¿t láº­p ngá»¯ cáº£nh vÃ  middleware
      - handler.ts Ä‘iá»ƒm vÃ o Lambda handler (sá»­ dá»¥ng response streaming cho REST APIs)
      - local-server.ts Ä‘Æ°á»£c sá»­ dá»¥ng khi cháº¡y mÃ¡y chá»§ tRPC cá»¥c bá»™
      - **router.ts** Ä‘á»‹nh nghÄ©a tRPC router vÃ  táº¥t cáº£ cÃ¡c thá»§ tá»¥c
    - project.json
    - ...
- eslint.config.mjs
- vitest.workspace.ts
</FileTree>

HÃ£y xem cÃ¡c tá»‡p chÃ­nh nÃ y:

```ts {5}
// packages/game-api/src/router.ts
import { echo } from './procedures/echo.js';
import { t } from './init.js';

export const router = t.router;

export const appRouter = router({
  echo,
});

export type AppRouter = typeof appRouter;
```
Router Ä‘á»‹nh nghÄ©a tRPC router cho API cá»§a báº¡n vÃ  lÃ  nÆ¡i báº¡n sáº½ khai bÃ¡o táº¥t cáº£ cÃ¡c phÆ°Æ¡ng thá»©c API cá»§a mÃ¬nh. NhÆ° báº¡n cÃ³ thá»ƒ tháº¥y á»Ÿ trÃªn, chÃºng ta cÃ³ má»™t phÆ°Æ¡ng thá»©c gá»i lÃ  `echo` vá»›i triá»ƒn khai cá»§a nÃ³ trong tá»‡p `./procedures/echo.ts`. Äiá»ƒm vÃ o Lambda handler náº±m trong `handler.ts`, Ä‘Æ°á»£c cáº¥u hÃ¬nh tá»± Ä‘á»™ng bá»Ÿi trÃ¬nh táº¡o.

```ts {2-5}
// packages/game-api/src/procedures/echo.ts
import { publicProcedure } from '../init.js';
import {
  EchoInputSchema,
  EchoOutputSchema,
} from '../schema/echo.js';

export const echo = publicProcedure
  .input(EchoInputSchema)
  .output(EchoOutputSchema)
  .query((opts) => ({ result: opts.input.message }));
```

Tá»‡p nÃ y lÃ  triá»ƒn khai cá»§a phÆ°Æ¡ng thá»©c `echo` vÃ  nhÆ° báº¡n cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c Ä‘á»‹nh kiá»ƒu máº¡nh báº±ng cÃ¡ch khai bÃ¡o cÃ¡c cáº¥u trÃºc dá»¯ liá»‡u Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra cá»§a nÃ³.

```ts
// packages/game-api/src/schema/echo.ts
import { z } from 'zod';

export const EchoInputSchema = z.object({
  message: z.string(),
});

export type IEchoInput = z.TypeOf<typeof EchoInputSchema>;

export const EchoOutputSchema = z.object({
  result: z.string(),
});

export type IEchoOutput = z.TypeOf<typeof EchoOutputSchema>;
```

Táº¥t cáº£ cÃ¡c Ä‘á»‹nh nghÄ©a schema tRPC Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a báº±ng [Zod](https://zod.dev/) vÃ  Ä‘Æ°á»£c xuáº¥t dÆ°á»›i dáº¡ng cÃ¡c kiá»ƒu typescript thÃ´ng qua cÃº phÃ¡p `z.TypeOf`.

```ts
// packages/common/constructs/src/app/apis/game-api.ts
import { Construct } from 'constructs';
import * as url from 'url';
import { Distribution } from 'aws-cdk-lib/aws-cloudfront';
import {
  Code,
  Runtime,
  Function,
  FunctionProps,
  Tracing,
} from 'aws-cdk-lib/aws-lambda';
import {
  AuthorizationType,
  Cors,
  LambdaIntegration,
  ResponseTransferMode,
} from 'aws-cdk-lib/aws-apigateway';
import { Duration } from 'aws-cdk-lib';
import {
  PolicyDocument,
  PolicyStatement,
  Effect,
  AnyPrincipal,
  IGrantable,
  Grant,
} from 'aws-cdk-lib/aws-iam';
import {
  IntegrationBuilder,
  RestApiIntegration,
} from '../../core/api/utils.js';
import { RestApi } from '../../core/api/rest-api.js';
import { Procedures, routerToOperations } from '../../core/api/trpc-utils.js';
import { AppRouter, appRouter } from ':dungeon-adventure/game-api';

// Kiá»ƒu union chuá»—i cho táº¥t cáº£ tÃªn hoáº¡t Ä‘á»™ng API
type Operations = Procedures<AppRouter>;

/**
 * Thuá»™c tÃ­nh Ä‘á»ƒ táº¡o má»™t construct GameApi
 *
 * @template TIntegrations - Ãnh xáº¡ tÃªn hoáº¡t Ä‘á»™ng vá»›i cÃ¡c tÃ­ch há»£p cá»§a chÃºng
 */
export interface GameApiProps<
  TIntegrations extends Record<Operations, RestApiIntegration>,
> {
  /**
   * Ãnh xáº¡ tÃªn hoáº¡t Ä‘á»™ng vá»›i cÃ¡c tÃ­ch há»£p API Gateway cá»§a chÃºng
   */
  integrations: TIntegrations;
}

/**
 * Má»™t CDK construct táº¡o vÃ  cáº¥u hÃ¬nh AWS API Gateway REST API
 * dÃ nh riÃªng cho GameApi.
 * @template TIntegrations - Ãnh xáº¡ tÃªn hoáº¡t Ä‘á»™ng vá»›i cÃ¡c tÃ­ch há»£p cá»§a chÃºng
 */
export class GameApi<
  TIntegrations extends Record<Operations, RestApiIntegration>,
> extends RestApi<Operations, TIntegrations> {
  /**
   * Táº¡o cÃ¡c tÃ­ch há»£p máº·c Ä‘á»‹nh cho táº¥t cáº£ cÃ¡c hoáº¡t Ä‘á»™ng, triá»ƒn khai má»—i hoáº¡t Ä‘á»™ng nhÆ°
   * má»™t hÃ m lambda riÃªng láº».
   *
   * @param scope - Pháº¡m vi construct CDK
   * @returns Má»™t IntegrationBuilder vá»›i cÃ¡c tÃ­ch há»£p lambda máº·c Ä‘á»‹nh
   */
  public static defaultIntegrations = (scope: Construct) => {
    return IntegrationBuilder.rest({
      operations: routerToOperations(appRouter),
      defaultIntegrationOptions: {
        runtime: Runtime.NODEJS_LATEST,
        handler: 'index.handler',
        code: Code.fromAsset(
          url.fileURLToPath(
            new URL(
              '../../../../../../dist/packages/game-api/bundle',
              import.meta.url,
            ),
          ),
        ),
        timeout: Duration.seconds(30),
        tracing: Tracing.ACTIVE,
        environment: {
          AWS_CONNECTION_REUSE_ENABLED: '1',
        },
      } satisfies FunctionProps,
      buildDefaultIntegration: (op, props: FunctionProps) => {
        const handler = new Function(scope, `GameApi${op}Handler`, props);
        return {
          handler,
          integration: new LambdaIntegration(handler, {
            responseTransferMode: ResponseTransferMode.STREAM,
          }),
        };
      },
    });
  };

  constructor(
    scope: Construct,
    id: string,
    props: GameApiProps<TIntegrations>,
  ) {
    super(scope, id, {
      apiName: 'GameApi',
      defaultMethodOptions: {
        authorizationType: AuthorizationType.IAM,
      },
      defaultCorsPreflightOptions: {
        allowOrigins: Cors.ALL_ORIGINS,
        allowMethods: Cors.ALL_METHODS,
      },
      deployOptions: {
        tracingEnabled: true,
      },
      policy: new PolicyDocument({
        statements: [
          // Má»Ÿ OPTIONS Ä‘á»ƒ cho phÃ©p trÃ¬nh duyá»‡t thá»±c hiá»‡n cÃ¡c yÃªu cáº§u preflight khÃ´ng xÃ¡c thá»±c
          new PolicyStatement({
            effect: Effect.ALLOW,
            principals: [new AnyPrincipal()],
            actions: ['execute-api:Invoke'],
            resources: ['execute-api:/*/OPTIONS/*'],
          }),
        ],
      }),
      operations: routerToOperations(appRouter),
      ...props,
    });
  }

  /**
   * Háº¡n cháº¿ CORS cho cÃ¡c domain CloudFront distribution cá»§a website
   *
   * Cáº¥u hÃ¬nh cÃ¡c domain CloudFront distribution lÃ  cÃ¡c CORS origin Ä‘Æ°á»£c phÃ©p duy nháº¥t
   * (ngoÃ i local host) trong cÃ¡c tÃ­ch há»£p AWS Lambda
   *
   * LÆ°u Ã½ ráº±ng háº¡n cháº¿ nÃ y khÃ´ng Ä‘Æ°á»£c Ã¡p dá»¥ng cho preflight OPTIONS
   *
   * @param websites - CloudFront distribution Ä‘á»ƒ cáº¥p CORS tá»«
   */
  public restrictCorsTo(
    ...websites: { cloudFrontDistribution: Distribution }[]
  ) {
    const allowedOrigins = websites
      .map(
        ({ cloudFrontDistribution }) =>
          `https://${cloudFrontDistribution.distributionDomainName}`,
      )
      .join(',');

    // Äáº·t biáº¿n mÃ´i trÆ°á»ng ALLOWED_ORIGINS cho táº¥t cáº£ cÃ¡c tÃ­ch há»£p Lambda
    Object.values(this.integrations).forEach((integration) => {
      if ('handler' in integration && integration.handler instanceof Function) {
        integration.handler.addEnvironment('ALLOWED_ORIGINS', allowedOrigins);
      }
    });
  }

  /**
   * Cáº¥p quyá»n IAM Ä‘á»ƒ gá»i báº¥t ká»³ phÆ°Æ¡ng thá»©c nÃ o trÃªn API nÃ y.
   *
   * @param grantee - IAM principal Ä‘á»ƒ cáº¥p quyá»n
   */
  public grantInvokeAccess(grantee: IGrantable) {
    // á» Ä‘Ã¢y chÃºng ta cáº¥p quyá»n cho grantee Ä‘á»ƒ gá»i api.
    // Truy cáº­p chi tiáº¿t mÃ¡y mÃ³c vá»›i mÃ¡y mÃ³c cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ Ä‘Ã¢y báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c principal cá»¥ thá»ƒ hÆ¡n (vÃ­ dá»¥: vai trÃ² hoáº·c
    // ngÆ°á»i dÃ¹ng) vÃ  tÃ i nguyÃªn (vÃ­ dá»¥: Ä‘Æ°á»ng dáº«n api nÃ o cÃ³ thá»ƒ Ä‘Æ°á»£c gá»i bá»Ÿi principal nÃ o) náº¿u cáº§n.
    this.api.addToResourcePolicy(
      new PolicyStatement({
        effect: Effect.ALLOW,
        principals: [grantee.grantPrincipal],
        actions: ['execute-api:Invoke'],
        resources: ['execute-api:/*'],
      }),
    );

    Grant.addToPrincipal({
      grantee,
      actions: ['execute-api:Invoke'],
      resourceArns: [this.api.arnForExecuteApi('*', '/*', '*')],
    });
  }
}
```

ÄÃ¢y lÃ  CDK construct Ä‘á»‹nh nghÄ©a `GameApi` cá»§a chÃºng ta. NÃ³ cung cáº¥p má»™t phÆ°Æ¡ng thá»©c `defaultIntegrations` tá»± Ä‘á»™ng táº¡o má»™t hÃ m Lambda cho má»—i thá»§ tá»¥c trong tRPC API cá»§a chÃºng ta, trá» Ä‘áº¿n triá»ƒn khai API Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  táº¡i thá»i Ä‘iá»ƒm `cdk synth`, viá»‡c Ä‘Ã³ng gÃ³i khÃ´ng xáº£y ra (trÃ¡i ngÆ°á»£c vá»›i viá»‡c sá»­ dá»¥ng [NodeJsFunction](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_lambda_nodejs.NodejsFunction.html)) vÃ¬ chÃºng ta Ä‘Ã£ Ä‘Ã³ng gÃ³i nÃ³ nhÆ° má»™t pháº§n cá»§a má»¥c tiÃªu build cá»§a dá»± Ã¡n backend.

</Drawer>

## Nhiá»‡m vá»¥ 3: Táº¡o cÃ¡c agent Story

BÃ¢y giá» hÃ£y táº¡o cÃ¡c Story Agent cá»§a chÃºng ta.

### Story agent: Dá»± Ã¡n Python

Äá»ƒ táº¡o má»™t dá»± Ã¡n Python:

<RunGenerator generator="py#project" requiredParameters={{name:"story"}} noInteractive />

Báº¡n sáº½ tháº¥y má»™t sá»‘ tá»‡p má»›i xuáº¥t hiá»‡n trong cÃ¢y tá»‡p cá»§a mÃ¬nh.
<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi py#project" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
`py#project` táº¡o cÃ¡c tá»‡p sau:

<FileTree>
- .venv/ mÃ´i trÆ°á»ng áº£o duy nháº¥t cho monorepo
- packages/
  - story/
    - dungeon_adventure_story/ module python
      - hello.py tá»‡p python vÃ­ dá»¥ (chÃºng ta sáº½ bá» qua Ä‘iá»u nÃ y)
    - tests/
    - .python-version
    - pyproject.toml
    - project.json
- .python-version phiÃªn báº£n python uv Ä‘Æ°á»£c cá»‘ Ä‘á»‹nh
- pyproject.toml
- uv.lock
</FileTree>

Äiá»u nÃ y Ä‘Ã£ cáº¥u hÃ¬nh má»™t dá»± Ã¡n Python vÃ  [UV Workspace](https://docs.astral.sh/uv/concepts/projects/workspaces/) vá»›i mÃ´i trÆ°á»ng áº£o Ä‘Æ°á»£c chia sáº».

</Drawer>

### Story agent: Strands Agent

Äá»ƒ thÃªm má»™t Strands agent vÃ o dá»± Ã¡n vá»›i trÃ¬nh táº¡o `py#strands-agent`:

<RunGenerator generator="py#strands-agent" requiredParameters={{project:"story"}} noInteractive />

Báº¡n sáº½ tháº¥y má»™t sá»‘ tá»‡p má»›i xuáº¥t hiá»‡n trong cÃ¢y tá»‡p cá»§a mÃ¬nh.
<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi py#strands-agent" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
TrÃ¬nh táº¡o `py#strands-agent` táº¡o cÃ¡c tá»‡p sau:

<FileTree>
- packages/
  - story/
    - dungeon_adventure_story/ module python
      - agent/
        - init.py thiáº¿t láº­p á»©ng dá»¥ng FastAPI vÃ  middleware
        - main.py Ä‘iá»ƒm vÃ o cho agent cá»§a báº¡n trong Bedrock AgentCore Runtime
        - agent.py Ä‘á»‹nh nghÄ©a má»™t agent vÃ  cÃ´ng cá»¥ vÃ­ dá»¥
        - agentcore_mcp_client.py tiá»‡n Ã­ch Ä‘á»ƒ táº¡o client Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c mÃ¡y chá»§ MCP
        - Dockerfile Ä‘á»‹nh nghÄ©a docker image Ä‘á»ƒ triá»ƒn khai lÃªn AgentCore Runtime
  - common/constructs/
    - src
      - app/agents/story-agent/
        - story-agent.ts construct Ä‘á»ƒ triá»ƒn khai Story agent cá»§a báº¡n lÃªn AgentCore Runtime
</FileTree>

HÃ£y xem xÃ©t má»™t sá»‘ tá»‡p chi tiáº¿t:

```python
# agent/agent.py
from contextlib import contextmanager

from strands import Agent, tool
from strands_tools import current_time


# Äá»‹nh nghÄ©a má»™t cÃ´ng cá»¥ tÃ¹y chá»‰nh
@tool
def add(a: int, b: int) -> int:
    return a + b


@contextmanager
def get_agent(session_id: str):
    yield Agent(
        system_prompt="""
You are an addition wizard.
Use the 'add' tool for addition tasks.
Refer to tools as your 'spellbook'.
""",
        tools=[add, current_time],
    )
```

Äiá»u nÃ y táº¡o má»™t Strands agent vÃ­ dá»¥ vÃ  Ä‘á»‹nh nghÄ©a má»™t cÃ´ng cá»¥ cá»™ng.

```python
# agent/main.py
import uvicorn
from bedrock_agentcore.runtime.models import PingStatus
from pydantic import BaseModel

from .agent import get_agent
from .init import JsonStreamingResponse, app


class InvokeInput(BaseModel):
    prompt: str
    session_id: str


class StreamChunk(BaseModel):
    content: str


async def handle_invoke(input: InvokeInput):
    """Streaming handler cho viá»‡c gá»i agent"""
    with get_agent(session_id=input.session_id) as agent:
        stream = agent.stream_async(input.prompt)
        async for event in stream:
            print(event)
            text = event.get("event", {}).get("contentBlockDelta", {}).get("delta", {}).get("text")
            if text is not None:
                yield StreamChunk(content=text)
            elif event.get("event", {}).get("messageStop") is not None:
                yield StreamChunk(content="\n")


@app.post(
    "/invocations",
    response_class=JsonStreamingResponse,
    responses={200: JsonStreamingResponse.openapi_response(StreamChunk, "Stream of agent response chunks")},
)
async def invoke(input: InvokeInput) -> JsonStreamingResponse:
    """Äiá»ƒm vÃ o cho viá»‡c gá»i agent"""
    return JsonStreamingResponse(handle_invoke(input))


@app.get("/ping")
def ping() -> str:
    # TODO: if running an async task, return PingStatus.HEALTHY_BUSY
    return PingStatus.HEALTHY


if __name__ == "__main__":
    uvicorn.run("dungeon_adventure_story.agent.main:app", port=8080)
```

ÄÃ¢y lÃ  Ä‘iá»ƒm vÃ o cho agent, Ä‘Æ°á»£c cáº¥u hÃ¬nh dÆ°á»›i dáº¡ng á»©ng dá»¥ng FastAPI tÆ°Æ¡ng thÃ­ch vá»›i [Amazon Bedrock AgentCore Runtime](https://github.com/aws/bedrock-agentcore-sdk-python). NÃ³ sá»­ dá»¥ng há»— trá»£ streaming cá»§a Strands vÃ  truyá»n cÃ¡c sá»± kiá»‡n trá»Ÿ láº¡i client khi chÃºng xáº£y ra qua JSON Lines.

```ts
// common/constructs/src/app/agents/story-agent.ts
import { Lazy, Names } from 'aws-cdk-lib';
import { Platform } from 'aws-cdk-lib/aws-ecr-assets';
import { Construct } from 'constructs';
import { execSync } from 'child_process';
import * as path from 'path';
import * as url from 'url';
import {
  AgentRuntimeArtifact,
  ProtocolType,
  Runtime,
  RuntimeProps,
} from '@aws-cdk/aws-bedrock-agentcore-alpha';

export type StoryAgentProps = Omit<
  RuntimeProps,
  'runtimeName' | 'protocolConfiguration' | 'agentRuntimeArtifact'
>;

export class StoryAgent extends Construct {
  public readonly dockerImage: AgentRuntimeArtifact;
  public readonly agentCoreRuntime: Runtime;

  constructor(scope: Construct, id: string, props?: StoryAgentProps) {
    super(scope, id);

    this.dockerImage = AgentRuntimeArtifact.fromAsset(
      path.dirname(url.fileURLToPath(new URL(import.meta.url))),
      {
        platform: Platform.LINUX_ARM64,
        extraHash: execSync(
          `docker inspect dungeon-adventure-story-agent:latest --format '{{.Id}}'`,
          { encoding: 'utf-8' },
        ).trim(),
      },
    );

    this.agentCoreRuntime = new Runtime(this, 'StoryAgent', {
      runtimeName: Lazy.string({
        produce: () =>
          Names.uniqueResourceName(this.agentCoreRuntime, { maxLength: 40 }),
      }),
      protocolConfiguration: ProtocolType.HTTP,
      agentRuntimeArtifact: this.dockerImage,
      ...props,
    });
  }
}
```

Äiá»u nÃ y cáº¥u hÃ¬nh má»™t CDK `AgentRuntimeArtifact` táº£i image Docker agent cá»§a báº¡n lÃªn ECR vÃ  lÆ°u trá»¯ nÃ³ báº±ng AgentCore Runtime.

Báº¡n cÃ³ thá»ƒ nháº­n tháº¥y má»™t `Dockerfile` bá»• sung, tham chiáº¿u Ä‘áº¿n Docker image tá»« dá»± Ã¡n `story`, cho phÃ©p chÃºng ta Ä‘áº·t cÃ¹ng vá»‹ trÃ­ Dockerfile vÃ  mÃ£ nguá»“n agent.

</Drawer>

## Nhiá»‡m vá»¥ 4: Thiáº¿t láº­p cÃ´ng cá»¥ inventory

### Inventory: Dá»± Ã¡n TypeScript

HÃ£y táº¡o má»™t mÃ¡y chá»§ MCP Ä‘á»ƒ cung cáº¥p cÃ´ng cá»¥ cho Story Agent cá»§a chÃºng ta Ä‘á»ƒ quáº£n lÃ½ kho Ä‘á»“ cá»§a ngÆ°á»i chÆ¡i.

Äáº§u tiÃªn, chÃºng ta táº¡o má»™t dá»± Ã¡n TypeScript:

<RunGenerator generator="ts#project" requiredParameters={{name:"inventory"}} noInteractive />

Äiá»u nÃ y sáº½ táº¡o má»™t dá»± Ã¡n TypeScript trá»‘ng.

<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi ts#project" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
TrÃ¬nh táº¡o `ts#project` táº¡o cÃ¡c tá»‡p nÃ y.

<FileTree>
- packages/
  - inventory/
    - src/
      - index.ts Ä‘iá»ƒm vÃ o vá»›i hÃ m vÃ­ dá»¥
    - project.json cáº¥u hÃ¬nh dá»± Ã¡n
    - eslint.config.mjs cáº¥u hÃ¬nh lint
    - vite.config.mts cáº¥u hÃ¬nh test
    - tsconfig.json cáº¥u hÃ¬nh typescript cÆ¡ sá»Ÿ cho dá»± Ã¡n
    - tsconfig.lib.json cáº¥u hÃ¬nh typescript cho dá»± Ã¡n Ä‘Æ°á»£c nháº¯m má»¥c tiÃªu Ä‘á»ƒ biÃªn dá»‹ch vÃ  Ä‘Ã³ng gÃ³i
    - tsconfig.spec.json cáº¥u hÃ¬nh typescript cho cÃ¡c bÃ i test
- tsconfig.base.json Ä‘Æ°á»£c cáº­p nháº­t Ä‘á»ƒ cáº¥u hÃ¬nh má»™t bÃ­ danh cho cÃ¡c dá»± Ã¡n khÃ¡c tham chiáº¿u Ä‘áº¿n dá»± Ã¡n nÃ y
</FileTree>

</Drawer>

### Inventory: MÃ¡y chá»§ MCP

Tiáº¿p theo, chÃºng ta sáº½ thÃªm má»™t mÃ¡y chá»§ MCP vÃ o dá»± Ã¡n TypeScript cá»§a mÃ¬nh:

<RunGenerator generator="ts#mcp-server" requiredParameters={{project:"inventory"}} noInteractive />

Äiá»u nÃ y sáº½ thÃªm má»™t mÃ¡y chá»§ MCP.
<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi ts#mcp-server" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
TrÃ¬nh táº¡o `ts#mcp-server` táº¡o cÃ¡c tá»‡p nÃ y.

<FileTree>
- packages/
  - inventory/
    - src/mcp-server/
      - index.ts barrel export
      - server.ts táº¡o mÃ¡y chá»§ MCP
      - tools/
        - add.ts cÃ´ng cá»¥ vÃ­ dá»¥
      - resources/
        - sample-guidance.ts tÃ i nguyÃªn vÃ­ dá»¥
      - stdio.ts Ä‘iá»ƒm vÃ o cho MCP vá»›i STDIO transport
      - http.ts Ä‘iá»ƒm vÃ o cho MCP vá»›i Streamable HTTP transport
      - Dockerfile xÃ¢y dá»±ng image cho AgentCore Runtime
    - rolldown.config.ts cáº¥u hÃ¬nh Ä‘á»ƒ Ä‘Ã³ng gÃ³i mÃ¡y chá»§ MCP Ä‘á»ƒ triá»ƒn khai lÃªn AgentCore
  - common/constructs/
    - src
      - app/mcp-servers/inventory-mcp-server/
        - inventory-mcp-server.ts construct Ä‘á»ƒ triá»ƒn khai mÃ¡y chá»§ MCP inventory cá»§a báº¡n lÃªn AgentCore Runtime
</FileTree>

</Drawer>

## Nhiá»‡m vá»¥ 5: Táº¡o Giao diá»‡n NgÆ°á»i dÃ¹ng (UI)

Trong nhiá»‡m vá»¥ nÃ y, chÃºng ta sáº½ táº¡o UI cho phÃ©p báº¡n tÆ°Æ¡ng tÃ¡c vá»›i trÃ² chÆ¡i.

### Game UI: Website

Äá»ƒ táº¡o UI, táº¡o má»™t website cÃ³ tÃªn `GameUI` báº±ng cÃ¡c bÆ°á»›c sau:

<RunGenerator generator="ts#react-website" requiredParameters={{name:"GameUI"}} noInteractive />

Báº¡n sáº½ tháº¥y má»™t sá»‘ tá»‡p má»›i xuáº¥t hiá»‡n trong cÃ¢y tá»‡p cá»§a mÃ¬nh.

<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi ts#react-website" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
`ts#react-website` táº¡o cÃ¡c tá»‡p nÃ y. HÃ£y xem xÃ©t má»™t sá»‘ tá»‡p chÃ­nh Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u trong cÃ¢y tá»‡p:

<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - app/ cÃ¡c cdk construct cá»¥ thá»ƒ cho á»©ng dá»¥ng
          - static-websites/
            - **game-ui.ts** cdk construct Ä‘á»ƒ táº¡o Game UI cá»§a báº¡n
        - core/
          - static-website.ts construct website tÄ©nh chung
  - game-ui/
    - public/
    - src/
      - components/
        - AppLayout/
          - index.tsx bá»‘ cá»¥c trang tá»•ng thá»ƒ: header, footer, sidebar, v.v.
      - hooks/
        - useAppLayout.tsx cho phÃ©p báº¡n Ä‘áº·t Ä‘á»™ng cÃ¡c thá»© nhÆ° thÃ´ng bÃ¡o, kiá»ƒu trang, v.v.
      - routes/ cÃ¡c tuyáº¿n Ä‘Æ°á»ng dá»±a trÃªn tá»‡p cá»§a @tanstack/react-router
        - **index.tsx** trang gá»‘c '/'
        - __root.tsx táº¥t cáº£ cÃ¡c trang sá»­ dá»¥ng component nÃ y lÃ m cÆ¡ sá»Ÿ
      - config.ts
      - **main.tsx** Ä‘iá»ƒm vÃ o React
      - routeTree.gen.ts tá»‡p nÃ y Ä‘Æ°á»£c cáº­p nháº­t tá»± Ä‘á»™ng bá»Ÿi @tanstack/react-router
      - styles.css
    - index.html
    - project.json
    - vite.config.mts
    - ...
</FileTree>

```ts
// packages/common/constructs/src/app/static-websites/game-ui.ts
import * as url from 'url';
import { Construct } from 'constructs';
import { StaticWebsite } from '../../core/index.js';

export class GameUI extends StaticWebsite {
  constructor(scope: Construct, id: string) {
    super(scope, id, {
      websiteName: 'GameUI',
      websiteFilePath: url.fileURLToPath(
        new URL(
          '../../../../../../dist/packages/game-ui/bundle',
          import.meta.url,
        ),
      ),
    });
  }
}
```

ÄÃ¢y lÃ  CDK construct Ä‘á»‹nh nghÄ©a GameUI cá»§a chÃºng ta. NÃ³ Ä‘Ã£ cáº¥u hÃ¬nh Ä‘Æ°á»ng dáº«n tá»‡p Ä‘áº¿n gÃ³i Ä‘Æ°á»£c táº¡o cho UI dá»±a trÃªn Vite cá»§a chÃºng ta. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  táº¡i thá»i Ä‘iá»ƒm `build`, viá»‡c Ä‘Ã³ng gÃ³i xáº£y ra trong má»¥c tiÃªu build cá»§a dá»± Ã¡n game-ui vÃ  Ä‘áº§u ra Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ Ä‘Ã¢y.

```tsx
// packages/game-ui/src/main.tsx
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import '@cloudscape-design/global-styles/index.css';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';

// eslint-disable-next-line @typescript-eslint/no-empty-object-type
export type RouterProviderContext = {};

const router = createRouter({
  routeTree,
  context: {},
});

// ÄÄƒng kÃ½ instance router Ä‘á»ƒ Ä‘áº£m báº£o kiá»ƒu an toÃ n
declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}

const App = () => {
  return <RouterProvider router={router} context={{}} />;
};

const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
        <App />
      </I18nProvider>
    </React.StrictMode>,
  );
```

ÄÃ¢y lÃ  Ä‘iá»ƒm vÃ o nÆ¡i React Ä‘Æ°á»£c gáº¯n káº¿t. NhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹, ban Ä‘áº§u nÃ³ chá»‰ cáº¥u hÃ¬nh má»™t `@tanstack/react-router` trong cáº¥u hÃ¬nh [`file-based-routing`](https://tanstack.com/router/v1/docs/framework/react/routing/file-based-routing). Miá»…n lÃ  mÃ¡y chá»§ phÃ¡t triá»ƒn cá»§a báº¡n Ä‘ang cháº¡y, báº¡n cÃ³ thá»ƒ táº¡o cÃ¡c tá»‡p trong thÆ° má»¥c `routes` vÃ  `@tanstack/react-router` sáº½ táº¡o thiáº¿t láº­p tá»‡p boilerplate cho báº¡n, cÃ¹ng vá»›i viá»‡c cáº­p nháº­t tá»‡p `routeTree.gen.ts`. Tá»‡p nÃ y duy trÃ¬ táº¥t cáº£ cÃ¡c tuyáº¿n Ä‘Æ°á»ng má»™t cÃ¡ch an toÃ n vá» kiá»ƒu, cÃ³ nghÄ©a lÃ  khi báº¡n sá»­ dá»¥ng `<Link>`, tÃ¹y chá»n `to` sáº½ chá»‰ hiá»ƒn thá»‹ cÃ¡c tuyáº¿n Ä‘Æ°á»ng há»£p lá»‡.
Äá»ƒ biáº¿t thÃªm thÃ´ng tin, hÃ£y tham kháº£o [tÃ i liá»‡u `@tanstack/react-router`](https://tanstack.com/router/v1/docs/framework/react/quick-start).

```tsx
// packages/game-ui/src/routes/index.tsx
import {
  ContentLayout,
  Header,
  SpaceBetween,
  Container,
} from '@cloudscape-design/components';
import { createFileRoute } from '@tanstack/react-router';

export const Route = createFileRoute('/')({
  component: RouteComponent,
});

function RouteComponent() {
  return (
    <ContentLayout header={<Header>Welcome</Header>}>
      <SpaceBetween size="l">
        <Container>Welcome to your new React website!</Container>
      </SpaceBetween>
    </ContentLayout>
  );
}
```

Má»™t component sáº½ Ä‘Æ°á»£c render khi Ä‘iá»u hÆ°á»›ng Ä‘áº¿n tuyáº¿n Ä‘Æ°á»ng `/`. `@tanstack/react-router` sáº½ quáº£n lÃ½ `Route` cho báº¡n báº¥t cá»© khi nÃ o báº¡n táº¡o/di chuyá»ƒn tá»‡p nÃ y (miá»…n lÃ  mÃ¡y chá»§ dev Ä‘ang cháº¡y).

</Drawer>

### Game UI: Auth

HÃ£y cáº¥u hÃ¬nh Game UI cá»§a chÃºng ta Ä‘á»ƒ yÃªu cáº§u truy cáº­p Ä‘Æ°á»£c xÃ¡c thá»±c qua Amazon Cognito báº±ng cÃ¡c bÆ°á»›c sau:

<RunGenerator generator="ts#react-website#auth" requiredParameters={{cognitoDomain:"game-ui", project:"@dungeon-adventure/game-ui", allowSignup:true}} noInteractive />

Báº¡n sáº½ tháº¥y má»™t sá»‘ tá»‡p má»›i xuáº¥t hiá»‡n/thay Ä‘á»•i trong cÃ¢y tá»‡p cá»§a mÃ¬nh.

<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi ts#react-website#auth" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
TrÃ¬nh táº¡o `ts#react-website#auth` cáº­p nháº­t/táº¡o cÃ¡c tá»‡p nÃ y. HÃ£y xem xÃ©t má»™t sá»‘ tá»‡p chÃ­nh Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u trong cÃ¢y tá»‡p:

<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - core/
          - user-identity.ts cdk construct Ä‘á»ƒ táº¡o user/identity pools
  - game-ui/
    - src/
      - components/
        - AppLayout/
          - index.tsx thÃªm ngÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p/Ä‘Äƒng xuáº¥t vÃ o header
        - CognitoAuth/
          - index.tsx quáº£n lÃ½ Ä‘Äƒng nháº­p vÃ o Cognito
        - RuntimeConfig/
          - index.tsx láº¥y `runtime-config.json` vÃ  cung cáº¥p cho cÃ¡c children qua context
      - hooks/
        - useRuntimeConfig.tsx
      - **main.tsx** ÄÆ°á»£c cáº­p nháº­t Ä‘á»ƒ thÃªm Cognito
</FileTree>

```diff lang="tsx"
// packages/game-ui/src/main.tsx
+import { useAuth } from 'react-oidc-context';
+import CognitoAuth from './components/CognitoAuth';
+import { useRuntimeConfig } from './hooks/useRuntimeConfig';
+import RuntimeConfigProvider from './components/RuntimeConfig';
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import '@cloudscape-design/global-styles/index.css';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';
// eslint-disable-next-line @typescript-eslint/no-empty-object-type
-export type RouterProviderContext = {};
+export type RouterProviderContext = {
+  runtimeConfig?: ReturnType<typeof useRuntimeConfig>;
+  auth?: ReturnType<typeof useAuth>;
+};
-const router = createRouter({
-  routeTree,
-  context: {},
-});
+const router = createRouter({
+  routeTree,
+  context: {
+    runtimeConfig: undefined,
+    auth: undefined,
+  },
+});
// ÄÄƒng kÃ½ instance router Ä‘á»ƒ Ä‘áº£m báº£o kiá»ƒu an toÃ n
declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}
-const App = () => {
-  return <RouterProvider router={router} context={{}} />;
-};
+const App = () => {
+  const auth = useAuth();
+  const runtimeConfig = useRuntimeConfig();
+  return <RouterProvider router={router} context={{ runtimeConfig, auth }} />;
+};
const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
+        <RuntimeConfigProvider>
+          <CognitoAuth>
            <App />
+          </CognitoAuth>
+        </RuntimeConfigProvider>
      </I18nProvider>
    </React.StrictMode>,
  );
```

CÃ¡c component `RuntimeConfigProvider` vÃ  `CognitoAuth` Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o tá»‡p `main.tsx` thÃ´ng qua má»™t biáº¿n Ä‘á»•i AST. Äiá»u nÃ y cho phÃ©p component `CognitoAuth` xÃ¡c thá»±c vá»›i Amazon Cognito báº±ng cÃ¡ch láº¥y `runtime-config.json` chá»©a cáº¥u hÃ¬nh káº¿t ná»‘i cognito cáº§n thiáº¿t Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c cuá»™c gá»i backend Ä‘áº¿n Ä‘Ã­ch chÃ­nh xÃ¡c.

</Drawer>

### Game UI: Káº¿t ná»‘i vá»›i Game API

HÃ£y cáº¥u hÃ¬nh Game UI cá»§a chÃºng ta Ä‘á»ƒ káº¿t ná»‘i vá»›i Game API Ä‘Ã£ táº¡o trÆ°á»›c Ä‘Ã³.

<RunGenerator generator="connection" requiredParameters={{sourceProject:"@dungeon-adventure/game-ui", targetProject:"@dungeon-adventure/game-api"}} noInteractive />

Báº¡n sáº½ tháº¥y má»™t sá»‘ tá»‡p má»›i xuáº¥t hiá»‡n/thay Ä‘á»•i trong cÃ¢y tá»‡p cá»§a mÃ¬nh.

<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi connection tá»« UI -> tRPC" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
TrÃ¬nh táº¡o `connection` táº¡o/cáº­p nháº­t cÃ¡c tá»‡p nÃ y. HÃ£y xem xÃ©t má»™t sá»‘ tá»‡p chÃ­nh Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u trong cÃ¢y tá»‡p:

<FileTree>
- packages/
  - game-ui/
    - src/
      - components/
        - GameApiClientProvider.tsx thiáº¿t láº­p client GameAPI
      - hooks/
        - **useGameApi.tsx** hooks Ä‘á»ƒ gá»i GameApi
      - **main.tsx** chÃ¨n cÃ¡c provider client trpc
- package.json

</FileTree>

```tsx
// packages/game-ui/src/hooks/useGameApi.tsx
import { useContext } from 'react';
import { GameApiTRPCContext } from '../components/GameApiClientProvider';

export const useGameApi = () => {
  const container = useContext(GameApiTRPCContext);
  if (!container) {
    throw new Error('useGameApi must be used within GameApiClientProvider');
  }
  return container.optionsProxy;
};

export const useGameApiClient = () => {
  const container = useContext(GameApiTRPCContext);
  if (!container) {
    throw new Error(
      'useGameApiClient must be used within GameApiClientProvider',
    );
  }
  return container.client;
};
```

Hook nÃ y cung cáº¥p quyá»n truy cáº­p vÃ o tRPC client Ä‘á»ƒ gá»i GameApi. Äá»ƒ xem vÃ­ dá»¥ vá» cÃ¡ch gá»i tRPC API, hÃ£y tham kháº£o <Link path="guides/connection/react-trpc#using-the-generated-code">hÆ°á»›ng dáº«n sá»­ dá»¥ng tRPC hook</Link>.

<Aside>
Hook `useGameApi` khÃ¡c vá»›i hook `useStoryApi` vÃ¬ nÃ³ khÃ´ng yÃªu cáº§u build Ä‘á»ƒ cÃ¡c thay Ä‘á»•i Ä‘Æ°á»£c pháº£n Ã¡nh nhá» vÃ o viá»‡c sá»­ dá»¥ng [suy luáº­n Typescript](https://trpc.io/docs/concepts) cá»§a tRPC. Äiá»u nÃ y cho phÃ©p cÃ¡c nhÃ  phÃ¡t triá»ƒn thá»±c hiá»‡n thay Ä‘á»•i Ä‘á»‘i vá»›i backend cá»§a há» vÃ  ngay láº­p tá»©c Ä‘Æ°á»£c pháº£n Ã¡nh trong frontend cá»§a há».
</Aside>

```diff lang="tsx"
// packages/game-ui/src/main.tsx
+import GameApiClientProvider from './components/GameApiClientProvider';
+import QueryClientProvider from './components/QueryClientProvider';
import { useAuth } from 'react-oidc-context';
import CognitoAuth from './components/CognitoAuth';
import { useRuntimeConfig } from './hooks/useRuntimeConfig';
import RuntimeConfigProvider from './components/RuntimeConfig';
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import '@cloudscape-design/global-styles/index.css';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';
...
const App = () => {
  const auth = useAuth();
  const runtimeConfig = useRuntimeConfig();
  return <RouterProvider router={router} context={{ runtimeConfig, auth }} />;
};
const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
        <RuntimeConfigProvider>
          <CognitoAuth>
+            <QueryClientProvider>
+              <GameApiClientProvider>
                <App />
+              </GameApiClientProvider>
+            </QueryClientProvider>
          </CognitoAuth>
        </RuntimeConfigProvider>
      </I18nProvider>
    </React.StrictMode>,
  );
```

Tá»‡p `main.tsx` Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t thÃ´ng qua má»™t biáº¿n Ä‘á»•i AST Ä‘á»ƒ chÃ¨n cÃ¡c provider tRPC.

</Drawer>

### Game UI: CÆ¡ sá»Ÿ háº¡ táº§ng

HÃ£y táº¡o dá»± Ã¡n con cuá»‘i cÃ¹ng cho cÆ¡ sá»Ÿ háº¡ táº§ng CDK.

<RunGenerator generator="ts#infra" requiredParameters={{name:"infra"}} noInteractive />

Báº¡n sáº½ tháº¥y má»™t sá»‘ tá»‡p má»›i xuáº¥t hiá»‡n/thay Ä‘á»•i trong cÃ¢y tá»‡p cá»§a mÃ¬nh.

<Drawer title="CÃ¡c tá»‡p Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi ts#infra" trigger="Nháº¥p vÃ o Ä‘Ã¢y Ä‘á»ƒ xem xÃ©t cÃ¡c tá»‡p nÃ y chi tiáº¿t hÆ¡n.">
TrÃ¬nh táº¡o `ts#infra` táº¡o/cáº­p nháº­t cÃ¡c tá»‡p nÃ y. HÃ£y xem xÃ©t má»™t sá»‘ tá»‡p chÃ­nh Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u trong cÃ¢y tá»‡p:

<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - core/
          - checkov.ts
          - index.ts
  - infra
    - src/
      - stages/
        - **application-stage.ts** cÃ¡c cdk stack Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ Ä‘Ã¢y
      - stacks/
        - **application-stack.ts** cÃ¡c tÃ i nguyÃªn cdk Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ Ä‘Ã¢y
      - **main.ts** Ä‘iá»ƒm vÃ o Ä‘á»‹nh nghÄ©a táº¥t cáº£ cÃ¡c stage
    - cdk.json
    - checkov.yml
    - project.json
    - ...
  - package.json
  - tsconfig.json thÃªm references
  - tsconfig.base.json thÃªm alias

</FileTree>

```ts
// packages/infra/src/main.ts
import { ApplicationStage } from './stages/application-stage.js';
import { App } from ':dungeon-adventure/common-constructs';

const app = new App();

// Sá»­ dá»¥ng cÃ¡i nÃ y Ä‘á»ƒ triá»ƒn khai mÃ´i trÆ°á»ng sandbox cá»§a riÃªng báº¡n (giáº£ Ä‘á»‹nh thÃ´ng tin xÃ¡c thá»±c CLI cá»§a báº¡n)
new ApplicationStage(app, 'dungeon-adventure-infra-sandbox', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  },
});

app.synth();
```

<Aside type="tip">Náº¿u báº¡n tháº¥y lá»—i import trong IDE cá»§a mÃ¬nh, Ä‘iá»u nÃ y lÃ  do dá»± Ã¡n cÆ¡ sá»Ÿ háº¡ táº§ng cá»§a chÃºng ta chÆ°a cÃ³ tham chiáº¿u typescript Ä‘Æ°á»£c thiáº¿t láº­p trong `tsconfig.json`. Nx Ä‘Ã£ Ä‘Æ°á»£c [cáº¥u hÃ¬nh](https://nx.dev/nx-api/js/generators/typescript-sync) Ä‘á»ƒ táº¡o cÃ¡c tham chiáº¿u nÃ y *Ä‘á»™ng* báº¥t cá»© khi nÃ o má»™t build/compile Ä‘Æ°á»£c cháº¡y hoáº·c náº¿u báº¡n cháº¡y lá»‡nh `nx sync` thá»§ cÃ´ng. Äá»ƒ biáº¿t thÃªm thÃ´ng tin, hÃ£y tham kháº£o <Link path="guides/typescript-project#importing-your-library-code-in-other-projects">hÆ°á»›ng dáº«n Typescript</Link>.</Aside>

ÄÃ¢y lÃ  Ä‘iá»ƒm vÃ o cho á»©ng dá»¥ng CDK cá»§a báº¡n.

```ts
// packages/infra/src/stacks/application-stack.ts
import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';

export class ApplicationStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // MÃ£ Ä‘á»‹nh nghÄ©a stack cá»§a báº¡n á»Ÿ Ä‘Ã¢y
  }
}
```

HÃ£y khá»Ÿi táº¡o cÃ¡c CDK construct cá»§a chÃºng ta Ä‘á»ƒ xÃ¢y dá»±ng trÃ² chÆ¡i phiÃªu lÆ°u háº§m ngá»¥c.

</Drawer>

## Nhiá»‡m vá»¥ 6: Cáº­p nháº­t cÆ¡ sá»Ÿ háº¡ táº§ng cá»§a chÃºng ta

HÃ£y cáº­p nháº­t `packages/infra/src/stacks/application-stack.ts` Ä‘á»ƒ khá»Ÿi táº¡o má»™t sá»‘ construct Ä‘Ã£ táº¡o cá»§a chÃºng ta:

<E2EDiff before="dungeon-adventure/1/application-stack.ts.original.template" after="dungeon-adventure/1/application-stack.ts.template" lang="ts" />

:::note
ChÃºng ta cung cáº¥p cÃ¡c tÃ­ch há»£p máº·c Ä‘á»‹nh cho Game API cá»§a chÃºng ta. Theo máº·c Ä‘á»‹nh, má»—i hoáº¡t Ä‘á»™ng trong API cá»§a chÃºng ta Ä‘Æ°á»£c Ã¡nh xáº¡ tá»›i má»™t hÃ m Lambda riÃªng láº» Ä‘á»ƒ xá»­ lÃ½ hoáº¡t Ä‘á»™ng Ä‘Ã³.
:::

## Nhiá»‡m vá»¥ 7: Build mÃ£

<Drawer title="CÃ¡c lá»‡nh Nx" trigger="BÃ¢y giá» Ä‘Ã£ Ä‘áº¿n lÃºc chÃºng ta build mÃ£ láº§n Ä‘áº§u tiÃªn">

###### Má»¥c tiÃªu Ä‘Æ¡n láº» vs nhiá»u má»¥c tiÃªu

Lá»‡nh `run-many` sáº½ cháº¡y má»™t má»¥c tiÃªu trÃªn nhiá»u dá»± Ã¡n con Ä‘Æ°á»£c liá»‡t kÃª (`--all` sáº½ nháº¯m má»¥c tiÃªu táº¥t cáº£). Äiá»u nÃ y Ä‘áº£m báº£o cÃ¡c phá»¥ thuá»™c Ä‘Æ°á»£c thá»±c thi theo Ä‘Ãºng thá»© tá»±.

Báº¡n cÅ©ng cÃ³ thá»ƒ kÃ­ch hoáº¡t má»™t build (hoáº·c báº¥t ká»³ tÃ¡c vá»¥ nÃ o khÃ¡c) cho má»™t má»¥c tiÃªu dá»± Ã¡n Ä‘Æ¡n láº» báº±ng cÃ¡ch cháº¡y má»¥c tiÃªu trá»±c tiáº¿p trÃªn dá»± Ã¡n. VÃ­ dá»¥: Ä‘á»ƒ build dá»± Ã¡n `@dungeon-adventure/infra`, cháº¡y lá»‡nh sau:

<NxCommands commands={['run @dungeon-adventure/infra:build']} />

Báº¡n cÅ©ng cÃ³ thá»ƒ bá» qua scope vÃ  sá»­ dá»¥ng cÃº phÃ¡p viáº¿t táº¯t cá»§a Nx náº¿u muá»‘n:

<NxCommands commands={['build infra']} />

###### Trá»±c quan hÃ³a cÃ¡c phá»¥ thuá»™c cá»§a báº¡n

Äá»ƒ trá»±c quan hÃ³a cÃ¡c phá»¥ thuá»™c cá»§a báº¡n, cháº¡y:

<NxCommands commands={['graph']} />
<br/>

<Image src={nxGraphPng} alt="nx-graph.png" width="800" height="600" />

###### Caching

Nx dá»±a vÃ o [caching](https://nx.dev/concepts/how-caching-works) Ä‘á»ƒ báº¡n cÃ³ thá»ƒ tÃ¡i sá»­ dá»¥ng cÃ¡c artifact tá»« cÃ¡c build trÆ°á»›c Ä‘Ã³ nháº±m tÄƒng tá»‘c Ä‘á»™ phÃ¡t triá»ƒn. CÃ³ má»™t sá»‘ cáº¥u hÃ¬nh cáº§n thiáº¿t Ä‘á»ƒ Ä‘iá»u nÃ y hoáº¡t Ä‘á»™ng chÃ­nh xÃ¡c vÃ  cÃ³ thá»ƒ cÃ³ nhá»¯ng trÆ°á»ng há»£p báº¡n muá»‘n thá»±c hiá»‡n build **mÃ  khÃ´ng sá»­ dá»¥ng cache**. Äá»ƒ lÃ m Ä‘iá»u Ä‘Ã³, chá»‰ cáº§n thÃªm Ä‘á»‘i sá»‘ `--skip-nx-cache` vÃ o lá»‡nh cá»§a báº¡n. VÃ­ dá»¥:

<NxCommands commands={['run @dungeon-adventure/infra:build --skip-nx-cache']} />
Náº¿u vÃ¬ báº¥t ká»³ lÃ½ do gÃ¬ báº¡n muá»‘n xÃ³a cache cá»§a mÃ¬nh (Ä‘Æ°á»£c lÆ°u trá»¯ trong thÆ° má»¥c `.nx`), báº¡n cÃ³ thá»ƒ cháº¡y lá»‡nh sau:

<NxCommands commands={['reset']} />

</Drawer>

Sá»­ dá»¥ng dÃ²ng lá»‡nh, cháº¡y lá»‡nh sau Ä‘á»ƒ sá»­a cÃ¡c lá»—i lint trÆ°á»›c:

<PackageManagerShortCommand commands={["lint"]} />

Sau Ä‘Ã³, cháº¡y lá»‡nh sau Ä‘á»ƒ thá»±c hiá»‡n build Ä‘áº§y Ä‘á»§:

<PackageManagerShortCommand commands={["build"]} />

Báº¡n sáº½ Ä‘Æ°á»£c nháº¯c vá»›i thÃ´ng bÃ¡o sau:

```bash
 NX   The workspace is out of sync

[@nx/js:typescript-sync]: Some TypeScript configuration files are missing project references to the projects they depend on or contain outdated project references.

This will result in an error in CI.

? Would you like to sync the identified changes to get your workspace up to date? â€¦
Yes, sync the changes and run the tasks
No, run the tasks without syncing the changes
```

ThÃ´ng bÃ¡o nÃ y cho biáº¿t ráº±ng NX Ä‘Ã£ phÃ¡t hiá»‡n má»™t sá»‘ tá»‡p cÃ³ thá»ƒ Ä‘Æ°á»£c cáº­p nháº­t tá»± Ä‘á»™ng cho báº¡n. Trong trÆ°á»ng há»£p nÃ y, nÃ³ Ä‘á» cáº­p Ä‘áº¿n cÃ¡c tá»‡p `tsconfig.json` khÃ´ng cÃ³ tham chiáº¿u Typescript Ä‘Æ°á»£c thiáº¿t láº­p trÃªn cÃ¡c dá»± Ã¡n tham chiáº¿u.

Chá»n tÃ¹y chá»n **Yes, sync the changes and run the tasks** Ä‘á»ƒ tiáº¿p tá»¥c. Báº¡n sáº½ nháº­n tháº¥y táº¥t cáº£ cÃ¡c lá»—i import liÃªn quan Ä‘áº¿n IDE cá»§a báº¡n Ä‘Æ°á»£c tá»± Ä‘á»™ng giáº£i quyáº¿t vÃ¬ trÃ¬nh táº¡o sync sáº½ tá»± Ä‘á»™ng thÃªm cÃ¡c tham chiáº¿u typescript cÃ²n thiáº¿u!

Táº¥t cáº£ cÃ¡c artifact Ä‘Ã£ build hiá»‡n cÃ³ sáºµn trong `thÆ° má»¥c dist/` náº±m á»Ÿ gá»‘c cá»§a monorepo. ÄÃ¢y lÃ  má»™t thá»±c hÃ nh tiÃªu chuáº©n khi sá»­ dá»¥ng cÃ¡c dá»± Ã¡n Ä‘Æ°á»£c táº¡o bá»Ÿi `@aws/nx-plugin` vÃ¬ nÃ³ khÃ´ng lÃ m Ã´ nhiá»…m cÃ¢y tá»‡p cá»§a báº¡n vá»›i cÃ¡c tá»‡p Ä‘Æ°á»£c táº¡o. Trong trÆ°á»ng há»£p báº¡n muá»‘n dá»n dáº¹p cÃ¡c tá»‡p cá»§a mÃ¬nh, hÃ£y xÃ³a thÆ° má»¥c `dist/` mÃ  khÃ´ng pháº£i lo láº¯ng vá» cÃ¡c artifact build bá»‹ ráº£i rÃ¡c kháº¯p cÃ¢y tá»‡p.

ChÃºc má»«ng! Báº¡n Ä‘Ã£ táº¡o táº¥t cáº£ cÃ¡c dá»± Ã¡n con cáº§n thiáº¿t Ä‘á»ƒ báº¯t Ä‘áº§u triá»ƒn khai cá»‘t lÃµi cá»§a trÃ² chÆ¡i AI Dungeon Adventure cá»§a chÃºng ta.  ğŸ‰ğŸ‰ğŸ‰