---
title: "Jogo de Dungeons com IA"
description: "Um guia passo a passo de como construir um jogo de aventura de dungeon com IA usando o @aws/nx-plugin."
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import CreateNxWorkspaceCommand from '@components/create-nx-workspace-command.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## M√≥dulo 1: Configura√ß√£o do monoreposit√≥rio

Vamos come√ßar criando um novo monoreposit√≥rio. Dentro do diret√≥rio desejado, execute o seguinte comando:

<CreateNxWorkspaceCommand workspace="dungeon-adventure" />

Isso configurar√° um monoreposit√≥rio NX dentro do diret√≥rio `dungeon-adventure` que voc√™ pode abrir no VSCode. Deve parecer com o seguinte:

<FileTree>
- .nx/
- .vscode/
- node_modules/
- packages/ aqui ficar√£o seus subprojetos
- .gitignore
- .npmrc
- .prettierignore
- .prettierrc
- nx.json configura o CLI do NX e padr√µes do monoreposit√≥rio
- package.json todas as depend√™ncias Node s√£o definidas aqui
- pnpm-lock.yaml ou bun.lock, yarn.lock, package-lock.json dependendo do gerenciador de pacotes
- pnpm-workspace.yaml se usar pnpm
- README.md
- tsconfig.base.json todos os subprojetos baseados em Node estendem este
- tsconfig.json
</FileTree>

Agora estamos prontos para come√ßar a criar nossos diferentes subprojetos usando o `@aws/nx-plugin`.

<Aside type="tip">√â uma melhor pr√°tica garantir que todos os arquivos n√£o stageados sejam commitados no Git antes de executar quaisquer geradores. Isso permite ver o que mudou ap√≥s executar seu gerador via `git diff`</Aside>

### Game API

Primeiro vamos criar nossa Game API. Para isso, vamos criar uma API tRPC chamada `GameApi` seguindo os passos abaixo:

<RunGenerator generator="ts#trpc-api" requiredParameters={{ name: "GameApi" }} noInteractive />

<br />

Voc√™ deve ver alguns novos arquivos aparecerem em sua √°rvore de arquivos.

<Aside>
O `package.json` raiz agora est√° configurado com `type` como `module`, o que significa que ESM √© o tipo de m√≥dulo padr√£o para todos os subprojetos Node fornecidos pelo `@aws/nx-plugin`. Para mais detalhes sobre projetos TypeScript, consulte o <Link path="guides/typescript-project">guia ts#project</Link>.
</Aside>

<Drawer title="Arquivos atualizados do ts#trpc-api" trigger="Clique aqui para examinar esses arquivos em detalhes.">
Abaixo est√° uma lista de todos os arquivos gerados pelo gerador `ts#trpc-api`. Vamos examinar alguns dos arquivos-chave destacados na √°rvore de arquivos:
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - app/ constructs CDK espec√≠ficos do aplicativo
          - apis/
            - **game-api.ts** construct CDK para criar sua API tRPC
            - index.ts
            - ...
          - index.ts
        - core/ constructs CDK gen√©ricos
          - api/
            - rest-api.ts construct base para API Gateway Rest API
            - trpc-utils.ts utilit√°rios para constructs CDK de API tRPC
            - utils.ts utilit√°rios para constructs de API
          - index.ts
          - runtime-config.ts
        - index.ts
      - project.json
      - ...
    - types/ tipos compartilhados
      - src/
        - index.ts
        - runtime-config.ts defini√ß√£o de interface usada por CDK e website
      - project.json
      - ...
  - game-api/ API tRPC
    - src/
      - client/ cliente vanilla tipicamente usado para chamadas m√°quina a m√°quina
        - index.ts
        - sigv4.ts
      - middleware/ instrumenta√ß√£o com powertools
        - error.ts
        - index.ts
        - logger.ts
        - metrics.ts
        - tracer.ts
      - schema/ defini√ß√µes de entradas e sa√≠das da API
        - **echo.ts**
      - procedures/ implementa√ß√µes espec√≠ficas dos procedimentos/rotas da API
        - **echo.ts**
      - index.ts
      - init.ts configura contexto e middleware
      - local-server.ts usado ao executar o servidor tRPC localmente
      - **router.ts** ponto de entrada para o lambda handler que define todos os procedimentos
    - project.json
    - ...
- eslint.config.mjs
- vitest.workspace.ts
</FileTree>

Analisando alguns dos arquivos-chave:

```ts {5,12}
// packages/game-api/src/router.ts
import {
  awsLambdaRequestHandler,
  CreateAWSLambdaContextOptions,
} from '@trpc/server/adapters/aws-lambda';
import { echo } from './procedures/echo.js';
import { t } from './init.js';
import { APIGatewayProxyEvent } from 'aws-lambda';

export const router = t.router;

export const appRouter = router({
  echo,
});

export const handler = awsLambdaRequestHandler({
  router: appRouter,
  createContext: (
    ctx: CreateAWSLambdaContextOptions<APIGatewayProxyEvent>,
  ) => ctx,
  responseMeta: () => ({
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': '*',
    },
  }),
});

export type AppRouter = typeof appRouter;
```
O router define o ponto de entrada para sua API tRPC e √© onde voc√™ declara todos os m√©todos da API. Como visto acima, temos um m√©todo chamado `echo` com implementa√ß√£o no arquivo `./procedures/echo.ts`.

```ts {2-5}
// packages/game-api/src/procedures/echo.ts
import { publicProcedure } from '../init.js';
import {
  EchoInputSchema,
  EchoOutputSchema,
} from '../schema/echo.js';

export const echo = publicProcedure
  .input(EchoInputSchema)
  .output(EchoOutputSchema)
  .query((opts) => ({ result: opts.input.message }));
```

Este arquivo √© a implementa√ß√£o do m√©todo `echo` e como visto √© fortemente tipado atrav√©s da declara√ß√£o de suas estruturas de dados de entrada e sa√≠da.

```ts
// packages/game-api/src/schema/echo.ts
import { z } from 'zod';

export const EchoInputSchema = z.object({
  message: z.string(),
});

export type IEchoInput = z.TypeOf<typeof EchoInputSchema>;

export const EchoOutputSchema = z.object({
  result: z.string(),
});

export type IEchoOutput = z.TypeOf<typeof EchoOutputSchema>;
```

Todas as defini√ß√µes de schema tRPC s√£o feitas usando [Zod](https://zod.dev/) e exportadas como tipos TypeScript via sintaxe `z.TypeOf`.

```ts
// packages/common/constructs/src/app/apis/game-api.ts
import { Construct } from 'constructs';
import * as url from 'url';
import {
  Code,
  Runtime,
  Function,
  FunctionProps,
  Tracing,
} from 'aws-cdk-lib/aws-lambda';
import {
  AuthorizationType,
  Cors,
  LambdaIntegration,
} from 'aws-cdk-lib/aws-apigateway';
import { Duration, Stack } from 'aws-cdk-lib';
import {
  PolicyDocument,
  PolicyStatement,
  Effect,
  AccountPrincipal,
  AnyPrincipal,
} from 'aws-cdk-lib/aws-iam';
import {
  IntegrationBuilder,
  RestApiIntegration,
} from '../../core/api/utils.js';
import { RestApi } from '../../core/api/rest-api.js';
import { Procedures, routerToOperations } from '../../core/api/trpc-utils.js';
import { AppRouter, appRouter } from ':dungeon-adventure/game-api';

// Tipo union para todos os nomes de opera√ß√µes da API
type Operations = Procedures<AppRouter>;

/**
 * Propriedades para criar um construct GameApi
 *
 * @template TIntegrations - Mapa de nomes de opera√ß√µes para suas integra√ß√µes
 */
export interface GameApiProps<
  TIntegrations extends Record<Operations, RestApiIntegration>,
> {
  /**
   * Mapa de nomes de opera√ß√µes para integra√ß√µes do API Gateway
   */
  integrations: TIntegrations;
}

/**
 * Um construct CDK que cria e configura uma API Gateway REST API
 * especificamente para GameApi.
 * @template TIntegrations - Mapa de nomes de opera√ß√µes para suas integra√ß√µes
 */
export class GameApi<
  TIntegrations extends Record<Operations, RestApiIntegration>,
> extends RestApi<Operations, TIntegrations> {
  /**
   * Cria integra√ß√µes padr√£o para todas as opera√ß√µes, implementando cada opera√ß√£o como
   * sua pr√≥pria fun√ß√£o lambda individual.
   *
   * @param scope - O escopo do construct CDK
   * @returns Um IntegrationBuilder com integra√ß√µes lambda padr√£o
   */
  public static defaultIntegrations = (scope: Construct) => {
    return IntegrationBuilder.rest({
      operations: routerToOperations(appRouter),
      defaultIntegrationOptions: {
        runtime: Runtime.NODEJS_LATEST,
        handler: 'index.handler',
        code: Code.fromAsset(
          url.fileURLToPath(
            new URL(
              '../../../../../../dist/packages/game-api/bundle',
              import.meta.url,
            ),
          ),
        ),
        timeout: Duration.seconds(30),
        tracing: Tracing.ACTIVE,
        environment: {
          AWS_CONNECTION_REUSE_ENABLED: '1',
        },
      } satisfies FunctionProps,
      buildDefaultIntegration: (op, props: FunctionProps) => {
        const handler = new Function(scope, `GameApi${op}Handler`, props);
        return { handler, integration: new LambdaIntegration(handler) };
      },
    });
  };

  constructor(
    scope: Construct,
    id: string,
    props: GameApiProps<TIntegrations>,
  ) {
    super(scope, id, {
      apiName: 'GameApi',
      defaultMethodOptions: {
        authorizationType: AuthorizationType.IAM,
      },
      defaultCorsPreflightOptions: {
        allowOrigins: Cors.ALL_ORIGINS,
        allowMethods: Cors.ALL_METHODS,
      },
      policy: new PolicyDocument({
        statements: [
          // Aqui concedemos a qualquer credencial AWS da conta de deploy para chamar a API.
          // Acesso granular m√°quina a m√°quina pode ser definido aqui usando principals espec√≠ficos
          // (ex: roles ou usu√°rios) e recursos (ex: quais caminhos da API podem ser invocados).
          new PolicyStatement({
            effect: Effect.ALLOW,
            principals: [new AccountPrincipal(Stack.of(scope).account)],
            actions: ['execute-api:Invoke'],
            resources: ['execute-api:/*'],
          }),
          // Libera OPTIONS para permitir preflight requests n√£o autenticadas de navegadores
          new PolicyStatement({
            effect: Effect.ALLOW,
            principals: [new AnyPrincipal()],
            actions: ['execute-api:Invoke'],
            resources: ['execute-api:/*/OPTIONS/*'],
          }),
        ],
      }),
      operations: routerToOperations(appRouter),
      ...props,
    });
  }
}
```

Este √© o construct CDK que define nossa GameApi. Como visto, ele fornece um m√©todo `defaultIntegrations` que cria automaticamente uma fun√ß√£o lambda para cada procedimento na API tRPC, apontando para a implementa√ß√£o empacotada. Isso significa que no momento do `cdk synth`, o bundling n√£o ocorre (diferente do [NodeJsFunction](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_lambda_nodejs.NodejsFunction.html)), pois j√° foi feito durante o build do projeto.

</Drawer>

### Story API

Agora vamos criar nossa Story API. Para isso, vamos criar uma API FastAPI chamada `StoryApi` seguindo os passos:

<RunGenerator generator="py#fast-api" requiredParameters={{name:"StoryApi", moduleName:"story_api"}} noInteractive />

Voc√™ deve ver novos arquivos aparecerem em sua √°rvore de arquivos.
<Drawer title="Arquivos atualizados do py#fast-api" trigger="Clique aqui para examinar esses arquivos em detalhes.">
Abaixo est√° a lista de arquivos gerados pelo gerador `py#fast-api`. Vamos examinar alguns arquivos-chave:
<FileTree>
- .venv/ ambiente virtual √∫nico para o monorepo
- packages/
  - common/
    - constructs/
      - src/
        - app/ constructs CDK espec√≠ficos do app
          - apis/
            - **story-api.ts** construct CDK para criar sua FastAPI
            - index.ts atualizado para exportar a nova story-api
      - project.json atualizado para adicionar depend√™ncia de build no story_api
    - types/ tipos compartilhados
      - src/
        - **runtime-config.ts** atualizado para adicionar StoryApi
  - story_api/
    - story_api/ m√≥dulo Python
      - init.py configura powertools, FastAPI e middleware
      - **main.py** ponto de entrada do lambda contendo todas as rotas
    - tests/
    - .python-version
    - project.json
    - pyproject.toml
    - project.json
- .python-version vers√£o Python fixada
- pyproject.toml
- uv.lock
</FileTree>

```ts
// packages/common/constructs/src/app/apis/story-api.ts
import { Construct } from 'constructs';
import * as url from 'url';
import {
  Code,
  Runtime,
  Function,
  FunctionProps,
  Tracing,
} from 'aws-cdk-lib/aws-lambda';
import {
  AuthorizationType,
  Cors,
  LambdaIntegration,
} from 'aws-cdk-lib/aws-apigateway';
import { Duration, Stack } from 'aws-cdk-lib';
import {
  PolicyDocument,
  PolicyStatement,
  Effect,
  AccountPrincipal,
  AnyPrincipal,
} from 'aws-cdk-lib/aws-iam';
import {
  IntegrationBuilder,
  RestApiIntegration,
} from '../../core/api/utils.js';
import { RestApi } from '../../core/api/rest-api.js';
import {
  OPERATION_DETAILS,
  Operations,
} from '../../generated/story-api/metadata.gen.js';

/**
 * Propriedades para criar um construct StoryApi
 *
 * @template TIntegrations - Mapa de nomes de opera√ß√µes para integra√ß√µes
 */
export interface StoryApiProps<
  TIntegrations extends Record<Operations, RestApiIntegration>,
> {
  /**
   * Mapa de nomes de opera√ß√µes para integra√ß√µes do API Gateway
   */
  integrations: TIntegrations;
}

/**
 * Um construct CDK que cria e configura uma API Gateway REST API
 * especificamente para StoryApi.
 * @template TIntegrations - Mapa de nomes de opera√ß√µes para integra√ß√µes
 */
export class StoryApi<
  TIntegrations extends Record<Operations, RestApiIntegration>,
> extends RestApi<Operations, TIntegrations> {
  /**
   * Cria integra√ß√µes padr√£o para todas as opera√ß√µes, implementando cada opera√ß√£o como
   * sua pr√≥pria fun√ß√£o lambda individual.
   *
   * @param scope - O escopo do construct CDK
   * @returns Um IntegrationBuilder com integra√ß√µes lambda padr√£o
   */
  public static defaultIntegrations = (scope: Construct) => {
    return IntegrationBuilder.rest({
      operations: OPERATION_DETAILS,
      defaultIntegrationOptions: {
        runtime: Runtime.PYTHON_3_12,
        handler: 'story_api.main.handler',
        code: Code.fromAsset(
          url.fileURLToPath(
            new URL(
              '../../../../../../dist/packages/story_api/bundle',
              import.meta.url,
            ),
          ),
        ),
        timeout: Duration.seconds(30),
        tracing: Tracing.ACTIVE,
        environment: {
          AWS_CONNECTION_REUSE_ENABLED: '1',
        },
      } satisfies FunctionProps,
      buildDefaultIntegration: (op, props: FunctionProps) => {
        const handler = new Function(scope, `StoryApi${op}Handler`, props);
        return { handler, integration: new LambdaIntegration(handler) };
      },
    });
  };

  constructor(
    scope: Construct,
    id: string,
    props: StoryApiProps<TIntegrations>,
  ) {
    super(scope, id, {
      apiName: 'StoryApi',
      defaultMethodOptions: {
        authorizationType: AuthorizationType.IAM,
      },
      defaultCorsPreflightOptions: {
        allowOrigins: Cors.ALL_ORIGINS,
        allowMethods: Cors.ALL_METHODS,
      },
      policy: new PolicyDocument({
        statements: [
          // Concede acesso a credenciais AWS da conta de deploy
          new PolicyStatement({
            effect: Effect.ALLOW,
            principals: [new AccountPrincipal(Stack.of(scope).account)],
            actions: ['execute-api:Invoke'],
            resources: ['execute-api:/*'],
          }),
          // Libera OPTIONS para preflight requests
          new PolicyStatement({
            effect: Effect.ALLOW,
            principals: [new AnyPrincipal()],
            actions: ['execute-api:Invoke'],
            resources: ['execute-api:/*/OPTIONS/*'],
          }),
        ],
      }),
      operations: OPERATION_DETAILS,
      ...props,
    });
  }
}

```

Este √© o construct CDK que define nossa StoryApi. Como visto, o m√©todo `defaultIntegrations` cria uma fun√ß√£o lambda para cada opera√ß√£o da FastAPI, apontando para a implementa√ß√£o empacotada. Isso evita bundling durante `cdk synth`, diferentemente do [PythonFunction](https://docs.aws.amazon.com/cdk/api/v2/docs/@aws-cdk_aws-lambda-python-alpha.PythonFunction.html).

```diff lang="ts"
// packages/common/types/src/runtime-config.ts
export type ApiUrl = string;
// eslint-disable-next-line @typescript-eslint/no-empty-object-type, @typescript-eslint/no-empty-interface
export interface IRuntimeConfig {
  apis: {
    GameApi: ApiUrl;
+    StoryApi: ApiUrl;
  };
}
```

Aqui vemos o gerador realizando uma transforma√ß√£o AST que preserva o c√≥digo existente e adiciona `StoryApi` √† defini√ß√£o `IRuntimeConfig`. Isso garante seguran√ßa de tipos quando consumido pelo frontend.

```py
// packages/story_api/story_api/main.py
from .init import app, lambda_handler, tracer

handler = lambda_handler

@app.get("/")
@tracer.capture_method
def read_root():
    return {"Hello": "World"}
```

Aqui s√£o definidos todos os m√©todos da API. Como visto, `read_root` est√° mapeado para `GET /`. [Pydantic](https://docs.pydantic.dev/latest/) pode ser usado para valida√ß√£o de tipos.

</Drawer>

### Game UI: Website

Agora vamos criar a UI para interagir com o jogo. Para isso, crie um website chamado `GameUI`:

<RunGenerator generator="ts#react-website" requiredParameters={{name:"GameUI"}} noInteractive />

Novos arquivos devem aparecer na √°rvore.

<Drawer title="Arquivos atualizados do ts#react-website" trigger="Clique aqui para examinar detalhes.">
Lista de arquivos gerados pelo `ts#react-website`:
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - app/ constructs CDK espec√≠ficos
          - static-websites/
            - **game-ui.ts** construct CDK para a UI
        - core/
          - static-website.ts construct gen√©rico para website est√°tico
  - game-ui/
    - public/
    - src/
      - components/
        - AppLayout/
          - index.ts layout geral da p√°gina
          - navitems.ts itens de navega√ß√£o
      - hooks/
        - useAppLayout.tsx configura notifica√ß√µes, estilo da p√°gina
      - routes/ rotas baseadas em arquivo com @tanstack/react-router
        - index.tsx p√°gina raiz redireciona para '/welcome'
        - __root.tsx componente base para todas as p√°ginas
        - welcome/
          - **index.tsx**
        - config.ts
        - **main.tsx** entrada do React
        - routeTree.gen.ts atualizado automaticamente
        - styles.css
    - index.html
    - project.json
    - vite.config.ts
    - ...
</FileTree>

```ts
// packages/common/constructs/src/app/static-websites/game-ui.ts
import * as url from 'url';
import { Construct } from 'constructs';
import { StaticWebsite } from '../../core/index.js';

export class GameUI extends StaticWebsite {
  constructor(scope: Construct, id: string) {
    super(scope, id, {
      websiteFilePath: url.fileURLToPath(
        new URL(
          '../../../../../../dist/packages/game-ui/bundle',
          import.meta.url,
        ),
      ),
    });
  }
}
```

Este construct CDK define a GameUI, configurando o caminho para o bundle gerado pelo Vite.

```tsx
// packages/game-ui/src/main.tsx
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';

import '@cloudscape-design/global-styles/index.css';

const router = createRouter({ routeTree });

declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}

const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
        <RouterProvider router={router} />
      </I18nProvider>
    </React.StrictMode>,
  );
```

Ponto de entrada do React usando [roteamento baseado em arquivo](https://tanstack.com/router/v1/docs/framework/react/routing/file-based-routing).

```tsx
// packages/game-ui/src/routes/welcome/index.tsx
import {
  ContentLayout,
  Header,
  SpaceBetween,
  Container,
} from '@cloudscape-design/components';
import { createFileRoute } from '@tanstack/react-router';

export const Route = createFileRoute('/welcome/')({
  component: RouteComponent,
});

function RouteComponent() {
  return (
    <ContentLayout header={<Header>Welcome</Header>}>
      <SpaceBetween size="l">
        <Container>Welcome to your new Cloudscape website!</Container>
      </SpaceBetween>
    </ContentLayout>
  );
}
```

Componente renderizado na rota `/welcome`. O roteador atualiza automaticamente o `routeTree.gen.ts`.

</Drawer>

### Game UI: Autentica√ß√£o

Agora vamos configurar autentica√ß√£o via Amazon Cognito:

<RunGenerator generator="ts#react-website#auth" requiredParameters={{cognitoDomain:"game-ui", project:"@dungeon-adventure/game-ui", allowSignup:true}} noInteractive />

Arquivos ser√£o atualizados/adicionados.

<Drawer title="Arquivos atualizados de autentica√ß√£o" trigger="Clique para detalhes.">
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - core/
          - user-identity.ts construct para pools de usu√°rios
    - types/
      - src/
        - runtime-config.ts adiciona cognitoProps
  - game-ui/
    - src/
      - components/
        - AppLayout/
          - index.tsx adiciona usu√°rio/logout no header
        - CognitoAuth/
          - index.ts gerencia login
        - RuntimeConfig/
          - index.tsx busca runtime-config.json
      - hooks/
        - useRuntimeConfig.tsx
      - **main.tsx** Adiciona Cognito
</FileTree>

```diff lang="tsx"
// packages/game-ui/src/main.tsx
+import CognitoAuth from './components/CognitoAuth';
+import RuntimeConfigProvider from './components/RuntimeConfig';
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';
import '@cloudscape-design/global-styles/index.css';
const router = createRouter({ routeTree });
declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}
const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
+        <RuntimeConfigProvider>
+          <CognitoAuth>
            <RouterProvider router={router} />
+          </CognitoAuth>
+        </RuntimeConfigProvider>
      </I18nProvider>
    </React.StrictMode>,
  );
```

Os componentes `RuntimeConfigProvider` e `CognitoAuth` foram adicionados via transforma√ß√£o AST.

</Drawer>

### Game UI: Conex√£o com Story API

Conectando a UI √† Story API:

<RunGenerator generator="api-connection" requiredParameters={{sourceProject:"@dungeon-adventure/game-ui", targetProject:"dungeon_adventure.story_api"}} noInteractive />

Arquivos atualizados:

<Drawer title="Arquivos atualizados UI -> FastAPI" trigger="Clique para detalhes.">
<FileTree>
- packages/
  - game-ui/
    - src/
      - hooks/
        - useSigV4.tsx assina requests para StoryApi
        - useStoryApiClient.tsx cliente StoryApi
        - useStoryApi.tsx hook com TanStack Query
      - components/
        - QueryClientProvider.tsx provedor do TanStack Query
        - StoryApiProvider.tsx provedor do hook
      - main.tsx adiciona provedores
    - .gitignore ignora arquivos gerados
    - project.json adiciona gera√ß√£o de hooks OpenAPI
  - story_api/
    - scripts/
      - generate_open_api.py
    - project.json gera openapi.json
</FileTree>

```tsx {1,12-15}
// packages/game-ui/src/hooks/useStoryApiClient.tsx
import { StoryApi } from '../generated/story-api/client.gen';
import { useSigV4 } from './useSigV4';
import { useRuntimeConfig } from './useRuntimeConfig';
import { useMemo } from 'react';

export const useStoryApi = (): StoryApi => {
  const runtimeConfig = useRuntimeConfig();
  const apiUrl = runtimeConfig.apis.StoryApi;
  const sigv4Client = useSigV4();
  return useMemo(
    () =>
      new StoryApi({
        url: apiUrl,
        fetch: sigv4Client,
      }),
    [apiUrl, sigv4Client],
  );
};
```

Hook para requisi√ß√µes autenticadas √† StoryApi. O cliente √© gerado durante o build.

```tsx
// packages/game-ui/src/components/StoryApiProvider.tsx
import { createContext, FC, PropsWithChildren, useMemo } from 'react';
import { useStoryApiClient } from '../hooks/useStoryApiClient';
import { StoryApiOptionsProxy } from '../generated/story-api/options-proxy.gen';

export const StoryApiContext = createContext<StoryApiOptionsProxy | undefined>(
  undefined,
);

export const StoryApiProvider: FC<PropsWithChildren> = ({ children }) => {
  const client = useStoryApiClient();
  const optionsProxy = useMemo(
    () => new StoryApiOptionsProxy({ client }),
    [client],
  );

  return (
    <StoryApiContext.Provider value={optionsProxy}>
      {children}
    </StoryApiContext.Provider>
  );
};

export default StoryApiProvider;
```

Provedor que usa o cliente gerado para interagir com a API via TanStack Query.

<Aside type="caution">
Arquivos em `src/generated/story-api/*.gen.ts` n√£o devem ser modificados manualmente.
</Aside>

</Drawer>

### Game UI: Conex√£o com Game API

Conectando a UI √† Game API:

<RunGenerator generator="api-connection" requiredParameters={{sourceProject:"@dungeon-adventure/game-ui", targetProject:"@dungeon-adventure/game-api"}} noInteractive />

Arquivos atualizados:

<Drawer title="Arquivos atualizados UI -> tRPC" trigger="Clique para detalhes.">
<FileTree>
- packages/
  - game-ui/
    - src/
      - components/
        - GameApiClientProvider.tsx configura cliente tRPC
      - hooks/
        - **useGameApi.tsx** hooks para chamar a API
      - **main.tsx** injeta provedores tRPC
- package.json
</FileTree>

```tsx
// packages/game-ui/src/hooks/useGameApi.tsx
import { GameApiTRCPContext } from '../components/GameApiClientProvider';

export const useGameApi = GameApiTRCPContext.useTRPC;
```

Hook usando [integra√ß√£o do React Query](https://trpc.io/blog/introducing-tanstack-react-query-client) do tRPC.

<Aside>
O hook `useGameApi` reflete altera√ß√µes no backend instantaneamente via infer√™ncia TypeScript.
</Aside>

```diff lang="tsx"
// packages/game-ui/src/main.tsx
+import GameApiClientProvider from './components/GameApiClientProvider';
+import QueryClientProvider from './components/QueryClientProvider';
import CognitoAuth from './components/CognitoAuth';
import RuntimeConfigProvider from './components/RuntimeConfig';
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';
import '@cloudscape-design/global-styles/index.css';
const router = createRouter({ routeTree });
declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}
const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
        <RuntimeConfigProvider>
          <CognitoAuth>
+            <QueryClientProvider>
+              <GameApiClientProvider>
                <RouterProvider router={router} />
+              </GameApiClientProvider>
+            </QueryClientProvider>
          </CognitoAuth>
        </RuntimeConfigProvider>
      </I18nProvider>
    </React.StrictMode>,
  );
```

Provedores tRPC adicionados via transforma√ß√£o AST.

</Drawer>

### Game UI: Infraestrutura

Criando projeto de infraestrutura CDK:

<RunGenerator generator="ts#infra" requiredParameters={{name:"infra"}} noInteractive />

Arquivos atualizados:

<Drawer title="Arquivos atualizados do ts#infra" trigger="Clique para detalhes.">
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - core/
          - cfn-guard-rules/
            - *.guard
          - cfn-guard.ts
          - index.ts
  - infra
    - src/
      - stacks/
        - **application-stack.ts** recursos CDK
      - index.ts
      - **main.ts** entrada do CDK
    - cdk.json
    - project.json
    - ...
  - package.json
  - tsconfig.json refer√™ncias atualizadas
  - tsconfig.base.json alias atualizado
</FileTree>

```ts
// packages/infra/src/main.ts
import { ApplicationStack } from './stacks/application-stack.js';
import {
  App,
  CfnGuardValidator,
  RuleSet,
} from ':dungeon-adventure/common-constructs';

const app = new App({
  policyValidationBeta1: [new CfnGuardValidator(RuleSet.AWS_PROTOTYPING)],
});

new ApplicationStack(app, 'dungeon-adventure-infra-sandbox', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  },
  crossRegionReferences: true,
});

app.synth();
```

<Aside type="tip">
Erros de importa√ß√£o podem ocorrer at√© executar `nx sync` para configurar refer√™ncias TypeScript.
</Aside>

Aplica√ß√£o CDK usando [cfn-guard](https://github.com/cdklabs/cdk-validator-cfnguard) para valida√ß√£o.

```ts
// packages/infra/src/stacks/application-stack.ts
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // C√≥digo que define sua stack
  }
}
```

Local para instanciar constructs CDK.

</Drawer>

#### Atualizando a infraestrutura

Atualize `application-stack.ts` para instanciar constructs:

<E2EDiff before="dungeon-adventure/1/application-stack.ts.original.template" after="dungeon-adventure/1/application-stack.ts.template" lang="ts" />

Usamos integra√ß√µes padr√£o que mapeiam cada opera√ß√£o da API para uma fun√ß√£o lambda.

### Construindo o c√≥digo

<Drawer title="Comandos Nx" trigger="Hora de construir o c√≥digo pela primeira vez">
###### Alvos √∫nicos vs m√∫ltiplos

O comando `run-many` executa um alvo em m√∫ltiplos subprojetos. Depend√™ncias s√£o resolvidas na ordem correta.

Para construir um √∫nico projeto:

<NxCommands commands={['run @dungeon-adventure/infra:build']} />
###### Visualizando depend√™ncias

Visualize depend√™ncias com:

<NxCommands commands={['graph']} />
<br/>

<Image src={nxGraphPng} alt="nx-graph.png" width="800" height="600" />

###### Cache

Nx usa [cache](https://nx.dev/concepts/how-caching-works) para acelerar builds. Use `--skip-nx-cache` para ignorar:

<NxCommands commands={['run @dungeon-adventure/infra:build --skip-nx-cache']} />
Limpar cache:

<NxCommands commands={['reset']} />

</Drawer>

<NxCommands commands={['run-many --target build --all']} />

Voc√™ ser√° questionado:

```bash
 NX   The workspace is out of sync

[@nx/js:typescript-sync]: Some TypeScript configuration files are missing project references...

? Would you like to sync the identified changes to get your workspace up to date? ‚Ä¶
Yes, sync the changes and run the tasks
No, run the tasks without syncing the changes
```

Selecione **Yes** para sincronizar refer√™ncias TypeScript e resolver erros de importa√ß√£o.

<Aside type="tip">
Para corrigir erros de lint:

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

<Aside type="caution" title="Erro no Windows">
<Drawer trigger="Se ocorrer erro no Windows, clique aqui." title="Erro no Windows">
Se ocorrer erro no `@dungeon-adventure/infra`, desative `cfn-guard` modificando `main.ts`:

```diff lang="ts"
// packages/infra/src/main.ts
import { ApplicationStack } from './stacks/application-stack.js';
import {
   App,
-  CfnGuardValidator,
-  RuleSet,
} from ':dungeon-adventure/common-constructs';
-
-const app = new App({
-  policyValidationBeta1: [new CfnGuardValidator(RuleSet.AWS_PROTOTYPING)],
-});
+const app = new App();
...
```
</Drawer>
</Aside>

Artefatos de build est√£o em `dist/`. Parab√©ns! Voc√™ criou todos os subprojetos necess√°rios. üéâüéâüéâ