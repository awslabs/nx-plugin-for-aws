---
title: "Jogo de Dungeons com IA"
description: "Um guia passo a passo de como construir um jogo de aventura de dungeon com IA usando o @aws/nx-plugin."
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import CreateNxWorkspaceCommand from '@components/create-nx-workspace-command.astro';
import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## M√≥dulo 1: Configurar seu Monorepo

Comece criando um novo monorepo. Um monorepo √© um √∫nico reposit√≥rio contendo m√∫ltiplos projetos distintos, com relacionamentos bem definidos.

Dentro do diret√≥rio desejado, execute o seguinte comando:

<CreateNxWorkspaceCommand workspace="dungeon-adventure" />

Isso configurar√° um monorepo NX no diret√≥rio `dungeon-adventure`.
Abra o diret√≥rio no VSCode. Voc√™ ver√° a seguinte estrutura de arquivos:

<FileTree>
- .nx/
- .vscode/
- node_modules/
- packages/ este √© o local onde seus subprojetos residir√£o
- .gitignore
- .npmrc
- .prettierignore
- .prettierrc
- nx.json configura o CLI NX e padr√µes do monorepo
- package.json todas as depend√™ncias Node s√£o definidas aqui
- pnpm-lock.yaml ou bun.lock, yarn.lock, package-lock.json dependendo do gerenciador de pacotes
- pnpm-workspace.yaml se usar pnpm
- README.md
- tsconfig.base.json todos os subprojetos baseados em Node estendem este
- tsconfig.json
</FileTree>

Antes de adicionar componentes do `@aws/nx-plugin` ao monorepo, precisamos instal√°-lo como uma depend√™ncia de desenvolvimento.
Para isso, execute o seguinte comando na raiz do monorepo `dungeon-adventure`:

<InstallCommand dev pkg="@aws/nx-plugin" />

Agora estamos prontos para come√ßar a criar nossos diferentes subprojetos usando o `@aws/nx-plugin`.

<Aside type="tip">Recomendamos fazer commit dos arquivos n√£o preparados no Git antes de executar qualquer gerador. Isso permite ver o que mudou ap√≥s executar o gerador via `git diff`.</Aside>

### Gerar a Game API

Come√ßaremos criando nossa Game API. Esta API √© usada para gerenciar o estado do jogo.
Para isso, crie uma API tRPC chamada `GameApi` seguindo estes passos:

<RunGenerator generator="ts#trpc-api" requiredParameters={{apiName:"GameApi"}} noInteractive />

<br />

Voc√™ ver√° novos arquivos aparecerem na sua √°rvore de arquivos.

<Drawer title="Arquivos atualizados pelo ts#trpc-api" trigger="Clique para examinar estes arquivos em detalhes.">
Abaixo est√° a lista de todos os arquivos gerados pelo gerador `ts#trpc-api`. Vamos examinar alguns dos arquivos-chave destacados na √°rvore de arquivos:
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - app/ constructs CDK espec√≠ficos do aplicativo
          - http-apis/
            - **game-api.ts** construct CDK para criar sua API tRPC
            - index.ts
            - ...
          - index.ts
        - core/ constructs CDK gen√©ricos
          - http-api.ts construct CDK base para API HTTP
          - index.ts
          - runtime-config.ts
        - index.ts
      - project.json
      - ...
    - types/ tipos compartilhados
      - src/
        - index.ts
        - runtime-config.ts defini√ß√£o de interface usada por CDK e website
      - project.json
      - ...
  - game-api/
    - backend/ c√≥digo de implementa√ß√£o tRPC
      - src/
        - client/ cliente vanilla tipicamente usado para chamadas m√°quina a m√°quina
          - index.ts
          - sigv4.ts
        - middleware/ instrumenta√ß√£o powertools
          - error.ts
          - index.ts
          - logger.ts
          - metrics.ts
          - tracer.ts
        - procedures/ implementa√ß√µes espec√≠ficas para procedimentos/rotas da API
          - **echo.ts**
        - index.ts
        - init.ts configura contexto e middleware
        - local-server.ts usado ao executar o servidor tRPC localmente
        - **router.ts** ponto de entrada para o lambda handler que define todos os procedimentos
      - project.json
      - ...
    - schema/
      - src/
        - procedures/
          - **echo.ts**
        - index.ts
      - project.json
      - ...
- eslint.config.mjs
- vitest.workspace.ts
</FileTree>

Vamos analisar estes arquivos-chave:

```ts {5,12}
// packages/game-api/backend/src/router.ts
import {
  awsLambdaRequestHandler,
  CreateAWSLambdaContextOptions,
} from '@trpc/server/adapters/aws-lambda';
import { echo } from './procedures/echo.js';
import { t } from './init.js';
import { APIGatewayProxyEventV2WithIAMAuthorizer } from 'aws-lambda';

export const router = t.router;

export const appRouter = router({
  echo,
});

export const handler = awsLambdaRequestHandler({
  router: appRouter,
  createContext: (
    ctx: CreateAWSLambdaContextOptions<APIGatewayProxyEventV2WithIAMAuthorizer>,
  ) => ctx,
});

export type AppRouter = typeof appRouter;
```
O router define o ponto de entrada para sua API tRPC e √© onde voc√™ declarar√° todos os m√©todos da API.
Temos um m√©todo chamado `echo` com sua implementa√ß√£o no arquivo `./procedures/echo.ts`.

```ts {2-5}
// packages/game-api/backend/src/procedures/echo.ts
import { publicProcedure } from '../init.js';
import {
  EchoInputSchema,
  EchoOutputSchema,
} from ':dungeon-adventure/game-api-schema';

export const echo = publicProcedure
  .input(EchoInputSchema)
  .output(EchoOutputSchema)
  .query((opts) => ({ result: opts.input.message }));
```

Este arquivo √© a implementa√ß√£o do m√©todo `echo`, fortemente tipado atrav√©s da declara√ß√£o de suas estruturas de dados de entrada e sa√≠da. Ele importa essas defini√ß√µes do projeto `:dungeon-adventure/game-api-schema` que √© um [alias](https://www.typescriptlang.org/tsconfig/paths.html) para o projeto de schema.

<Aside type="tip">Se voc√™ vir um erro de importa√ß√£o no seu IDE, isso pode ocorrer porque o backend ainda n√£o tem uma refer√™ncia TypeScript configurada em seu `tsconfig.json`. O Nx foi [configurado](https://nx.dev/nx-api/js/generators/typescript-sync) para criar essas refer√™ncias *dinamicamente* sempre que um build/compile √© executado, ou se voc√™ executar o comando `nx sync` manualmente. Para mais informa√ß√µes, consulte o <Link path="guides/typescript-project#importing-your-library-code-in-other-projects">guia TypeScript</Link>.</Aside>

```ts
// packages/game-api/schema/src/procedures/echo.ts
import { z } from 'zod';

export const EchoInputSchema = z.object({
  message: z.string(),
});

export type IEchoInput = z.TypeOf<typeof EchoInputSchema>;

export const EchoOutputSchema = z.object({
  result: z.string(),
});

export type IEchoOutput = z.TypeOf<typeof EchoOutputSchema>;
```

Todas as defini√ß√µes de schema tRPC s√£o definidas usando [Zod](https://zod.dev/), e exportadas como tipos TypeScript via sintaxe `z.TypeOf`.

```ts
// packages/common/constructs/src/app/http-apis/game-api.ts
import { Construct } from 'constructs';
import * as url from 'url';
import { HttpApi } from '../../core/http-api.js';
import { HttpIamAuthorizer } from 'aws-cdk-lib/aws-apigatewayv2-authorizers';
import { Runtime } from 'aws-cdk-lib/aws-lambda';

export class GameApi extends HttpApi {
  constructor(scope: Construct, id: string) {
    super(scope, id, {
      defaultAuthorizer: new HttpIamAuthorizer(),
      apiName: 'GameApi',
      runtime: Runtime.NODEJS_LATEST,
      handler: 'index.handler',
      handlerFilePath: url.fileURLToPath(
        new URL(
          '../../../../../../dist/packages/game-api/backend/bundle',
          import.meta.url,
        ),
      ),
    });
  }
}
```

Este √© o construct CDK que define nossa GameAPI. Ele configurou o caminho do arquivo handler para o bundle gerado para nossa implementa√ß√£o backend tRPC, para que no momento de `cdk synth` o bundling n√£o ocorra (contr√°rio ao uso de [NodeJsFunction](https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_lambda_nodejs.NodejsFunction.html)), pois j√° fizemos o bundling como parte do target build do projeto backend.

</Drawer>

<Aside>
O `package.json` raiz est√° agora configurado com um `type` como `module`, o que significa que ESM √© o tipo de m√≥dulo padr√£o para todos os subprojetos Node fornecidos pelo `@aws/nx-plugin`. Para mais detalhes sobre como trabalhar com projetos TypeScript, consulte o <Link path="guides/typescript-project">guia ts#project</Link>.
</Aside>

### Gerar a Story API

Em seguida, vamos criar nossa Story API usando o gerador FastAPI. Esta API √© usada com respostas de streaming para gera√ß√£o de hist√≥rias, usando Amazon Bedrock.
Para isso, crie uma API Fast chamada `StoryApi` seguindo estes passos:

<RunGenerator generator="py#fast-api" requiredParameters={{name:"StoryApi"}} noInteractive />

Voc√™ ver√° novos arquivos aparecerem na sua √°rvore de arquivos.

<Drawer title="Arquivos atualizados pelo py#fast-api" trigger="Clique aqui para examinar estes arquivos em mais detalhes.">
Esta √© uma lista de todos os arquivos gerados pelo gerador `py#fast-api`. Vamos examinar alguns dos arquivos-chave destacados na √°rvore de arquivos:
<FileTree>
- .venv/ √∫nico ambiente virtual para o monorepo
- packages/
  - common/
    - constructs/
      - src/
        - app/ constructs CDK espec√≠ficos do aplicativo
          - http-apis/
            - **story-api.ts** construct CDK para criar sua Fast API
            - index.ts atualizado para exportar o novo story-api
      - project.json atualizado para adicionar depend√™ncia de build no story_api
    - types/ tipos compartilhados
      - src/
        - **runtime-config.ts** atualizado para adicionar o StoryApi
  - story_api/
    - story_api/ m√≥dulo Python
      - init.py configura powertools, FastAPI e middleware
      - **main.py** ponto de entrada para o lambda contendo todas as rotas
    - tests/
    - .python-version
    - project.json
    - pyproject.toml
    - project.json
- .python-version vers√£o Python fixa do uv
- pyproject.toml
- uv.lock
</FileTree>

```ts
// packages/common/constructs/src/app/http-apis/story-api.ts
import { Construct } from 'constructs';
import * as url from 'url';
import { HttpApi } from '../../core/http-api.js';
import { HttpIamAuthorizer } from 'aws-cdk-lib/aws-apigatewayv2-authorizers';
import { Runtime } from 'aws-cdk-lib/aws-lambda';

export class StoryApi extends HttpApi {
  constructor(scope: Construct, id: string) {
    super(scope, id, {
      defaultAuthorizer: new HttpIamAuthorizer(),
      apiName: 'StoryApi',
      runtime: Runtime.PYTHON_3_12,
      handler: 'story_api.main.handler',
      handlerFilePath: url.fileURLToPath(
        new URL(
          '../../../../../../dist/packages/story_api/bundle',
          import.meta.url,
        ),
      ),
    });
  }
}
```

Este √© o construct CDK que define nossa StoryApi. Ele configura o caminho do arquivo handler para o bundle gerado para nossa implementa√ß√£o backend Fast API. Isso significa que no momento de `cdk synth` o bundling n√£o ocorre (contr√°rio a [PythonFunction](https://docs.aws.amazon.com/cdk/api/v2/docs/@aws-cdk_aws-lambda-python-alpha.PythonFunction.html)) pois j√° fizemos o bundling como parte do target build do projeto backend.

```diff lang="ts"
// packages/common/types/src/runtime-config.ts
export type ApiUrl = string;
// eslint-disable-next-line @typescript-eslint/no-empty-object-type, @typescript-eslint/no-empty-interface
export interface IRuntimeConfig {
  httpApis: {
    GameApi: ApiUrl;
+    StoryApi: ApiUrl;
  };
}
```

Aqui est√° um exemplo do gerador realizando uma transforma√ß√£o AST que preserva todo o c√≥digo existente e realiza uma atualiza√ß√£o. Aqui voc√™ pode ver que o `StoryApi` foi adicionado √† defini√ß√£o `IRuntimeConfig` o que significa que, quando isso for consumido pelo nosso frontend, ir√° impor seguran√ßa de tipos!

```py
// packages/story_api/story_api/main.py
from .init import app, lambda_handler, tracer

handler = lambda_handler

@app.get("/")
@tracer.capture_method
def read_root():
    return {"Hello": "World"}
```

Este √© o local onde todos os seus m√©todos de API ser√£o definidos. Como pode ver aqui, temos um m√©todo `read_root` mapeado para a rota `GET /`. Voc√™ pode usar [Pydantic](https://docs.pydantic.dev/latest/) para declarar entradas e sa√≠das de m√©todos e garantir seguran√ßa de tipos.

</Drawer>

### Adicionar o website Game UI

Para interagir com o jogo, crie a UI usando o gerador de website CloudScape.
Para isso, crie um website chamado `GameUI` seguindo estes passos:

<RunGenerator generator="ts#cloudscape-website" requiredParameters={{name:"GameUI"}} noInteractive />

Voc√™ ver√° novos arquivos aparecerem na sua √°rvore de arquivos.

<Drawer title="Arquivos atualizados pelo ts#cloudscape-website" trigger="Clique aqui para examinar estes arquivos em mais detalhes.">
Abaixo est√° a lista de todos os arquivos gerados pelo gerador `ts#cloudscape-website`. Vamos examinar alguns dos arquivos-chave destacados na √°rvore de arquivos:
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - app/ constructs CDK espec√≠ficos do aplicativo
          - static-websites/
            - **game-ui.ts** construct CDK para criar sua Game UI
        - core/
          - static-website.ts construct gen√©rico de website est√°tico
  - game-ui/
    - public/
    - src/
      - components/
        - AppLayout/
          - index.ts layout geral da p√°gina: cabe√ßalho, rodap√©, barra lateral, etc
          - navitems.ts itens de navega√ß√£o da barra lateral
      - hooks/
        - useAppLayout.tsx permite definir dinamicamente notifica√ß√µes, estilo da p√°gina, etc
      - routes/ rotas baseadas em arquivo @tanstack/react-router
        - index.tsx p√°gina raiz '/' redireciona para '/welcome'
        - __root.tsx todas as p√°ginas usam este componente como base
        - welcome/
          - **index.tsx**
        - config.ts
        - **main.tsx** ponto de entrada React
        - routeTree.gen.ts atualizado automaticamente pelo @tanstack/react-router
        - styles.css
    - index.html
    - project.json
    - vite.config.ts
    - ...
</FileTree>

```ts
// packages/common/constructs/src/app/static-websites/game-ui.ts
import * as url from 'url';
import { Construct } from 'constructs';
import { StaticWebsite } from '../../core/index.js';

export class GameUI extends StaticWebsite {
  constructor(scope: Construct, id: string) {
    super(scope, id, {
      websiteFilePath: url.fileURLToPath(
        new URL(
          '../../../../../../dist/packages/game-ui/bundle',
          import.meta.url,
        ),
      ),
    });
  }
}
```

Este √© o construct CDK que define nossa GameUI. Como pode ver, ele j√° configurou o caminho do arquivo para o bundle gerado para nossa UI baseada em Vite. Isso significa que no momento de `build` o bundling ocorre dentro do target build do projeto game-ui e sua sa√≠da √© usada aqui.

```tsx
// packages/game-ui/src/main.tsx
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';

import '@cloudscape-design/global-styles/index.css';

const router = createRouter({ routeTree });

// Registra a inst√¢ncia do router para seguran√ßa de tipos
declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}

const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
        <RouterProvider router={router} />
      </I18nProvider>
    </React.StrictMode>,
  );
```

Este √© o ponto de entrada onde o React √© montado. Como mostrado, inicialmente apenas configura um `@tanstack/react-router` em uma configura√ß√£o de [`roteamento baseado em arquivo`](https://tanstack.com/router/v1/docs/framework/react/routing/file-based-routing). Isso significa que, enquanto seu servidor de desenvolvimento estiver em execu√ß√£o, voc√™ pode simplesmente criar arquivos na pasta `routes` e o `@tanstack/react-router` criar√° a configura√ß√£o de arquivo boilerplate para voc√™, atualizando o arquivo `routeTree.gen.ts`. Este arquivo mant√©m todas as rotas de forma type-safe, o que significa que ao usar `<Link>`, a op√ß√£o `to` s√≥ mostrar√° rotas v√°lidas. Para mais informa√ß√µes, consulte a [documenta√ß√£o do `@tanstack/react-router`](https://tanstack.com/router/v1/docs/framework/react/quick-start).

```tsx
// packages/game-ui/src/routes/welcome/index.tsx
import {
  ContentLayout,
  Header,
  SpaceBetween,
  Container,
} from '@cloudscape-design/components';
import { createFileRoute } from '@tanstack/react-router';

export const Route = createFileRoute('/welcome/')({
  component: RouteComponent,
});

function RouteComponent() {
  return (
    <ContentLayout header={<Header>Welcome</Header>}>
      <SpaceBetween size="l">
        <Container>Welcome to your new Cloudscape website!</Container>
      </SpaceBetween>
    </ContentLayout>
  );
}
```

Um componente que ser√° renderizado ao navegar para a rota `/welcome`. O `@tanstack/react-router` gerenciar√° a `Route` para voc√™ sempre que criar/mover este arquivo (desde que o servidor de desenvolvimento esteja em execu√ß√£o). Isso ser√° mostrado em uma se√ß√£o posterior deste tutorial.

</Drawer>

### Adicionar autentica√ß√£o ao Game UI

Para configurar nossa Game UI com acesso autenticado via Amazon Cognito, siga estes passos:

<RunGenerator generator="ts#cloudscape-website#auth" requiredParameters={{cognitoDomain:"game-ui", project:"@dungeon-adventure/game-ui", allowSignup:true}} noInteractive />

Voc√™ ver√° novos arquivos aparecerem na sua √°rvore de arquivos.

<Drawer title="Arquivos atualizados pelo ts#cloudscape-website#auth" trigger="Clique aqui para examinar estes arquivos em mais detalhes.">
Abaixo est√° a lista de todos os arquivos gerados/atualizados pelo gerador `ts#cloudscape-website#auth`. Vamos examinar alguns dos arquivos-chave destacados na √°rvore de arquivos:
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - core/
          - user-identity.ts construct CDK para criar pools de usu√°rios/identidade
    - types/
      - src/
        - runtime-config.ts atualizado para adicionar cognitoProps
  - game-ui/
    - src/
      - components/
        - AppLayout/
          - index.tsx adiciona o usu√°rio logado/logout ao cabe√ßalho
        - CognitoAuth/
          - index.ts gerencia login no Cognito
        - RuntimeConfig/
          - index.tsx busca o `runtime-config.json` e fornece aos filhos via contexto
      - hooks/
        - useRuntimeConfig.tsx
      - **main.tsx** Atualizado para adicionar Cognito
</FileTree>

```diff lang="tsx"
// packages/game-ui/src/main.tsx
+import CognitoAuth from './components/CognitoAuth';
+import RuntimeConfigProvider from './components/RuntimeConfig';
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';
import '@cloudscape-design/global-styles/index.css';
const router = createRouter({ routeTree });
// Registra a inst√¢ncia do router para seguran√ßa de tipos
declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}
const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
+        <RuntimeConfigProvider>
+          <CognitoAuth>
            <RouterProvider router={router} />
+          </CognitoAuth>
+        </RuntimeConfigProvider>
      </I18nProvider>
    </React.StrictMode>,
  );
```

Os componentes `RuntimeConfigProvider` e `CognitoAuth` foram adicionados ao arquivo `main.tsx` via transforma√ß√£o AST. Isso permite que o componente `CognitoAuth` autentique com Amazon Cognito buscando o `runtime-config.json` que cont√©m a configura√ß√£o de conex√£o Cognito necess√°ria para fazer chamadas backend para o destino correto.

</Drawer>

### Configurar Game UI para conectar √† Story API

Para configurar nossa Game UI para conectar √† Story API criada anteriormente, siga estes passos:

<RunGenerator generator="api-connection" requiredParameters={{sourceProject:"@dungeon-adventure/game-ui", targetProject:"dungeon_adventure.story_api"}} noInteractive />

Voc√™ ver√° novos arquivos aparecerem na sua √°rvore de arquivos.

<Drawer title="Arquivos atualizados pela conex√£o UI -> FastAPI" trigger="Clique aqui para examinar estes arquivos em mais detalhes.">
Abaixo est√° a lista de todos os arquivos gerados/atualizados pelo gerador `api-connection`. Vamos examinar alguns dos arquivos-chave destacados na √°rvore de arquivos:
<FileTree>
- packages/
  - game-ui/
    - src/
      - hooks/
        - useSigV4.tsx usado pelo StoryApi para assinar requisi√ß√µes
        - useStoryApiClient.tsx hook para construir um cliente StoryApi
        - useStoryApi.tsx hook para interagir com o StoryApi usando TanStack Query
      - components/
        - QueryClientProvider.tsx provedor do cliente TanStack Query
        - StoryApiProvider.tsx Provedor para o hook TanStack Query do StoryApi
      - main.tsx Instrumenta o QueryClientProvider e StoryApiProvider
    - .gitignore ignora arquivos client gerados
    - project.json atualizado para adicionar targets para gerar hooks openapi
    - ...
  - story_api/
    - scripts/
      - generate_open_api.py
    - project.json atualizado para emitir um arquivo openapi.json

</FileTree>

```tsx {1,12-15}
// packages/game-ui/src/hooks/useStoryApiClient.tsx
import { StoryApi } from '../generated/story-api/client.gen';
import { useSigV4 } from './useSigV4';
import { useRuntimeConfig } from './useRuntimeConfig';
import { useMemo } from 'react';

export const useStoryApi = (): StoryApi => {
  const runtimeConfig = useRuntimeConfig();
  const apiUrl = runtimeConfig.httpApis.StoryApi;
  const sigv4Client = useSigV4();
  return useMemo(
    () =>
      new StoryApi({
        url: apiUrl,
        fetch: sigv4Client,
      }),
    [apiUrl, sigv4Client],
  );
};
```

Voc√™ pode usar este hook para fazer requisi√ß√µes de API autenticadas para o `StoryApi`. Ele usa o `StoryApi` que √© gerado no momento do build, e voc√™ ver√° um erro no seu IDE at√© que nosso c√≥digo seja constru√≠do. Para mais detalhes sobre como o cliente √© gerado ou como consumir a API, consulte o <Link path="guides/api-connection/react-fastapi">guia React para FastAPI</Link>.

```tsx
// packages/game-ui/src/components/StoryApiProvider.tsx
import { createContext, FC, PropsWithChildren, useMemo } from 'react';
import { useStoryApiClient } from '../hooks/useStoryApiClient';
import { StoryApiOptionsProxy } from '../generated/story-api/options-proxy.gen';

export const StoryApiContext = createContext<StoryApiOptionsProxy | undefined>(
  undefined,
);

export const StoryApiProvider: FC<PropsWithChildren> = ({ children }) => {
  const client = useStoryApiClient();
  const optionsProxy = useMemo(
    () => new StoryApiOptionsProxy({ client }),
    [client],
  );

  return (
    <StoryApiContext.Provider value={optionsProxy}>
      {children}
    </StoryApiContext.Provider>
  );
};

export default StoryApiProvider;
```

O componente provedor acima usa o hook `useStoryApiClient` e instancia o `StoryApiOptionsProxy`, que √© usado para construir op√ß√µes para hooks TanStack Query. Voc√™ pode usar o hook correspondente `useStoryApi` para acessar este proxy de op√ß√µes, que fornece uma maneira de interagir com sua FastAPI de forma consistente com sua API tRPC.

Como `useStoryApiClient` nos fornece um iterador ass√≠ncrono para nossa API de streaming, usaremos o cliente vanilla diretamente neste tutorial.

<Aside type="caution">
Os arquivos `src/generated/story-api/*.gen.ts` nunca devem ser modificados manualmente, pois ser√£o re-gerados toda vez que voc√™ construir sua API.
</Aside>

</Drawer>

### Configurar Game UI para conectar √† Game API

Para configurar nossa Game UI para conectar √† nossa Game API, siga estes passos:

<RunGenerator generator="api-connection" requiredParameters={{sourceProject:"@dungeon-adventure/game-ui", targetProject:"@dungeon-adventure/game-api-backend"}} noInteractive />

Voc√™ deve ver alguns arquivos novos terem aparecido/mudado na sua √°rvore de arquivos.

<Drawer title="Arquivos atualizados pela conex√£o UI -> tRPC" trigger="Clique aqui para examinar estes arquivos em mais detalhes.">
Abaixo est√° a lista de todos os arquivos gerados/atualizados pelo gerador `api-connection`. Vamos examinar alguns dos arquivos-chave destacados na √°rvore de arquivos:
<FileTree>
- packages/
  - game-ui/
    - src/
      - components/
        - TrpcClients/
          - index.tsx
          - TrpcApis.tsx todas as APIs tRPC configuradas
          - TrpcClientProviders.tsx cria um provedor de cliente por API tRPC
          - TrpcProvider.tsx
      - hooks/
        - **useGameApi.tsx** hooks para chamar a GameApi
      - **main.tsx** injeta os provedores de cliente trpc
- package.json

</FileTree>

```tsx
// packages/game-ui/src/hooks/useGameApi.tsx
import { TrpcApis } from '../components/TrpcClients';

export const useGameApi = () => TrpcApis.GameApi.useTRPC();
```

Este hook usa a √∫ltima [integra√ß√£o React Query do tRPC](https://trpc.io/blog/introducing-tanstack-react-query-client) permitindo que usu√°rios interajam diretamente com `@tanstack/react-query` sem camadas adicionais de abstra√ß√£o. Para exemplos de como chamar APIs tRPC, consulte o <Link path="guides/api-connection/react-trpc#using-the-generated-code">guia de uso do hook tRPC</Link>.

<Aside>
O hook `useGameApi` √© diferente do `useStoryApi` pois n√£o requer um build para que mudan√ßas sejam refletidas, gra√ßas ao uso de [infer√™ncia TypeScript](https://trpc.io/docs/concepts) pelo tRPC. Isso permite que desenvolvedores fa√ßam mudan√ßas no backend que s√£o instantaneamente refletidas no frontend!
</Aside>

```diff lang="tsx"
// packages/game-ui/src/main.tsx
+import TrpcClientProviders from './components/TrpcClients';
+import QueryClientProvider from './components/QueryClientProvider';
import CognitoAuth from './components/CognitoAuth';
import RuntimeConfigProvider from './components/RuntimeConfig';
import React from 'react';
import { createRoot } from 'react-dom/client';
import { I18nProvider } from '@cloudscape-design/components/i18n';
import messages from '@cloudscape-design/components/i18n/messages/all.en';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { routeTree } from './routeTree.gen';
import '@cloudscape-design/global-styles/index.css';
const router = createRouter({ routeTree });
// Registra a inst√¢ncia do router para seguran√ßa de tipos
declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}
const root = document.getElementById('root');
root &&
  createRoot(root).render(
    <React.StrictMode>
      <I18nProvider locale="en" messages={[messages]}>
        <RuntimeConfigProvider>
          <CognitoAuth>
+            <QueryClientProvider>
+              <TrpcClientProviders>
                <RouterProvider router={router} />
+              </TrpcClientProviders>
+            </QueryClientProvider>
          </CognitoAuth>
        </RuntimeConfigProvider>
      </I18nProvider>
    </React.StrictMode>,
  );
```

O arquivo `main.tsx` foi atualizado via transforma√ß√£o AST para injetar os provedores tRPC.

</Drawer>

### Criar infraestrutura CDK para Game UI

Para criar a infraestrutura CDK como subprojeto final, siga estes passos:

<RunGenerator generator="ts#infra" requiredParameters={{name:"infra"}} noInteractive />

Voc√™ deve ver alguns arquivos novos terem aparecido/mudado na sua √°rvore de arquivos.

<Drawer title="Arquivos atualizados pelo ts#infra" trigger="Clique aqui para examinar estes arquivos em mais detalhes.">
Abaixo est√° a lista de todos os arquivos gerados/atualizados pelo gerador `ts#infra`. Vamos examinar alguns dos arquivos-chave destacados na √°rvore de arquivos:
<FileTree>
- packages/
  - common/
    - constructs/
      - src/
        - core/
          - cfn-guard-rules/
            - *.guard
          - cfn-guard.ts
          - index.ts
  - infra
    - src/
      - stacks/
        - **application-stack.ts** recursos CDK definidos aqui
      - index.ts
      - **main.ts** ponto de entrada que define todas as stacks
    - cdk.json
    - project.json
    - ...
  - package.json
  - tsconfig.json adiciona refer√™ncias
  - tsconfig.base.json adiciona alias

</FileTree>

```ts
// packages/infra/src/main.ts
import { ApplicationStack } from './stacks/application-stack.js';
import {
  App,
  CfnGuardValidator,
  RuleSet,
} from ':dungeon-adventure/common-constructs';

const app = new App({
  policyValidationBeta1: [new CfnGuardValidator(RuleSet.AWS_PROTOTYPING)],
});

// Use isso para implantar seu pr√≥prio ambiente sandbox (assume suas credenciais CLI)
new ApplicationStack(app, 'dungeon-adventure-infra-sandbox', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  },
  crossRegionReferences: true,
});

app.synth();
```

Este √© o ponto de entrada para sua aplica√ß√£o CDK. Ele est√° configurado para usar [`cfn-guard`](https://github.com/cdklabs/cdk-validator-cfnguard) para executar valida√ß√£o de infraestrutura baseada no conjunto de regras configurado. Isso √© instrumentado p√≥s-s√≠ntese.

<Aside type="tip">
Pode haver casos onde voc√™ queira suprimir certas regras em recursos. Voc√™ pode fazer isso de duas formas:

###### Suprimir uma regra em um construct espec√≠fico

```typescript
import { suppressRule } from ':dungeon-adventure/common-constructs';

...
// suprime a RULE_NAME para o construct dado
suppressRule(construct, 'RULE_NAME');
```

###### Suprimir uma regra em um construct descendente

```typescript
import { suppressRule } from ':dungeon-adventure/common-constructs';

...
// Suprime a RULE_NAME para o construct ou qualquer descendente se for uma inst√¢ncia de Bucket
suppressRule(construct, 'RULE_NAME', (construct) => construct instanceof Bucket);
```
</Aside>

```ts
// packages/infra/src/stacks/application-stack.ts
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // O c√≥digo que define sua stack vai aqui
  }
}
```

Este √© o local onde instanciamos nossos constructs CDK para construir nosso jogo dungeon adventure.

</Drawer>

#### Atualizar infraestrutura CDK

Para instanciar alguns de nossos constructs j√° gerados, vamos atualizar nosso `packages/infra/src/stacks/application-stack.ts` :

```diff lang="ts"
+import {
+  GameApi,
+  GameUI,
+  StoryApi,
+  UserIdentity,
+} from ':dungeon-adventure/common-constructs';
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

-    // O c√≥digo que define sua stack vai aqui
+    const userIdentity = new UserIdentity(this, 'UserIdentity');
+
+    const gameApi = new GameApi(this, 'GameApi');
+    const storyApi = new StoryApi(this, 'StoryApi');
+
+    // concede √† nossa fun√ß√£o autenticada acesso para invocar nossas APIs
+    [storyApi, gameApi].forEach((api) =>
+      api.grantInvokeAccess(userIdentity.identityPool.authenticatedRole),
+    );
+
+    // Garante que isso seja instanciado por √∫ltimo para que nosso runtime-config.json possa ser configurado automaticamente
+    new GameUI(this, 'GameUI');
  }
}

```

### Construindo nosso c√≥digo

<Drawer title="Comandos Nx" trigger="Agora √© hora de construir nosso c√≥digo pela primeira vez">
###### Targets √∫nicos vs m√∫ltiplos

O comando `run-many` executar√° um target em m√∫ltiplos subprojetos listados (`--all` os targetar√° todos). Ele garantir√° que depend√™ncias sejam executadas na ordem correta.

Voc√™ tamb√©m pode acionar um build (ou qualquer outra tarefa) para um target de projeto √∫nico executando o target diretamente no projeto. Por exemplo, se quisermos construir o projeto `@dungeon-adventure/infra`, voc√™ pode executar o seguinte comando:

<NxCommands commands={['run @dungeon-adventure/infra:build']} />
###### Visualizando suas depend√™ncias

Voc√™ tamb√©m pode visualizar suas depend√™ncias via:

<NxCommands commands={['graph']} />
<br/>

<Image src={nxGraphPng} alt="nx-graph.png" width="800" height="600" />

###### Cache

O Nx depende de [cache](https://nx.dev/concepts/how-caching-works) para que voc√™ possa reutilizar artefatos de builds anteriores e acelerar o desenvolvimento. √â necess√°ria alguma configura√ß√£o para que isso funcione corretamente e pode haver casos onde voc√™ queira executar um build **sem usar o cache**. Para isso, simplesmente adicione o argumento `--skip-nx-cache` ao seu comando. Por exemplo:

<NxCommands commands={['run @dungeon-adventure/infra:build --skip-nx-cache']} />
Se por qualquer motivo voc√™ quiser limpar seu cache (armazenado na pasta `.nx`), voc√™ pode executar o seguinte comando:

<NxCommands commands={['reset']} />

</Drawer>

<NxCommands commands={['run-many --target build --all']} />

Voc√™ ser√° questionado com o seguinte:

```bash
 NX   The workspace is out of sync

[@nx/js:typescript-sync]: Some TypeScript configuration files are missing project references to the projects they depend on or contain outdated project references.

This will result in an error in CI.

? Would you like to sync the identified changes to get your workspace up to date? ‚Ä¶
Yes, sync the changes and run the tasks
No, run the tasks without syncing the changes
```

Esta mensagem indica que o NX detectou alguns arquivos que podem ser atualizados automaticamente. Neste caso, refere-se aos arquivos `tsconfig.json` que n√£o t√™m refer√™ncias TypeScript configuradas para projetos dependentes. Selecione a op√ß√£o **Yes, sync the changes and run the tasks** para prosseguir. Voc√™ deve notar que todos os erros de importa√ß√£o relacionados ao IDE s√£o resolvidos automaticamente, pois o gerador sync adicionar√° as refer√™ncias TypeScript faltantes automaticamente!

<Aside type="tip">
Se encontrar erros de lint, voc√™ pode executar o seguinte comando para corrigi-los automaticamente.

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

<Aside type="caution" title="Falha de build no Windows">
<Drawer trigger="Se voc√™ estiver no Windows e encontrar um erro de build, clique aqui." title="Falha de build no Windows">
Se voc√™ encontrar um erro de build/synth para o projeto `@dungeon-adventure/infra`, isso √© esperado pois a biblioteca que instrumenta o `cfn-guard` atualmente n√£o suporta Windows. H√° uma feature request acompanhando isso, mas por enquanto podemos simplesmente desabilitar o `cfn-guard` modificando o arquivo `packages/infra/src/main.ts` da seguinte forma:

```diff lang="ts"
// packages/infra/src/main.ts
import { ApplicationStack } from './stacks/application-stack.js';
import {
   App,
-  CfnGuardValidator,
-  RuleSet,
} from ':dungeon-adventure/common-constructs';
-
-const app = new App({
-  policyValidationBeta1: [new CfnGuardValidator(RuleSet.AWS_PROTOTYPING)],
-});
+const app = new App();

// Use isso para implantar seu pr√≥prio ambiente sandbox (assume suas credenciais CLI)
new ApplicationStack(app, 'dungeon-adventure-infra-sandbox', {
  env: {
    account: process.env.CDK_DEFAULT_ACCOUNT,
    region: process.env.CDK_DEFAULT_REGION,
  },
  crossRegionReferences: true,
});

app.synth();
```
</Drawer>
</Aside>

Todos os artefatos constru√≠dos est√£o agora dispon√≠veis dentro da pasta `dist/` localizada na raiz do monorepo. Esta √© uma pr√°tica padr√£o ao usar projetos gerados pelo `@aws/nx-plugin` para n√£o misturar sua √°rvore de arquivos com arquivos gerados. Se quiser limpar seus arquivos, delete a pasta `dist/` sem se preocupar com arquivos gerados espalhados pela √°rvore de arquivos.

Parab√©ns! Voc√™ criou todos os subprojetos necess√°rios para come√ßar a implementar o n√∫cleo do nosso jogo Dunegeon Adventure.  üéâüéâüéâ