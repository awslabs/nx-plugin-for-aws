---
title: "Implementar e configurar o agente Story"
description: "Um guia passo a passo de como construir um jogo de aventura de dungeon alimentado por IA ag√™ntica usando o @aws/nx-plugin."
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## Tarefa 1: Implementar o Agente de Hist√≥ria

O Agente de Hist√≥ria √© um agente [Strands](https://strandsagents.com/) que, dado um `Game` e uma lista de `Action`s como contexto, ir√° progredir uma narrativa. Configuraremos o agente para interagir com nosso Inventory MCP Server e gerenciar os itens dispon√≠veis de um jogador.

:::note
Para este tutorial, implementaremos o Agente de forma "stateless", onde cada invoca√ß√£o √© uma sess√£o independente incluindo todo o hist√≥rico de mensagens. Para produ√ß√£o, considere integrar com [Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html). Para mais informa√ß√µes, consulte a p√°gina [usando AgentCore Memory com Strands](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands).
:::

### Implementa√ß√£o do Agente

Para implementar nosso agente, atualize os seguintes arquivos em `packages/story/dungeon_adventure_story/agent`:

<Tabs>
  <TabItem label="main.py">
<E2EDiff lang="python" before="dungeon-adventure/3/main.py.old.template" after="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2EDiff lang="python" before="dungeon-adventure/3/agent.py.old.template" after="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

Esta configura√ß√£o implementa:

- Extra√ß√£o do jogador, g√™nero e a√ß√µes do payload do agente,
- Constru√ß√£o de um cliente que o Agente pode usar para invocar nosso MCP Server com autentica√ß√£o SigV4, e
- Constru√ß√£o do agente com um prompt de sistema e as ferramentas do MCP Server.

## Tarefa 2: Implanta√ß√£o e testes

### Construir o c√≥digo

Para construir o c√≥digo:

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
Se encontrar erros de lint, execute o seguinte comando para corrigi-los automaticamente.

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

### Implantar sua aplica√ß√£o
Para implantar sua aplica√ß√£o, execute o seguinte comando:

<NxCommands commands={['deploy infra dungeon-adventure-infra-sandbox/*']} />

Esta implanta√ß√£o levar√° aproximadamente 2 minutos para ser conclu√≠da.

Ap√≥s a conclus√£o da implanta√ß√£o, voc√™ ver√° sa√≠das similares √†s seguintes _(alguns valores foram redigidos)_:

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 ‚úÖ  dungeon-adventure-infra-sandbox-Application

‚ú®  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

### Testar sua API

Voc√™ pode testar sua API de duas formas:
<ul>
<li>Iniciando uma inst√¢ncia local do servidor Agent e invocando-o usando `curl`, ou</li>
<li>Chamando a API implantada usando curl com um token JWT.</li>
</ul>

<Tabs>
  <TabItem label="Local">
  Inicie seu servidor Agent local executando o seguinte comando:
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    Use a sa√≠da `InventoryMcpArn` do CDK deploy acima, e especifique sua `AWS_REGION` alvo.
    :::

    Uma vez que o servidor Agent esteja em execu√ß√£o (voc√™ n√£o ver√° nenhuma sa√≠da), invoque-o executando o seguinte comando:

    ```bash
    curl -N -X POST http://127.0.0.1:8081/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="Implantado">
    Para testar o agente implantado, voc√™ precisar√° autenticar com Cognito e obter um token JWT. Primeiro, configure suas vari√°veis de ambiente:

    ```bash
    # Defina seu Cognito User Pool ID e Client ID das sa√≠das do CDK
    export POOL_ID="<UserPoolId das sa√≠das do CDK>"
    export CLIENT_ID="<UserPoolClientId das sa√≠das do CDK>"
    export REGION="<sua-regiao>"
    ```

    Crie um usu√°rio de teste e obtenha um token de autentica√ß√£o:

    ```bash
    # Criar Usu√°rio
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --temporary-password "TempPass123!" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    # Definir Senha Permanente (substitua por algo mais seguro!)
    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --password "PermanentPass123!" \
      --region $REGION \
      --permanent > /dev/null

    # Autenticar Usu√°rio e capturar ID Token
    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='testuser',PASSWORD='PermanentPass123!' \
      --region $REGION | jq -r '.AuthenticationResult.IdToken')
    ```

    :::caution
    Use a sa√≠da `UserIdentityUserIdentityUserPoolIdXXX` para `POOL_ID` e certifique-se de ter o Client ID correspondente das sa√≠das da implanta√ß√£o do CDK.
    :::

    Invoque o agente implantado usando a URL do runtime do Bedrock AgentCore:

    ```bash
    # Defina a ARN do Story Agent das sa√≠das do CDK
    export AGENT_ARN="<StoryAgentArn das sa√≠das do CDK>"

    # Codifique a ARN em URL
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')

    # Construa a URL de invoca√ß√£o
    export MCP_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    # Invoque o agente
    curl -N -X POST "$MCP_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    A codifica√ß√£o URL √© necess√°ria para formatar corretamente a ARN para o endpoint da API do Bedrock AgentCore.
    :::
  </TabItem>
</Tabs>

Se o comando for executado com sucesso, voc√™ ver√° eventos sendo transmitidos de forma similar a:

```
data: {"init_event_loop": true}

data: {"start": true}

data: {"start_event_loop": true}

data: {"event": {"messageStart": {"role": "assistant"}}}

data: {"event": {"contentBlockDelta": {"delta": {"text": "Welcome"}, "contentBlockIndex": 0}}}

...
```

Parab√©ns. Voc√™ construiu e implantou seu primeiro Agente Strands no Bedrock AgentCore Runtime! üéâüéâüéâ