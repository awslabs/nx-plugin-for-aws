---
title: "Jogo de Dungeons de IA Ag√™ntica"
description: "Um guia passo a passo de como construir um jogo de aventura de dungeon alimentado por IA ag√™ntica usando o @aws/nx-plugin."
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## M√≥dulo 3: Implementa√ß√£o do Agente de Hist√≥ria

<Aside type="caution">
Certifique-se que sua conta AWS habilitou acesso ao [modelo padr√£o da Strands](https://strandsagents.com/latest/documentation/docs/user-guide/concepts/model-providers/amazon-bedrock/) dentro do Bedrock para sua regi√£o alvo seguindo os passos do [guia oficial](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html). Na data desta escrita, o modelo √© o Anthropic Claude Sonnet 4.
</Aside>

O Agente de Hist√≥ria √© um agente [Strands](https://strandsagents.com/) que, dado um `Game` e uma lista de `Action`s como contexto, ir√° progredir uma narrativa. Configuraremos o agente para interagir com nosso Inventory MCP Server e gerenciar os itens dispon√≠veis do jogador.

:::note
Para simplificar este tutorial, implementamos o Agente de forma "stateless" onde cada invoca√ß√£o √© uma sess√£o independente incluindo todo o hist√≥rico. Para produ√ß√£o, considere integrar com [Bedrock AgentCore Memory](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/memory.html). Mais documenta√ß√£o sobre uso com Strands est√° [dispon√≠vel aqui](https://github.com/aws/bedrock-agentcore-sdk-python/tree/main/src/bedrock_agentcore/memory/integrations/strands).
:::

### Implementa√ß√£o do Agente

Vamos implementar nosso agente. Atualize os seguintes arquivos em `packages/story/dungeon_adventure_story/agent`:

<Tabs>
  <TabItem label="main.py">
<E2EDiff lang="python" before="dungeon-adventure/3/main.py.old.template" after="dungeon-adventure/3/main.py.template" />
  </TabItem>
  <TabItem label="agent.py">
<E2EDiff lang="python" before="dungeon-adventure/3/agent.py.old.template" after="dungeon-adventure/3/agent.py.template" />
  </TabItem>
</Tabs>

Esta configura√ß√£o implementa:

- Extra√ß√£o do jogador, g√™nero e a√ß√µes do payload do agente
- Constru√ß√£o de um cliente para o Agente invocar o MCP Server com autentica√ß√£o SigV4
- Cria√ß√£o do agente com prompt de sistema e ferramentas do MCP Server

### Implanta√ß√£o e Testes

Primeiro, vamos construir o c√≥digo:

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
Se encontrar erros de lint, execute este comando para corre√ß√£o autom√°tica:

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

Implante a aplica√ß√£o com:

<NxCommands commands={['deploy infra dungeon-adventure-infra-sandbox/*']} />

Esta implanta√ß√£o levar√° aproximadamente 2 minutos.

Ap√≥s conclus√£o, voc√™ ver√° sa√≠das similares a estas _(valores redigidos)_:

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 ‚úÖ  dungeon-adventure-infra-sandbox-Application

‚ú®  Tempo de implanta√ß√£o: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.InventoryMcpArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.StoryAgentArn = arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventurecationStoryAgentXXXX-YYYY
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

Podemos testar nossa API de duas formas:
<ul>
<li>Iniciando uma inst√¢ncia local do servidor Agent e invocando com `curl`</li>
<li>Chamando a API implantada usando curl com token JWT</li>
</ul>

<Tabs>
  <TabItem label="Local">
  Inicie o servidor local com:
    <NxCommands highlights={['arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY', 'region']} env={{PORT: '9999', INVENTORY_MCP_ARN:"arn:aws:bedrock-agentcore:region:xxxxxxx:runtime/dungeonadventureventoryMcpServerXXXX-YYYY", AWS_REGION: '<region>'}} commands={["run dungeon_adventure.story:agent-serve"]} />

    :::caution
    Use o output `InventoryMcpArn` do CDK deploy acima, e especifique sua `AWS_REGION` alvo.
    :::

    Com o servidor rodando (sem output vis√≠vel), invoque com:

    ```bash
    curl -N -X POST http://127.0.0.1:9999/invocations \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789"
    ```
  </TabItem>
  <TabItem label="Implantado">
    Para testar o agente implantado, autentique via Cognito para obter token JWT. Primeiro configure vari√°veis:

    ```bash
    export POOL_ID="<UserPoolId dos outputs do CDK>"
    export CLIENT_ID="<UserPoolClientId dos outputs do CDK>"
    export REGION="<sua-regiao>"
    ```

    Crie usu√°rio teste e obtenha token:

    ```bash
    aws cognito-idp admin-create-user \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --temporary-password "TempPass123!" \
      --region $REGION \
      --message-action SUPPRESS > /dev/null

    aws cognito-idp admin-set-user-password \
      --user-pool-id $POOL_ID \
      --username "testuser" \
      --password "PermanentPass123!" \
      --region $REGION \
      --permanent > /dev/null

    export BEARER_TOKEN=$(aws cognito-idp initiate-auth \
      --client-id "$CLIENT_ID" \
      --auth-flow USER_PASSWORD_AUTH \
      --auth-parameters USERNAME='testuser',PASSWORD='PermanentPass123!' \
      --region $REGION | jq -r '.AuthenticationResult.IdToken')
    ```

    :::caution
    Use o output `UserIdentityUserIdentityUserPoolIdXXX` para `POOL_ID` e confirme o Client ID correto.
    :::

    Invoque o agente implantado:

    ```bash
    export AGENT_ARN="<StoryAgentArn dos outputs do CDK>"
    export ENCODED_ARN=$(echo $AGENT_ARN | sed 's/:/%3A/g' | sed 's/\//%2F/g')
    export MCP_URL="https://bedrock-agentcore.$REGION.amazonaws.com/runtimes/$ENCODED_ARN/invocations?qualifier=DEFAULT"

    curl -N -X POST "$MCP_URL" \
      -H "authorization: Bearer $BEARER_TOKEN" \
      -H "Content-Type: application/json" \
      -H "X-Amzn-Bedrock-AgentCore-Runtime-Session-Id: abcdefghijklmnopqrstuvwxyz-123456789" \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}'
    ```

    :::note
    A codifica√ß√£o URL √© necess√°ria para formatar corretamente a ARN no endpoint da API.
    :::
  </TabItem>
</Tabs>

Se executado com sucesso, voc√™ ver√° eventos sendo transmitidos como:

```
data: {"init_event_loop": true}

data: {"start": true}

data: {"start_event_loop": true}

data: {"event": {"messageStart": {"role": "assistant"}}}

data: {"event": {"contentBlockDelta": {"delta": {"text": "Welcome"}, "contentBlockIndex": 0}}}

...
```

Parab√©ns! Voc√™ implementou e implantou seu primeiro Agente Strands no Bedrock AgentCore Runtime! üéâüéâüéâ