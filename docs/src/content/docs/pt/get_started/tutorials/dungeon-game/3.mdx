---
title: "Jogo de Dungeons com IA"
description: "Um guia passo a passo de como construir um jogo de aventura de dungeon com IA usando o @aws/nx-plugin."
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## M√≥dulo 3: Implementa√ß√£o da API de Hist√≥ria

<Aside type="caution">
Certifique-se de ter concedido acesso ao modelo **Anthropic Claude 3.5 Sonnet v2** seguindo os passos descritos neste [guia](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html).
</Aside>

A StoryApi consiste em uma √∫nica API `generate_story` que, dado um `Game` e uma lista de `Action`s como contexto, ir√° progredir uma hist√≥ria. Esta API ser√° implementada como uma API de streaming em Python/FastAPI e tamb√©m demonstrar√° como altera√ß√µes podem ser feitas no c√≥digo gerado para atender ao prop√≥sito desejado.

### Implementa√ß√£o da API

Para criar nossa API, primeiro precisamos instalar algumas depend√™ncias adicionais:

- `boto3` ser√° usado para chamar o Amazon Bedrock;
- `uvicorn` ser√° usado para iniciar nossa API em conjunto com o [Lambda Web Adapter (LWA)](https://github.com/awslabs/aws-lambda-web-adapter);
- `copyfiles` √© uma depend√™ncia npm necess√°ria para suportar a c√≥pia de arquivos multiplataforma ao atualizar nossa tarefa `bundle`.

Para instalar estas depend√™ncias, execute os seguintes comandos:

<NxCommands commands={["run dungeon_adventure.story_api:add --args boto3 uvicorn"]} />
<InstallCommand pkg="copyfiles" dev />

Agora vamos substituir o conte√∫do dos seguintes arquivos em `packages/story_api/story_api`:

<Tabs>
<TabItem label="main.py">
<E2ECode path="dungeon-adventure/3/main.py.template" lang="python" />
</TabItem>
<TabItem label="init.py">
<E2ECode path="dungeon-adventure/3/init.py.template" lang="python" />

:::note
A altera√ß√£o acima no `init.py` simplesmente remove o middleware CORS para evitar conflitos com o tratamento pr√≥prio de cabe√ßalhos CORS do Lambda Function URL.
:::

</TabItem>
</Tabs>

Analisando o c√≥digo acima:

- Usamos a configura√ß√£o `x-streaming` para indicar que esta √© uma API de streaming quando gerarmos nosso client SDK. Isso permitir√° consumir esta API de forma streaming mantendo a seguran√ßa de tipos!
- Nossa API simplesmente retorna um fluxo de texto definido por `media_type="text/plain"` e `response_class=PlainTextResponse`

:::note
Sempre que fizer altera√ß√µes em seu FastAPI, voc√™ precisar√° reconstruir seu projeto para ver essas altera√ß√µes refletidas no client gerado em seu website.

Faremos mais algumas altera√ß√µes abaixo antes de reconstruir.
:::

### Infraestrutura

A <Link path="get_started/tutorials/dungeon-game/1#game-ui-infrastructure">infraestrutura configurada anteriormente</Link> assume que todas as APIs t√™m um API Gateway integrado com fun√ß√µes Lambda. Para nossa `story_api`, n√£o queremos usar API Gateway pois ele n√£o suporta respostas em streaming. Em vez disso, usaremos um [Lambda Function URL configurado com response streaming](https://docs.aws.amazon.com/lambda/latest/dg/configuration-response-streaming.html).

Para suportar isso, primeiro atualizaremos nossos constructs CDK da seguinte forma:

<Tabs>
<TabItem label="story-api.ts">
<E2ECode path="dungeon-adventure/3/story-api.ts.template" lang="typescript" />
</TabItem>
<TabItem label="application-stack.ts">
<E2EDiff before="dungeon-adventure/2/stacks/application-stack.ts.template" after="dungeon-adventure/3/application-stack.ts.template" lang="typescript" />
</TabItem>
</Tabs>

Agora atualizaremos a `story_api` para suportar a implanta√ß√£o do [Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter).

<Tabs>
<TabItem label="run.sh">
<E2ECode path="dungeon-adventure/3/run.sh.template" lang="bash" />
</TabItem>
<TabItem label="project.json">
```diff lang="json"
// packages/story_api/project.json
{
  "name": "dungeon_adventure.story_api",
  ...
  "targets": {
    ...
    "bundle": {
+      "cache": true,
+      "executor": "nx:run-commands",
+      "outputs": ["{workspaceRoot}/dist/packages/story_api/bundle"],
+      "options": {
+        "commands": [
+          "copyfiles -f packages/story_api/run.sh dist/packages/story_api/bundle"
+        ],
+        "parallel": false
+      },
      "dependsOn": ["bundle-x86"]
    },
    ...
  }
}
```
</TabItem>
</Tabs>

### Implanta√ß√£o e testes

Primeiro, vamos construir a base de c√≥digo:

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
Se encontrar erros de lint, voc√™ pode executar o seguinte comando para corrigi-los automaticamente:

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

Sua aplica√ß√£o j√° pode ser implantada executando o seguinte comando:

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox/*']} />

Esta implanta√ß√£o levar√° aproximadamente 2 minutos para ser conclu√≠da.

Ap√≥s a conclus√£o da implanta√ß√£o, voc√™ dever√° ver algumas sa√≠das semelhantes √†s seguintes _(alguns valores foram omitidos)_:

```bash
dungeon-adventure-infra-sandbox-Application
dungeon-adventure-infra-sandbox-Application: deploying... [2/2]

 ‚úÖ  dungeon-adventure-infra-sandbox-Application

‚ú®  Tempo de implanta√ß√£o: 354s

Outputs:
dungeon-adventure-infra-sandbox-Application.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-Application-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox-Application.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox-Application.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox-Application.StoryApiStoryApiUrlXXX = https://xxx.lambda-url.ap-southeast-2.on.aws/
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox-Application.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

Podemos testar nossa API de duas formas:
<ul>
<li>Iniciando uma inst√¢ncia local do servidor FastAPI e invocando as APIs usando `curl`</li>
<li>
<Drawer title="curl com Sigv4 habilitado" trigger="Chamando a API implantada usando curl com Sigv4 habilitado diretamente">

<Tabs>
  <TabItem label="Bash/Linux/macOS">
Voc√™ pode adicionar o seguinte script ao seu arquivo `.bashrc` (e executar `source`) ou simplesmente colar o seguinte no mesmo terminal onde deseja executar o comando.
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

Para fazer uma requisi√ß√£o curl autenticada com sigv4, voc√™ pode invocar `acurl` como nos exemplos abaixo:

###### API Gateway
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### URL Lambda com streaming
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
  <TabItem label="Windows PowerShell">
Voc√™ pode adicionar a seguinte fun√ß√£o ao seu perfil do PowerShell ou simplesmente colar o seguinte na mesma sess√£o do PowerShell onde deseja executar o comando.
```powershell
# Perfil do PowerShell ou sess√£o atual
function acurl {
    param(
        [Parameter(Mandatory=$true)][string]$Region,
        [Parameter(Mandatory=$true)][string]$Service,
        [Parameter(ValueFromRemainingArguments=$true)][string[]]$CurlArgs
    )

    $AccessKey = aws configure get aws_access_key_id
    $SecretKey = aws configure get aws_secret_access_key
    $SessionToken = aws configure get aws_session_token

    & curl --aws-sigv4 "aws:amz:$Region`:$Service" --user "$AccessKey`:$SecretKey" -H "X-Amz-Security-Token: $SessionToken" @CurlArgs
}
```

Para fazer uma requisi√ß√£o curl autenticada com sigv4, voc√™ pode invocar `acurl` como nos exemplos abaixo:

###### API Gateway
```powershell
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### URL Lambda com streaming
```powershell
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
</Tabs>

</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="Local">
  Inicie seu servidor FastAPI local executando:
    <NxCommands commands={["run dungeon_adventure.story_api:serve"]} />

    Com o servidor FastAPI em execu√ß√£o, chame-o com:
    
    ```bash
    curl -N -X POST http://127.0.0.1:8000/story/generate \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="Deployed">
```bash "https://xxx.lambda-url.ap-southeast-2.on.aws/" "ap-southeast-2"
acurl ap-southeast-2 lambda -N -X POST \
  https://xxx.lambda-url.ap-southeast-2.on.aws/story/generate \
  -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
  -H "Content-Type: application/json"
```
    <Aside type="caution">
    Use o valor de sa√≠da `dungeon-adventure-infra-sandbox-Application.StoryApiStoryApiUrlXXX` do deploy CDK para substituir o placeholder de URL destacado e defina a regi√£o adequadamente.
    </Aside>
  </TabItem>
</Tabs>

Se o comando for executado com sucesso, voc√™ dever√° ver uma resposta em streaming similar a:

```
UnnamedHero stood tall, his cape billowing in the wind....
```

Parab√©ns. Voc√™ construiu e implantou sua primeira API usando FastAPI! üéâüéâüéâ