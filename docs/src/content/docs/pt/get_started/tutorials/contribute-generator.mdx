---
title: "Contribua com um Gerador"
description: "Um guia passo a passo de como criar um gerador usando o @aws/nx-plugin."
---



import {
  Aside,
  Code,
  FileTree,
  Steps,
  Tabs,
  TabItem,
} from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import LinkCommand from '@components/link-command.astro';
import InstallCommand from '@components/install-command.astro';
import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png';
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png';
import baselineWebsitePng from '@assets/baseline-website.png';
import baselineGamePng from '@assets/baseline-game.png';
import nxGraphPng from '@assets/nx-graph.png';
import gameSelectPng from '@assets/game-select.png';
import gameConversationPng from '@assets/game-conversation.png';

Vamos criar um novo gerador para contribuir com o `@aws/nx-plugin`. Nosso objetivo será gerar um novo procedimento para nossa API tRPC.

### Clonar o Plugin

Primeiro, vamos clonar o plugin:

```bash
git clone git@github.com:awslabs/nx-plugin-for-aws.git
```

Em seguida, instale e compile:

```bash
cd nx-plugin-for-aws
pnpm i
pnpm nx run-many --target build --all
```

### Criar um Gerador Vazio

Vamos criar o novo gerador em `packages/nx-plugin/src/trpc/procedure`.

Fornecemos um gerador de geradores para você criar rapidamente seu novo gerador! Execute-o da seguinte forma:

<RunGenerator generator="ts#nx-generator" requiredParameters={{ pluginProject: '@aws/nx-plugin', name: 'ts#trpc-api#procecure', directory: 'trpc/procedure', description: 'Adds a procedure to a tRPC API' }} />

Você notará que os seguintes arquivos foram gerados:

<FileTree>
  - packages/nx-plugin/src/trpc/procedure
    - schema.json Define a entrada para nosso gerador
    - schema.d.ts Uma interface TypeScript que corresponde ao schema
    - generator.ts Função executada pelo Nx como nosso gerador  
    - generator.spec.ts Testes para nosso gerador
</FileTree>

Vamos atualizar o schema para adicionar as propriedades necessárias:

<Tabs>
  <TabItem label="schema.json">
    ```json
    {
      "$schema": "https://json-schema.org/schema",
      "$id": "tRPCProcedure",
      "title": "Adds a procedure to a tRPC API",
      "type": "object",
      "properties": {
        "project": {
          "type": "string",
          "description": "tRPC API project",
          "x-prompt": "Select the tRPC API project to add the procedure to",
          "x-dropdown": "projects",
          "x-priority": "important"
        },
        "procedure": {
          "description": "The name of the new procedure",
          "type": "string",
          "x-prompt": "What would you like to call your new procedure?",
          "x-priority": "important",
        },
        "type": {
          "description": "The type of procedure to generate",
          "type": "string",
          "x-prompt": "What type of procedure would you like to generate?",
          "x-priority": "important",
          "default": "query",
          "enum": ["query", "mutation"]
        }
      },
      "required": ["project", "procedure"]
    }
    ```
  </TabItem>
  <TabItem label="schema.d.ts">
    ```ts
    export interface TrpcProcedureSchema {
      project: string;
      procedure: string;
      type: 'query' | 'mutation';
    }
    ```
  </TabItem>
</Tabs>

:::note
Observe que nosso gerador recebe uma `Tree` como entrada, além das opções definidas no schema. A `Tree` é essencialmente um sistema de arquivos virtual que podemos ler e escrever para criar/atualizar arquivos. Não queremos acessar o sistema de arquivos diretamente para evitar alterações acidentais em modo "dry-run".
:::

O gerador já foi registrado em `packages/nx-plugin/generators.json`:

```json
 ...
  "generators": {
    ...
    "ts#trpc-api#procedure": {
      "factory": "./src/trpc/procedure/generator",
      "schema": "./src/trpc/procedure/schema.json",
      "description": "Adds a procedure to a tRPC API"
    }
  },
...
```

### Implementar o Gerador

Para adicionar um procedimento a uma API tRPC, precisamos:

1. Criar um arquivo TypeScript para o novo procedimento
2. Adicionar o procedimento ao router

#### Criar o Novo Procedimento

Usaremos o utilitário `generateFiles` com um template EJS para gerar o arquivo:

```ts title="files/procedures/__procedureNameKebabCase__.ts.template"
import { publicProcedure } from '../init.js';
import { z } from 'zod';

export const <%- procedureNameCamelCase %> = publicProcedure
  .input(z.object({
    // TODO: define input
  }))
  .output(z.object({
    // TODO: define output
  }))
  .<%- procedureType %>(async ({ input, ctx }) => {
    // TODO: implement!
    return {};
  });
```

:::tip
O `generateFiles` substitui variáveis `__<variável>__` em nomes de arquivo/diretório e remove `.template`. O conteúdo usa sintaxe EJS `<% ... %>`.
:::

Atualizamos o gerador para passar as variáveis necessárias:

```ts title="procedure/generator.ts" {8-19}
import {
  generateFiles,
  joinPathFragments,
  readProjectConfiguration,
  Tree,
} from '@nx/devkit';
import { TrpcProcedureSchema } from './schema';
import { formatFilesInSubtree } from '../../utils/format';
import camelCase from 'lodash.camelcase';
import kebabCase from 'lodash.kebabcase';

export const trpcProcedureGenerator = async (
  tree: Tree,
  options: TrpcProcedureSchema,
) => {
  const projectConfig = readProjectConfiguration(tree, options.project);

  const procedureNameCamelCase = camelCase(options.procedure);
  const procedureNameKebabCase = kebabCase(options.procedure);

  generateFiles(
    tree,
    joinPathFragments(__dirname, 'files'),
    projectConfig.sourceRoot,
    {
      procedureNameCamelCase,
      procedureNameKebabCase,
      procedureType: options.type,
    },
  );

  await formatFilesInSubtree(tree);
};

export default trpcProcedureGenerator;
```

:::tip
O `formatFilesInSubtree` formata os arquivos gerados de acordo com as configurações do Prettier.
:::

#### Adicionar o Procedimento ao Router

Usamos manipulação de AST para atualizar o arquivo do router:

```ts title="procedure/generator.ts" {6, 23-33}
import {
  generateFiles,
  joinPathFragments,
  readProjectConfiguration,
  Tree,
} from '@nx/devkit';
import { TrpcProcedureSchema } from './schema';
import { formatFilesInSubtree } from '../../utils/format';
import camelCase from 'lodash.camelcase';
import kebabCase from 'lodash.kebabcase';
import { destructuredImport, replace } from '../../utils/ast';
import { factory, ObjectLiteralExpression } from 'typescript';

export const trpcProcedureGenerator = async (
  tree: Tree,
  options: TrpcProcedureSchema,
) => {
  const projectConfig = readProjectConfiguration(tree, options.project);

  const procedureNameCamelCase = camelCase(options.procedure);
  const procedureNameKebabCase = kebabCase(options.procedure);

  generateFiles(
    tree,
    joinPathFragments(__dirname, 'files'),
    projectConfig.sourceRoot,
    {
      procedureNameCamelCase,
      procedureNameKebabCase,
      procedureType: options.type,
    },
  );

  const routerPath = joinPathFragments(projectConfig.sourceRoot, 'router.ts');

  destructuredImport(
    tree,
    routerPath,
    [procedureNameCamelCase],
    `./procedures/${procedureNameKebabCase}.js`,
  );

  replace(
    tree,
    routerPath,
    'CallExpression[expression.name="router"] > ObjectLiteralExpression',
    (node) =>
      factory.createObjectLiteralExpression([
        ...(node as ObjectLiteralExpression).properties,
        factory.createShorthandPropertyAssignment(procedureNameCamelCase),
      ]),
  );

  await formatFilesInSubtree(tree);
};

export default trpcProcedureGenerator;
```

:::tip
O `replace` usa seletores tsquery para encontrar elementos na AST. Use o [tsquery playground](https://tsquery-playground.firebaseapp.com/) para testar seletores.
:::

Compile o gerador para testar:

```bash
pnpm nx run @aws/nx-plugin:compile
```

### Testando o Gerador

Para testar, vincule o plugin local ao projeto <Link path="get_started/tutorials/dungeon-game/overview">dungeon-adventure</Link>:

<LinkCommand
  dependency="@aws/nx-plugin"
  dependencyPath="path/to/nx-plugin-for-aws/dist/packages/nx-plugin"
  projectPath="path/to/dungeon-adventure"
/>

Execute o novo gerador:

<RunGenerator generator="ts#trpc-api#procedure" />

:::note
Se não visualizar o gerador no VSCode, atualize o workspace Nx:

<NxCommands commands={['reset']} />
:::

### Exercícios

Sugestões para aprimorar o gerador:

#### 1. Operações Aninhadas
- Aceitar notação de ponto para `procedure` (ex: `games.query`)
- Gerar procedimentos com nomes baseados na notação reversa (ex: `queryGames`)
- Criar routers aninhados conforme necessário

#### 2. Validação
- Impedir seleção de projetos que não são APIs tRPC
- Verificar exemplo do gerador `api-connection`

#### 3. Testes Unitários
1. Criar workspace vazio com `createTreeUsingTsSolutionSetup()`
2. Adicionar arquivos pré-existentes necessários
3. Executar gerador
4. Validar mudanças na árvore

#### 4. Testes End-to-End
- Atualizar teste de fumaça existente para incluir o novo gerador

#### 5. Contribua!
- Envie um pull request se o gerador ainda não foi contribuído
- Explore outras oportunidades de contribuição